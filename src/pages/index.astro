---
import AuthGuard from "../components/AuthGuard.astro";
---

<AuthGuard />

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Gestión de Canchas - AngloAmerican</title>

    <!-- Chart.js para gráficos de perfil -->
    <script
      src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"
    ></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background-color: #f5f7fa;
        color: #333;
        line-height: 1.6;
      }

      .header {
        background: linear-gradient(135deg, #2c3e50, #3498db);
        color: white;
        padding: 2rem 0;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
      }

      /* Canvas de partículas de fondo */
      #particles-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
      }

      .header h1 {
        position: relative;
        z-index: 1;
      }

      /* Estilos para logos (comentado temporalmente)
      .logos-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 2rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
      }
      
      .company-logo {
        transition: transform 0.3s ease, filter 0.3s ease;
        filter: brightness(1.1) contrast(1.1);
        background: rgba(255, 255, 255, 0.08);
        padding: 0.6rem;
        border-radius: 8px;
        backdrop-filter: blur(10px);
      }
      
      .company-logo:hover {
        transform: scale(1.03);
        filter: brightness(1.15) contrast(1.15);
        background: rgba(255, 255, 255, 0.15);
      }
      */

      .header h1 {
        font-size: 2.2rem;
        margin: 0;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        padding: 1rem 0;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
        margin: 0;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
      }

      .controls {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }

      .control-group {
        margin-bottom: 1.5rem;
      }

      .control-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #2c3e50;
      }

      select,
      input,
      button {
        padding: 0.75rem;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      select:focus,
      input:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
      }

      button {
        background: #3498db;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 600;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
      }

      button:hover {
        background: #2980b9;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
      }

      button:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-success {
        background: #27ae60;
      }

      .btn-success:hover {
        background: #229954;
      }

      .btn-pdf {
        background: #8e44ad;
        color: white;
        font-weight: 600;
      }

      .btn-pdf:hover {
        background: #732d91;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(142, 68, 173, 0.3);
      }

      .btn-danger {
        background: #e74c3c;
      }

      .btn-danger:hover {
        background: #c0392b;
      }

      .btn-warning {
        background: #f39c12;
      }

      .btn-warning:hover {
        background: #e67e22;
      }

      /* Estilos para botones del header */
      .header-buttons {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .header-btn {
        padding: 0.6rem 1.2rem;
        border: none;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
      }

      .header-btn-admin {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        color: white;
      }

      .header-btn-admin:hover {
        background: linear-gradient(135deg, #229954, #27ae60);
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(46, 204, 113, 0.3);
      }

      /* === BOTONES ESPECIALES LINKAPSIS === */
      .header-btn-linkapsis {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        font-size: 0.9rem;
        border: none;
        position: relative;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .header-btn-linkapsis::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.3),
          rgba(37, 99, 235, 0.3)
        );
        transition: left 0.5s ease;
      }

      .header-btn-linkapsis:hover {
        background: linear-gradient(135deg, #60a5fa, #3b82f6);
        transform: translateY(-2px);
        box-shadow:
          0 8px 20px rgba(59, 130, 246, 0.4),
          0 0 30px rgba(59, 130, 246, 0.2);
      }

      .header-btn-linkapsis:hover::before {
        left: 100%;
      }

      .header-btn-linkapsis:active {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      .header-btn-logout {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
      }

      .header-btn-logout:hover {
        background: linear-gradient(135deg, #c0392b, #a93226);
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(231, 76, 60, 0.3);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr auto;
        gap: 1rem;
        align-items: end;
      }

      .form-row input,
      .form-row select {
        padding: 0.75rem;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 1rem;
        background: white;
        transition: border-color 0.3s ease;
      }

      .form-row input:focus,
      .form-row select:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
      }

      .form-row select:disabled {
        background: #f8f9fa;
        color: #6c757d;
        cursor: not-allowed;
      }

      .form-row label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.5rem;
        display: block;
      }

      .table-container {
        background: white;
        border-radius: 16px;
        box-shadow:
          0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.04);
        margin-bottom: 2rem;
        transition: transform 0.3s ease;
      }

      .table-container:hover {
        transform: translateY(-2px);
      }

      /* Estilos de paginación */
      .pagination-container {
        background: white;
        padding: 1rem 1.5rem;
        border-top: 1px solid #e5e7eb;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .pagination-info {
        color: #64748b;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .pagination-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .pagination-current {
        color: #334155;
        font-weight: 600;
        padding: 0 1rem;
      }

      .pagination-btn {
        background: white;
        border: 1px solid #e5e7eb;
        color: #64748b;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.2s;
        min-width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .pagination-btn:hover:not(:disabled) {
        background: #f1f5f9;
        border-color: #cbd5e1;
        color: #334155;
      }

      .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #f9fafb;
      }

      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }

      th,
      td {
        padding: 1.2rem 1rem;
        text-align: center;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
      }

      th {
        background: linear-gradient(to bottom, #f0f9ff, #e0f2fe);
        font-weight: 700;
        color: #1e3a8a;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.05em;
        border-bottom: 2px solid #bfdbfe;
        position: relative;
      }

      /* Asegurar que el contenido de las celdas esté centrado */
      td {
        text-align: center !important;
        color: #475569;
        font-size: 0.95rem;
      }

      td strong {
        display: inline-block;
        color: #1e293b;
        font-weight: 600;
      }

      tr:last-child td {
        border-bottom: none;
      }

      tr:hover {
        background: #f8fafc;
      }

      /* Estilo para filas clickeables con doble-click */
      .cancha-row {
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .cancha-row:hover {
        background: #f8fafc !important;
        transform: scale(1.001);
        border-left: 3px solid #3b82f6;
      }

      .cancha-row:active {
        background: #bbdefb !important;
      }

      .estado {
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 700;
        text-align: center;
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .estado-creada {
        background: #eff6ff;
        color: #2563eb;
        border: 1px solid #dbeafe;
      }
      .estado-en-proceso {
        background: #fff7ed;
        color: #ea580c;
        border: 1px solid #ffedd5;
      }
      .estado-finalizada {
        background: #f0fdf4;
        color: #16a34a;
        border: 1px solid #dcfce7;
      }
      .estado-validada {
        background: #f0fdf4;
        color: #15803d;
        border: 1px solid #dcfce7;
      }
      .estado-rechazada {
        background: #fef2f2;
        color: #dc2626;
        border: 1px solid #fee2e2;
      }
      .estado-cerrada {
        background: #faf5ff;
        color: #9333ea;
        border: 1px solid #f3e8ff;
      }

      .actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        margin: 0 auto;
      }

      .actions button {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
        margin: 0;
        border-radius: 50px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        transition: all 0.2s ease;
      }

      .btn-accion {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        border: none;
        box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5);
      }

      .btn-accion:hover {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.4);
      }

      .admin-actions {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0 auto;
      }

      .admin-actions button {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
        border-radius: 50px;
        border: 1px solid #ef4444;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        color: #ef4444;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
      }

      .admin-actions button:hover {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        border-color: transparent;
      }

      /* Estilos #borrar-header eliminados - columna removida */

      .loading {
        text-align: center;
        padding: 2rem;
        color: #666;
      }

      .error {
        background: #ffebee;
        color: #c62828;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border-left: 4px solid #c62828;
      }

      .success {
        background: #e8f5e8;
        color: #2e7d32;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border-left: 4px solid #2e7d32;
      }

      .empresa-actual {
        display: inline-block;
        height: 36px;
        padding: 0.3rem 0.8rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 2px solid #e5e7eb;
        transition: all 0.3s ease;
      }

      .empresa-actual:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-1px);
      }

      .empresa-actual img {
        height: 100%;
        width: auto;
        object-fit: contain;
        display: block;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      }

      .modal-content {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        margin: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: -2rem -2rem 2rem -2rem;
        padding: 1.5rem 2rem;
        background: linear-gradient(
          135deg,
          #3b82f6 0%,
          #2563eb 50%,
          #1d4ed8 100%
        );
        border-radius: 12px 12px 0 0;
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
      }

      .modal-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: #ffffff;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        letter-spacing: 0.02em;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .close-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        font-size: 1.75rem;
        cursor: pointer;
        color: #ffffff;
        padding: 0.4rem 0.8rem;
        border-radius: 8px;
        transition: all 0.3s ease;
        font-weight: 700;
        line-height: 1;
        width: 42px;
        height: 42px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .close-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        transform: scale(1.1) rotate(90deg);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      .observacion-item {
        background: #f8f9fa;
        border-left: 4px solid #e74c3c;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 8px;
      }

      .observacion-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }

      .observacion-empresa {
        font-weight: 600;
        color: #e74c3c;
      }

      .observacion-fecha {
        font-size: 0.85rem;
        color: #666;
      }

      .observacion-tipo {
        font-size: 0.8rem;
        color: #7f8c8d;
        text-transform: capitalize;
      }

      .observacion-texto {
        color: #2c3e50;
        line-height: 1.5;
        margin-top: 0.5rem;
      }

      /* Estilos para Login por Empresa */
      .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 60vh;
        padding: 2rem;
      }

      .login-card {
        background: white;
        border-radius: 16px;
        padding: 3rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 500px;
        width: 100%;
      }

      .login-card h2 {
        color: #2c3e50;
        margin-bottom: 1rem;
        font-size: 2rem;
      }

      .login-card p {
        color: #666;
        margin-bottom: 2rem;
        font-size: 1.1rem;
      }

      .login-form {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      #empresa-login {
        font-size: 1.2rem;
        padding: 1rem;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        background: white;
        transition: border-color 0.3s ease;
      }

      #empresa-login:focus {
        border-color: #3498db;
        outline: none;
      }

      #btn-ingresar {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      #btn-ingresar:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
      }

      #btn-ingresar:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
      }

      /* Header de empresa logueada */
      .empresa-header {
        background: white;
        padding: 1rem 2rem;
        margin-bottom: 2rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .empresa-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .empresa-nombre {
        font-size: 1.5rem;
        font-weight: 600;
        color: #2c3e50;
      }

      .empresa-rol {
        font-size: 0.9rem;
        color: #666;
      }

      #btn-cambiar-empresa {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      #btn-cambiar-empresa:hover {
        background: #c0392b;
      }

      /* Estilos para filtros */
      .filtros-container {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }

      .filtros-container h3 {
        color: #2c3e50;
        margin-bottom: 1rem;
        font-size: 1.3rem;
      }

      .filtros-row {
        display: flex;
        gap: 2rem;
        align-items: end;
        flex-wrap: wrap;
        margin-bottom: 1rem;
      }

      .filtro-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        min-width: 150px;
      }

      .filtro-group.rango-fechas {
        flex-direction: row;
        align-items: center;
        gap: 1rem;
        min-width: auto;
      }

      .filtro-group.rango-fechas label {
        margin: 0;
        white-space: nowrap;
      }

      .filtro-group label {
        font-weight: 600;
        color: #555;
        font-size: 0.9rem;
      }

      .toggle-group {
        display: flex;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        overflow: hidden;
      }

      .toggle-btn {
        background: #f8f9fa;
        border: none;
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        color: #555;
      }

      .toggle-btn:hover:not(.active) {
        background: #e9ecef;
        color: #333;
      }

      .toggle-btn.active {
        background: #3498db;
        color: white;
      }

      .toggle-btn:first-child {
        border-right: 1px solid #e1e8ed;
      }

      #filtro-fecha,
      #fecha-desde,
      #fecha-hasta {
        padding: 0.75rem;
        border: 2px solid #e1e8ed;
        border-radius: 6px;
        transition: border-color 0.3s ease;
      }

      #filtro-fecha:focus,
      #fecha-desde:focus,
      #fecha-hasta:focus {
        border-color: #3498db;
        outline: none;
      }

      #btn-aplicar-rango {
        background: #27ae60;
        color: white;
        border: none;
        padding: 0.75rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s ease;
        font-weight: 500;
      }

      #btn-aplicar-rango:hover {
        background: #229954;
      }

      /* Layout principal de filtros */
      .filtros-main-layout {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 2rem;
        align-items: start;
      }

      .filtros-controls {
        flex: 1;
      }

      /* === STATS SIDEBAR (WIDGETS ORIGINALES) === */
      .stats-sidebar {
        display: flex;
        flex-direction: row;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 1rem 1.5rem;
        color: white;
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 1rem;
        flex: 1;
        box-shadow:
          0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }

      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow:
          0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }

      .stat-card.stat-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      }

      .stat-card.stat-info {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      }

      .stat-icon {
        font-size: 2rem;
        opacity: 0.9;
        line-height: 1;
        flex-shrink: 0;
      }

      .stat-content {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex: 1;
      }

      .stat-content-top {
        display: flex;
        align-items: center;
        gap: 0;
      }

      .stat-number {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1;
        flex-shrink: 0;
      }

      .stat-label {
        font-size: 0.875rem;
        opacity: 0.9;
        font-weight: 500;
        white-space: nowrap;
      }

      /* === DASHBOARD DE ESTADOS (NUEVA SECCIÓN) === */
      .dashboard-estados-section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 2rem;
        margin-bottom: 2rem;
        box-shadow:
          0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
      }

      .dashboard-estados-header {
        margin-bottom: 1.5rem;
      }

      .dashboard-estados-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
      }

      /* Dashboard de Estados - Widgets circulares */
      .dashboard-estados {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        gap: 1.5rem;
        padding: 1rem 0;
        min-width: 700px;
      }

      .estado-widget {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
        flex: 1;
        min-width: 0;
        transition: transform 0.3s ease;
        cursor: pointer;
        user-select: none;
      }

      .estado-widget:hover {
        transform: translateY(-4px);
      }

      /* No hover para widgets dimmed */
      .estado-widget.dimmed:hover {
        transform: none;
      }

      .estado-widget.selected .widget-circle {
        transform: scale(1.2);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.45);
        border-width: 6px;
      }

      .estado-widget.selected .widget-label {
        font-weight: 700;
        color: #1f2937;
      }

      /* Widgets no seleccionados cuando hay uno activo */
      .estado-widget.dimmed .widget-circle {
        opacity: 0.3 !important;
        filter: grayscale(100%) !important;
        transform: scale(1) !important;
      }

      .estado-widget.dimmed:hover .widget-circle {
        opacity: 0.3 !important;
        filter: grayscale(100%) !important;
        transform: scale(1) !important;
      }

      .estado-widget.dimmed .widget-label {
        opacity: 0.4;
        color: #9ca3af;
      }

      .widget-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
        border: 4px solid;
        position: relative;
      }

      .estado-widget:not(.dimmed):hover .widget-circle {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
      }

      .widget-number {
        font-size: 2rem;
        font-weight: 800;
        color: white;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        font-family: "Segoe UI", system-ui, sans-serif;
      }

      .widget-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #475569;
        text-align: center;
        line-height: 1.2;
        text-transform: capitalize;
      }

      /* Colores específicos por estado - Basados en el mapa */
      .widget-creada {
        background: #3b82f6; /* Azul */
        border-color: #2563eb; /* Azul oscuro */
      }

      .widget-en-espera {
        background: #fbbf24; /* Amarillo */
        border-color: #f59e0b; /* Amarillo oscuro */
      }

      .widget-en-proceso {
        background: #fbbf24; /* Amarillo */
        border-color: #10b981; /* Verde - diferenciador */
      }

      .widget-validada {
        background: #10b981; /* Verde */
        border-color: #fbbf24; /* Amarillo - diferenciador */
      }

      .widget-rechazada-en-espera {
        background: #ef4444; /* Rojo */
        border-color: #fbbf24; /* Amarillo */
      }

      .widget-cerrada {
        background: #10b981; /* Verde */
        border-color: #059669; /* Verde oscuro */
      }

      @media (max-width: 1200px) {
        .filtros-main-layout {
          grid-template-columns: 1fr;
          gap: 1.5rem;
        }

        .dashboard-estados {
          min-width: unset;
          gap: 1.2rem;
        }

        .widget-circle {
          width: 70px;
          height: 70px;
        }

        .widget-number {
          font-size: 1.75rem;
        }

        .widget-label {
          font-size: 0.8rem;
        }
      }

      @media (max-width: 768px) {
        .dashboard-estados {
          flex-wrap: wrap;
          justify-content: center;
          gap: 1.5rem;
        }

        .estado-widget {
          flex: 0 0 auto;
          min-width: 90px;
        }

        .widget-circle {
          width: 75px;
          height: 75px;
        }
      }

      @media (max-width: 480px) {
        .dashboard-estados {
          gap: 1rem;
        }

        .widget-circle {
          width: 65px;
          height: 65px;
        }

        .widget-number {
          font-size: 1.5rem;
        }

        .widget-label {
          font-size: 0.75rem;
        }
      }

      /* Estilos para formularios de validación */
      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.5rem;
      }

      .form-group textarea,
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e1e8ed;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }

      .form-group textarea {
        min-height: 100px;
        resize: vertical;
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        border-color: #3498db;
        outline: none;
      }

      .mediciones-group {
        display: flex;
        gap: 0.5rem;
      }

      .mediciones-group input {
        flex: 1;
      }

      .form-group small {
        color: #666;
        font-size: 0.85rem;
        margin-top: 0.25rem;
        display: block;
      }

      /* Estilos para checkboxes de tipo de trabajo */
      .checkbox-group {
        display: flex;
        gap: 1rem;
        margin-top: 0.5rem;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        padding: 0.5rem;
        border: 2px solid #e1e8ed;
        border-radius: 6px;
        transition: all 0.3s ease;
      }

      .checkbox-item:hover {
        background-color: #f8f9fa;
        border-color: #3498db;
      }

      .checkbox-item input[type="checkbox"] {
        width: auto;
        margin: 0;
      }

      .checkbox-item span {
        font-weight: 500;
        color: #2c3e50;
      }

      /* Estilos para coordenadas */
      .coordenadas-grid {
        display: grid;
        gap: 1.5rem;
        margin-top: 1rem;
      }

      .punto-section {
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        padding: 1rem;
        background-color: #f8f9fa;
      }

      .punto-section h5 {
        margin: 0 0 1rem 0;
        color: #2c3e50;
        font-weight: 600;
        font-size: 1.1rem;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 0.5rem;
      }

      .coordenadas-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1rem;
      }

      .coord-field {
        display: flex;
        flex-direction: column;
      }

      .coord-field label {
        font-size: 0.9rem;
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.25rem;
      }

      .coord-field input {
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.9rem;
      }

      .coord-field input:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
      }

      /* Responsive para coordenadas */
      @media (max-width: 768px) {
        .coordenadas-row {
          grid-template-columns: 1fr;
          gap: 0.5rem;
        }

        .checkbox-group {
          flex-direction: column;
          gap: 0.5rem;
        }
      }

      .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid #e1e8ed;
      }

      .btn-cancel,
      .btn-validar,
      .btn-rechazar,
      .btn-finalizar {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-cancel {
        background: #6c757d;
        color: white;
      }

      .btn-cancel:hover {
        background: #5a6268;
      }

      .btn-validar,
      .btn-finalizar {
        background: #27ae60;
        color: white;
      }

      .btn-validar:hover,
      .btn-finalizar:hover {
        background: #229954;
      }

      .btn-rechazar {
        background: #e74c3c;
        color: white;
      }

      .btn-rechazar:hover {
        background: #c0392b;
      }

      .btn-comenzar {
        background: #3498db;
        color: white;
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-comenzar:hover {
        background: #2980b9;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
      }

      #empresa-selector {
        font-size: 1.2rem;
        font-weight: 600;
        padding: 1rem;
        background: #f8f9fa;
        border: 2px solid #3498db;
      }

      /* Estilos para historial de observaciones */
      .historial-observaciones {
        margin: 1rem 0;
        padding: 1.5rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        border-left: 4px solid #3498db;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .historial-observaciones h4 {
        margin: 0 0 1.5rem 0;
        font-size: 1.3rem;
        color: #2c3e50;
        text-align: center;
        border-bottom: 3px solid #3498db;
        padding-bottom: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .historial-content {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 0.5rem;
      }

      .historial-timeline {
        position: relative;
        padding-left: 2rem;
      }

      .historial-timeline::before {
        content: "";
        position: absolute;
        left: 1rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, #3498db, #2ecc71);
      }

      .observacion-item {
        position: relative;
        background: white;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        border: 2px solid #e0e0e0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .observacion-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        border-color: #3498db;
      }

      .observacion-item::before {
        content: "";
        position: absolute;
        left: -2.75rem;
        top: 1rem;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: white;
        border: 3px solid #3498db;
        z-index: 1;
      }

      .observacion-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #eee;
      }

      .observacion-empresa {
        font-weight: 700;
        font-size: 1rem;
        color: #2c3e50;
        background: #3498db;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.9rem;
      }

      .observacion-fecha {
        font-size: 0.8rem;
        color: #7f8c8d;
        font-weight: 500;
      }

      .observacion-contenido {
        margin-top: 0.5rem;
      }

      .observacion-texto {
        color: #2c3e50;
        margin: 0.5rem 0;
        line-height: 1.5;
        font-style: italic;
        background: #f8f9fa;
        padding: 0.75rem;
        border-radius: 6px;
        border-left: 3px solid #3498db;
      }

      .observacion-mediciones {
        background: linear-gradient(135deg, #e8f4fd 0%, #d1ecf1 100%);
        padding: 0.75rem;
        border-radius: 6px;
        margin-top: 0.75rem;
        border: 1px solid #bee5eb;
      }

      .medicion-titulo {
        font-weight: 600;
        color: #155724;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
        display: flex;
        align-items: center;
      }

      .medicion-titulo::before {
        content: "📏";
        margin-right: 0.5rem;
      }

      .medicion-valor {
        font-size: 1rem;
        color: #0c5460;
        font-weight: 700;
        font-family: "Courier New", monospace;
      }

      .empresa-besalco::before {
        background-color: #e74c3c;
      }
      .empresa-linkapsis::before {
        background-color: #f39c12;
      }
      .empresa-llayllay::before {
        background-color: #27ae60;
      }
      .empresa-angloamerican::before {
        background-color: #3498db;
      }

      /* Nuevos estilos para historial mejorado */
      .historial-entry {
        background: #ffffff;
        border: 2px solid #e1e8ed;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        position: relative;
      }

      .historial-entry:hover {
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
      }

      .empresa-nombre {
        font-size: 1.4rem;
        font-weight: 800;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 1.2px;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      /* Colores específicos por empresa */
      .historial-entry.empresa-besalco {
        border-left: 6px solid #e74c3c;
        background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
      }

      .historial-entry.empresa-besalco .empresa-nombre {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
      }

      .historial-entry.empresa-linkapsis {
        border-left: 6px solid #f39c12;
        background: linear-gradient(135deg, #fffaf5 0%, #ffffff 100%);
      }

      .historial-entry.empresa-linkapsis .empresa-nombre {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        color: white;
      }

      .historial-entry.empresa-llayllay {
        border-left: 6px solid #27ae60;
        background: linear-gradient(135deg, #f8fff8 0%, #ffffff 100%);
      }

      .historial-entry.empresa-llayllay .empresa-nombre {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        color: white;
      }

      .historial-entry.empresa-angloamerican {
        border-left: 6px solid #3498db;
        background: linear-gradient(135deg, #f5f9ff 0%, #ffffff 100%);
      }

      .historial-entry.empresa-angloamerican .empresa-nombre {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
      }

      .fecha-linea,
      .observacion-linea,
      .medicion-linea {
        margin-bottom: 1rem;
        line-height: 1.6;
        padding: 0.5rem 0;
      }

      .fecha-label,
      .observacion-label,
      .medicion-label {
        font-weight: 700;
        color: #2c3e50;
        font-size: 1rem;
        display: inline-block;
        min-width: 120px;
      }

      .observacion-linea {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #3498db;
        font-style: italic;
        font-size: 1.05rem;
      }

      .medicion-linea {
        background: linear-gradient(135deg, #e8f4fd 0%, #d1ecf1 100%);
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #bee5eb;
        font-size: 1rem;
      }

      .medicion-linea strong {
        color: #155724;
        font-family: "Courier New", monospace;
        font-size: 1.1rem;
        font-weight: 800;
      }

      /* Separador entre empresas */
      .separador-empresas {
        text-align: center;
        margin: 2rem 0;
        font-size: 1.2rem;
        color: #bdc3c7;
        letter-spacing: 3px;
        font-family: monospace;
        line-height: 1;
      }

      .hidden {
        display: none;
      }

      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
        }

        .container {
          padding: 1rem;
        }

        .header h1 {
          font-size: 1.8rem;
        }

        /* Estilos responsivos para logos (comentado temporalmente)
        .logos-container {
          gap: 1.5rem;
          margin-bottom: 1.2rem;
        }
        
        .company-logo {
          max-width: 220px;
          height: auto;
        }
        */

        /* Para pantallas muy pequeñas */
        @media (max-width: 480px) {
          /* Estilos para logos comentados
          .logos-container {
            gap: 1rem;
          }
          
          .company-logo {
            max-width: 180px;
          }
          */

          .header h1 {
            font-size: 1.5rem;
            line-height: 1.3;
            padding: 0 1rem;
          }
        }

        table {
          font-size: 0.9rem;
        }

        th,
        td {
          padding: 0.5rem;
        }

        .actions {
          flex-direction: column;
        }
      }

      /* Estilos para el Modal del Mapa */
      .map-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
      }

      .map-modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease-out;
      }

      .map-modal-content {
        background: white;
        border-radius: 16px;
        width: 95%;
        height: 90%;
        max-width: 1200px;
        max-height: 800px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: slideIn 0.3s ease-out;
      }

      .map-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 16px 16px 0 0;
      }

      .map-modal-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
      }

      .map-close-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 2rem;
        cursor: pointer;
        padding: 0.5rem 0.8rem;
        border-radius: 50%;
        transition: all 0.3s ease;
        line-height: 1;
      }

      .map-close-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      .map-container {
        flex: 1;
        position: relative;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 500px;
      }

      .map-container iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 0 0 16px 16px;
      }

      .map-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #666;
        font-size: 1.1rem;
      }

      .map-loading::before {
        content: "";
        width: 40px;
        height: 40px;
        border: 4px solid #e1e8ed;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: scale(0.9) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Responsive para el modal del mapa */
      @media (max-width: 768px) {
        .map-modal-content {
          width: 98%;
          height: 95%;
          margin: 1%;
        }

        .map-modal-header {
          padding: 1rem 1.5rem;
        }

        .map-modal-title {
          font-size: 1.2rem;
        }

        /* Responsive para modal de creación */
        #createCanchaModal .map-modal-content {
          width: 98vw !important;
          height: 98vh !important;
          margin: 1vh auto !important;
        }

        .create-cancha-container {
          flex-direction: column !important;
          height: calc(100% - 60px) !important;
        }

        .create-cancha-form {
          flex: 0 0 auto !important;
          max-height: 45vh !important;
          border-right: none !important;
          border-bottom: 2px solid #e1e8ed !important;
          padding: 1.5rem !important;
        }

        .create-cancha-map-panel {
          flex: 1 !important;
          min-height: 300px !important;
        }

        .map-panel-header {
          padding: 1rem !important;
        }

        .form-actions {
          flex-direction: row !important;
          gap: 0.5rem !important;
        }

        .form-actions button {
          font-size: 0.8rem !important;
          padding: 0.6rem 0.8rem !important;
        }
      }

      /* Estilos para el Modal de Creación de Cancha */
      #createCanchaModal .map-modal-content {
        max-width: 1400px !important;
        width: 95vw !important;
        height: 90vh !important;
        max-height: none !important;
      }

      .create-cancha-container {
        display: flex !important;
        height: calc(100% - 80px) !important; /* Altura total menos header */
        gap: 0 !important;
        flex-direction: row !important;
      }

      .create-cancha-form {
        flex: 0 0 380px !important; /* Ancho fijo para el formulario */
        padding: 2rem !important;
        background: #f8f9fa !important;
        border-right: 2px solid #e1e8ed !important;
        display: flex !important;
        flex-direction: column !important;
        gap: 1.5rem !important;
        overflow-y: auto !important;
        min-height: 100% !important;
      }

      .form-section-title {
        color: #2c3e50 !important;
        font-size: 1.1rem !important;
        font-weight: 600 !important;
        margin: 0 0 1rem 0 !important;
        padding-bottom: 0.5rem !important;
        border-bottom: 2px solid #667eea !important;
      }

      .create-cancha-map-panel {
        flex: 1 !important; /* Ocupa el resto del espacio */
        display: flex !important;
        flex-direction: column !important;
        background: #ffffff !important;
        min-width: 0 !important; /* Permite que el flex item se encoja */
      }

      .map-panel-header {
        padding: 1.5rem 2rem 1rem 2rem !important;
        border-bottom: 1px solid #e1e8ed !important;
        background: linear-gradient(
          135deg,
          #667eea 0%,
          #764ba2 100%
        ) !important;
        color: white !important;
        flex-shrink: 0 !important;
      }

      .map-panel-title {
        margin: 0 0 0.5rem 0 !important;
        font-size: 1.1rem !important;
        font-weight: 600 !important;
      }

      .map-panel-subtitle {
        margin: 0 !important;
        font-size: 0.9rem !important;
        opacity: 0.9 !important;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
      }

      .form-group input,
      .form-group select {
        padding: 0.8rem;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-actions {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        margin-top: auto; /* Empuja los botones hacia abajo */
      }

      .form-actions button {
        padding: 0.8rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
        border: none;
        font-size: 0.9rem;
      }

      .drawing-map-container {
        flex: 1;
        min-height: 500px;
        background: #f0f2f5;
        position: relative;
        border-radius: 0;
        overflow: hidden;
      }

      .drawing-map-container iframe {
        width: 100%;
        height: 100%;
        border: none;
      }

      .drawing-status {
        padding: 1rem;
        border-radius: 8px;
        font-weight: 500;
        text-align: center;
        font-size: 0.9rem;
      }

      .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 1rem;
      }

      .btn-primary,
      .btn-success {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-success {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
      }

      .btn-success:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
      }

      .btn-primary:disabled,
      .btn-success:disabled {
        background: #cccccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .drawing-status {
        text-align: center;
        padding: 1rem;
        border-radius: 8px;
        font-weight: 500;
        min-height: 1.5rem;
      }

      .drawing-status.success {
        background: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #4caf50;
      }

      .drawing-status.info {
        background: #e3f2fd;
        color: #1976d2;
        border: 1px solid #2196f3;
      }

      #createCanchaModal .drawing-map-container {
        flex: 1 !important;
        height: 100% !important;
        min-height: 400px !important;
        background: #f0f2f5 !important;
        position: relative !important;
        border-radius: 0 !important;
        overflow: hidden !important;
        display: flex !important; /* Siempre visible en el nuevo diseño */
        align-items: center !important;
        justify-content: center !important;
      }

      #createCanchaModal .drawing-map-container iframe {
        width: 100% !important;
        height: 100% !important;
        border: none !important;
      }

      #createCanchaModal .drawing-map-container:empty::before {
        content: "🗺️ El mapa aparecerá aquí cuando hagas clic en 'Dibujar Área en Mapa'" !important;
        color: #6c757d !important;
        font-style: italic !important;
        text-align: center !important;
        padding: 2rem !important;
        line-height: 1.5 !important;
      }

      /* Estilos para el botón de crear cancha en el header */
      .btn-crear-cancha {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      }

      .btn-crear-cancha:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
      }

      .texto-ayuda {
        color: #666;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        font-style: italic;
      }

      /* === ESTILOS DEL MAPA DASHBOARD === */
      .dashboard-map-section {
        margin: 2rem 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }

      .dashboard-map-header {
        padding: 1.5rem;
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        border-bottom: 3px solid #3b82f6;
      }

      .dashboard-map-title {
        margin: 0;
        color: white;
        font-size: 1.5rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .dashboard-map-subtitle {
        margin: 0.5rem 0 0 0;
        color: #cbd5e1;
        font-size: 0.9rem;
        font-weight: 400;
      }

      .dashboard-map-container {
        position: relative;
        width: 100%;
        height: 600px;
        background: #f8fafc;
      }

      .dashboard-map-container iframe {
        width: 100%;
        height: 100%;
        border: none;
      }

      .dashboard-map-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #64748b;
        font-size: 1rem;
        font-weight: 500;
      }

      .dashboard-map-loading::before {
        content: "🗺️";
        display: block;
        font-size: 3rem;
        margin-bottom: 1rem;
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.7;
          transform: scale(1.1);
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .dashboard-map-container {
          height: 400px;
        }
      }

      /* === ESTILOS PARA HEADER DEL MAPA === */
      .dashboard-map-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 2rem;
        flex-wrap: wrap;
      }

      .map-header-left {
        flex: 1;
        min-width: 200px;
      }

      .map-header-controls {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        flex-wrap: wrap;
      }

      /* Filtro de Muros */
      .map-filter-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .filter-label {
        font-weight: 600;
        color: #cbd5e1;
        font-size: 0.9rem;
        white-space: nowrap;
      }

      .map-filter-select {
        appearance: none;
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 0.5rem 2rem 0.5rem 0.75rem;
        font-size: 0.9rem;
        color: white;
        font-weight: 500;
        cursor: pointer;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='white'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.5rem center;
        background-size: 1rem;
        transition: all 0.2s ease;
        min-width: 140px;
      }

      .map-filter-select:hover {
        background-color: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
      }

      .map-filter-select:focus {
        outline: none;
        border-color: #60a5fa;
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
      }

      .map-filter-select option {
        background-color: #1e293b;
        color: white;
      }

      /* Toggle Revanchas */
      .map-toggle-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .toggle-label {
        font-weight: 600;
        color: #cbd5e1;
        font-size: 0.9rem;
        white-space: nowrap;
      }

      /* Toggle Switch Moderno (ON/OFF) */
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 52px;
        height: 28px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .toggle-slider-round {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        transition: 0.3s;
        border-radius: 28px;
      }

      .toggle-slider-round:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .toggle-switch input:checked + .toggle-slider-round {
        background-color: #10b981;
        border-color: #10b981;
      }

      .toggle-switch input:checked + .toggle-slider-round:before {
        transform: translateX(24px);
      }

      .toggle-switch input:focus + .toggle-slider-round {
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
      }

      /* Símbolos ON/OFF */
      .toggle-slider-round:after {
        content: "O";
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.7rem;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.6);
        transition: 0.3s;
      }

      .toggle-switch input:checked + .toggle-slider-round:after {
        content: "I";
        left: 8px;
        right: auto;
        color: white;
      }

      /* Responsive para controles del mapa */
      @media (max-width: 768px) {
        .dashboard-map-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 1rem;
        }

        .map-header-controls {
          width: 100%;
          justify-content: space-between;
        }
      }

      /* === REDISEÑO FILTROS (V2) === */
      .toggle-container {
        position: relative;
        display: inline-flex;
        background: #f1f5f9;
        border-radius: 50px;
        padding: 4px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
      }

      .toggle-slider {
        position: absolute;
        top: 4px;
        left: 0;
        height: calc(100% - 8px);
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        border-radius: 50px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        z-index: 1;
      }

      .toggle-btn {
        position: relative;
        z-index: 2;
        background: transparent;
        border: none;
        padding: 0.6rem 1.5rem;
        font-weight: 600;
        color: #64748b;
        cursor: pointer;
        transition: color 0.3s ease;
        border-radius: 50px;
        font-size: 0.9rem;
        white-space: nowrap;
      }

      .toggle-btn.active {
        color: white;
      }

      .toggle-btn:hover:not(.active) {
        color: #334155;
      }

      /* Estilo para el selector de fecha */
      #filtro-fecha {
        appearance: none;
        background-color: white;
        border: 1px solid #cbd5e1;
        border-radius: 50px;
        padding: 0.6rem 2.5rem 0.6rem 1.2rem;
        font-size: 0.9rem;
        color: #334155;
        font-weight: 500;
        cursor: pointer;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%233b82f6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.8rem center;
        background-size: 1rem;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        min-width: 180px;
      }

      #filtro-fecha:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .filtro-group label {
        font-weight: 600;
        color: #475569;
        margin-right: 0.5rem;
        font-size: 0.9rem;
      }

      /* === ESTILOS DE SELECCIÓN MÚLTIPLE === */
      .cancha-checkbox {
        cursor: pointer;
        width: 18px;
        height: 18px;
        accent-color: #3b82f6;
      }

      #select-all-checkbox {
        cursor: pointer;
        width: 18px;
        height: 18px;
        accent-color: #3b82f6;
      }

      .cancha-row.selected {
        background-color: #eff6ff !important;
        border-left: 3px solid #3b82f6;
      }

      /* Barra flotante de acciones masivas */
      .bulk-actions-bar {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        padding: 1rem 2rem;
        border-radius: 50px;
        box-shadow:
          0 10px 40px rgba(0, 0, 0, 0.3),
          0 0 20px rgba(59, 130, 246, 0.2);
        display: flex;
        align-items: center;
        gap: 1.5rem;
        z-index: 1000;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(59, 130, 246, 0.3);
      }

      .bulk-actions-bar.hidden {
        display: none;
      }

      .bulk-actions-content {
        display: flex;
        align-items: center;
        gap: 1.5rem;
      }

      .selected-count {
        color: #ffffff;
        font-weight: 600;
        font-size: 0.95rem;
        padding: 0.5rem 1rem;
        background: rgba(59, 130, 246, 0.2);
        border-radius: 20px;
        border: 1px solid rgba(59, 130, 246, 0.3);
      }

      .bulk-actions-buttons {
        display: flex;
        gap: 0.75rem;
      }

      .btn-bulk-action {
        padding: 0.6rem 1.5rem;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .btn-bulk-delete {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
      }

      .btn-bulk-delete:hover {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
      }

      .btn-bulk-delete:active {
        transform: translateY(0);
      }

      .btn-bulk-timeline {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
      }

      .btn-bulk-timeline:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100 %);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      }

      .btn-bulk-timeline:active {
        transform: translateY(0);
      }

      .btn-clear-selection {
        padding: 0.6rem 1.2rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 25px;
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .btn-clear-selection:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.05);
      }

      /* === ESTILOS DEL MODAL TIMELINE === */
      .modal-timeline {
        max-width: 95vw;
        width: 1400px;
        max-height: 90vh;
        box-shadow:
          0 25px 50px -12px rgba(0, 0, 0, 0.5),
          0 0 100px rgba(59, 130, 246, 0.3);
        border: 1px solid rgba(59, 130, 246, 0.3);
        animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: scale(0.9) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      .timeline-container {
        padding: 1rem 0;
      }

      .timeline-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 2rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .timeline-legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: white;
        border-radius: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .timeline-legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid #fff;
        box-shadow: 0 0 0 2px currentColor;
      }

      .timeline-legend-name {
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.9rem;
      }

      .timeline-legend {
        display: flex;
        gap: 1.5rem;
        padding: 1rem;
        background: linear-gradient(to right, #f8fafc, #f1f5f9);
        border-radius: 8px;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        justify-content: center;
      }

      .timeline-legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: white;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .timeline-legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .timeline-legend-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 12px;
        border: 2px solid #e2e8f0;
      }

      .timeline-legend-title {
        font-size: 1rem;
        font-weight: 700;
        color: #334155;
        margin: 0 0 0.5rem 0;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .timeline-legend-items {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .timeline-legend-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.6rem 1.25rem;
        background: #ffffff;
        border-radius: 50px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 2px solid #e2e8f0;
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease,
          border-color 0.2s ease;
      }

      .timeline-legend-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        border-color: currentColor;
      }

      .timeline-legend-dot {
        display: block;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        flex-shrink: 0;
        border: 3px solid white;
        box-shadow:
          0 0 0 2px currentColor,
          0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .timeline-legend-name {
        font-size: 0.95rem;
        font-weight: 600;
        color: #475569;
        white-space: nowrap;
      }

      /* === ESTILOS PARA CHECKBOXES DE LEYENDA === */
      .timeline-legend-item.with-checkbox {
        padding-left: 0.75rem;
        cursor: pointer;
        user-select: none;
      }

      .timeline-legend-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: currentColor;
        margin: 0;
        flex-shrink: 0;
        transition: transform 0.2s ease;
      }

      .timeline-legend-checkbox:hover {
        transform: scale(1.15);
      }

      .timeline-legend-checkbox:checked {
        filter: brightness(1.1);
      }

      /* Estado dimmed para leyenda desactivada */
      .timeline-legend-item.dimmed {
        opacity: 0.4;
        filter: grayscale(80%);
        transform: scale(0.95);
      }

      .timeline-legend-item.dimmed:hover {
        opacity: 0.6;
        transform: scale(0.98);
      }

      .timeline-legend-item.dimmed .timeline-legend-dot {
        box-shadow:
          0 0 0 2px #cbd5e1,
          0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .timeline-legend-item.dimmed .timeline-legend-name {
        text-decoration: line-through;
        color: #94a3b8;
      }
    </style>
    <style is:global>
      /* === TIMELINE ENTERPRISE REDESIGN (REFINED) === */
      .timeline-canvas-wrapper {
        position: relative;
        width: 100%;
        min-height: 550px;
        background: #f8fafc; /* Clean background */
        border-radius: 24px;
        overflow-x: hidden; /* Sin scroll horizontal - todo proporcional */
        overflow-y: hidden;
        border: 1px solid #e2e8f0;
        padding: 100px 40px; /* More vertical space */
        box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.02);
      }

      #timeline-canvas {
        position: absolute;
        top: 0;
        left: 0;
      }

      .timeline-axis {
        position: absolute;
        top: 50%;
        left: 2%; /* Porcentaje para responsividad */
        right: 5%; /* Más espacio para la flecha */
        height: 8px;
        background: linear-gradient(
          90deg,
          #cbd5e1 0%,
          #94a3b8 50%,
          #64748b 100%
        );
        border-radius: 4px;
        transform: translateY(-50%);
        z-index: 1;
        box-shadow:
          0 2px 8px rgba(0, 0, 0, 0.1),
          inset 0 1px 2px rgba(255, 255, 255, 0.1);
      }

      /* Flecha al final del eje - más visible */
      .timeline-axis::after {
        content: "";
        position: absolute;
        right: -25px; /* Más separada del final */
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-left: 25px solid #64748b; /* Más grande y color coherente */
        border-top: 15px solid transparent;
        border-bottom: 15px solid transparent; /* Simétrico */
        filter: drop-shadow(
          0 2px 4px rgba(0, 0, 0, 0.2)
        ); /* Sombra más sutil */
      }

      .timeline-events {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }

      .timeline-event {
        position: absolute;
        pointer-events: all;
        z-index: 10;
        transition: z-index 0s linear 0.3s;
      }

      .timeline-event:hover {
        z-index: 100;
        transition-delay: 0s;
      }

      /* Puntos sólidos con borde blanco */
      .timeline-dot {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background-color: #ffffff; /* Fondo blanco por defecto */
        border: 5px solid currentColor; /* Borde con color de la cancha */
        box-shadow:
          0 4px 12px rgba(0, 0, 0, 0.2),
          0 2px 6px rgba(0, 0, 0, 0.15);
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 20;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        cursor: pointer;
        /* Flexbox para centrar las iniciales */
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .timeline-event:hover .timeline-dot {
        transform: translate(-50%, -50%) scale(1.35);
        box-shadow:
          0 6px 20px rgba(0, 0, 0, 0.25),
          0 3px 10px rgba(0, 0, 0, 0.2);
        border-width: 6px;
      }

      .timeline-line {
        position: absolute;
        width: 4px !important;
        background: currentColor;
        opacity: 0; /* Ocultar por defecto */
        visibility: hidden; /* Ocultar por defecto */
        left: 50%;
        transform: translateX(-50%);
        z-index: 5;
        transition: all 0.3s ease;
        border-radius: 2px;
      }

      .timeline-event:hover .timeline-line {
        opacity: 0.95;
        visibility: visible;
        width: 5px !important;
      }

      .timeline-label {
        position: absolute;
        white-space: nowrap;
        font-size: 0.85rem;
        font-weight: 600;
        color: #334155;
        background: #ffffff;
        padding: 0.6rem 1.1rem;
        border-radius: 8px;
        box-shadow:
          0 4px 12px rgba(0, 0, 0, 0.1),
          0 2px 4px rgba(0, 0, 0, 0.06);
        border: 1.5px solid #e2e8f0;
        pointer-events: none;
        z-index: 30;
        left: 50%;
        transform: translateX(-50%);
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        letter-spacing: 0.01em;
        text-align: center;
        min-width: 100px;
        /* Ocultar por defecto */
        opacity: 0;
        visibility: hidden;
      }

      .timeline-event:hover .timeline-label {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(-4px);
        box-shadow:
          0 10px 25px rgba(0, 0, 0, 0.12),
          0 4px 8px rgba(0, 0, 0, 0.08);
        border-color: #cbd5e1;
        color: #0f172a;
        z-index: 101;
      }

      /* Date Markers - Ocultos por defecto, visibles en hover */
      .timeline-event-date {
        position: absolute;
        top: 50%;
        margin-top: 32px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.85rem;
        color: #1e293b;
        font-weight: 800;
        white-space: nowrap;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        z-index: 15;
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        padding: 0.4rem 0.7rem;
        border-radius: 6px;
        border: 2px solid #fbbf24;
        box-shadow:
          0 3px 10px rgba(251, 191, 36, 0.4),
          0 1px 3px rgba(0, 0, 0, 0.2);
        pointer-events: none;
        /* Ocultar por defecto */
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .timeline-event:hover .timeline-event-date {
        opacity: 1;
        visibility: visible;
        color: #0f172a;
        transform: translateX(-50%) scale(1.15);
        box-shadow:
          0 5px 15px rgba(251, 191, 36, 0.6),
          0 2px 5px rgba(0, 0, 0, 0.25);
        background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
      }

      /* === MARCADORES DE FECHA EN EL EJE === */
      .timeline-date-marker {
        position: absolute;
        top: 50%;
        transform: translateX(-50%) translateY(-50%);
        z-index: 1;
        pointer-events: none;
      }

      .timeline-date-marker-line {
        width: 1px;
        height: 50px;
        background: #cbd5e1;
        margin: 0 auto;
        margin-top: 5px;
        opacity: 0.4;
      }

      .timeline-date-marker-label {
        font-size: 11px;
        font-weight: 600;
        color: #64748b;
        text-align: center;
        white-space: nowrap;
        background: transparent;
        padding: 4px 10px;
        border-radius: 4px;
      }

      /* === ESTILOS PARA EVENTOS OCULTOS (GLOBAL) === */
      .timeline-event.hidden {
        opacity: 0 !important;
        pointer-events: none !important;
        transform: scale(0.8) !important;
        transition: all 0.3s ease !important;
      }

      .timeline-event.hidden .timeline-dot,
      .timeline-event.hidden .timeline-line,
      .timeline-event.hidden .timeline-label,
      .timeline-event.hidden .timeline-event-date {
        opacity: 0 !important;
        visibility: hidden !important;
      }

      /* === ESTILOS PARA MODAL DE REVANCHAS === */
      .modal-large {
        max-width: 1200px !important;
      }

      .tabla-revanchas {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
        background: white;
      }

      .tabla-revanchas thead {
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .tabla-revanchas th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.75rem 0.5rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.8rem;
        white-space: nowrap;
      }

      .tabla-revanchas td {
        padding: 0.6rem 0.5rem;
        border-bottom: 1px solid #e2e8f0;
        color: #334155;
      }

      .tabla-revanchas tbody tr:hover {
        background: #f8fafc;
      }

      .tabla-revanchas .sector-col {
        font-weight: 700;
        color: #1e293b;
      }

      /* Colores por sector */
      .tabla-revanchas tr.sector-1 {
        border-left: 4px solid #ef4444;
      }
      .tabla-revanchas tr.sector-2 {
        border-left: 4px solid #f97316;
      }
      .tabla-revanchas tr.sector-3 {
        border-left: 4px solid #f59e0b;
      }
      .tabla-revanchas tr.sector-4 {
        border-left: 4px solid #84cc16;
      }
      .tabla-revanchas tr.sector-5 {
        border-left: 4px solid #10b981;
      }
      .tabla-revanchas tr.sector-6 {
        border-left: 4px solid #06b6d4;
      }
      .tabla-revanchas tr.sector-7 {
        border-left: 4px solid #3b82f6;
      }

      .mensaje-error {
        background: #fee2e2;
        border-left: 4px solid #ef4444;
        color: #991b1b;
      }

      .mensaje-exito {
        background: #d1fae5;
        border-left: 4px solid #10b981;
        color: #065f46;
      }

      .mensaje-info {
        background: #dbeafe;
        border-left: 4px solid #3b82f6;
        color: #1e40af;
      }

      /* === CONTENEDOR CON SCROLL SOLO PARA TABLA PRINCIPAL === */
      .tabla-datos-scroll {
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .tabla-datos-scroll::-webkit-scrollbar {
        width: 8px;
      }

      .tabla-datos-scroll::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
      }

      .tabla-datos-scroll::-webkit-scrollbar-thumb {
        background: #94a3b8;
        border-radius: 4px;
      }

      .tabla-datos-scroll::-webkit-scrollbar-thumb:hover {
        background: #64748b;
      }

      /* === COLORES CONDICIONALES PARA VALORES === */
      .valor-verde {
        background-color: #d1fae5 !important;
        color: #065f46 !important;
        font-weight: 600;
      }

      .valor-amarillo {
        background-color: #fef3c7 !important;
        color: #92400e !important;
        font-weight: 600;
      }

      .valor-rojo {
        background-color: #fee2e2 !important;
        color: #991b1b !important;
        font-weight: 600;
      }

      /* === TABLA DE RESUMEN ESTADÍSTICO === */
      .tabla-resumen {
        width: 100%;
        border-collapse: collapse;
        margin-top: 2rem;
        background: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
      }

      .tabla-resumen thead {
        background: linear-gradient(135deg, #1e3a8a, #3b82f6);
      }

      .tabla-resumen thead th {
        color: white;
        padding: 1rem;
        text-align: center;
        font-weight: 700;
        font-size: 1.1rem;
        letter-spacing: 0.05em;
      }

      .tabla-resumen thead th:first-child {
        text-align: left;
        padding-left: 1.5rem;
      }

      .tabla-resumen tbody tr {
        border-bottom: 1px solid #e2e8f0;
        transition: background 0.2s;
      }

      .tabla-resumen tbody tr:hover {
        background: #f8fafc;
      }

      .tabla-resumen tbody td {
        padding: 0.875rem 1rem;
        text-align: center;
        color: #475569;
        font-size: 0.95rem;
      }

      .tabla-resumen tbody td:first-child {
        text-align: left;
        font-weight: 600;
        color: #1e293b;
        padding-left: 1.5rem;
        background: #f1f5f9;
      }

      /* === TABLA DE RESUMEN POR SECTOR === */
      .tabla-resumen-sectores {
        width: 100%;
        border-collapse: collapse;
        margin-top: 2rem;
        background: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
      }

      .tabla-resumen-sectores thead {
        background: linear-gradient(135deg, #7c3aed, #a78bfa);
      }

      .tabla-resumen-sectores thead th {
        color: white;
        padding: 1rem;
        text-align: center;
        font-weight: 700;
        font-size: 1.05rem;
        letter-spacing: 0.05em;
      }

      .tabla-resumen-sectores thead th:first-child {
        text-align: left;
        padding-left: 1.5rem;
      }

      .tabla-resumen-sectores tbody tr {
        border-bottom: 1px solid #e2e8f0;
        transition: background 0.2s;
      }

      .tabla-resumen-sectores tbody tr:hover {
        background: #faf5ff;
      }

      .tabla-resumen-sectores tbody td {
        padding: 0.875rem 1rem;
        text-align: center;
        color: #475569;
        font-size: 0.95rem;
      }

      .tabla-resumen-sectores tbody td:first-child {
        text-align: left;
        font-weight: 700;
        color: #7c3aed;
        padding-left: 1.5rem;
        background: #faf5ff;
        font-size: 1rem;
      }

      .tabla-resumen-sectores .parametro-label {
        font-weight: 600;
        color: #64748b;
        padding-left: 2.5rem !important;
        font-size: 0.9rem;
      }

      /* === CONTENEDOR DE GRÁFICO DE PERFIL === */
      .perfil-chart-container {
        width: 100%;
        margin-top: 2rem;
        padding: 1.5rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .perfil-chart-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 1rem;
        text-align: center;
        background: linear-gradient(135deg, #0f766e, #14b8a6);
        color: white;
        padding: 0.75rem;
        border-radius: 6px;
      }

      .perfil-chart-canvas {
        position: relative;
        height: 400px;
        width: 100%;
      }
      /* === ESTILOS PARA FORMULARIO DE SUBIR CANCHAS === */
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      .form-group label {
        font-weight: 600;
        color: #1e293b;
        font-size: 0.95rem;
      }

      .form-group input,
      .form-group select {
        padding: 0.75rem;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: all 0.2s;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .form-group input:disabled,
      .form-group select:disabled {
        background: #f1f5f9;
        cursor: not-allowed;
        opacity: 0.6;
      }

      .form-group small {
        color: #64748b;
        font-size: 0.85rem;
      }

      .form-group input[type="file"] {
        padding: 0.5rem;
        cursor: pointer;
      }

      #preview-foto-cancha,
      #preview-foto-muestra {
        border: 2px dashed #cbd5e1;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        background: #f8fafc;
      }

      /* === ESTILOS PARA PANTALLA DE SELECCIÓN === */
      .seleccion-container {
        padding: 2rem 0;
      }

      .tipo-opciones {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        max-width: 800px;
        margin: 0 auto;
      }

      .tipo-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 2px solid #e2e8f0;
        border-radius: 16px;
        padding: 2.5rem 2rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .tipo-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 0;
      }

      .tipo-card:hover {
        transform: translateY(-8px);
        border-color: #3b82f6;
        box-shadow: 0 20px 40px rgba(59, 130, 246, 0.2);
      }

      .tipo-card:hover::before {
        opacity: 0.05;
      }

      .tipo-card:active {
        transform: translateY(-4px);
      }

      .tipo-card > * {
        position: relative;
        z-index: 1;
      }

      .tipo-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
      }

      .tipo-card h3 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        margin: 1rem 0 0.75rem 0;
        letter-spacing: 0.5px;
      }

      .tipo-card p {
        color: #64748b;
        font-size: 0.95rem;
        line-height: 1.5;
        margin: 0 0 1.5rem 0;
        min-height: 3rem;
      }

      .tipo-badge {
        display: inline-block;
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        padding: 0.4rem 1rem;
        border-radius: 50px;
        font-size: 0.85rem;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      /* === BOTÓN VOLVER === */
      .btn-volver {
        background: #f1f5f9;
        color: #475569;
        border: 1px solid #cbd5e1;
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 1.5rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-volver:hover {
        background: #e2e8f0;
        border-color: #94a3b8;
        color: #334155;
        transform: translateX(-2px);
      }

      .btn-volver:active {
        transform: translateX(0);
      }

      /* Responsive para móviles */
      @media (max-width: 768px) {
        .tipo-opciones {
          grid-template-columns: 1fr;
          gap: 1.5rem;
        }

        .tipo-card {
          padding: 2rem 1.5rem;
        }

        .tipo-icon {
          font-size: 3rem;
        }
      }
    </style>

    <!-- SheetJS library para procesar archivos Excel/CSV -->
    <script
      src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"
    ></script>
  </head>
  <body>
    <div class="header">
      <!-- Logos de empresas (comentado temporalmente) -->
      <!--
      <div class="logos-container">
        <img title="Besalco" width="280" height="60" src="/Besalco.png" alt="Besalco" class="company-logo">
        <img title="Linkapsis" width="280" height="60" src="/Linkapsis.png" alt="Linkapsis" class="company-logo">
        <img title="AngloAmerican" width="280" height="60" src="/AngloAmerican.png" alt="AngloAmerican" class="company-logo">
        <img title="LlayLlay" width="80" height="80" src="/LlayLlay.png" alt="LlayLlay" class="company-logo">
      </div>
      -->

      <canvas id="particles-canvas"></canvas>
      <h1>Gestión de Canchas AngloAmerican - Las Tórtolas</h1>
    </div>

    <div class="container">
      <div id="mensaje-container"></div>

      <!-- Pantalla Principal -->
      <div id="main-screen">
        <!-- Header de usuario logueado -->
        <div class="empresa-header" id="user-header">
          <div class="empresa-info">
            <span class="empresa-nombre" id="user-name"
              >Cargando usuario...</span
            >
            <span class="empresa-rol" id="user-role"
              >Verificando permisos...</span
            >
          </div>
          <div class="header-buttons">
            <div id="user-company" class="empresa-actual">
              <img
                id="user-company-logo"
                src=""
                alt="Logo Empresa"
                style="display: none;"
              />
            </div>
            <button
              id="btn-abrir-modal-crear"
              type="button"
              class="header-btn header-btn-create"
              style="display: none;">🏗️ Crear Cancha</button
            >
            <a
              id="btn-admin-usuarios"
              href="/admin/usuarios"
              class="header-btn header-btn-admin"
              style="display: none;">👥 Gestión Usuarios</a
            >
            <!-- === BOTONES ESPECIALES PARA LINKAPSIS === -->
            <!-- 
              Estos botones solo se muestran cuando el usuario logueado es de Linkapsis.
              Permiten funcionalidades especiales de carga de datos:
              - Subir Revanchas: Modal para cargar información de revanchas
              - Subir Canchas: Modal para cargar información masiva de canchas
            -->
            <button
              id="btn-subir-revanchas"
              type="button"
              class="header-btn header-btn-linkapsis"
              style="display: none;">📤 Subir Revanchas</button
            >
            <button
              id="btn-subir-canchas"
              type="button"
              class="header-btn header-btn-linkapsis"
              style="display: none;">📁 Subir Canchas</button
            >
            <button
              id="btn-logout"
              type="button"
              class="header-btn header-btn-logout">Cerrar Sesión</button
            >
          </div>
        </div>

        <!-- Controles y Filtros -->
        <div class="controls">
          <!-- Filtros -->

          <!-- Filtros -->
          <div class="filtros-container">
            <h3>Filtros</h3>
            <!-- Layout principal con controles a la izquierda y stats a la derecha -->
            <div class="filtros-main-layout">
              <!-- Controles de filtros -->
              <div class="filtros-controls">
                <div class="filtros-row">
                  <div class="filtro-group">
                    <label>Vista:</label>
                    <div class="toggle-container">
                      <div class="toggle-slider"></div>
                      <button id="btn-vista-acciones" class="toggle-btn active"
                        >Mis Acciones</button
                      >
                      <button id="btn-vista-historico" class="toggle-btn"
                        >Ver Histórico</button
                      >
                    </div>
                  </div>

                  <div class="filtro-group">
                    <label for="filtro-fecha">Filtro de Fecha:</label>
                    <select id="filtro-fecha">
                      <option value="all">Todas las fechas</option>
                      <option value="today">Hoy</option>
                      <option value="week">Última semana</option>
                      <option value="month">Último mes</option>
                      <option value="custom">Rango personalizado</option>
                    </select>
                  </div>

                  <div
                    id="rango-fechas"
                    class="filtro-group rango-fechas hidden"
                  >
                    <label>Desde:</label>
                    <input type="date" id="fecha-desde" />
                    <label>Hasta:</label>
                    <input type="date" id="fecha-hasta" />
                    <button id="btn-aplicar-rango" type="button">Aplicar</button
                    >
                  </div>
                </div>
              </div>

              <!-- Dashboard de Estadísticas en sidebar -->
              <div class="stats-sidebar">
                <div class="stat-card stat-primary">
                  <div class="stat-icon">⚙️</div>
                  <div class="stat-number" id="stat-acciones">-</div>
                  <div class="stat-label">Acciones Disponibles</div>
                </div>

                <div class="stat-card stat-info">
                  <div class="stat-icon">📋</div>
                  <div class="stat-number" id="stat-total">-</div>
                  <div class="stat-label">Total de Canchas</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tabla de canchas -->
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th style="width: 50px;">
                  <input
                    type="checkbox"
                    id="select-all-checkbox"
                    title="Seleccionar todas"
                  />
                </th>
                <th>Nombre de Cancha</th>
                <th>Estado Actual</th>
                <th>Empresa Actual</th>
                <th>Fecha Creación</th>
                <th>Mapa</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="canchas-tbody">
              <!-- Las canchas se cargarán dinámicamente -->
            </tbody>
          </table>

          <!-- Controles de paginación -->
          <div class="pagination-container">
            <div class="pagination-info">
              Mostrando <span id="pagination-start">0</span> - <span
                id="pagination-end">0</span
              > de <span id="pagination-total">0</span> canchas
            </div>
            <div class="pagination-controls">
              <button
                id="btn-primera-pagina"
                class="pagination-btn"
                title="Primera página">&laquo;</button
              >
              <button
                id="btn-pagina-anterior"
                class="pagination-btn"
                title="Página anterior">&lsaquo;</button
              >
              <span class="pagination-current">
                Página <span id="pagina-actual">1</span> de <span
                  id="total-paginas">1</span
                >
              </span>
              <button
                id="btn-pagina-siguiente"
                class="pagination-btn"
                title="Página siguiente">&rsaquo;</button
              >
              <button
                id="btn-ultima-pagina"
                class="pagination-btn"
                title="Última página">&raquo;</button
              >
            </div>
          </div>
        </div>
      </div>

      <!-- === BOTÓN FLOTANTE DE ACCIONES MASIVAS === -->
      <div id="bulk-actions-bar" class="bulk-actions-bar hidden">
        <div class="bulk-actions-content">
          <span id="selected-count" class="selected-count"
            >0 canchas seleccionadas</span
          >
          <div class="bulk-actions-buttons">
            <button
              id="btn-bulk-timeline"
              class="btn-bulk-action btn-bulk-timeline"
              title="Ver timeline de canchas seleccionadas"
            >
              📊 Ver Timeline
            </button>
            <button
              id="btn-bulk-delete"
              class="btn-bulk-action btn-bulk-delete hidden"
              title="Borrar canchas seleccionadas"
            >
              🗑️ Borrar Seleccionadas
            </button>
            <!-- Espacio para futuros botones de acciones masivas -->
          </div>
          <button
            id="btn-clear-selection"
            class="btn-clear-selection"
            title="Limpiar selección"
          >
            ✖ Limpiar
          </button>
        </div>
      </div>

      <!-- === DASHBOARD DE ESTADOS === -->
      <div class="dashboard-estados-section">
        <div class="dashboard-estados-header">
          <h3 class="dashboard-estados-title">📊 Estados de Canchas</h3>
        </div>
        <div class="dashboard-estados">
          <div class="estado-widget" data-estado="creada">
            <div class="widget-circle widget-creada">
              <span class="widget-number" id="count-creada">0</span>
            </div>
            <div class="widget-label">Creada</div>
          </div>

          <div class="estado-widget" data-estado="en-espera">
            <div class="widget-circle widget-en-espera">
              <span class="widget-number" id="count-en-espera">0</span>
            </div>
            <div class="widget-label">En Espera</div>
          </div>

          <div class="estado-widget" data-estado="en-proceso">
            <div class="widget-circle widget-en-proceso">
              <span class="widget-number" id="count-en-proceso">0</span>
            </div>
            <div class="widget-label">En Proceso</div>
          </div>

          <div class="estado-widget" data-estado="validada">
            <div class="widget-circle widget-validada">
              <span class="widget-number" id="count-validada">0</span>
            </div>
            <div class="widget-label">Validada</div>
          </div>

          <div class="estado-widget" data-estado="rechazada-en-espera">
            <div class="widget-circle widget-rechazada-en-espera">
              <span class="widget-number" id="count-rechazada-en-espera">0</span
              >
            </div>
            <div class="widget-label">Rechazada, en Espera</div>
          </div>

          <div class="estado-widget" data-estado="cerrada">
            <div class="widget-circle widget-cerrada">
              <span class="widget-number" id="count-cerrada">0</span>
            </div>
            <div class="widget-label">Cerrada</div>
          </div>
        </div>
      </div>

      <!-- === MAPA DASHBOARD === -->
      <div class="dashboard-map-section">
        <div class="dashboard-map-header">
          <div class="map-header-left">
            <h3 class="dashboard-map-title">🗺️ Vista de Mapa</h3>
            <p class="dashboard-map-subtitle" id="map-subtitle">
              Mostrando todas las canchas
            </p>
          </div>
          <div class="map-header-controls">
            <!-- Filtro de Muros -->
            <div class="map-filter-group">
              <label for="map-muro-filter" class="filter-label">Muro:</label>
              <select id="map-muro-filter" class="map-filter-select">
                <option value="">Todos</option>
                <option value="Principal">Principal</option>
                <option value="Este">Este</option>
                <option value="Oeste">Oeste</option>
              </select>
            </div>

            <!-- Toggle Revanchas -->
            <div class="map-toggle-group">
              <label class="toggle-switch">
                <input type="checkbox" id="toggle-revanchas" />
                <span class="toggle-slider-round"></span>
              </label>
              <span class="toggle-label">Revanchas</span>
            </div>
          </div>
        </div>
        <div class="dashboard-map-container" id="dashboard-map-container">
          <div class="dashboard-map-loading">Cargando mapa...</div>
        </div>
      </div>

      <!-- Modal para validación de Linkapsis (Espesores) -->
      <div id="validacion-linkapsis-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">Validación de Espesores - Linkapsis</h3>
            <button class="close-btn">×</button>
          </div>

          <!-- Historial de observaciones anteriores -->
          <div id="historial-linkapsis" class="historial-observaciones">
            <h4>Observaciones del Proceso:</h4>
            <div class="historial-content">
              <p>Cargando historial...</p>
            </div>
          </div>

          <form id="form-validacion-linkapsis">
            <div class="form-group">
              <label for="linkapsis-observaciones">Observaciones:</label>
              <textarea
                id="linkapsis-observaciones"
                placeholder="Ingresa observaciones sobre la validación..."
                required></textarea>
            </div>

            <div class="form-group">
              <label for="linkapsis-espesor"
                >Medición de Espesor (metros):</label
              >
              <input
                type="number"
                id="linkapsis-espesor"
                placeholder="Ej: 0.03"
                min="0"
                step="0.001"
                required
              />
              <small>Ingresa la medición en metros (ej: 0.03)</small>
            </div>

            <!-- Tipo de Trabajo -->
            <div class="form-group">
              <label>Tipo de Trabajo:</label>
              <div class="checkbox-group">
                <label class="checkbox-item">
                  <input
                    type="checkbox"
                    id="trabajo-corte"
                    name="tipo-trabajo"
                    value="corte"
                  />
                  <span>Corte</span>
                </label>
                <label class="checkbox-item">
                  <input
                    type="checkbox"
                    id="trabajo-relleno"
                    name="tipo-trabajo"
                    value="relleno"
                  />
                  <span>Relleno</span>
                </label>
              </div>
            </div>

            <!-- Coordenadas de Puntos -->
            <div class="form-group">
              <label>Coordenadas de Puntos:</label>
              <div class="coordenadas-grid">
                <!-- Punto 1 -->
                <div class="punto-section">
                  <h5>Punto 1</h5>
                  <div class="coordenadas-row">
                    <div class="coord-field">
                      <label for="p1-norte">Norte:</label>
                      <input
                        type="number"
                        id="p1-norte"
                        placeholder="Norte P1"
                        step="0.001"
                      />
                    </div>
                    <div class="coord-field">
                      <label for="p1-este">Este:</label>
                      <input
                        type="number"
                        id="p1-este"
                        placeholder="Este P1"
                        step="0.001"
                      />
                    </div>
                    <div class="coord-field">
                      <label for="p1-cota">Cota:</label>
                      <input
                        type="number"
                        id="p1-cota"
                        placeholder="Cota P1"
                        step="0.001"
                      />
                    </div>
                  </div>
                </div>

                <!-- Punto 2 -->
                <div class="punto-section">
                  <h5>Punto 2</h5>
                  <div class="coordenadas-row">
                    <div class="coord-field">
                      <label for="p2-norte">Norte:</label>
                      <input
                        type="number"
                        id="p2-norte"
                        placeholder="Norte P2"
                        step="0.001"
                      />
                    </div>
                    <div class="coord-field">
                      <label for="p2-este">Este:</label>
                      <input
                        type="number"
                        id="p2-este"
                        placeholder="Este P2"
                        step="0.001"
                      />
                    </div>
                    <div class="coord-field">
                      <label for="p2-cota">Cota:</label>
                      <input
                        type="number"
                        id="p2-cota"
                        placeholder="Cota P2"
                        step="0.001"
                      />
                    </div>
                  </div>
                </div>

                <!-- Punto 3 -->
                <div class="punto-section">
                  <h5>Punto 3</h5>
                  <div class="coordenadas-row">
                    <div class="coord-field">
                      <label for="p3-norte">Norte:</label>
                      <input
                        type="number"
                        id="p3-norte"
                        placeholder="Norte P3"
                        step="0.001"
                      />
                    </div>
                    <div class="coord-field">
                      <label for="p3-este">Este:</label>
                      <input
                        type="number"
                        id="p3-este"
                        placeholder="Este P3"
                        step="0.001"
                      />
                    </div>
                    <div class="coord-field">
                      <label for="p3-cota">Cota:</label>
                      <input
                        type="number"
                        id="p3-cota"
                        placeholder="Cota P3"
                        step="0.001"
                      />
                    </div>
                  </div>
                </div>

                <!-- Punto 4 -->
                <div class="punto-section">
                  <h5>Punto 4</h5>
                  <div class="coordenadas-row">
                    <div class="coord-field">
                      <label for="p4-norte">Norte:</label>
                      <input
                        type="number"
                        id="p4-norte"
                        placeholder="Norte P4"
                        step="0.001"
                      />
                    </div>
                    <div class="coord-field">
                      <label for="p4-este">Este:</label>
                      <input
                        type="number"
                        id="p4-este"
                        placeholder="Este P4"
                        step="0.001"
                      />
                    </div>
                    <div class="coord-field">
                      <label for="p4-cota">Cota:</label>
                      <input
                        type="number"
                        id="p4-cota"
                        placeholder="Cota P4"
                        step="0.001"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn-cancel">Cancelar</button>
              <button type="submit" class="btn-validar"
                >Validar Espesores</button
              >
              <button type="button" class="btn-rechazar">Rechazar</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Modal para validación de LlayLlay (Densidad) -->
      <!-- Modal de RECEPCIÓN de trabajo para Besalco -->
      <div id="recepcion-besalco-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">📋 Recepción de Trabajo - Besalco</h3>
            <button class="close-btn">×</button>
          </div>

          <!-- Historial de observaciones (solo lectura) -->
          <div id="historial-recepcion-besalco" class="historial-observaciones">
            <h4>Observaciones del Proceso:</h4>
            <div class="historial-content">
              <p>Cargando historial...</p>
            </div>
          </div>

          <div
            style="padding: 1rem; background: #e8f4f8; border-left: 4px solid #3498db; border-radius: 4px; margin: 1rem 0;"
          >
            <p style="margin: 0; color: #2c3e50;">
              <strong>Modo Recepción:</strong> Revise el trabajo anterior y presione
              "Comenzar Trabajo" para iniciar la validación.
            </p>
          </div>

          <div class="form-actions" style="justify-content: center;">
            <button type="button" class="btn-cancel">Cancelar</button>
            <button type="button" class="btn-comenzar" id="btn-comenzar-besalco"
              >🚀 Comenzar Trabajo</button
            >
          </div>
        </div>
      </div>

      <!-- Modal de RECEPCIÓN de trabajo para Linkapsis -->
      <div id="recepcion-linkapsis-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">📋 Recepción de Trabajo - Linkapsis</h3>
            <button class="close-btn">×</button>
          </div>

          <!-- Historial de observaciones (solo lectura) -->
          <div
            id="historial-recepcion-linkapsis"
            class="historial-observaciones"
          >
            <h4>Observaciones del Proceso:</h4>
            <div class="historial-content">
              <p>Cargando historial...</p>
            </div>
          </div>

          <div
            style="padding: 1rem; background: #e8f4f8; border-left: 4px solid #3498db; border-radius: 4px; margin: 1rem 0;"
          >
            <p style="margin: 0; color: #2c3e50;">
              <strong>Modo Recepción:</strong> Revise el trabajo anterior y presione
              "Comenzar Trabajo" para iniciar la validación de espesores.
            </p>
          </div>

          <div class="form-actions" style="justify-content: center;">
            <button type="button" class="btn-cancel">Cancelar</button>
            <button
              type="button"
              class="btn-comenzar"
              id="btn-comenzar-linkapsis">🚀 Comenzar Trabajo</button
            >
          </div>
        </div>
      </div>

      <!-- ========================================== -->
      <!-- MODALES ESPECIALES PARA LINKAPSIS          -->
      <!-- ========================================== -->
      <!-- 
        Estos modales están preparados para funcionalidades especiales de Linkapsis:
        1. Modal Subir Revanchas: Para cargar información de revanchas
        2. Modal Subir Canchas: Para carga masiva de canchas
        
        ESTADO ACTUAL: Estructura base creada, lista para desarrollo
        TODO: Implementar formularios y lógica de procesamiento de datos
      -->

      <!-- Modal para Subir Revanchas (Linkapsis) -->
      <div id="modal-subir-revanchas" class="modal">
        <div class="modal-content modal-large">
          <div class="modal-header">
            <h3 class="modal-title">📤 Subir Revanchas - Linkapsis</h3>
            <button class="close-btn">×</button>
          </div>

          <div class="modal-body">
            <!-- Selector de Tipo de Muro -->
            <div class="form-group">
              <label for="tipo-muro-revanchas">
                <strong>Tipo de Muro:</strong>
              </label>
              <select id="tipo-muro-revanchas" class="form-select">
                <option value="">Seleccione un muro...</option>
                <option value="principal">Muro Principal</option>
                <option value="oeste">Muro Oeste</option>
                <option value="este">Muro Este</option>
              </select>
              <small
                style="color: #64748b; display: block; margin-top: 0.5rem;"
              >
                Seleccione el tipo de muro antes de cargar el archivo
              </small>
            </div>

            <!-- Selector de Archivo -->
            <div class="form-group">
              <label for="file-revanchas">
                <strong>Archivo de Revanchas:</strong>
              </label>
              <input
                type="file"
                id="file-revanchas"
                accept=".csv,.xlsx,.xls"
                disabled
                style="padding: 0.75rem; border: 2px dashed #cbd5e1; border-radius: 8px; background: #f8fafc; cursor: pointer;"
              />
              <small
                style="color: #64748b; display: block; margin-top: 0.5rem;"
              >
                Formatos soportados: CSV, XLSX, XLS
              </small>
            </div>

            <!-- Mensajes de Error/Info -->
            <div
              id="mensaje-revanchas"
              style="display:none; padding: 1rem; border-radius: 8px; margin: 1rem 0;"
            >
            </div>

            <!-- Área de Preview -->
            <div
              id="preview-revanchas"
              style="display:none; margin-top: 1.5rem;"
            >
              <h4
                style="color: #1e293b; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;"
              >
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M9 11l3 3L22 4"></path>
                  <path
                    d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"
                  ></path>
                </svg>
                Vista Previa de Datos
              </h4>
              <div
                id="info-archivo-revanchas"
                style="background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;"
              >
              </div>
              <div
                id="tabla-revanchas"
                style="overflow-x: auto; max-height: 500px; border: 1px solid #e2e8f0; border-radius: 8px;"
              >
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel">Cancelar</button>
            <button
              type="button"
              id="btn-procesar-revanchas"
              class="btn-primary"
              disabled
              style="opacity: 0.5;"
            >
              Procesar Datos
            </button>
          </div>
        </div>
      </div>

      <!-- Modal para Subir Canchas (Linkapsis) - Mejorado con Selección -->
      <div id="modal-subir-canchas" class="modal">
        <div class="modal-content modal-large">
          <div class="modal-header">
            <h3 class="modal-title">📁 Subir Canchas - Linkapsis</h3>
            <button class="close-btn">×</button>
          </div>

          <div class="modal-body">
            <!-- PASO 1: Pantalla de Selección -->
            <div id="seleccion-tipo" class="seleccion-container">
              <h2
                style="text-align: center; color: #2c3e50; margin-bottom: 2rem;"
              >
                ¿Qué deseas subir?
              </h2>

              <div class="tipo-opciones">
                <button type="button" class="tipo-card" data-tipo="cancha">
                  <div class="tipo-icon">🏗️</div>
                  <h3>CANCHA</h3>
                </button>

                <button type="button" class="tipo-card" data-tipo="muestra">
                  <div class="tipo-icon">🧪</div>
                  <h3>MUESTRAS</h3>
                </button>
              </div>
            </div>

            <!-- PASO 2A: Formulario CANCHA (existente) -->
            <div id="formulario-cancha" style="display: none;">
              <button type="button" class="btn-volver"
                >← Volver a selección</button
              >

              <h3
                style="color: #2c3e50; margin: 1.5rem 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;"
              >
                <span>🏗️</span> Formulario de Cancha
              </h3>

              <form id="form-subir-canchas">
                <!-- Fila 1: Muro y Sector -->
                <div class="form-row">
                  <div class="form-group">
                    <label for="muro-cancha">
                      <strong>Muro *</strong>
                    </label>
                    <select id="muro-cancha" required>
                      <option value="">Seleccione...</option>
                      <option value="Principal">Principal</option>
                      <option value="Este">Este</option>
                      <option value="Oeste">Oeste</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label for="sector-cancha">
                      <strong>Sector *</strong>
                    </label>
                    <select id="sector-cancha" disabled required>
                      <option value="">Seleccione muro primero...</option>
                    </select>
                  </div>
                </div>

                <!-- Fila 2: Relleno y Fecha -->
                <div class="form-row">
                  <div class="form-group">
                    <label for="relleno-cancha">
                      <strong>Relleno *</strong>
                    </label>
                    <input
                      type="text"
                      id="relleno-cancha"
                      placeholder="Ingrese nombre del relleno"
                      required
                    />
                  </div>

                  <div class="form-group">
                    <label for="fecha-cancha">
                      <strong>Fecha *</strong>
                    </label>
                    <input type="date" id="fecha-cancha" required />
                  </div>
                </div>

                <!-- Fila 3: Foto -->
                <div class="form-group">
                  <label for="foto-cancha">
                    <strong>Foto</strong>
                  </label>
                  <input type="file" id="foto-cancha" accept="image/*" />
                  <small style="color: #64748b;"
                    >Formatos: JPG, PNG (máx. 5MB)</small
                  >
                  <div
                    id="preview-foto-cancha"
                    style="display:none; margin-top: 1rem;"
                  >
                    <img
                      id="img-preview-cancha"
                      style="max-width: 200px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"
                      alt="Preview"
                    />
                  </div>
                </div>

                <!-- Fila 4: Archivo -->
                <div class="form-group">
                  <label for="archivo-cancha">
                    <strong>Archivo *</strong>
                  </label>
                  <input
                    type="file"
                    id="archivo-cancha"
                    accept=".csv,.xlsx,.asc"
                    required
                  />
                  <small style="color: #64748b;">Formatos: CSV, XLSX, ASC</small
                  >
                </div>

                <!-- Fila 5: Responsable y Método -->
                <div class="form-row">
                  <div class="form-group">
                    <label for="responsable-cancha">
                      <strong>Responsable *</strong>
                    </label>
                    <select id="responsable-cancha" required>
                      <option value="">Cargando...</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label for="metodo-cancha">
                      <strong>Método *</strong>
                    </label>
                    <select id="metodo-cancha" required>
                      <option value="">Seleccione...</option>
                      <option value="Movimiento de Tierra"
                        >Movimiento de Tierra</option
                      >
                      <option value="Hidraulico">Hidráulico</option>
                    </select>
                  </div>
                </div>

                <!-- Fila 6: N° Capas -->
                <div class="form-group">
                  <label for="capas-cancha">
                    <strong>N° Capas *</strong>
                  </label>
                  <select id="capas-cancha" required>
                    <option value="">Seleccione...</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                  </select>
                </div>

                <div class="form-actions">
                  <button type="button" class="btn-cancel">Cancelar</button>
                  <button type="submit" class="btn-primary">
                    Guardar Cancha
                  </button>
                </div>
              </form>
            </div>

            <!-- PASO 2B: Formulario MUESTRAS (nuevo) -->
            <div id="formulario-muestra" style="display: none;">
              <button type="button" class="btn-volver"
                >← Volver a selección</button
              >

              <h3
                style="color: #2c3e50; margin: 1.5rem 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;"
              >
                <span>🧪</span> Formulario de Muestras
              </h3>

              <form id="form-subir-muestras">
                <!-- Fila 1: Muro y Sector -->
                <div class="form-row">
                  <div class="form-group">
                    <label for="muro-muestra">
                      <strong>Muro *</strong>
                    </label>
                    <select id="muro-muestra" required>
                      <option value="">Seleccione...</option>
                      <option value="Principal">Principal</option>
                      <option value="Este">Este</option>
                      <option value="Oeste">Oeste</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label for="sector-muestra">
                      <strong>Sector *</strong>
                    </label>
                    <select id="sector-muestra" disabled required>
                      <option value="">Seleccione muro primero...</option>
                    </select>
                  </div>
                </div>

                <!-- Fila 2: Relleno y Fecha -->
                <div class="form-row">
                  <div class="form-group">
                    <label for="relleno-muestra">
                      <strong>Relleno *</strong>
                    </label>
                    <input
                      type="text"
                      id="relleno-muestra"
                      placeholder="Ingrese nombre del relleno"
                      required
                    />
                  </div>

                  <div class="form-group">
                    <label for="fecha-muestra">
                      <strong>Fecha *</strong>
                    </label>
                    <input type="date" id="fecha-muestra" required />
                  </div>
                </div>

                <!-- Fila 3: Foto -->
                <div class="form-group">
                  <label for="foto-muestra">
                    <strong>Foto</strong>
                  </label>
                  <input type="file" id="foto-muestra" accept="image/*" />
                  <small style="color: #64748b;"
                    >Formatos: JPG, PNG (máx. 5MB)</small
                  >
                  <div
                    id="preview-foto-muestra"
                    style="display:none; margin-top: 1rem;"
                  >
                    <img
                      id="img-preview-muestra"
                      style="max-width: 200px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"
                      alt="Preview"
                    />
                  </div>
                </div>

                <!-- Fila 4: Archivo -->
                <div class="form-group">
                  <label for="archivo-muestra">
                    <strong>Archivo *</strong>
                  </label>
                  <input
                    type="file"
                    id="archivo-muestra"
                    accept=".csv,.xlsx,.asc"
                    required
                  />
                  <small style="color: #64748b;">Formatos: CSV, XLSX, ASC</small
                  >
                </div>

                <div class="form-actions">
                  <button type="button" class="btn-cancel">Cancelar</button>
                  <button type="submit" class="btn-primary">
                    Guardar Muestra
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal de RECEPCIÓN de trabajo para LlayLlay -->
      <div id="recepcion-llayllay-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">📋 Recepción de Trabajo - LlayLlay</h3>
            <button class="close-btn">×</button>
          </div>

          <!-- Historial de observaciones (solo lectura) -->
          <div
            id="historial-recepcion-llayllay"
            class="historial-observaciones"
          >
            <h4>Observaciones del Proceso:</h4>
            <div class="historial-content">
              <p>Cargando historial...</p>
            </div>
          </div>

          <div
            style="padding: 1rem; background: #e8f4f8; border-left: 4px solid #3498db; border-radius: 4px; margin: 1rem 0;"
          >
            <p style="margin: 0; color: #2c3e50;">
              <strong>Modo Recepción:</strong> Revise el trabajo anterior y presione
              "Comenzar Trabajo" para iniciar la validación de densidad.
            </p>
          </div>

          <div class="form-actions" style="justify-content: center;">
            <button type="button" class="btn-cancel">Cancelar</button>
            <button
              type="button"
              class="btn-comenzar"
              id="btn-comenzar-llayllay">🚀 Comenzar Trabajo</button
            >
          </div>
        </div>
      </div>

      <!-- Modal de VALIDACIÓN de trabajo para LlayLlay -->
      <div id="validacion-llayllay-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">Validación de Densidad - LlayLlay</h3>
            <button class="close-btn">×</button>
          </div>

          <!-- Historial de observaciones anteriores -->
          <div id="historial-llayllay" class="historial-observaciones">
            <h4>Observaciones del Proceso:</h4>
            <div class="historial-content">
              <p>Cargando historial...</p>
            </div>
          </div>

          <form id="form-validacion-llayllay">
            <div class="form-group">
              <label for="llayllay-observaciones">Observaciones:</label>
              <textarea
                id="llayllay-observaciones"
                placeholder="Ingresa observaciones sobre la validación..."
                required></textarea>
            </div>

            <div class="form-group">
              <label for="llayllay-densidad">Densidad (g/cm³):</label>
              <input
                type="number"
                id="llayllay-densidad"
                placeholder="ej: 2.35"
                min="0"
                step="0.01"
                required
              />
            </div>

            <div class="form-actions">
              <button type="button" class="btn-cancel">Cancelar</button>
              <button type="submit" class="btn-validar">Validar Densidad</button
              >
              <button type="button" class="btn-rechazar">Rechazar</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Modal para validación/rechazo de Besalco -->
      <div id="validacion-besalco-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">Validación de Trabajo - Besalco</h3>
            <button class="close-btn">×</button>
          </div>

          <!-- Historial de observaciones anteriores -->
          <div id="historial-besalco" class="historial-observaciones">
            <h4>Observaciones del Proceso:</h4>
            <div class="historial-content">
              <p>Cargando historial...</p>
            </div>
          </div>

          <form id="form-validacion-besalco">
            <div class="form-group">
              <label for="besalco-observaciones"
                >Observaciones del Trabajo:</label
              >
              <textarea
                id="besalco-observaciones"
                placeholder="Describe el trabajo realizado o motivo del rechazo..."
                required></textarea>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-cancel">Cancelar</button>
              <button type="submit" class="btn-finalizar"
                >Finalizar Trabajo</button
              >
              <button type="button" class="btn-rechazar"
                >Rechazar Trabajo</button
              >
            </div>
          </form>
        </div>
      </div>

      <!-- Modal para cerrar cancha (AngloAmerican) -->
      <div id="cerrar-cancha-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">Cerrar Cancha - AngloAmerican</h3>
            <button class="close-btn">×</button>
          </div>

          <!-- Historial completo de observaciones -->
          <div id="historial-cierre" class="historial-observaciones">
            <h4>Historial Completo del Proceso:</h4>
            <div class="historial-content">
              <p>Cargando historial completo...</p>
            </div>
          </div>

          <div
            class="form-actions"
            style="justify-content: center; gap: 1rem; padding-top: 1rem;"
          >
            <button type="button" class="btn-cancel">Cancelar</button>
            <button type="button" class="btn-finalizar" id="confirmar-cierre"
              >Cerrar Cancha Definitivamente</button
            >
          </div>
        </div>
      </div>

      <!-- Modal para borrar cancha (AngloAmerican) -->
      <div id="borrar-cancha-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title" style="color: #e74c3c;">
              ⚠️ Borrar Cancha Definitivamente
            </h3>
            <button class="close-btn">×</button>
          </div>

          <div
            style="padding: 1rem; background: #fef5e7; border: 2px solid #f39c12; border-radius: 8px; margin: 1rem 0;"
          >
            <h4 style="color: #d68910; margin: 0 0 0.5rem 0;">
              ⚠️ ADVERTENCIA
            </h4>
            <p style="margin: 0; color: #8e6e01;">
              Esta acción <strong>NO SE PUEDE DESHACER</strong>. Se eliminará la
              cancha y todas sus validaciones asociadas de forma permanente.
            </p>
          </div>

          <div id="historial-borrado" class="historial-observaciones">
            <h4>Historial que se Eliminará:</h4>
            <div class="historial-content">
              <p>Cargando historial...</p>
            </div>
          </div>

          <div class="form-group">
            <label
              for="confirmacion-borrado"
              style="color: #e74c3c; font-weight: 700;"
            >
              Para confirmar, escribe exactamente: <code
                style="background: #f8f9fa; padding: 0.25rem;"
                >borrar-cancha</code
              >
            </label>
            <input
              type="text"
              id="confirmacion-borrado"
              placeholder="Escribe 'borrar-cancha' para confirmar"
              style="border: 2px solid #e74c3c;"
            />
          </div>

          <div
            class="form-actions"
            style="justify-content: center; gap: 1rem; padding-top: 1rem;"
          >
            <button type="button" class="btn-cancel">Cancelar</button>
            <button
              type="button"
              class="btn-danger"
              id="confirmar-borrado"
              disabled>BORRAR CANCHA DEFINITIVAMENTE</button
            >
          </div>
        </div>
      </div>

      <!-- Modal para Timeline de Canchas -->
      <div id="timeline-modal" class="modal">
        <div class="modal-content modal-timeline">
          <div class="modal-header">
            <div>
              <h3 class="modal-title">
                <svg
                  width="28"
                  height="28"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
                Timeline de Transiciones
              </h3>
              <p
                style="margin: 0.5rem 0 0 0; font-size: 0.95rem; color: rgba(255,255,255,0.85); font-weight: 400;"
              >
                Visualización cronológica de eventos de las canchas
                seleccionadas
              </p>
            </div>
            <button class="close-btn" id="timeline-close-btn">×</button>
          </div>

          <div class="timeline-container">
            <div id="timeline-legend" class="timeline-legend"></div>
            <div id="timeline-canvas-wrapper" class="timeline-canvas-wrapper">
              <canvas id="timeline-canvas"></canvas>
              <div id="timeline-axis" class="timeline-axis"></div>
              <div id="timeline-events" class="timeline-events"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      // ========== ANIMACIÓN DE PARTÍCULAS EN HEADER ==========
      function initParticles() {
        const canvas = document.getElementById("particles-canvas");
        if (!canvas) return;

        const ctx = canvas.getContext("2d");
        const header = canvas.parentElement;

        let width, height;

        // Ajustar tamaño del canvas
        function resizeCanvas() {
          width = header.offsetWidth;
          height = header.offsetHeight;
          canvas.width = width;
          canvas.height = height;
        }

        resizeCanvas();

        // Configuración de partículas
        let particles = [];
        const particleDensity = 9000; // Menor número = más partículas

        // Mouse interaction
        let mouse = { x: null, y: null, radius: 150 };

        header.addEventListener("mousemove", (event) => {
          const rect = header.getBoundingClientRect();
          mouse.x = event.clientX - rect.left;
          mouse.y = event.clientY - rect.top;
        });

        header.addEventListener("mouseleave", () => {
          mouse.x = null;
          mouse.y = null;
        });

        class Particle {
          constructor() {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.size = Math.random() * 2 + 1.5; // Tamaño variado
            this.speedX = (Math.random() * 1.5 - 0.75) * 0.5; // Velocidad lenta y elegante
            this.speedY = (Math.random() * 1.5 - 0.75) * 0.5;
            this.density = Math.random() * 30 + 1;
          }

          update() {
            // Movimiento normal
            this.x += this.speedX;
            this.y += this.speedY;

            // Rebote en bordes
            if (this.x > width || this.x < 0) this.speedX = -this.speedX;
            if (this.y > height || this.y < 0) this.speedY = -this.speedY;

            // Interacción con mouse
            if (mouse.x != null) {
              let dx = mouse.x - this.x;
              let dy = mouse.y - this.y;
              let distance = Math.sqrt(dx * dx + dy * dy);

              if (distance < mouse.radius) {
                const forceDirectionX = dx / distance;
                const forceDirectionY = dy / distance;
                const maxDistance = mouse.radius;
                const force = (maxDistance - distance) / maxDistance;
                const directionX = forceDirectionX * force * this.density;
                const directionY = forceDirectionY * force * this.density;

                // Efecto de repulsión suave
                this.x -= directionX * 0.05;
                this.y -= directionY * 0.05;
              }
            }
          }

          draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fillStyle = "rgba(255, 255, 255, 0.7)"; // Partículas claras
            ctx.fill();
          }
        }

        function init() {
          particles = [];
          let numberOfParticles = (width * height) / particleDensity;
          // Asegurar un mínimo de partículas
          if (numberOfParticles < 50) numberOfParticles = 50;
          if (numberOfParticles > 150) numberOfParticles = 150; // Límite superior

          for (let i = 0; i < numberOfParticles; i++) {
            particles.push(new Particle());
          }
        }

        init();

        window.addEventListener("resize", () => {
          resizeCanvas();
          init();
        });

        // Animar
        function animate() {
          ctx.clearRect(0, 0, width, height);

          particles.forEach((particle) => {
            particle.update();
            particle.draw();
          });

          connect();

          requestAnimationFrame(animate);
        }

        function connect() {
          const maxDistance = 130; // Distancia de conexión
          for (let a = 0; a < particles.length; a++) {
            for (let b = a; b < particles.length; b++) {
              let dx = particles[a].x - particles[b].x;
              let dy = particles[a].y - particles[b].y;
              let distance = Math.sqrt(dx * dx + dy * dy);

              if (distance < maxDistance) {
                let opacityValue = 1 - distance / maxDistance;
                ctx.strokeStyle =
                  "rgba(255, 255, 255," + opacityValue * 0.35 + ")";
                ctx.lineWidth = 0.8;
                ctx.beginPath();
                ctx.moveTo(particles[a].x, particles[a].y);
                ctx.lineTo(particles[b].x, particles[b].y);
                ctx.stroke();
              }
            }
          }
        }

        animate();
      }

      // Inicializar partículas cuando cargue el DOM
      initParticles();
      // ========== FIN ANIMACIÓN DE PARTÍCULAS ==========

      // Variables globales
      let usuarioLogueado = null;
      let empresaLogueada = null;
      let cargando = false;
      let vistaActual = "acciones"; // 'acciones' o 'historico'
      let filtroFecha = "all";
      let todasLasCanchas = [];
      let canchasFiltradas = [];

      // Variables de paginación
      let paginaActual = 1;
      const filasPorPagina = 15;
      let filtroEstadoActivo = null; // Estado seleccionado desde los círculos

      // Elementos del DOM
      const mainScreen = document.getElementById("main-screen");
      const userHeader = document.getElementById("user-header");
      const userName = document.getElementById("user-name");
      const userRole = document.getElementById("user-role");
      const userCompany = document.getElementById("user-company");
      const btnAdminUsuarios = document.getElementById("btn-admin-usuarios");
      const btnLogout = document.getElementById("btn-logout");
      const formCrearCancha = document.getElementById("form-crear-cancha");
      const btnCrearCancha = document.getElementById("btn-crear-cancha");
      const btnAbrirModalCrear = document.getElementById(
        "btn-abrir-modal-crear",
      );
      const canchasTBody = document.getElementById("canchas-tbody");
      const mensajeContainer = document.getElementById("mensaje-container");
      // Elementos del dashboard de estadísticas (reemplaza contador-resultados)

      // Elementos de filtros
      const btnVistaAcciones = document.getElementById("btn-vista-acciones");
      const btnVistaHistorico = document.getElementById("btn-vista-historico");
      const filtroFechaSelect = document.getElementById("filtro-fecha");
      const rangoFechas = document.getElementById("rango-fechas");
      const fechaDesde = document.getElementById("fecha-desde");
      const fechaHasta = document.getElementById("fecha-hasta");
      const btnAplicarRango = document.getElementById("btn-aplicar-rango");

      // Cargar datos iniciales
      async function inicializar() {
        try {
          configurarEventListeners();

          // Esperar a que el AuthGuard termine de verificar
          window.addEventListener("userAuthenticated", (event) => {
            cargarUsuarioAutenticado(event.detail);
          });

          // Verificar si ya hay usuario autenticado
          verificarUsuarioExistente();
        } catch (error) {
          console.error("Error al inicializar:", error);
          mostrarMensaje("Error al cargar datos iniciales", "error");
        }
      }

      // Verificar si hay usuario autenticado en localStorage
      function verificarUsuarioExistente() {
        try {
          const sessionData = localStorage.getItem("userSession");
          if (sessionData) {
            const session = JSON.parse(sessionData);
            const expiresAt = new Date(session.expiresAt);

            if (expiresAt > new Date()) {
              cargarUsuarioAutenticado(session.usuario);
            } else {
              // Sesión expirada, redirigir al login
              window.location.href = "/login";
            }
          } else {
            // No hay sesión, redirigir al login
            window.location.href = "/login";
          }
        } catch (error) {
          console.error("Error verificando usuario:", error);
          window.location.href = "/login";
        }
      }

      // Configurar todos los event listeners
      function configurarEventListeners() {
        // Logout
        btnLogout.addEventListener("click", cerrarSesion);

        // Filtros
        btnVistaAcciones.addEventListener("click", () =>
          cambiarVista("acciones"),
        );
        btnVistaHistorico.addEventListener("click", () =>
          cambiarVista("historico"),
        );
        filtroFechaSelect.addEventListener("change", manejarCambioFiltroFecha);
        btnAplicarRango.addEventListener("click", aplicarRangoFechas);

        // Modal
        configurarModalEventListeners();

        // === EVENT LISTENERS PARA BOTONES ESPECIALES DE LINKAPSIS ===
        configurarBotonesLinkapsis();

        // Crear cancha (si aplica)
        if (btnCrearCancha) {
          console.log("Registrando event listener para btnCrearCancha");
          btnCrearCancha.addEventListener("click", crearCancha);
        } else {
          console.log("No se encontró btnCrearCancha");
        }

        // Botón para abrir modal de crear cancha con polígono
        if (btnAbrirModalCrear) {
          console.log("Registrando event listener para btnAbrirModalCrear");
          btnAbrirModalCrear.addEventListener("click", abrirModalCrearCancha);
        } else {
          console.log("No se encontró btnAbrirModalCrear");
        }

        // Configurar selectores dinámicos de Muro y Sector
        configurarSelectoresMuroSector();

        // Configurar botones de paginación
        configurarPaginacion();

        // Configurar controles del mapa
        configurarControlesMapa();

        // Inicializar slider de filtros
        setTimeout(updateSliderPosition, 100);
        window.addEventListener("resize", updateSliderPosition);
      }

      // Configurar controles del header del mapa
      function configurarControlesMapa() {
        const mapMuroFilter = document.getElementById("map-muro-filter");
        const toggleRevanchas = document.getElementById("toggle-revanchas");
        const mapSubtitle = document.getElementById("map-subtitle");

        // Filtro de muros del mapa
        if (mapMuroFilter) {
          mapMuroFilter.addEventListener("change", (e) => {
            const muroSeleccionado = e.target.value;
            console.log("🗺️ Filtro de muro cambiado:", muroSeleccionado);

            // Actualizar subtítulo
            if (mapSubtitle) {
              if (muroSeleccionado) {
                mapSubtitle.textContent = `Mostrando canchas del Muro ${muroSeleccionado}`;
              } else {
                mapSubtitle.textContent = "Mostrando todas las canchas";
              }
            }

            // Recargar el iframe del mapa con el filtro aplicado
            recargarMapaConFiltro(muroSeleccionado);
          });
        }

        // Toggle de Revanchas
        if (toggleRevanchas) {
          toggleRevanchas.addEventListener("change", async (e) => {
            const activado = e.target.checked;
            console.log("📊 Revanchas toggle:", activado ? "ON" : "OFF");

            const mapContainer = document.getElementById(
              "dashboard-map-container",
            );
            const iframe = mapContainer?.querySelector("iframe");

            if (!iframe || !iframe.contentWindow) {
              console.log("⚠️ Iframe del mapa no disponible");
              return;
            }

            if (activado) {
              try {
                console.log("🔄 Cargando revanchas georreferenciadas...");

                // Obtener filtro de muro actual
                const muroFiltro = mapMuroFilter?.value || "";

                // Construir URL con filtros
                let apiUrl =
                  "/api/revanchas/georreferenciadas?soloUltimas=true&formato=geojson";
                if (muroFiltro) {
                  apiUrl += `&muro=${muroFiltro}`;
                }

                // Cargar datos de revanchas georreferenciadas
                const response = await fetch(apiUrl);
                if (!response.ok) {
                  throw new Error(
                    `Error ${response.status}: ${response.statusText}`,
                  );
                }

                const geojsonData = await response.json();
                console.log(
                  `✅ ${geojsonData.features.length} revanchas georreferenciadas cargadas`,
                );

                // Enviar datos al iframe del mapa
                iframe.contentWindow.postMessage(
                  {
                    type: "mostrar-revanchas",
                    data: geojsonData,
                  },
                  "*",
                );

                console.log("📤 Datos de revanchas enviados al mapa");
              } catch (error) {
                console.error("❌ Error al cargar revanchas:", error);
                alert("Error al cargar revanchas georreferenciadas");
                // Desmarcar el toggle en caso de error
                e.target.checked = false;
              }
            } else {
              // Ocultar capa de revanchas
              iframe.contentWindow.postMessage(
                {
                  type: "ocultar-revanchas",
                },
                "*",
              );
              console.log("📤 Comando de ocultar revanchas enviado al mapa");
            }
          });
        }
      }

      // Recargar el mapa con el filtro de muro aplicado
      function recargarMapaConFiltro(muro) {
        const mapContainer = document.getElementById("dashboard-map-container");
        if (!mapContainer) return;

        // Mostrar indicador de carga
        mapContainer.innerHTML =
          '<div class="dashboard-map-loading">Cargando mapa...</div>';

        // Construir URL del mapa con filtro
        let mapUrl = "/mapbox-window?dashboardMode=true";

        // Obtener IDs de todas las canchas filtradas
        const canchaIds = canchasFiltradas.map((c) => c.id).join(",");
        if (canchaIds) {
          mapUrl += `&canchaIds=${canchaIds}`;
        }

        // Agregar filtro de muro si está seleccionado
        if (muro) {
          // Convertir nombre completo a código (Principal -> MP, Este -> ME, Oeste -> MO)
          const muroCodigo =
            muro === "Principal"
              ? "MP"
              : muro === "Este"
                ? "ME"
                : muro === "Oeste"
                  ? "MO"
                  : muro;
          mapUrl += `&muro=${muroCodigo}`;
        }

        console.log("🌐 Recargando mapa con URL:", mapUrl);

        // Crear nuevo iframe
        setTimeout(() => {
          const iframe = document.createElement("iframe");
          iframe.src = mapUrl;
          iframe.style.width = "100%";
          iframe.style.height = "100%";
          iframe.style.border = "none";

          mapContainer.innerHTML = "";
          mapContainer.appendChild(iframe);
        }, 300);
      }

      // Configurar event listeners de paginación
      function configurarPaginacion() {
        document
          .getElementById("btn-primera-pagina")
          .addEventListener("click", () => {
            paginaActual = 1;
            renderizarPaginaCanchas();
          });

        document
          .getElementById("btn-pagina-anterior")
          .addEventListener("click", () => {
            if (paginaActual > 1) {
              paginaActual--;
              renderizarPaginaCanchas();
            }
          });

        document
          .getElementById("btn-pagina-siguiente")
          .addEventListener("click", () => {
            const totalPaginas = Math.ceil(
              canchasFiltradas.length / filasPorPagina,
            );
            if (paginaActual < totalPaginas) {
              paginaActual++;
              renderizarPaginaCanchas();
            }
          });

        document
          .getElementById("btn-ultima-pagina")
          .addEventListener("click", () => {
            const totalPaginas = Math.ceil(
              canchasFiltradas.length / filasPorPagina,
            );
            paginaActual = totalPaginas || 1;
            renderizarPaginaCanchas();
          });

        // Configurar event listeners para widgets de estado (doble click)
        const estadoWidgets = document.querySelectorAll(".estado-widget");
        estadoWidgets.forEach((widget) => {
          widget.addEventListener("dblclick", () => {
            const estadoData = widget.getAttribute("data-estado");
            const estadoMap = {
              creada: "Creada",
              "en-espera": "En Espera",
              "en-proceso": "En Proceso",
              validada: "Validada",
              "rechazada-en-espera": "Rechazada, en Espera",
              cerrada: "Cerrada",
            };
            const estadoNombre = estadoMap[estadoData];
            if (estadoNombre) {
              filtrarPorEstadoWidget(estadoNombre);
            }
          });
        });
      }

      // Configurar selectores dinámicos de Muro y Sector
      function configurarSelectoresMuroSector() {
        const selectMuro = document.getElementById("muro-select");
        const selectSector = document.getElementById("sector-select");

        if (!selectMuro || !selectSector) return;

        selectMuro.addEventListener("change", function () {
          const muroSeleccionado = this.value;

          // Limpiar opciones del sector
          selectSector.innerHTML = "";

          if (!muroSeleccionado) {
            selectSector.disabled = true;
            selectSector.innerHTML =
              '<option value="">Primero selecciona un muro</option>';
            return;
          }

          selectSector.disabled = false;
          selectSector.innerHTML =
            '<option value="">Selecciona un sector</option>';

          // Agregar opciones según el muro seleccionado
          if (muroSeleccionado === "MP") {
            // MP: S1 hasta S7
            for (let i = 1; i <= 7; i++) {
              const option = document.createElement("option");
              option.value = `S${i}`;
              option.textContent = `S${i}`;
              selectSector.appendChild(option);
            }
          } else if (muroSeleccionado === "ME" || muroSeleccionado === "MO") {
            // ME y MO: S1 hasta S3
            for (let i = 1; i <= 3; i++) {
              const option = document.createElement("option");
              option.value = `S${i}`;
              option.textContent = `S${i}`;
              selectSector.appendChild(option);
            }
          }
        });
      }

      // Configurar event listeners del modal
      function configurarModalEventListeners() {
        // Botón de cerrar modal
        const closeBtn = document.querySelector(".close-btn");
        if (closeBtn) {
          closeBtn.addEventListener("click", cerrarTodosLosModales);
        }
      }

      // === FUNCIÓN TEMPORAL DE DEBUG ===
      window.debugCancha = function (canchaId) {
        const cancha = todasLasCanchas.find((c) => c.id == canchaId);
        if (cancha) {
          console.log("=== DEBUG CANCHA ===");
          console.log("Cancha encontrada:", cancha);
          console.log("Estado actual:", cancha.estado_actual);
          console.log("Empresa actual:", cancha.empresa_actual);
          console.log("Validaciones:", cancha.validaciones);

          if (cancha.validaciones) {
            cancha.validaciones.forEach((v) => {
              console.log(`- ${v.empresa}: ${v.estado}`);
            });
          }

          // Verificar qué botones debería mostrar
          const botonesGenerados = generarBotonesAccion(
            canchaId,
            cancha.estado_actual,
            cancha.empresa_actual,
          );
          console.log("Botones que debería generar:", botonesGenerados);

          return cancha;
        } else {
          console.log("Cancha no encontrada con ID:", canchaId);
          console.log(
            "Canchas disponibles:",
            todasLasCanchas.map((c) => ({ id: c.id, nombre: c.nombre })),
          );
          return null;
        }
      };

      window.debugTodasLasCanchas = function () {
        console.log("=== TODAS LAS CANCHAS ===");
        todasLasCanchas.forEach((cancha) => {
          console.log(
            `ID: ${cancha.id}, Nombre: ${cancha.nombre}, Estado: ${cancha.estado_actual}, Empresa: ${cancha.empresa_actual}`,
          );
        });
        return todasLasCanchas;
      };

      // === FUNCIONES DE AUTENTICACIÓN ===
      // Las funciones de autenticación ahora se manejan en login.astro y AuthGuard.astro

      // Cargar información del usuario autenticado
      async function cargarUsuarioAutenticado(usuario) {
        try {
          console.log("Cargando usuario autenticado:", usuario);

          usuarioLogueado = usuario;
          empresaLogueada = {
            id: usuario.empresa_id,
            nombre: usuario.empresa_nombre,
          };

          // Actualizar UI del header
          userName.textContent = usuario.nombre_completo;
          userRole.textContent = `${usuario.rol_nombre} - ${usuario.empresa_nombre}`;

          // Asignar logo de empresa
          const companyLogo = document.getElementById("user-company-logo");
          const logoMap = {
            AngloAmerican: "/AngloAmerican.png",
            Besalco: "/Besalco.png",
            Linkapsis: "/Linkapsis.png",
            LlayLlay: "/LlayLlay.png",
          };

          if (companyLogo && logoMap[usuario.empresa_nombre]) {
            companyLogo.src = logoMap[usuario.empresa_nombre];
            companyLogo.alt = `Logo ${usuario.empresa_nombre}`;
            companyLogo.style.display = "block";
          }

          userCompany.className = `empresa-actual empresa-${usuario.empresa_nombre.toLowerCase().replace(" ", "")}`;

          // Mostrar/ocultar botón de crear cancha según la empresa
          if (usuario.empresa_nombre === "AngloAmerican") {
            console.log("Mostrando botón de crear cancha para AngloAmerican");
            if (btnAbrirModalCrear)
              btnAbrirModalCrear.style.display = "inline-flex";
          } else {
            console.log(
              "Ocultando botón de crear cancha para:",
              usuario.empresa_nombre,
            );
            if (btnAbrirModalCrear) btnAbrirModalCrear.style.display = "none";
          }

          // Mostrar enlace de administración si es de AngloAmerican
          if (usuario.empresa_id === 1) {
            // AngloAmerican
            btnAdminUsuarios.style.display = "inline-block";
          } else {
            btnAdminUsuarios.style.display = "none";
          }

          // === MOSTRAR BOTONES ESPECIALES PARA LINKAPSIS ===
          // Linkapsis tiene empresa_nombre === "Linkapsis" (verificar en base de datos)
          const btnSubirRevanchas = document.getElementById(
            "btn-subir-revanchas",
          );
          const btnSubirCanchas = document.getElementById("btn-subir-canchas");

          if (usuario.empresa_nombre === "Linkapsis") {
            console.log("Mostrando botones especiales para Linkapsis");
            if (btnSubirRevanchas)
              btnSubirRevanchas.style.display = "inline-flex";
            if (btnSubirCanchas) btnSubirCanchas.style.display = "inline-flex";
          } else {
            if (btnSubirRevanchas) btnSubirRevanchas.style.display = "none";
            if (btnSubirCanchas) btnSubirCanchas.style.display = "none";
          }

          // Cargar datos
          await cargarCanchas();

          // Mensaje de bienvenida eliminado para evitar duplicados
        } catch (error) {
          console.error("Error cargando usuario:", error);
          mostrarMensaje("Error al cargar información del usuario", "error");
          window.location.href = "/login";
        }
      }

      function getRolEmpresa(nombreEmpresa) {
        const roles = {
          AngloAmerican: "Creación y cierre de canchas",
          Besalco: "Trabajo de maquinaria",
          Linkapsis: "Validación de espesores",
          LlayLlay: "Validación de densidad",
        };
        return roles[nombreEmpresa] || "Usuario del sistema";
      }

      // ========================================
      // FUNCIONES PARA BOTONES LINKAPSIS
      // ========================================
      /**
       * Configurar event listeners para los botones especiales de Linkapsis
       * - btn-subir-revanchas: Abre modal para cargar información de revanchas
       * - btn-subir-canchas: Abre modal para carga masiva de canchas
       */
      function configurarBotonesLinkapsis() {
        const btnSubirRevanchas = document.getElementById(
          "btn-subir-revanchas",
        );
        const btnSubirCanchas = document.getElementById("btn-subir-canchas");

        // Event listener para Subir Revanchas
        if (btnSubirRevanchas) {
          btnSubirRevanchas.addEventListener("click", () => {
            console.log("Abriendo modal de Subir Revanchas");
            abrirModalSubirRevanchas();
          });
        }

        // Event listener para Subir Canchas
        if (btnSubirCanchas) {
          btnSubirCanchas.addEventListener("click", () => {
            console.log("Abriendo modal de Subir Canchas");
            abrirModalSubirCanchas();
          });
        }

        // Configurar cierre de modales
        configurarCierreModalesLinkapsis();
      }

      /**
       * Abrir modal de Subir Revanchas
       * TODO: Implementar lógica de carga y procesamiento de revanchas
       */
      function abrirModalSubirRevanchas() {
        const modal = document.getElementById("modal-subir-revanchas");
        if (modal) {
          modal.classList.add("show");
          // TODO: Inicializar formulario, limpiar campos previos
          // TODO: Configurar validaciones de archivo
        }
      }

      /**
       * Abrir modal de Subir Canchas
       * TODO: Implementar lógica de carga masiva de canchas
       */
      function abrirModalSubirCanchas() {
        const modal = document.getElementById("modal-subir-canchas");
        if (modal) {
          modal.classList.add("show");
          // TODO: Inicializar formulario, limpiar campos previos
          // TODO: Configurar validaciones de archivo y geometrías
        }
      }

      /**
       * Configurar event listeners para cerrar modales de Linkapsis
       * Permite cerrar con:
       * - Botón X (close-btn)
       * - Botón Cancelar/Cerrar (btn-cancel)
       * - Click fuera del modal (backdrop)
       */
      function configurarCierreModalesLinkapsis() {
        const modales = [
          { id: "modal-subir-revanchas", nombre: "Subir Revanchas" },
          { id: "modal-subir-canchas", nombre: "Subir Canchas" },
        ];

        modales.forEach((modalInfo) => {
          const modal = document.getElementById(modalInfo.id);
          if (!modal) {
            console.warn(`Modal ${modalInfo.nombre} no encontrado`);
            return;
          }

          const closeBtn = modal.querySelector(".close-btn");
          const cancelBtn = modal.querySelector(".btn-cancel");

          // Cerrar con botón X
          if (closeBtn) {
            closeBtn.addEventListener("click", () => {
              console.log(`Cerrando modal ${modalInfo.nombre} (botón X)`);
              modal.classList.remove("show");
            });
          }

          // Cerrar con botón Cancelar/Cerrar
          if (cancelBtn) {
            cancelBtn.addEventListener("click", () => {
              console.log(
                `Cerrando modal ${modalInfo.nombre} (botón Cancelar)`,
              );
              modal.classList.remove("show");
            });
          }

          // Cerrar al hacer click en el backdrop (fuera del modal-content)
          modal.addEventListener("click", (e) => {
            if (e.target === modal) {
              console.log(`Cerrando modal ${modalInfo.nombre} (backdrop)`);
              modal.classList.remove("show");
            }
          });
        });
      }

      function cerrarSesion() {
        usuarioLogueado = null;
        empresaLogueada = null;

        // Limpiar localStorage
        localStorage.removeItem("userSession");

        // Redirigir al login
        window.location.href = "/login";
        todasLasCanchas = [];
        canchasFiltradas = [];

        mostrarMensaje("Sesión cerrada correctamente", "success");
      }

      // === FUNCIONES DE CARGA DE DATOS ===

      // === FUNCIONES DE FILTROS ===
      function cambiarVista(nuevaVista) {
        console.log("Cambiando vista a:", nuevaVista);
        vistaActual = nuevaVista;

        // Actualizar botones
        btnVistaAcciones.classList.toggle("active", nuevaVista === "acciones");
        btnVistaHistorico.classList.toggle(
          "active",
          nuevaVista === "historico",
        );

        // Aplicar filtros
        aplicarFiltros();

        // Actualizar slider
        updateSliderPosition();
      }

      function updateSliderPosition() {
        const container = document.querySelector(".toggle-container");
        const activeBtn = container?.querySelector(".active");
        const slider = container?.querySelector(".toggle-slider");

        if (activeBtn && slider && container) {
          // Calcular posición relativa al contenedor
          const containerRect = container.getBoundingClientRect();
          const btnRect = activeBtn.getBoundingClientRect();

          const left = btnRect.left - containerRect.left;
          const width = btnRect.width;

          slider.style.transform = `translateX(${left}px)`;
          slider.style.width = `${width}px`;
        }
      }

      function manejarCambioFiltroFecha() {
        filtroFecha = filtroFechaSelect.value;

        if (filtroFecha === "custom") {
          rangoFechas.classList.remove("hidden");
        } else {
          rangoFechas.classList.add("hidden");
          aplicarFiltros();
        }
      }

      function aplicarRangoFechas() {
        const desde = fechaDesde.value;
        const hasta = fechaHasta.value;

        if (!desde || !hasta) {
          mostrarMensaje("Por favor selecciona ambas fechas", "error");
          return;
        }

        aplicarFiltros();
      }

      function aplicarFiltros() {
        if (!empresaLogueada || !todasLasCanchas.length) return;

        canchasFiltradas = [...todasLasCanchas];
        console.log("Aplicando filtros, vista actual:", vistaActual);
        console.log("Total canchas antes del filtro:", canchasFiltradas.length);

        // Filtro por vista (acciones vs histórico)
        if (vistaActual === "acciones") {
          canchasFiltradas = filtrarPorAccionesDisponibles(canchasFiltradas);
          console.log(
            "Canchas después del filtro de acciones:",
            canchasFiltradas.length,
          );
        }

        // Filtro por fecha
        canchasFiltradas = filtrarPorFecha(canchasFiltradas);

        // Filtro por estado desde widgets circulares
        if (filtroEstadoActivo) {
          canchasFiltradas = canchasFiltradas.filter(
            (cancha) => cancha.estado_actual === filtroEstadoActivo,
          );
          console.log(
            "Canchas después del filtro de estado:",
            canchasFiltradas.length,
          );
        }

        // Reiniciar a la primera página al aplicar filtros
        paginaActual = 1;

        // Mostrar resultados
        mostrarCanchas(canchasFiltradas);
        actualizarContadorResultados(
          canchasFiltradas.length,
          todasLasCanchas.length,
        );
      }

      function filtrarPorAccionesDisponibles(canchas) {
        const empresaId = empresaLogueada.id;
        const empresaNombre = empresaLogueada.nombre;

        console.log("Filtrando para empresa:", empresaNombre);

        return canchas.filter((cancha) => {
          const estado = cancha.estado_actual;
          const empresaActual = cancha.empresa_actual;

          console.log(
            `Cancha ${cancha.nombre}: estado="${estado}", empresa="${empresaActual}"`,
          );

          let tieneAccion = false;

          switch (empresaNombre) {
            case "AngloAmerican":
              // AngloAmerican puede actuar cuando:
              // - Cancha creada (enviar a Besalco)
              // - Cancha validada (cerrar)
              tieneAccion = estado === "Creada" || estado === "Validada";
              break;

            case "Besalco":
              // Besalco puede actuar cuando:
              // - Está en espera (recién asignada o rechazada)
              // - Está en proceso (trabajando activamente)
              tieneAccion =
                (estado === "En Espera" && empresaActual === "Besalco") ||
                (estado === "En Proceso" && empresaActual === "Besalco") ||
                (estado === "Rechazada, en Espera" &&
                  empresaActual === "Besalco");
              break;

            case "Linkapsis":
              // Linkapsis puede actuar cuando está en espera o en proceso
              tieneAccion =
                (estado === "En Espera" && empresaActual === "Linkapsis") ||
                (estado === "En Proceso" && empresaActual === "Linkapsis");
              break;

            case "LlayLlay":
              // LlayLlay puede actuar cuando está en espera o en proceso
              tieneAccion =
                (estado === "En Espera" && empresaActual === "LlayLlay") ||
                (estado === "En Proceso" && empresaActual === "LlayLlay");
              break;

            default:
              tieneAccion = false;
          }

          console.log(`-> Tiene acción: ${tieneAccion}`);
          return tieneAccion;
        });
      }

      function filtrarPorFecha(canchas) {
        if (filtroFecha === "all") return canchas;

        const ahora = new Date();
        const hoy = new Date(
          ahora.getFullYear(),
          ahora.getMonth(),
          ahora.getDate(),
        );

        return canchas.filter((cancha) => {
          const fechaCancha = new Date(cancha.created_at);

          switch (filtroFecha) {
            case "today":
              return fechaCancha >= hoy;
            case "week":
              const semanaAtras = new Date(
                hoy.getTime() - 7 * 24 * 60 * 60 * 1000,
              );
              return fechaCancha >= semanaAtras;
            case "month":
              const mesAtras = new Date(
                hoy.getTime() - 30 * 24 * 60 * 60 * 1000,
              );
              return fechaCancha >= mesAtras;
            case "custom":
              if (!fechaDesde.value || !fechaHasta.value) return true;
              const desde = new Date(fechaDesde.value);
              const hasta = new Date(fechaHasta.value + "T23:59:59");
              return fechaCancha >= desde && fechaCancha <= hasta;
            default:
              return true;
          }
        });
      }

      // Actualizar dashboard de estados con contadores
      function actualizarContadorResultados(mostradas, total) {
        // === ACTUALIZAR WIDGETS ORIGINALES (SIDEBAR) ===
        // Contar acciones disponibles para la empresa logueada
        const accionesDisponibles = canchasFiltradas.filter((cancha) => {
          const estado = cancha.estado_actual;
          const empresaActual = cancha.empresa_actual;

          if (!empresaLogueada) return false;

          let tieneAccion = false;
          const empresaNombre = empresaLogueada.nombre;

          switch (empresaNombre) {
            case "AngloAmerican":
              // AngloAmerican puede actuar cuando:
              // - Cancha creada (enviar a Besalco)
              // - Cancha validada (cerrar)
              tieneAccion = estado === "Creada" || estado === "Validada";
              break;
            case "Besalco":
              // Besalco puede actuar cuando:
              // - Está en espera (recién asignada o rechazada)
              // - Está en proceso (trabajando activamente)
              tieneAccion =
                (estado === "En Espera" && empresaActual === "Besalco") ||
                (estado === "En Proceso" && empresaActual === "Besalco") ||
                (estado === "Rechazada, en Espera" &&
                  empresaActual === "Besalco");
              break;
            case "Linkapsis":
              // Linkapsis puede actuar cuando está en espera o en proceso
              tieneAccion =
                (estado === "En Espera" && empresaActual === "Linkapsis") ||
                (estado === "En Proceso" && empresaActual === "Linkapsis");
              break;
            case "LlayLlay":
              // LlayLlay puede actuar cuando está en espera o en proceso
              tieneAccion =
                (estado === "En Espera" && empresaActual === "LlayLlay") ||
                (estado === "En Proceso" && empresaActual === "LlayLlay");
              break;
            default:
              tieneAccion = false;
          }
          return tieneAccion;
        }).length;

        // Actualizar contadores del sidebar
        const statAcciones = document.getElementById("stat-acciones");
        const statTotal = document.getElementById("stat-total");

        if (statAcciones) {
          animateNumber(
            statAcciones,
            parseInt(statAcciones.textContent) || 0,
            accionesDisponibles,
          );
        }

        if (statTotal) {
          animateNumber(statTotal, parseInt(statTotal.textContent) || 0, total);
        }

        // === ACTUALIZAR WIDGETS CIRCULARES (DASHBOARD DE ESTADOS) ===
        // Contar canchas por estado
        const contadores = {
          Creada: 0,
          "En Espera": 0,
          "En Proceso": 0,
          Validada: 0,
          "Rechazada, en Espera": 0,
          Cerrada: 0,
        };

        // Contar las canchas filtradas por estado
        canchasFiltradas.forEach((cancha) => {
          const estado = cancha.estado_actual;
          if (contadores.hasOwnProperty(estado)) {
            contadores[estado]++;
          }
        });

        // Actualizar los widgets circulares con animación
        animateNumber(
          document.getElementById("count-creada"),
          parseInt(document.getElementById("count-creada").textContent) || 0,
          contadores["Creada"],
        );

        animateNumber(
          document.getElementById("count-en-espera"),
          parseInt(document.getElementById("count-en-espera").textContent) || 0,
          contadores["En Espera"],
        );

        animateNumber(
          document.getElementById("count-en-proceso"),
          parseInt(document.getElementById("count-en-proceso").textContent) ||
            0,
          contadores["En Proceso"],
        );

        animateNumber(
          document.getElementById("count-validada"),
          parseInt(document.getElementById("count-validada").textContent) || 0,
          contadores["Validada"],
        );

        animateNumber(
          document.getElementById("count-rechazada-en-espera"),
          parseInt(
            document.getElementById("count-rechazada-en-espera").textContent,
          ) || 0,
          contadores["Rechazada, en Espera"],
        );

        animateNumber(
          document.getElementById("count-cerrada"),
          parseInt(document.getElementById("count-cerrada").textContent) || 0,
          contadores["Cerrada"],
        );

        // Actualizar subtítulo del mapa
        actualizarSubtituloMapa(mostradas);
      }

      // Manejar doble click en widgets de estado para filtrar
      function filtrarPorEstadoWidget(estadoNombre) {
        const widgets = document.querySelectorAll(".estado-widget");

        // Si se clickea el mismo estado, desactivar filtro
        if (filtroEstadoActivo === estadoNombre) {
          filtroEstadoActivo = null;
          widgets.forEach((w) => {
            w.classList.remove("selected");
            w.classList.remove("dimmed");
          });
        } else {
          // Activar nuevo filtro
          filtroEstadoActivo = estadoNombre;

          // Actualizar clases de selección y dimmed
          widgets.forEach((widget) => {
            const estadoWidget = widget.getAttribute("data-estado");
            const estadoMap = {
              creada: "Creada",
              "en-espera": "En Espera",
              "en-proceso": "En Proceso",
              validada: "Validada",
              "rechazada-en-espera": "Rechazada, en Espera",
              cerrada: "Cerrada",
            };

            if (estadoMap[estadoWidget] === estadoNombre) {
              widget.classList.add("selected");
              widget.classList.remove("dimmed");
            } else {
              widget.classList.remove("selected");
              widget.classList.add("dimmed");
            }
          });
        }

        // Re-aplicar filtros
        aplicarFiltros();
      }

      // Actualizar subtítulo del mapa según filtros activos
      function actualizarSubtituloMapa(cantidadCanchas) {
        const subtitle = document.getElementById("map-subtitle");
        if (!subtitle) return;

        let texto = "";

        if (vistaActual === "acciones") {
          texto = `Mostrando ${cantidadCanchas} cancha${cantidadCanchas !== 1 ? "s" : ""} con acciones disponibles`;
        } else {
          texto = `Mostrando ${cantidadCanchas} cancha${cantidadCanchas !== 1 ? "s" : ""} del histórico`;
        }

        // Agregar información del filtro de fecha
        if (filtroFecha === "today") {
          texto += " (Hoy)";
        } else if (filtroFecha === "week") {
          texto += " (Última semana)";
        } else if (filtroFecha === "month") {
          texto += " (Último mes)";
        } else if (filtroFecha === "custom") {
          texto += " (Rango personalizado)";
        }

        subtitle.textContent = texto;
      }

      // Actualizar mapa dashboard con las canchas filtradas
      function actualizarMapaDashboard(canchas) {
        const mapContainer = document.getElementById("dashboard-map-container");
        if (!mapContainer) return;

        console.log(
          "🗺️ Actualizando mapa dashboard con",
          canchas.length,
          "canchas",
        );

        // Extraer IDs de canchas para el mapa
        const canchaIds = canchas.map((c) => c.id).join(",");

        // Construir URL del iframe con parámetros de filtrado
        const params = new URLSearchParams();
        params.set("dashboardMode", "true");
        params.set("canchaIds", canchaIds);

        const mapUrl = `/mapbox-window?${params.toString()}`;

        // Crear o actualizar iframe
        let iframe = mapContainer.querySelector("iframe");
        if (!iframe) {
          iframe = document.createElement("iframe");
          iframe.style.width = "100%";
          iframe.style.height = "100%";
          iframe.style.border = "none";

          // Limpiar loading y agregar iframe
          mapContainer.innerHTML = "";
          mapContainer.appendChild(iframe);
        }

        // Actualizar src del iframe
        iframe.src = mapUrl;

        console.log("✅ Mapa dashboard actualizado con URL:", mapUrl);
      }

      // Función para animar números
      function animateNumber(element, start, end, suffix = "") {
        const duration = 800;
        const startTime = Date.now();

        function update() {
          const elapsed = Date.now() - startTime;
          const progress = Math.min(elapsed / duration, 1);

          // Easing function (ease-out)
          const easedProgress = 1 - Math.pow(1 - progress, 3);
          const current = Math.round(start + (end - start) * easedProgress);

          element.textContent = current + suffix;

          if (progress < 1) {
            requestAnimationFrame(update);
          }
        }

        update();
      }

      // === FUNCIÓN DE CREACIÓN DE CANCHAS ===
      async function crearCancha() {
        console.log("Función crearCancha llamada");
        if (cargando) return;

        const muro = document.getElementById("muro").value.trim();
        const sector = document.getElementById("sector").value.trim();
        const nombreDetalle = document
          .getElementById("nombre-detalle")
          .value.trim();

        console.log("Datos del formulario:", { muro, sector, nombreDetalle });

        if (!muro || !sector || !nombreDetalle) {
          alert("Por favor completa todos los campos");
          return;
        }

        try {
          cargando = true;
          btnCrearCancha.textContent = "Creando...";
          btnCrearCancha.disabled = true;

          const response = await fetch("/api/canchas", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ muro, sector, nombreDetalle }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || "Error al crear cancha");
          }

          // Limpiar formulario
          document.getElementById("muro").value = "";
          document.getElementById("sector").value = "";
          document.getElementById("nombre-detalle").value = "";

          // Recargar tabla
          await cargarCanchas();

          mostrarMensaje("Cancha creada exitosamente", "success");
        } catch (error) {
          console.error("Error al crear cancha:", error);
          mostrarMensaje("Error al crear la cancha: " + error.message, "error");
        } finally {
          cargando = false;
          btnCrearCancha.textContent = "Crear Cancha";
          btnCrearCancha.disabled = false;
        }
      }

      // === FUNCIÓN DE CARGA DE CANCHAS ===
      async function cargarCanchas() {
        try {
          const response = await fetch("/api/canchas");
          if (!response.ok) {
            throw new Error("Error al cargar canchas");
          }

          todasLasCanchas = await response.json();
          console.log("🗂️ Datos de canchas cargados:", todasLasCanchas);
          if (todasLasCanchas.length > 0) {
            console.log("🔍 Primer cancha ejemplo:", todasLasCanchas[0]);
            console.log(
              "🏷️ Campos disponibles:",
              Object.keys(todasLasCanchas[0]),
            );
          }
          aplicarFiltros();
        } catch (error) {
          console.error("Error al cargar canchas:", error);
          mostrarMensaje("Error al cargar las canchas", "error");
        }
      }

      // Mostrar canchas filtradas
      function mostrarCanchas(canchas) {
        renderizarCanchas(canchas);
        actualizarMapaDashboard(canchas);
      }

      // Renderizar tabla de canchas con paginación
      function renderizarCanchas(canchas) {
        canchasFiltradas = canchas;
        paginaActual = 1; // Resetear a la primera página cuando cambian los datos
        renderizarPaginaCanchas();
      }

      // Renderizar página específica de canchas
      function renderizarPaginaCanchas() {
        const inicio = (paginaActual - 1) * filasPorPagina;
        const fin = inicio + filasPorPagina;
        const canchasPagina = canchasFiltradas.slice(inicio, fin);

        canchasTBody.innerHTML = canchasPagina
          .map(
            (cancha) => `
          <tr data-cancha-id="${cancha.id}" class="cancha-row">
            <td style="text-align: center;">
              <input type="checkbox" class="cancha-checkbox" data-cancha-id="${cancha.id}" data-cancha-nombre="${cancha.nombre}">
            </td>
            <td><strong>${cancha.nombre.toUpperCase()}</strong></td>
            <td>
              <span class="estado estado-${cancha.estado_actual.toLowerCase().replace(/\s+/g, "-")}">
                ${cancha.estado_actual}
              </span>
            </td>
            <td>
              <span class="empresa-actual empresa-${cancha.empresa_actual.toLowerCase().replace(/\s+/g, "-")}">
                ${cancha.empresa_actual}
              </span>
            </td>
            <td>${new Date(cancha.created_at).toLocaleDateString("es-ES")}</td>
            <td>
              <button class="btn-mapa" data-cancha-id="${cancha.id}" data-cancha-nombre="${cancha.nombre}" type="button" style="background:none; border:none; font-size:1.5rem; cursor:pointer; padding:0.5rem; transition: transform 0.2s;" title="Ver en mapa">🗺️</button>
            </td>
            <td>
              <div class="actions" data-cancha-id="${cancha.id}" data-estado="${cancha.estado_actual}" data-empresa="${cancha.empresa_actual}">
              </div>
            </td>
          </tr>
        `,
          )
          .join("");

        // Agregar event listeners para botones del mapa inmediatamente después de renderizar
        setTimeout(() => {
          console.log("🔧 Agregando event listeners para botones del mapa...");
          document.querySelectorAll(".btn-mapa").forEach((btn, index) => {
            console.log(`🔧 Configurando botón ${index}:`, btn.dataset);
            btn.addEventListener("click", (e) => {
              const canchaId = e.target.dataset.canchaId;
              const canchaName = e.target.dataset.canchaNombre;
              console.log("🗺️ Botón de mapa clickeado:", {
                canchaId,
                canchaName,
              });
              console.log("🔍 Datasets disponibles:", e.target.dataset);
              abrirMapaModal(canchaId, canchaName);
            });
          });

          // Agregar listeners de checkboxes
          attachCheckboxListeners();
        }, 100); // Pequeño delay para asegurar que el DOM esté actualizado

        actualizarAcciones();
        actualizarControlesPaginacion();
      }

      // Actualizar controles de paginación
      function actualizarControlesPaginacion() {
        const totalCanchas = canchasFiltradas.length;
        const totalPaginas = Math.ceil(totalCanchas / filasPorPagina);
        const inicio = (paginaActual - 1) * filasPorPagina + 1;
        const fin = Math.min(inicio + filasPorPagina - 1, totalCanchas);

        document.getElementById("pagination-start").textContent =
          totalCanchas > 0 ? inicio : 0;
        document.getElementById("pagination-end").textContent = fin;
        document.getElementById("pagination-total").textContent = totalCanchas;
        document.getElementById("pagina-actual").textContent = paginaActual;
        document.getElementById("total-paginas").textContent =
          totalPaginas || 1;

        // Habilitar/deshabilitar botones
        document.getElementById("btn-primera-pagina").disabled =
          paginaActual === 1;
        document.getElementById("btn-pagina-anterior").disabled =
          paginaActual === 1;
        document.getElementById("btn-pagina-siguiente").disabled =
          paginaActual >= totalPaginas;
        document.getElementById("btn-ultima-pagina").disabled =
          paginaActual >= totalPaginas;
      }

      // Actualizar botones de acción según empresa seleccionada
      function actualizarAcciones() {
        console.log("Actualizando acciones para empresa:", empresaLogueada);
        const actionsDivs = document.querySelectorAll(".actions");

        console.log("Encontrados", actionsDivs.length, "divs de acciones");

        actionsDivs.forEach((div, index) => {
          const canchaId = div.dataset.canchaId;
          const estado = div.dataset.estado;
          const empresaActual = div.dataset.empresa;

          console.log(
            `Procesando div ${index}: canchaId=${canchaId}, estado=${estado}, empresaActual=${empresaActual}`,
          );

          const botonesHTML = generarBotonesAccion(
            canchaId,
            estado,
            empresaActual,
          );
          console.log(`Botones generados: ${botonesHTML}`);
          div.innerHTML = botonesHTML;
        });

        // Agregar event listeners a los botones
        agregarEventListeners();
        console.log("Event listeners agregados");

        // Agregar event listeners de doble-click
        agregarEventListenersDobleClick();
      }

      // Generar botones según empresa y estado
      function generarBotonesAccion(canchaId, estado, empresaActual) {
        console.log(
          `generarBotonesAccion: canchaId=${canchaId}, estado=${estado}, empresaActual=${empresaActual}`,
        );
        console.log("empresaLogueada:", empresaLogueada);

        if (!empresaLogueada) {
          console.log("No hay empresa logueada");
          return '<span style="color:#666;">Selecciona tu empresa</span>';
        }

        const botones = [];
        const empresaId = empresaLogueada.id;
        console.log("Empresa ID:", empresaId);

        // AngloAmerican
        if (empresaId === 1) {
          console.log("Procesando para AngloAmerican");
          if (estado === "Creada") {
            console.log("Estado es Creada, agregando botón enviar a Besalco");
            botones.push(
              `<button class="btn-accion" data-accion="enviar-besalco" data-cancha-id="${canchaId}">📤 Enviar a Besalco</button>`,
            );
          } else if (estado === "Validada") {
            console.log("Estado es Validada, agregando botón cerrar cancha");
            botones.push(
              `<button class="btn-accion btn-success" data-accion="abrir-modal-cierre" data-cancha-id="${canchaId}">🔒 Cerrar Cancha</button>`,
            );
          } else if (
            estado === "En Proceso" &&
            empresaActual === "AngloAmerican"
          ) {
            console.log(
              "Estado es En Proceso y empresa actual es AngloAmerican",
            );
            // Buscar la cancha para verificar validaciones
            const cancha = todasLasCanchas.find((c) => c.id == canchaId);
            if (cancha) {
              const validaciones = cancha.validaciones || [];
              console.log("Validaciones encontradas:", validaciones);
              const hasLinkapsis = validaciones.some(
                (v) => v.empresa === "Linkapsis" && v.estado === "VALIDADO",
              );
              const hasLlayLlay = validaciones.some(
                (v) => v.empresa === "LlayLlay" && v.estado === "VALIDADO",
              );
              const hasBesalco = validaciones.some(
                (v) => v.empresa === "Besalco" && v.estado === "VALIDADO",
              );

              console.log("Estado validaciones:", {
                hasLinkapsis,
                hasLlayLlay,
                hasBesalco,
              });

              if (hasLinkapsis && hasLlayLlay && hasBesalco) {
                console.log(
                  "Todas las validaciones completas, agregando botón PDF",
                );
                botones.push(
                  `<button class="btn-accion btn-pdf" data-accion="exportar-pdf" data-cancha-id="${canchaId}">📄 PDF</button>`,
                );
              }
            }
          } else if (estado === "Finalizada" || estado === "Cerrada") {
            console.log("Estado es Finalizada/Cerrada, agregando botón PDF");
            // Para canchas finalizadas o cerradas, siempre mostrar el botón PDF
            botones.push(
              `<button class="btn-accion btn-pdf" data-accion="exportar-pdf" data-cancha-id="${canchaId}">📄 PDF</button>`,
            );
          }
        }

        // Besalco
        else if (empresaId === 2) {
          if (
            (estado === "En Espera" || estado === "Rechazada, en Espera") &&
            empresaActual === "Besalco"
          ) {
            // Cancha en espera - Recepcionar para revisar
            botones.push(
              `<button class="btn-accion btn-info" data-accion="recepcionar-besalco" data-cancha-id="${canchaId}">📋 Recepcionar Trabajo</button>`,
            );
          } else if (estado === "En Proceso" && empresaActual === "Besalco") {
            // Cancha en proceso - Validar trabajo activo
            botones.push(
              `<button class="btn-accion btn-success" data-accion="validar-besalco" data-cancha-id="${canchaId}">🛠️ Gestionar</button>`,
            );
          }
        }

        // Linkapsis
        else if (empresaId === 3) {
          if (estado === "En Espera" && empresaActual === "Linkapsis") {
            // Cancha en espera - Recepcionar para revisar
            botones.push(
              `<button class="btn-accion btn-info" data-accion="recepcionar-linkapsis" data-cancha-id="${canchaId}">📋 Recepcionar Trabajo</button>`,
            );
          } else if (estado === "En Proceso" && empresaActual === "Linkapsis") {
            // Cancha en proceso - Validar espesores
            botones.push(
              `<button class="btn-accion btn-success" data-accion="validar-linkapsis" data-cancha-id="${canchaId}">📏 Gestionar</button>`,
            );
          }
        }

        // LlayLlay
        else if (empresaId === 4) {
          if (estado === "En Espera" && empresaActual === "LlayLlay") {
            // Cancha en espera - Recepcionar para revisar
            botones.push(
              `<button class="btn-accion btn-info" data-accion="recepcionar-llayllay" data-cancha-id="${canchaId}">📋 Recepcionar Trabajo</button>`,
            );
          } else if (estado === "En Proceso" && empresaActual === "LlayLlay") {
            // Cancha en proceso - Validar densidad
            botones.push(
              `<button class="btn-accion btn-success" data-accion="validar-llayllay" data-cancha-id="${canchaId}">🧪 Gestionar</button>`,
            );
          }
        }

        return botones.length > 0
          ? botones.join("")
          : '<span style="color:#666;">Sin acciones disponibles</span>';
      }

      // Generar botones de administración (solo para AngloAmerican)
      // NOTA: Las funciones generarBotonesAdmin() y actualizarColumnaAdmin() fueron eliminadas
      // porque ahora se usa el sistema de selección múltiple con checkboxes

      // Agregar event listeners a botones de acción
      function agregarEventListeners() {
        document.querySelectorAll(".btn-accion").forEach((btn) => {
          btn.addEventListener("click", manejarAccion);
        });

        // Los event listeners para botones del mapa se agregan en renderizarCanchas()
        console.log("🖱️ Event listeners de acciones agregados");
      }

      // Agregar event listeners de doble-click a las filas de la tabla
      function agregarEventListenersDobleClick() {
        document.querySelectorAll(".cancha-row").forEach((row) => {
          row.addEventListener("dblclick", (e) => {
            const canchaId = e.currentTarget.dataset.canchaId;
            console.log("🖱️ Doble-click en cancha:", canchaId);
            hacerZoomEnMapaDashboard(canchaId);
          });
        });
        console.log("✅ Event listeners de doble-click agregados");
      }

      // Enviar mensaje al iframe del mapa para hacer zoom a una cancha
      function hacerZoomEnMapaDashboard(canchaId) {
        const mapContainer = document.getElementById("dashboard-map-container");
        const iframe = mapContainer?.querySelector("iframe");

        if (!iframe || !iframe.contentWindow) {
          console.log("⚠️ Iframe del mapa no disponible");
          return;
        }

        // Enviar mensaje al iframe
        iframe.contentWindow.postMessage(
          {
            type: "zoom-to-cancha",
            canchaId: canchaId,
          },
          "*",
        );

        console.log("📤 Mensaje de zoom enviado al mapa:", canchaId);
      }

      // Manejar acciones de botones
      async function manejarAccion(e) {
        if (cargando) return;

        const accion = e.target.dataset.accion;
        const canchaId = parseInt(e.target.dataset.canchaId);

        // Manejar apertura de modales de RECEPCIÓN (solo lectura + botón Comenzar)
        if (accion === "recepcionar-besalco") {
          abrirModalRecepcionBesalco(canchaId);
          return;
        } else if (accion === "recepcionar-linkapsis") {
          abrirModalRecepcionLinkapsis(canchaId);
          return;
        } else if (accion === "recepcionar-llayllay") {
          abrirModalRecepcionLlayLlay(canchaId);
          return;
        }

        // Manejar apertura de modales de VALIDACIÓN (formulario completo)
        else if (accion === "validar-besalco") {
          abrirModalBesalco(canchaId);
          return;
        } else if (accion === "validar-linkapsis") {
          abrirModalLinkapsis(canchaId);
          return;
        } else if (accion === "validar-llayllay") {
          abrirModalLlayLlay(canchaId);
          return;
        }

        // Otros modales
        else if (accion === "abrir-modal-cierre") {
          abrirModalCierre(canchaId);
          return;
        } else if (accion === "abrir-modal-borrar") {
          abrirModalBorrar(canchaId);
          return;
        } else if (accion === "exportar-pdf") {
          await exportarPDF(canchaId);
          return;
        }

        // Confirmar acción de cierre
        if (accion === "cerrar") {
          if (!confirm("¿Confirmas el cierre de esta cancha?")) {
            return;
          }
        }

        // Pedir observaciones para rechazos (acciones directas legacy)
        let observaciones = null;
        if (accion.includes("rechazar")) {
          const empresaNombre =
            accion === "rechazar-besalco"
              ? "Besalco"
              : accion === "rechazar-linkapsis"
                ? "Linkapsis"
                : "LlayLlay";
          observaciones = prompt(
            `Observaciones del rechazo por ${empresaNombre}:`,
          );
          if (observaciones === null) return; // Usuario canceló
        }

        try {
          cargando = true;
          const textoOriginal = e.target.textContent;
          e.target.disabled = true;
          e.target.textContent = "Procesando...";

          const response = await fetch(`/api/canchas/${canchaId}/action`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ accion, observaciones }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || "Error al ejecutar acción");
          }

          await cargarCanchas();
          mostrarMensaje("Acción realizada exitosamente", "success");
        } catch (error) {
          console.error("Error en acción:", error);
          mostrarMensaje("Error: " + error.message, "error");
        } finally {
          cargando = false;
        }
      }

      // Mostrar mensajes
      function mostrarMensaje(mensaje, tipo) {
        const div = document.createElement("div");
        div.className = tipo;
        div.innerHTML = `<strong>${tipo === "success" ? "Éxito:" : "Error:"}</strong> ${mensaje}`;

        mensajeContainer.appendChild(div);

        setTimeout(() => {
          div.remove();
        }, 5000);
      }

      // === FUNCIONES DE MODALES DE VALIDACIÓN ===
      let canchaIdActual = null;

      // Función para cargar historial de observaciones de una cancha
      async function cargarHistorialObservaciones(
        canchaId,
        historialElementId,
      ) {
        try {
          const response = await fetch(`/api/canchas/${canchaId}/validaciones`);
          if (!response.ok) {
            throw new Error("Error al cargar historial");
          }

          const validaciones = await response.json();
          const historialElement = document.getElementById(historialElementId);
          const content = historialElement.querySelector(".historial-content");

          if (validaciones.length === 0) {
            content.innerHTML =
              '<p style="color: #666; font-style: italic; text-align: center; padding: 2rem;">No hay observaciones previas</p>';
          } else {
            content.innerHTML = `
              <div class="historial-timeline">
                ${validaciones
                  .map((val, index) => {
                    let medicionesHtml = "";

                    if (val.mediciones) {
                      if (val.mediciones.espesores) {
                        // Mediciones de Linkapsis (formato anterior)
                        medicionesHtml = `
                        <div class="medicion-linea">
                          <span class="medicion-label">📏 Medición de Espesor:</span> <strong>${val.mediciones.espesores.join(", ")} ${val.mediciones.unidad || "metros"}</strong>
                          ${val.mediciones.promedio ? `<br><span style="font-size: 0.95rem; color: #666; margin-left: 1.5rem;">📊 Promedio: <strong>${val.mediciones.promedio} ${val.mediciones.unidad || "metros"}</strong></span>` : ""}
                        </div>`;
                      } else if (val.mediciones.espesor) {
                        // Nueva medición de Linkapsis
                        medicionesHtml = `
                        <div class="medicion-linea">
                          <span class="medicion-label">📏 Medición de Espesor:</span> <strong>${val.mediciones.espesor} ${val.mediciones.unidad || "metros"}</strong>
                        </div>`;
                      } else if (val.mediciones.densidad) {
                        // Mediciones de LlayLlay
                        medicionesHtml = `
                        <div class="medicion-linea">
                          <span class="medicion-label">⚖️ Medición de Densidad:</span> <strong>${val.mediciones.densidad} ${val.mediciones.unidad || "g/cm³"}</strong>
                        </div>`;
                      }
                    }

                    const empresaNombre =
                      val.empresa_validadora?.nombre || "Empresa desconocida";
                    const empresaClass = empresaNombre
                      .toLowerCase()
                      .replace(/\s+/g, "");

                    // Generar separador solo si no es la última entrada
                    const separador =
                      index < validaciones.length - 1
                        ? `
                    <div class="separador-empresas">
                      ──────────────────────────────────────
                    </div>`
                        : "";

                    return `
                    <div class="historial-entry empresa-${empresaClass}">
                      <div class="empresa-nombre">🏢 ${empresaNombre}</div>
                      <div class="fecha-linea">
                        <span class="fecha-label">📅 Fecha:</span> ${new Date(
                          val.created_at,
                        ).toLocaleDateString("es-ES", {
                          weekday: "short",
                          year: "numeric",
                          month: "short",
                          day: "numeric",
                          hour: "2-digit",
                          minute: "2-digit",
                        })}
                      </div>
                      <div class="observacion-linea">
                        <span class="observacion-label">💬 Observaciones:</span> "${val.observaciones || "Sin observaciones específicas"}"
                      </div>
                      ${medicionesHtml}
                    </div>${separador}`;
                  })
                  .join("")}
              </div>
            `;
          }
        } catch (error) {
          console.error("Error al cargar historial:", error);
          const historialElement = document.getElementById(historialElementId);
          const content = historialElement.querySelector(".historial-content");
          content.innerHTML =
            '<p style="color: #e74c3c;">Error al cargar historial</p>';
        }
      }

      function abrirModalBesalco(canchaId) {
        canchaIdActual = canchaId;
        const modal = document.getElementById("validacion-besalco-modal");
        const form = document.getElementById("form-validacion-besalco");

        // Limpiar formulario
        form.reset();

        // Cargar historial de observaciones
        cargarHistorialObservaciones(canchaId, "historial-besalco");

        // Mostrar modal
        modal.classList.add("show");
      }

      function abrirModalLinkapsis(canchaId) {
        canchaIdActual = canchaId;
        const modal = document.getElementById("validacion-linkapsis-modal");
        const form = document.getElementById("form-validacion-linkapsis");

        // Limpiar formulario básico
        form.reset();

        // Limpiar checkboxes específicamente
        document.getElementById("trabajo-corte").checked = false;
        document.getElementById("trabajo-relleno").checked = false;

        // Verificar si ya existen coordenadas previas de Linkapsis
        verificarCoordenadasExistentes(canchaId);

        // Cargar historial de observaciones (incluye observaciones de Besalco)
        cargarHistorialObservaciones(canchaId, "historial-linkapsis");

        // Mostrar modal
        modal.classList.add("show");
      }

      async function verificarCoordenadasExistentes(canchaId) {
        try {
          const response = await fetch(`/api/canchas/${canchaId}/validaciones`);
          const validaciones = await response.json();

          console.log("Validaciones obtenidas:", validaciones);

          // Buscar validaciones de Linkapsis (empresa_validadora_id = 3) que tengan coordenadas
          if (validaciones && validaciones.length > 0) {
            const validacionLinkapsis = validaciones.find(
              (v) =>
                v.empresa_validadora_id === 3 &&
                v.mediciones &&
                v.mediciones.coordenadas,
            );

            if (
              validacionLinkapsis &&
              validacionLinkapsis.mediciones &&
              validacionLinkapsis.mediciones.coordenadas
            ) {
              const coordenadas = validacionLinkapsis.mediciones.coordenadas;
              console.log("Coordenadas existentes encontradas:", coordenadas);
              console.log(
                "Validación Linkapsis completa:",
                validacionLinkapsis,
              );

              // Pre-llenar los campos con coordenadas existentes
              const coordMap = {
                "p1-norte": coordenadas.p1?.norte || "",
                "p1-este": coordenadas.p1?.este || "",
                "p1-cota": coordenadas.p1?.cota || "",
                "p2-norte": coordenadas.p2?.norte || "",
                "p2-este": coordenadas.p2?.este || "",
                "p2-cota": coordenadas.p2?.cota || "",
                "p3-norte": coordenadas.p3?.norte || "",
                "p3-este": coordenadas.p3?.este || "",
                "p3-cota": coordenadas.p3?.cota || "",
                "p4-norte": coordenadas.p4?.norte || "",
                "p4-este": coordenadas.p4?.este || "",
                "p4-cota": coordenadas.p4?.cota || "",
              };

              console.log("Mapa de coordenadas para llenar:", coordMap);

              // Llenar los campos si tienen valores
              Object.keys(coordMap).forEach((id) => {
                const input = document.getElementById(id);
                if (input && coordMap[id]) {
                  console.log(
                    `Llenando campo ${id} con valor: ${coordMap[id]}`,
                  );
                  input.value = coordMap[id];
                } else if (input) {
                  console.log(
                    `Campo ${id} encontrado pero sin valor para llenar`,
                  );
                } else {
                  console.log(`Campo ${id} NO encontrado en el DOM`);
                }
              });

              // Mantener espesor y checkboxes vacíos para nueva evaluación
              const espesorInput = document.getElementById("espesor-linkapsis");
              if (espesorInput) {
                espesorInput.value = "";
              }

              // Mantener checkboxes de tipo de trabajo sin marcar para nueva evaluación
              document.getElementById("trabajo-corte").checked = false;
              document.getElementById("trabajo-relleno").checked = false;
            } else {
              console.log(
                "No se encontraron validaciones previas de Linkapsis con coordenadas",
              );
              console.log("Validaciones disponibles:", validaciones);
              // No hay coordenadas previas, limpiar todos los campos
              const coordInputs = [
                "p1-norte",
                "p1-este",
                "p1-cota",
                "p2-norte",
                "p2-este",
                "p2-cota",
                "p3-norte",
                "p3-este",
                "p3-cota",
                "p4-norte",
                "p4-este",
                "p4-cota",
              ];

              coordInputs.forEach((id) => {
                const input = document.getElementById(id);
                if (input) input.value = "";
              });
            }
          }
        } catch (error) {
          console.error("Error al verificar coordenadas existentes:", error);
          // En caso de error, limpiar campos por seguridad
          const coordInputs = [
            "p1-norte",
            "p1-este",
            "p1-cota",
            "p2-norte",
            "p2-este",
            "p2-cota",
            "p3-norte",
            "p3-este",
            "p3-cota",
            "p4-norte",
            "p4-este",
            "p4-cota",
          ];

          coordInputs.forEach((id) => {
            const input = document.getElementById(id);
            if (input) input.value = "";
          });
        }
      }

      function abrirModalLlayLlay(canchaId) {
        canchaIdActual = canchaId;
        const modal = document.getElementById("validacion-llayllay-modal");
        const form = document.getElementById("form-validacion-llayllay");

        // Limpiar formulario
        form.reset();

        // Cargar historial de observaciones (incluye Besalco y Linkapsis)
        cargarHistorialObservaciones(canchaId, "historial-llayllay");

        // Mostrar modal
        modal.classList.add("show");
      }

      // ============ MODALES DE RECEPCIÓN (solo lectura + botón Comenzar) ============

      function abrirModalRecepcionBesalco(canchaId) {
        canchaIdActual = canchaId;
        const modal = document.getElementById("recepcion-besalco-modal");

        // Cargar historial de observaciones
        cargarHistorialObservaciones(canchaId, "historial-recepcion-besalco");

        // Mostrar modal
        modal.classList.add("show");
      }

      function abrirModalRecepcionLinkapsis(canchaId) {
        canchaIdActual = canchaId;
        const modal = document.getElementById("recepcion-linkapsis-modal");

        // Cargar historial de observaciones
        cargarHistorialObservaciones(canchaId, "historial-recepcion-linkapsis");

        // Mostrar modal
        modal.classList.add("show");
      }

      function abrirModalRecepcionLlayLlay(canchaId) {
        canchaIdActual = canchaId;
        const modal = document.getElementById("recepcion-llayllay-modal");

        // Cargar historial de observaciones
        cargarHistorialObservaciones(canchaId, "historial-recepcion-llayllay");

        // Mostrar modal
        modal.classList.add("show");
      }

      // ============ MODALES DE CIERRE Y BORRADO ============

      function abrirModalCierre(canchaId) {
        canchaIdActual = canchaId;
        const modal = document.getElementById("cerrar-cancha-modal");

        // Cargar historial completo para revisión final
        cargarHistorialObservaciones(canchaId, "historial-cierre");

        // Mostrar modal
        modal.classList.add("show");
      }

      function abrirModalBorrar(canchaId) {
        canchaIdActual = canchaId;
        const modal = document.getElementById("borrar-cancha-modal");
        const inputConfirmacion = document.getElementById(
          "confirmacion-borrado",
        );
        const btnConfirmar = document.getElementById("confirmar-borrado");

        // Limpiar input y deshabilitar botón
        inputConfirmacion.value = "";
        btnConfirmar.disabled = true;

        // Cargar historial que se eliminará
        cargarHistorialObservaciones(canchaId, "historial-borrado");

        // Mostrar modal
        modal.classList.add("show");
      }

      // Función para exportar PDF
      async function exportarPDF(canchaId) {
        try {
          cargando = true;
          mostrarMensaje("Generando PDF...", "info");

          // Abrir la URL de descarga directamente en una nueva ventana
          const url = `/api/canchas/${canchaId}/download-pdf`;
          window.open(url, "_blank");

          mostrarMensaje("PDF generado correctamente", "success");
        } catch (error) {
          console.error("Error al exportar PDF:", error);
          mostrarMensaje("Error al generar PDF: " + error.message, "error");
        } finally {
          cargando = false;
        }
      }

      function cerrarTodosLosModales() {
        document.querySelectorAll(".modal").forEach((modal) => {
          modal.classList.remove("show");
        });
        canchaIdActual = null;
      }

      // Cerrar modal al hacer click fuera
      window.addEventListener("click", (e) => {
        if (e.target.classList.contains("modal")) {
          cerrarTodosLosModales();
        }
      });

      // Event listeners para botones de cerrar y cancelar
      // === SISTEMA DE SELECCIÓN MÚLTIPLE ===
      let selectedCanchas = new Set();

      function initializeSelectionSystem() {
        const selectAllCheckbox = document.getElementById(
          "select-all-checkbox",
        );
        const bulkActionsBar = document.getElementById("bulk-actions-bar");
        const btnBulkDelete = document.getElementById("btn-bulk-delete");
        const btnBulkTimeline = document.getElementById("btn-bulk-timeline");
        const btnClearSelection = document.getElementById(
          "btn-clear-selection",
        );

        // Seleccionar/Deseleccionar todas
        if (selectAllCheckbox) {
          selectAllCheckbox.addEventListener("change", (e) => {
            const checkboxes = document.querySelectorAll(".cancha-checkbox");
            checkboxes.forEach((checkbox) => {
              checkbox.checked = e.target.checked;
              const canchaId = checkbox.dataset.canchaId;
              if (e.target.checked) {
                selectedCanchas.add(canchaId);
                checkbox.closest("tr").classList.add("selected");
              } else {
                selectedCanchas.delete(canchaId);
                checkbox.closest("tr").classList.remove("selected");
              }
            });
            updateBulkActionsBar();
          });
        }

        // Limpiar selección
        if (btnClearSelection) {
          btnClearSelection.addEventListener("click", clearSelection);
        }

        // Borrar canchas seleccionadas
        if (btnBulkDelete) {
          btnBulkDelete.addEventListener("click", handleBulkDelete);
        }

        // Ver timeline de canchas seleccionadas
        if (btnBulkTimeline) {
          btnBulkTimeline.addEventListener("click", openTimelineModal);
        }
      }

      // Manejar click en checkbox individual (se agrega después de renderizar)
      function attachCheckboxListeners() {
        document.querySelectorAll(".cancha-checkbox").forEach((checkbox) => {
          checkbox.addEventListener("change", (e) => {
            const canchaId = e.target.dataset.canchaId;
            const row = e.target.closest("tr");

            if (e.target.checked) {
              selectedCanchas.add(canchaId);
              row.classList.add("selected");
            } else {
              selectedCanchas.delete(canchaId);
              row.classList.remove("selected");
              document.getElementById("select-all-checkbox").checked = false;
            }

            updateBulkActionsBar();
          });
        });

        // Prevenir que el click en checkbox dispare el evento de la fila
        document.querySelectorAll(".cancha-checkbox").forEach((checkbox) => {
          checkbox.addEventListener("click", (e) => {
            e.stopPropagation();
          });
        });
      }

      function updateBulkActionsBar() {
        const bulkActionsBar = document.getElementById("bulk-actions-bar");
        const selectedCount = document.getElementById("selected-count");
        const btnBulkDelete = document.getElementById("btn-bulk-delete");
        const count = selectedCanchas.size;

        if (count > 0) {
          bulkActionsBar.classList.remove("hidden");
          selectedCount.textContent = `${count} cancha${count > 1 ? "s" : ""} seleccionada${count > 1 ? "s" : ""}`;

          // Mostrar botón de borrar solo si es AngloAmerican
          if (empresaLogueada && empresaLogueada.nombre === "AngloAmerican") {
            btnBulkDelete.classList.remove("hidden");
          } else {
            btnBulkDelete.classList.add("hidden");
          }
        } else {
          bulkActionsBar.classList.add("hidden");
        }
      }

      function clearSelection() {
        selectedCanchas.clear();
        document.querySelectorAll(".cancha-checkbox").forEach((checkbox) => {
          checkbox.checked = false;
          checkbox.closest("tr").classList.remove("selected");
        });
        document.getElementById("select-all-checkbox").checked = false;
        updateBulkActionsBar();
      }

      async function handleBulkDelete() {
        if (selectedCanchas.size === 0) return;

        const canchaIds = Array.from(selectedCanchas);

        // Si es solo una cancha, usar el modal normal
        if (canchaIds.length === 1) {
          abrirModalBorrar(canchaIds[0]);
          return;
        }

        // Si son múltiples canchas, abrir modal adaptado para borrado masivo
        abrirModalBorradoMasivo(canchaIds);
      }

      function abrirModalBorradoMasivo(canchaIds) {
        const modal = document.getElementById("borrar-cancha-modal");
        const inputConfirmacion = document.getElementById(
          "confirmacion-borrado",
        );
        const btnConfirmar = document.getElementById("confirmar-borrado");
        const historialDiv = document.getElementById("historial-borrado");

        // Limpiar input y deshabilitar botón
        inputConfirmacion.value = "";
        btnConfirmar.disabled = true;

        // Mostrar lista de canchas que se borrarán
        const canchaNames = canchaIds.map((id) => {
          const checkbox = document.querySelector(
            `.cancha-checkbox[data-cancha-id="${id}"]`,
          );
          return checkbox ? checkbox.dataset.canchaNombre : `ID ${id}`;
        });

        historialDiv.innerHTML = `
          <h4>⚠️ Se eliminarán ${canchaIds.length} canchas:</h4>
          <div class="historial-content" style="max-height: 200px; overflow-y: auto;">
            <ul style="margin: 0; padding-left: 1.5rem;">
              ${canchaNames.map((name) => `<li><strong>${name}</strong></li>`).join("")}
            </ul>
            <p style="margin-top: 1rem; color: #e74c3c; font-weight: 600;">
              Se eliminarán todas las validaciones y observaciones asociadas a estas canchas.
            </p>
          </div>
        `;

        // Guardar los IDs para el borrado
        modal.dataset.bulkDeleteIds = JSON.stringify(canchaIds);
        modal.dataset.isBulkDelete = "true";

        // Mostrar modal
        modal.classList.add("show");
      }

      document.addEventListener("DOMContentLoaded", () => {
        // === SISTEMA DE SELECCIÓN MÚLTIPLE ===
        initializeSelectionSystem();

        // Botones de cerrar (X)
        document.querySelectorAll(".close-btn").forEach((btn) => {
          btn.addEventListener("click", cerrarTodosLosModales);
        });

        // Botones de cancelar
        document.querySelectorAll(".btn-cancel").forEach((btn) => {
          btn.addEventListener("click", cerrarTodosLosModales);
        });

        // Formularios de validación
        configurarFormulariosValidacion();
      });

      function configurarFormulariosValidacion() {
        // Formulario Besalco
        const formBesalco = document.getElementById("form-validacion-besalco");
        if (formBesalco) {
          formBesalco.addEventListener("submit", procesarValidacionBesalco);

          const btnRechazar = formBesalco.querySelector(".btn-rechazar");
          if (btnRechazar) {
            btnRechazar.addEventListener("click", procesarRechazoBesalco);
          }
        }

        // Botones de "Comenzar Trabajo" en modales de recepción
        const btnComenzarBesalco = document.getElementById(
          "btn-comenzar-besalco",
        );
        if (btnComenzarBesalco) {
          btnComenzarBesalco.addEventListener("click", () =>
            comenzarTrabajo("Besalco"),
          );
        }

        const btnComenzarLinkapsis = document.getElementById(
          "btn-comenzar-linkapsis",
        );
        if (btnComenzarLinkapsis) {
          btnComenzarLinkapsis.addEventListener("click", () =>
            comenzarTrabajo("Linkapsis"),
          );
        }

        const btnComenzarLlayLlay = document.getElementById(
          "btn-comenzar-llayllay",
        );
        if (btnComenzarLlayLlay) {
          btnComenzarLlayLlay.addEventListener("click", () =>
            comenzarTrabajo("LlayLlay"),
          );
        }

        // Formulario Linkapsis
        const formLinkapsis = document.getElementById(
          "form-validacion-linkapsis",
        );
        if (formLinkapsis) {
          formLinkapsis.addEventListener("submit", procesarValidacionLinkapsis);

          const btnRechazar = formLinkapsis.querySelector(".btn-rechazar");
          if (btnRechazar) {
            btnRechazar.addEventListener("click", procesarRechazoLinkapsis);
          }
        }

        // Formulario LlayLlay
        const formLlayLlay = document.getElementById(
          "form-validacion-llayllay",
        );
        if (formLlayLlay) {
          formLlayLlay.addEventListener("submit", procesarValidacionLlayLlay);

          const btnRechazar = formLlayLlay.querySelector(".btn-rechazar");
          if (btnRechazar) {
            btnRechazar.addEventListener("click", procesarRechazoLlayLlay);
          }
        }

        // Botón de cierre definitivo
        const btnConfirmarCierre = document.getElementById("confirmar-cierre");
        if (btnConfirmarCierre) {
          btnConfirmarCierre.addEventListener("click", async () => {
            if (
              confirm(
                "¿Estás seguro de que deseas cerrar esta cancha definitivamente?",
              )
            ) {
              await ejecutarAccion("cerrar_cancha", canchaIdActual, null);
              cerrarTodosLosModales();
            }
          });
        }

        // Input de confirmación de borrado
        const inputConfirmacion = document.getElementById(
          "confirmacion-borrado",
        );
        const btnConfirmarBorrado =
          document.getElementById("confirmar-borrado");

        if (inputConfirmacion && btnConfirmarBorrado) {
          inputConfirmacion.addEventListener("input", () => {
            btnConfirmarBorrado.disabled =
              inputConfirmacion.value.trim() !== "borrar-cancha";
          });

          btnConfirmarBorrado.addEventListener("click", async () => {
            const modal = document.getElementById("borrar-cancha-modal");
            const isBulkDelete = modal.dataset.isBulkDelete === "true";

            if (isBulkDelete) {
              // Borrado masivo
              const canchaIds = JSON.parse(modal.dataset.bulkDeleteIds || "[]");
              await ejecutarBorradoMasivo(canchaIds);
            } else {
              // Borrado individual
              await ejecutarAccion("borrar_cancha", canchaIdActual, null);
            }

            // Limpiar dataset y cerrar modal
            delete modal.dataset.isBulkDelete;
            delete modal.dataset.bulkDeleteIds;
            cerrarTodosLosModales();
          });
        }
      }

      // === FUNCIONES DE PROCESAMIENTO DE VALIDACIONES ===

      // Función para cambiar estado de "En Espera" a "En Proceso"
      async function comenzarTrabajo(empresa) {
        try {
          if (!canchaIdActual) {
            mostrarMensaje("No hay cancha seleccionada", "error");
            return;
          }

          console.log(
            `Comenzando trabajo para ${empresa} en cancha ${canchaIdActual}`,
          );

          // Cambiar estado de En Espera (7) o Rechazada, en Espera (8) → En Proceso (3)
          const response = await fetch(
            `/api/canchas/${canchaIdActual}/accion`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                accion: "tomar_trabajo",
                empresa: empresa,
              }),
            },
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Error al comenzar trabajo");
          }

          const result = await response.json();
          console.log("Trabajo iniciado:", result);

          mostrarMensaje(`✅ Trabajo iniciado para ${empresa}`, "success");
          cerrarTodosLosModales();

          // Recargar canchas para actualizar la tabla
          await cargarCanchas();
        } catch (error) {
          console.error("Error al comenzar trabajo:", error);
          mostrarMensaje(`Error: ${error.message}`, "error");
        }
      }

      async function procesarValidacionBesalco(e) {
        e.preventDefault();

        const observaciones = document
          .getElementById("besalco-observaciones")
          .value.trim();
        if (!observaciones) {
          mostrarMensaje("Por favor ingresa observaciones", "error");
          return;
        }

        await ejecutarAccion(
          "finalizar_besalco",
          canchaIdActual,
          observaciones,
        );
      }

      async function procesarRechazoBesalco(e) {
        e.preventDefault();

        const observaciones = document
          .getElementById("besalco-observaciones")
          .value.trim();
        if (!observaciones) {
          mostrarMensaje(
            "Por favor ingresa observaciones del rechazo",
            "error",
          );
          return;
        }

        await ejecutarAccion("rechazar_besalco", canchaIdActual, observaciones);
      }

      async function procesarValidacionLinkapsis(e) {
        e.preventDefault();

        const observaciones = document
          .getElementById("linkapsis-observaciones")
          .value.trim();
        const espesor = parseFloat(
          document.getElementById("linkapsis-espesor").value,
        );

        if (!observaciones || !espesor) {
          mostrarMensaje(
            "Por favor completa las observaciones y la medición de espesor",
            "error",
          );
          return;
        }

        // Verificar si es revalidación
        const isRevalidacion = await esRevalidacion(
          canchaIdActual,
          "Linkapsis",
        );

        // Recopilar tipo de trabajo
        const tipoTrabajo = [];
        if (document.getElementById("trabajo-corte").checked) {
          tipoTrabajo.push("corte");
        }
        if (document.getElementById("trabajo-relleno").checked) {
          tipoTrabajo.push("relleno");
        }

        // Recopilar coordenadas de los 4 puntos
        const coordenadas = {
          p1: {
            norte:
              parseFloat(document.getElementById("p1-norte").value) || null,
            este: parseFloat(document.getElementById("p1-este").value) || null,
            cota: parseFloat(document.getElementById("p1-cota").value) || null,
          },
          p2: {
            norte:
              parseFloat(document.getElementById("p2-norte").value) || null,
            este: parseFloat(document.getElementById("p2-este").value) || null,
            cota: parseFloat(document.getElementById("p2-cota").value) || null,
          },
          p3: {
            norte:
              parseFloat(document.getElementById("p3-norte").value) || null,
            este: parseFloat(document.getElementById("p3-este").value) || null,
            cota: parseFloat(document.getElementById("p3-cota").value) || null,
          },
          p4: {
            norte:
              parseFloat(document.getElementById("p4-norte").value) || null,
            este: parseFloat(document.getElementById("p4-este").value) || null,
            cota: parseFloat(document.getElementById("p4-cota").value) || null,
          },
        };

        const mediciones = {
          espesor: espesor,
          unidad: "metros",
          tipoTrabajo: tipoTrabajo,
          coordenadas: coordenadas,
          isRevalidacion: isRevalidacion,
        };

        await ejecutarAccion(
          "validar_linkapsis",
          canchaIdActual,
          observaciones,
          mediciones,
        );
      }

      async function procesarRechazoLinkapsis(e) {
        e.preventDefault();

        const observaciones = document
          .getElementById("linkapsis-observaciones")
          .value.trim();
        const espesor = parseFloat(
          document.getElementById("linkapsis-espesor").value,
        );

        if (!observaciones) {
          mostrarMensaje(
            "Por favor ingresa observaciones del rechazo",
            "error",
          );
          return;
        }

        // Incluir mediciones aunque sea rechazo
        let mediciones = null;
        if (espesor) {
          // Recopilar tipo de trabajo si están marcados
          const tipoTrabajo = [];
          if (document.getElementById("trabajo-corte").checked) {
            tipoTrabajo.push("corte");
          }
          if (document.getElementById("trabajo-relleno").checked) {
            tipoTrabajo.push("relleno");
          }

          // Recopilar coordenadas si están disponibles
          const coordenadas = {
            p1: {
              norte:
                parseFloat(document.getElementById("p1-norte").value) || null,
              este:
                parseFloat(document.getElementById("p1-este").value) || null,
              cota:
                parseFloat(document.getElementById("p1-cota").value) || null,
            },
            p2: {
              norte:
                parseFloat(document.getElementById("p2-norte").value) || null,
              este:
                parseFloat(document.getElementById("p2-este").value) || null,
              cota:
                parseFloat(document.getElementById("p2-cota").value) || null,
            },
            p3: {
              norte:
                parseFloat(document.getElementById("p3-norte").value) || null,
              este:
                parseFloat(document.getElementById("p3-este").value) || null,
              cota:
                parseFloat(document.getElementById("p3-cota").value) || null,
            },
            p4: {
              norte:
                parseFloat(document.getElementById("p4-norte").value) || null,
              este:
                parseFloat(document.getElementById("p4-este").value) || null,
              cota:
                parseFloat(document.getElementById("p4-cota").value) || null,
            },
          };

          mediciones = {
            espesor: espesor,
            unidad: "metros",
            tipoTrabajo: tipoTrabajo,
            coordenadas: coordenadas,
          };
        }

        await ejecutarAccion(
          "rechazar_linkapsis",
          canchaIdActual,
          observaciones,
          mediciones,
        );
      }

      async function procesarValidacionLlayLlay(e) {
        e.preventDefault();

        const observaciones = document
          .getElementById("llayllay-observaciones")
          .value.trim();
        const densidad = parseFloat(
          document.getElementById("llayllay-densidad").value,
        );

        if (!observaciones || !densidad) {
          mostrarMensaje(
            "Por favor completa observaciones y densidad",
            "error",
          );
          return;
        }

        // Verificar si es revalidación
        const isRevalidacion = await esRevalidacion(canchaIdActual, "LlayLlay");

        const mediciones = {
          densidad: densidad,
          unidad: "g/cm³",
          isRevalidacion: isRevalidacion,
        };

        await ejecutarAccion(
          "validar_llay_llay",
          canchaIdActual,
          observaciones,
          mediciones,
        );
      }

      async function procesarRechazoLlayLlay(e) {
        e.preventDefault();

        const observaciones = document
          .getElementById("llayllay-observaciones")
          .value.trim();
        const densidad = parseFloat(
          document.getElementById("llayllay-densidad").value,
        );

        if (!observaciones) {
          mostrarMensaje(
            "Por favor ingresa observaciones del rechazo",
            "error",
          );
          return;
        }

        // Incluir mediciones aunque sea rechazo
        let mediciones = null;
        if (densidad) {
          mediciones = {
            densidad: densidad,
            unidad: "g/cm³",
          };
        }

        await ejecutarAccion(
          "rechazar_llay_llay",
          canchaIdActual,
          observaciones,
          mediciones,
        );
      }

      // Función auxiliar para determinar si es revalidación
      async function esRevalidacion(canchaId, empresa) {
        try {
          const response = await fetch(`/api/canchas/${canchaId}`);
          if (!response.ok) return false;

          const data = await response.json();
          const cancha = data.cancha;

          // Buscar validaciones previas de la misma empresa
          const validacionesPrevias =
            cancha.validaciones?.filter(
              (v) => v.empresa === empresa && v.estado === "VALIDADO",
            ) || [];

          return validacionesPrevias.length > 0;
        } catch (error) {
          console.error("Error al verificar revalidación:", error);
          return false;
        }
      }

      // Función unificada para ejecutar acciones
      async function ejecutarAccion(
        accion,
        canchaId,
        observaciones,
        mediciones = null,
      ) {
        try {
          cargando = true;

          const payload = {
            accion: accion,
            observaciones: observaciones,
            usuario: usuarioLogueado, // Incluir información del usuario actual
          };

          if (mediciones) {
            payload.mediciones = mediciones;
          }

          const response = await fetch(`/api/canchas/${canchaId}/accion`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            throw new Error("Error en la respuesta del servidor");
          }

          const resultado = await response.json();

          cerrarTodosLosModales();
          mostrarMensaje(`Acción completada exitosamente`, "success");

          // Recargar canchas para mostrar cambios
          await cargarCanchas();
        } catch (error) {
          console.error("Error al ejecutar acción:", error);
          mostrarMensaje("Error al procesar la acción", "error");
        } finally {
          cargando = false;
        }
      }

      // Función para ejecutar borrado masivo de canchas
      async function ejecutarBorradoMasivo(canchaIds) {
        try {
          cargando = true;
          let eliminadas = 0;
          let errores = 0;

          for (const canchaId of canchaIds) {
            try {
              // Usar el endpoint de acción con borrar_cancha
              const response = await fetch(`/api/canchas/${canchaId}/accion`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  accion: "borrar_cancha",
                }),
              });

              if (response.ok) {
                eliminadas++;
              } else {
                errores++;
                console.error(`Error al borrar cancha ${canchaId}`);
              }
            } catch (error) {
              errores++;
              console.error(`Error al borrar cancha ${canchaId}:`, error);
            }
          }

          // Limpiar selección
          clearSelection();

          // Mostrar resultado
          if (eliminadas > 0) {
            mostrarMensaje(
              `✅ ${eliminadas} cancha${eliminadas > 1 ? "s eliminadas" : " eliminada"} correctamente${errores > 0 ? `. ${errores} error${errores > 1 ? "es" : ""}` : ""}`,
              errores > 0 ? "warning" : "success",
            );
          } else {
            mostrarMensaje("❌ No se pudo eliminar ninguna cancha", "error");
          }

          // Recargar canchas
          await cargarCanchas();
        } catch (error) {
          console.error("Error en borrado masivo:", error);
          mostrarMensaje("Error al borrar las canchas seleccionadas", "error");
        } finally {
          cargando = false;
        }
      }

      // ========== FUNCIONES DEL TIMELINE ==========

      // Generar color aleatorio vibrante para cada cancha
      // Generar colores muy distintos entre sí usando una paleta predefinida
      function generateDistinctColors(count) {
        // Paleta de colores vibrantes y muy diferentes
        const distinctColors = [
          "#ef4444", // Rojo vibrante
          "#3b82f6", // Azul brillante
          "#10b981", // Verde esmeralda
          "#f59e0b", // Naranja dorado
          "#8b5cf6", // Púrpura
          "#ec4899", // Rosa fuerte
          "#06b6d4", // Cyan
          "#84cc16", // Lima
          "#f97316", // Naranja intenso
          "#6366f1", // Índigo
          "#14b8a6", // Turquesa
          "#eab308", // Amarillo
          "#a855f7", // Violeta
          "#22c55e", // Verde brillante
          "#f43f5e", // Rosa rojo
          "#0ea5e9", // Azul cielo
        ];

        // Si hay más canchas que colores, generar colores adicionales con HSL espaciados
        if (count > distinctColors.length) {
          const step = 360 / count;
          return Array.from({ length: count }, (_, i) => {
            const hue = Math.floor(i * step);
            return `hsl(${hue}, 75%, 55%)`;
          });
        }

        // Mezclar los colores para que no sigan un patrón predecible
        const shuffled = [...distinctColors].sort(() => Math.random() - 0.5);
        return shuffled.slice(0, count);
      }

      // Abrir modal de timeline
      async function openTimelineModal() {
        if (selectedCanchas.size === 0) {
          mostrarMensaje(
            "Selecciona al menos una cancha para ver el timeline",
            "warning",
          );
          return;
        }

        const modal = document.getElementById("timeline-modal");
        const legendContainer = document.getElementById("timeline-legend");
        const eventsContainer = document.getElementById("timeline-events");
        const modalTitle = modal.querySelector("h3"); // Get title element

        modal.style.display = "flex";

        try {
          cargando = true;

          // Obtener transiciones de todas las canchas seleccionadas
          const canchaIds = Array.from(selectedCanchas);
          const timelineData = await fetchTimelineData(canchaIds);

          // === SMART TITLE LOGIC ===
          if (timelineData.length > 1) {
            modalTitle.innerHTML = `
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
              </svg>
              Timeline Comparativo
            `;
          } else if (timelineData.length === 1) {
            modalTitle.innerHTML = `
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
              </svg>
              Timeline de Transiciones
            `;
          } else {
            modalTitle.innerHTML = `
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
              </svg>
              Timeline
            `;
          }

          // Generar colores distintos para cada cancha
          const colors = generateDistinctColors(timelineData.length);
          const canchaColors = {};
          timelineData.forEach((data, index) => {
            canchaColors[data.canchaId] = colors[index];
          });

          // Renderizar leyenda
          renderLegend(timelineData, canchaColors, legendContainer);

          // Renderizar timeline
          renderTimeline(timelineData, canchaColors, eventsContainer);

          // Inicializar checkboxes DESPUÉS de renderizar todo
          if (timelineData.length >= 2) {
            initializeTimelineCheckboxes();
          }
        } catch (error) {
          console.error("Error cargando timeline:", error);
          mostrarMensaje("Error al cargar el timeline", "error");
        } finally {
          cargando = false;
        }
      }

      // Obtener datos de transiciones para múltiples canchas
      async function fetchTimelineData(canchaIds) {
        const promises = canchaIds.map(async (id) => {
          try {
            const response = await fetch(`/api/canchas/${id}/timeline`);
            if (!response.ok) throw new Error("Error al obtener timeline");

            const data = await response.json();
            const cancha = todasLasCanchas.find((c) => c.id == id);

            return {
              canchaId: id,
              canchaName: cancha?.nombre || `Cancha ${id}`,
              transiciones: data.transiciones || [],
            };
          } catch (error) {
            console.error(`Error obteniendo timeline de cancha ${id}:`, error);
            return {
              canchaId: id,
              canchaName: `Cancha ${id}`,
              transiciones: [],
            };
          }
        });

        return await Promise.all(promises);
      }

      // Renderizar leyenda de canchas
      function renderLegend(timelineData, canchaColors, container) {
        if (!timelineData || timelineData.length === 0) {
          container.innerHTML = "";
          return;
        }

        const title =
          timelineData.length === 1
            ? "Cancha en Timeline"
            : `Canchas en Timeline (${timelineData.length})`;

        // Mostrar checkboxes solo si hay 2 o más canchas
        const showCheckboxes = timelineData.length >= 2;

        container.innerHTML =
          `<div class="timeline-legend-container">
            <div class="timeline-legend-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 6v6l4 2"></path>
              </svg>
              ${title}
            </div>
            <div class="timeline-legend-items">` +
          timelineData
            .map((data) => {
              const color = canchaColors[data.canchaId];
              const displayName = data.canchaName.replace(/_/g, " ");
              const checkboxHtml = showCheckboxes
                ? `<input type="checkbox" 
                         class="timeline-legend-checkbox" 
                         data-cancha-id="${data.canchaId}" 
                         checked 
                         title="Mostrar/ocultar eventos de esta cancha">`
                : "";

              return `
              <div class="timeline-legend-item ${showCheckboxes ? "with-checkbox" : ""}" 
                   style="color: ${color};" 
                   data-cancha-id="${data.canchaId}">
                ${checkboxHtml}
                <span class="timeline-legend-dot" style="background-color: ${color};"></span>
                <span class="timeline-legend-name">${displayName}</span>
              </div>
            `;
            })
            .join("") +
          `</div></div>`;
      }

      // Inicializar event listeners de checkboxes del timeline
      function initializeTimelineCheckboxes() {
        console.log("🔧 Inicializando checkboxes del timeline...");

        const checkboxes = document.querySelectorAll(
          ".timeline-legend-checkbox",
        );
        console.log(`📊 Encontrados ${checkboxes.length} checkboxes`);

        checkboxes.forEach((checkbox, index) => {
          const canchaId = checkbox.dataset.canchaId;
          console.log(
            `✅ Configurando checkbox ${index} para cancha ID: ${canchaId}`,
          );

          checkbox.addEventListener("change", (e) => {
            const isVisible = e.target.checked;
            console.log(
              `🔄 Toggle cancha ${canchaId}: ${isVisible ? "MOSTRAR" : "OCULTAR"}`,
            );
            toggleCanchaVisibility(canchaId, isVisible);
          });
        });
      }

      // Toggle visibilidad de eventos de una cancha específica
      function toggleCanchaVisibility(canchaId, isVisible) {
        console.log(
          `🎯 toggleCanchaVisibility llamado: cancha=${canchaId}, visible=${isVisible}`,
        );

        const events = document.querySelectorAll(
          `.timeline-event[data-cancha-id="${canchaId}"]`,
        );
        const legendItem = document.querySelector(
          `.timeline-legend-item[data-cancha-id="${canchaId}"]`,
        );

        console.log(
          `📍 Encontrados ${events.length} eventos para cancha ${canchaId}`,
        );
        console.log(`📍 Legend item encontrado:`, legendItem ? "SÍ" : "NO");

        events.forEach((event) => {
          if (isVisible) {
            event.classList.remove("hidden");
          } else {
            event.classList.add("hidden");
          }
        });

        // Actualizar estilo del item de leyenda
        if (legendItem) {
          if (isVisible) {
            legendItem.classList.remove("dimmed");
          } else {
            legendItem.classList.add("dimmed");
          }
        }

        console.log(`✅ Toggle completado para cancha ${canchaId}`);
      }

      // Renderizar timeline visual
      function renderTimeline(timelineData, canchaColors, container) {
        container.innerHTML = "";
        // Obtener todas las fechas para calcular el rango
        let allDates = [];
        let allTransitions = [];

        timelineData.forEach((data) => {
          data.transiciones.forEach((t) => {
            allDates.push(new Date(t.fecha_transicion));
            allTransitions.push({
              ...t,
              canchaId: data.canchaId,
              canchaName: data.canchaName,
              color: canchaColors[data.canchaId],
            });
          });
        });

        if (allDates.length === 0) {
          container.innerHTML =
            '<p style="text-align: center; padding: 2rem; color: #666;">No hay transiciones para mostrar</p>';
          return;
        }

        // Ordenar transiciones por fecha
        allTransitions.sort(
          (a, b) => new Date(a.fecha_transicion) - new Date(b.fecha_transicion),
        );

        const minDate = new Date(Math.min(...allDates));
        const maxDate = new Date(Math.max(...allDates));
        const timeRange = maxDate - minDate || 86400000; // Mínimo 1 día

        // Usar el ancho real del contenedor y calcular márgenes en porcentaje
        const totalWidth = container.parentElement.offsetWidth;
        const marginLeftPercent = 0.02; // 2% a la izquierda
        const marginRightPercent = 0.05; // 5% a la derecha (más espacio para la flecha)
        const marginLeft = totalWidth * marginLeftPercent;
        const marginRight = totalWidth * marginRightPercent;
        const containerWidth = totalWidth - marginLeft - marginRight; // Ancho útil sin márgenes
        const containerHeight = container.parentElement.offsetHeight;
        const startX = marginLeft; // Comenzar después del margen izquierdo
        const centerY = containerHeight / 2;

        // Agrupar eventos por posición X para evitar superposición
        const eventsByPosition = {};

        allTransitions.forEach((transicion) => {
          const eventDate = new Date(transicion.fecha_transicion);
          const xPosition =
            startX + ((eventDate - minDate) / timeRange) * containerWidth;
          const xKey = Math.round(xPosition / 5) * 5; // Agrupar por cada 5px

          if (!eventsByPosition[xKey]) {
            eventsByPosition[xKey] = [];
          }
          eventsByPosition[xKey].push({ transicion, xPosition });
        });

        // Renderizar cada evento
        Object.values(eventsByPosition).forEach((events) => {
          events.forEach((eventData, stackIndex) => {
            const { transicion, xPosition } = eventData;
            const eventDate = new Date(transicion.fecha_transicion);

            // Alternar eventos arriba y abajo de la línea central
            const isTop = stackIndex % 2 === 0;
            const offsetMultiplier = Math.floor(stackIndex / 2) + 1;
            const baseOffset = 80;
            const yOffset = baseOffset * offsetMultiplier;
            const yPosition = isTop ? centerY - yOffset : centerY + yOffset;

            // Crear marcador de evento
            const eventDiv = document.createElement("div");
            eventDiv.className = "timeline-event";
            eventDiv.setAttribute("data-cancha-id", transicion.canchaId);
            eventDiv.style.position = "absolute";
            eventDiv.style.left = `${xPosition}px`;
            eventDiv.style.top = `${centerY}px`;
            eventDiv.style.width = "0px";
            eventDiv.style.height = "0px";
            eventDiv.style.color = transicion.color;

            // Línea perpendicular desde el eje hasta el punto
            const line = document.createElement("div");
            line.className = "timeline-line";
            line.style.position = "absolute";
            line.style.backgroundColor = transicion.color;
            line.style.width = "4px";
            line.style.left = "50%";
            line.style.transform = "translateX(-50%)";

            if (isTop) {
              line.style.height = `${yOffset}px`;
              line.style.bottom = "0px";
            } else {
              line.style.height = `${yOffset}px`;
              line.style.top = "0px";
            }

            // Mapeo de nombres amigables para timeline
            const NOMBRES_ACCIONES_TIMELINE = {
              // AngloAmerican - Botón "CREAR CANCHA"
              crear_cancha: "Creación de Cancha",
              crear_cancha_con_poligono: "Creación de Cancha",

              // AngloAmerican - Botón "ENVIAR A BESALCO"
              enviar_besalco: "Envío a Besalco",

              // AngloAmerican - Botón "CERRAR CANCHA"
              cerrar_cancha: "Cierre de Cancha",

              // Besalco - Botón "RECEPCIONAR TRABAJO"
              recepcionar_besalco: "Trabajo recepcionado por Besalco",

              // Besalco - Botón "GESTIONAR" (finalizar y enviar a Linkapsis)
              finalizar_besalco: "Trabajo finalizado por Besalco",

              // Besalco - Botón "RECHAZAR"
              rechazar_besalco: "Trabajo rechazado por Besalco",

              // Linkapsis - Botón "RECEPCIONAR TRABAJO"
              recepcionar_linkapsis: "Trabajo recepcionado por Linkapsis",

              // Linkapsis - Botón "GESTIONAR" (validar espesores y enviar a LlayLlay)
              validar_linkapsis: "Espesores validados por Linkapsis",

              // Linkapsis - Botón "RECHAZAR"
              rechazar_linkapsis: "Espesores rechazados por Linkapsis",

              // LlayLlay - Botón "RECEPCIONAR TRABAJO"
              recepcionar_llay_llay: "Trabajo recepcionado por LlayLlay",

              // LlayLlay - Botón "GESTIONAR" (validar densidad y enviar a AA)
              validar_llay_llay: "Densidad validada por LlayLlay",

              // LlayLlay - Botón "RECHAZAR"
              rechazar_llay_llay: "Densidad rechazada por LlayLlay",

              // Genérico - Cualquier botón "RECHAZAR"
              rechazar_cancha: "Cancha rechazada",

              // Tomar trabajo (si se usa)
              tomar_trabajo: "Trabajo tomado",
            };

            const accionRaw = transicion.accion || "Sin acción";
            let accionTexto =
              NOMBRES_ACCIONES_TIMELINE[accionRaw] ||
              // Fallback: capitalizar si no está en el mapeo
              accionRaw
                .replace(/_/g, " ")
                .replace(/\b\w/g, (l) => l.toUpperCase());

            // Para 'tomar_trabajo', agregar el nombre de la empresa dinámicamente
            if (accionRaw === "tomar_trabajo" && transicion.empresa_nueva) {
              accionTexto = `Trabajo tomado por ${transicion.empresa_nueva}`;
            }

            // Mapeo de iniciales de empresas para mostrar en los puntos
            const INICIALES_EMPRESAS = {
              AngloAmerican: "AA",
              Besalco: "BS",
              Linkapsis: "LK",
              LlayLlay: "LL",
            };

            // Colores específicos para cada empresa
            const COLORES_EMPRESAS = {
              AA: "#3b82f6", // Azul
              BS: "#06b6d4", // Celeste/Cyan
              LK: "#f97316", // Naranja
              LL: "#ef4444", // Rojo
            };

            // Obtener iniciales de la empresa (usar empresa_nueva como prioridad)
            const empresaNombre =
              transicion.empresa_nueva || transicion.empresa_anterior || "";
            const inicialesEmpresa = INICIALES_EMPRESAS[empresaNombre] || "";

            // Punto en el eje
            const dot = document.createElement("div");
            dot.className = "timeline-dot";
            // Fondo blanco con borde de color de la cancha
            dot.style.backgroundColor = "#ffffff";
            dot.style.borderColor = transicion.color;
            dot.title = `${transicion.canchaName}\n${accionTexto}\n${eventDate.toLocaleDateString("es-CL")}`;

            // Agregar iniciales de la empresa dentro del punto
            if (inicialesEmpresa) {
              dot.textContent = inicialesEmpresa;
              const colorInicial =
                COLORES_EMPRESAS[inicialesEmpresa] || "#334155";
              dot.style.color = colorInicial;
              dot.style.display = "flex";
              dot.style.alignItems = "center";
              dot.style.justifyContent = "center";
              dot.style.fontSize = "10px";
              dot.style.fontWeight = "900";
              dot.style.letterSpacing = "-0.5px";
            }

            // Etiqueta de la acción
            const label = document.createElement("div");
            label.className = "timeline-label";

            if (timelineData.length > 1) {
              // Si hay múltiples canchas, mostrar nombre corto
              const nombreCorto =
                transicion.canchaName.length > 20
                  ? transicion.canchaName.substring(0, 17) + "..."
                  : transicion.canchaName;
              label.innerHTML = `<strong style="color: ${transicion.color};">${nombreCorto}</strong><br/>${accionTexto}`;
            } else {
              label.textContent = accionTexto;
            }

            if (isTop) {
              label.style.bottom = `${yOffset + 15}px`;
            } else {
              label.style.top = `${yOffset + 15}px`;
            }

            // Etiqueta de FECHA (Nueva implementación)
            const dateLabel = document.createElement("div");
            dateLabel.className = "timeline-event-date";
            dateLabel.textContent = eventDate.toLocaleDateString("es-CL", {
              day: "2-digit",
              month: "short",
            });

            // Añadir elementos al contenedor del evento
            eventDiv.appendChild(line);
            eventDiv.appendChild(dot);
            eventDiv.appendChild(label);
            eventDiv.appendChild(dateLabel);

            container.appendChild(eventDiv);
          });
        });

        // Renderizar marcadores de fecha en el eje
        renderDateMarkers(
          minDate,
          maxDate,
          containerWidth,
          startX,
          centerY,
          container,
        );
      }

      // Función para renderizar marcadores de fecha en el eje del timeline
      function renderDateMarkers(
        minDate,
        maxDate,
        containerWidth,
        startX,
        centerY,
        container,
      ) {
        const rangoTotal = maxDate - minDate;
        const diasTotales = rangoTotal / (1000 * 60 * 60 * 24);

        // Calcular intervalo óptimo según el rango de fechas
        let intervalo;
        if (diasTotales <= 15)
          intervalo = 2; // 2 días
        else if (diasTotales <= 30)
          intervalo = 3; // 3 días
        else intervalo = 5; // 5 días

        // Generar marcadores
        let currentDate = new Date(minDate);

        while (currentDate <= maxDate) {
          const xPosition =
            startX + ((currentDate - minDate) / rangoTotal) * containerWidth;

          const marker = document.createElement("div");
          marker.className = "timeline-date-marker";
          marker.style.left = `${xPosition}px`;
          marker.style.top = `${centerY - 70}px`; // Posicionar arriba del eje

          const label = document.createElement("div");
          label.className = "timeline-date-marker-label";
          label.textContent = currentDate.toLocaleDateString("es-CL", {
            day: "numeric",
            month: "short",
          });

          const line = document.createElement("div");
          line.className = "timeline-date-marker-line";

          // Agregar primero la etiqueta, luego la línea (para que la línea vaya hacia abajo)
          marker.appendChild(label);
          marker.appendChild(line);
          container.appendChild(marker);

          // Avanzar al siguiente marcador
          currentDate.setDate(currentDate.getDate() + intervalo);
        }
      }

      // Cerrar modal de timeline
      const timelineCloseBtn = document.getElementById("timeline-close-btn");
      if (timelineCloseBtn) {
        timelineCloseBtn.addEventListener("click", () => {
          const modal = document.getElementById("timeline-modal");
          modal.style.display = "none";
        });
      }

      // Funciones para el Modal del Mapa
      function abrirMapaModal(canchaId, canchaName) {
        console.log("🚀 abrirMapaModal llamado con:", { canchaId, canchaName });

        const modal = document.getElementById("mapModal");
        const mapContainer = document.getElementById("mapContainer");
        const canchaIdSpan = document.getElementById("mapCanchaId");
        const closeBtn = document.getElementById("mapCloseBtn");

        // Extraer el muro del nombre de la cancha (primera parte antes del primer _)
        const muro = canchaName ? canchaName.split("_")[0] : null;
        console.log(
          `🗺️ Abriendo mapa para cancha ${canchaId} (${canchaName}) - Muro detectado: ${muro}`,
        );

        // Mostrar ID y nombre de la cancha en el título
        canchaIdSpan.textContent = `${canchaId} (${canchaName || "Sin nombre"})`;

        // Agregar event listener al botón de cerrar
        closeBtn.addEventListener("click", cerrarMapaModal);

        // Mostrar el modal
        modal.classList.add("show");

        // Agregar evento para cerrar con Escape
        document.addEventListener("keydown", handleEscapeKey);

        // Mostrar indicador de carga
        mapContainer.innerHTML =
          '<div class="map-loading">Cargando mapa...</div>';

        // Cargar el mapa en un iframe con el filtro de muro y cancha ID
        setTimeout(() => {
          const iframe = document.createElement("iframe");
          // Pasar el muro y canchaId como parámetros en la URL
          let mapUrl = "/mapbox-window";
          const params = new URLSearchParams();

          if (muro) {
            params.set("muro", muro);
          }
          if (canchaId) {
            params.set("canchaId", canchaId);
          }

          if (params.toString()) {
            mapUrl += "?" + params.toString();
          }

          console.log("🌐 URL del mapa:", mapUrl);
          iframe.src = mapUrl;
          iframe.style.width = "100%";
          iframe.style.height = "100%";
          iframe.style.border = "none";
          iframe.style.borderRadius = "0 0 16px 16px";

          mapContainer.innerHTML = "";
          mapContainer.appendChild(iframe);
        }, 300);
      }

      function cerrarMapaModal() {
        const modal = document.getElementById("mapModal");
        const mapContainer = document.getElementById("mapContainer");
        const closeBtn = document.getElementById("mapCloseBtn");

        modal.classList.remove("show");

        // Remover event listeners
        document.removeEventListener("keydown", handleEscapeKey);
        closeBtn.removeEventListener("click", cerrarMapaModal);

        // Limpiar el contenido del mapa
        setTimeout(() => {
          mapContainer.innerHTML = "";
        }, 300);
      }

      function handleEscapeKey(e) {
        if (e.key === "Escape") {
          cerrarMapaModal();
        }
      }

      // Cerrar modal al hacer clic fuera del contenido
      document.addEventListener("click", function (e) {
        const modal = document.getElementById("mapModal");
        if (e.target === modal) {
          cerrarMapaModal();
        }

        const createModal = document.getElementById("createCanchaModal");
        if (e.target === createModal) {
          cerrarModalCrearCancha();
        }
      });

      // =====================================================
      // FUNCIONES PARA CREAR CANCHA CON POLÍGONO
      // =====================================================

      // Variable global para almacenar las coordenadas del polígono dibujado
      let poligonoCoordinadas = null;

      // Función para abrir el modal de crear cancha
      function abrirModalCrearCancha() {
        console.log("🏗️ Abriendo modal de crear cancha...");
        const modal = document.getElementById("createCanchaModal");
        const closeBtn = document.getElementById("createCanchaCloseBtn");

        // Resetear formulario
        document.getElementById("muro-select").value = "";
        document.getElementById("sector-select").value = "";
        document.getElementById("nombre-detalle-input").value = "";
        document.getElementById("open-drawing-btn").disabled = true;
        document.getElementById("create-cancha-btn").disabled = true;
        document.getElementById("drawing-status").innerHTML = "";
        document.getElementById("drawingMapContainer").style.display = "none";
        poligonoCoordinadas = null;

        // Inicializar estado del selector de sector
        const sectorSelect = document.getElementById("sector-select");
        sectorSelect.disabled = true;
        sectorSelect.innerHTML =
          '<option value="">Selecciona un muro primero</option>';

        // Agregar event listeners
        closeBtn.addEventListener("click", cerrarModalCrearCancha);
        document
          .getElementById("open-drawing-btn")
          .addEventListener("click", abrirMapaDibujo);
        document
          .getElementById("create-cancha-btn")
          .addEventListener("click", crearCanchaConPoligono);

        // Agregar listeners para validar formulario
        document
          .getElementById("muro-select")
          .addEventListener("change", validarFormularioCreacion);
        document
          .getElementById("sector-select")
          .addEventListener("change", validarFormularioCreacion);
        document
          .getElementById("nombre-detalle-input")
          .addEventListener("input", validarFormularioCreacion);

        modal.classList.add("show");

        // Agregar evento para cerrar con Escape
        document.addEventListener("keydown", handleEscapeKeyCrear);
      }

      // Función para cerrar el modal de crear cancha
      function cerrarModalCrearCancha() {
        console.log("❌ Cerrando modal de crear cancha...");
        const modal = document.getElementById("createCanchaModal");
        const closeBtn = document.getElementById("createCanchaCloseBtn");

        modal.classList.remove("show");

        // Remover event listeners
        document.removeEventListener("keydown", handleEscapeKeyCrear);
        window.removeEventListener("message", handleDrawingMessage);
        closeBtn.removeEventListener("click", cerrarModalCrearCancha);
        document
          .getElementById("open-drawing-btn")
          .removeEventListener("click", abrirMapaDibujo);
        document
          .getElementById("create-cancha-btn")
          .removeEventListener("click", crearCanchaConPoligono);
        document
          .getElementById("muro-select")
          .removeEventListener("change", validarFormularioCreacion);
        document
          .getElementById("sector-select")
          .removeEventListener("change", validarFormularioCreacion);
        document
          .getElementById("nombre-detalle-input")
          .removeEventListener("input", validarFormularioCreacion);

        // Limpiar el contenido del mapa de dibujo
        setTimeout(() => {
          document.getElementById("drawingMapContainer").innerHTML = "";
        }, 300);
      }

      // Función para validar el formulario y habilitar botones
      function validarFormularioCreacion() {
        const muro = document.getElementById("muro-select").value;
        const sector = document.getElementById("sector-select").value;
        const nombreDetalle = document
          .getElementById("nombre-detalle-input")
          .value.trim();

        // Solo actualizar opciones de sector si el muro cambió
        const sectorSelect = document.getElementById("sector-select");
        if (sectorSelect.dataset.ultimoMuro !== muro) {
          actualizarOpcionesSector(muro);
          sectorSelect.dataset.ultimoMuro = muro;
        }

        const formularioCompleto = muro && sector && nombreDetalle;
        document.getElementById("open-drawing-btn").disabled =
          !formularioCompleto;

        // Solo habilitar crear cancha si también hay polígono dibujado
        const puedeCrear = formularioCompleto && poligonoCoordinadas;
        document.getElementById("create-cancha-btn").disabled = !puedeCrear;

        console.log("🔍 Validación formulario:", {
          muro,
          sector,
          nombreDetalle,
          formularioCompleto,
          puedeCrear,
        });
      }

      // Función para actualizar las opciones del selector de sector
      function actualizarOpcionesSector(muro) {
        const sectorSelect = document.getElementById("sector-select");

        if (!muro) {
          sectorSelect.disabled = true;
          sectorSelect.innerHTML =
            '<option value="">Selecciona un muro primero</option>';
          return;
        }

        // Guardar la selección actual antes de regenerar
        const seleccionActual = sectorSelect.value;

        sectorSelect.disabled = false;

        // Determinar el rango de sectores según el muro
        let maxSector = 3; // Por defecto para MO y ME
        if (muro === "MP") {
          maxSector = 7;
        }

        // Generar opciones dinámicamente
        let opciones = '<option value="">Selecciona un sector</option>';
        for (let i = 1; i <= maxSector; i++) {
          opciones += `<option value="S${i}">S${i}</option>`;
        }

        sectorSelect.innerHTML = opciones;

        // Restaurar la selección anterior si es válida
        if (seleccionActual && seleccionActual.match(/^S[1-9]$/)) {
          const numeroSector = parseInt(seleccionActual.substring(1));
          if (numeroSector <= maxSector) {
            sectorSelect.value = seleccionActual;
          }
        }

        console.log(
          `📍 Muro ${muro} seleccionado - Sectores disponibles: S1 a S${maxSector}`,
        );
      }

      // Función para abrir el mapa de dibujo
      function abrirMapaDibujo() {
        console.log("🗺️ Abriendo mapa de dibujo...");
        const muro = document.getElementById("muro-select").value;
        const drawingContainer = document.getElementById("drawingMapContainer");
        const statusDiv = document.getElementById("drawing-status");

        // Mostrar status de carga
        statusDiv.innerHTML = "🔄 Cargando mapa de dibujo...";
        statusDiv.className = "drawing-status info";

        // Mostrar el contenedor del mapa
        drawingContainer.style.display = "block";

        // Crear iframe con el mapa de dibujo
        setTimeout(() => {
          const iframe = document.createElement("iframe");
          iframe.src = `/mapbox-window?muro=${encodeURIComponent(muro)}&drawing=true`;
          iframe.style.width = "100%";
          iframe.style.height = "100%";
          iframe.style.border = "none";

          // Limpiar listener anterior si existe
          window.removeEventListener("message", handleDrawingMessage);

          // Agregar listener para mensajes del iframe
          window.addEventListener("message", handleDrawingMessage);

          drawingContainer.innerHTML = "";
          drawingContainer.appendChild(iframe);

          statusDiv.innerHTML = "🎨 Herramientas de dibujo activas";
          statusDiv.className = "drawing-status info";
        }, 300);
      }

      // Función para manejar mensajes del iframe de dibujo
      function handleDrawingMessage(event) {
        if (event.data.type === "polygon-drawn") {
          poligonoCoordinadas = event.data.coordinates;
          console.log("✅ Polígono recibido del iframe:", poligonoCoordinadas);

          const statusDiv = document.getElementById("drawing-status");
          statusDiv.innerHTML = `✅ ¡Área dibujada correctamente! (${poligonoCoordinadas.length} puntos) Ahora puedes crear la cancha.`;
          statusDiv.className = "drawing-status success";

          // Validar formulario nuevamente para habilitar el botón de crear
          validarFormularioCreacion();
        } else if (event.data.type === "polygon-deleted") {
          poligonoCoordinadas = null;
          console.log("🗑️ Polígono eliminado del iframe");

          const statusDiv = document.getElementById("drawing-status");
          statusDiv.innerHTML = "🎨 Dibuja un nuevo área de trabajo en el mapa";
          statusDiv.className = "drawing-status info";

          // Validar formulario nuevamente para deshabilitar el botón de crear
          validarFormularioCreacion();
        }
      }

      // Función para crear la cancha con polígono
      async function crearCanchaConPoligono() {
        console.log("🚀 Creando cancha con polígono...");

        const muro = document.getElementById("muro-select").value;
        const sector = document.getElementById("sector-select").value;
        const nombreDetalle = document
          .getElementById("nombre-detalle-input")
          .value.trim();

        if (!muro || !sector || !nombreDetalle || !poligonoCoordinadas) {
          alert(
            "Por favor completa todos los campos y dibuja el área en el mapa",
          );
          return;
        }

        try {
          // Deshabilitar botón mientras se crea
          document.getElementById("create-cancha-btn").disabled = true;
          document.getElementById("create-cancha-btn").textContent =
            "Creando...";

          const response = await fetch("/api/canchas", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              muro,
              sector,
              nombreDetalle,
              poligonoCoordinadas,
            }),
          });

          if (!response.ok) {
            throw new Error("Error al crear la cancha");
          }

          const nuevaCancha = await response.json();
          console.log("✅ Cancha creada exitosamente:", nuevaCancha);

          // Cerrar modal
          cerrarModalCrearCancha();

          // Recargar la lista de canchas
          await cargarCanchas();

          // Mostrar mensaje de éxito
          mostrarMensaje(
            `Cancha ${nuevaCancha.nombre} creada exitosamente con área dibujada`,
            "success",
          );
        } catch (error) {
          console.error("❌ Error al crear cancha:", error);
          alert("Error al crear la cancha: " + error.message);
        } finally {
          // Restaurar botón
          document.getElementById("create-cancha-btn").disabled = false;
          document.getElementById("create-cancha-btn").textContent =
            "Crear Cancha";
        }
      }

      // Manejar tecla Escape para cerrar modal de crear cancha
      function handleEscapeKeyCrear(e) {
        if (e.key === "Escape") {
          cerrarModalCrearCancha();
        }
      }

      // Inicializar la aplicación
      inicializar();
    </script>

    <!-- Modal para Crear Cancha (solo AngloAmerican) -->
    <div id="createCanchaModal" class="map-modal">
      <div class="map-modal-content create-cancha-modal-content">
        <div class="map-modal-header">
          <h3 class="map-modal-title">Crear Nueva Cancha</h3>
          <button id="createCanchaCloseBtn" class="map-close-btn"
            >&times;</button
          >
        </div>
        <div class="create-cancha-container">
          <!-- Panel izquierdo: Formulario -->
          <div class="create-cancha-form">
            <h4 class="form-section-title">📋 Datos de la Cancha</h4>
            <div class="form-group">
              <label for="muro-select">Muro:</label>
              <select id="muro-select" required>
                <option value="">Seleccionar Muro</option>
                <option value="MP">MP</option>
                <option value="ME">ME</option>
                <option value="MO">MO</option>
              </select>
            </div>
            <div class="form-group">
              <label for="sector-select">Sector:</label>
              <select id="sector-select" disabled required>
                <option value="">Selecciona un muro primero</option>
              </select>
            </div>
            <div class="form-group">
              <label for="nombre-detalle-input">Nombre Detalle:</label>
              <input
                type="text"
                id="nombre-detalle-input"
                placeholder="ej: TEST1"
                required
              />
            </div>
            <div class="form-actions">
              <button id="open-drawing-btn" class="btn-primary" disabled
                >🗺️ Dibujar Área en Mapa</button
              >
              <button id="create-cancha-btn" class="btn-success" disabled
                >✅ Crear Cancha</button
              >
            </div>
            <div id="drawing-status" class="drawing-status"></div>
          </div>

          <!-- Panel derecho: Mapa -->
          <div class="create-cancha-map-panel">
            <div class="map-panel-header">
              <h4 class="map-panel-title">🗺️ Área de Trabajo</h4>
              <p class="map-panel-subtitle">
                Dibuja el polígono que define el área de la cancha
              </p>
            </div>
            <div id="drawingMapContainer" class="drawing-map-container">
              <!-- El mapa de dibujo se cargará aquí -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para el Mapa -->
    <div id="mapModal" class="map-modal">
      <div class="map-modal-content">
        <div class="map-modal-header">
          <h3 class="map-modal-title">
            Visor de Mapa - Cancha <span id="mapCanchaId"></span>
          </h3>
          <button id="mapCloseBtn" class="map-close-btn">&times;</button>
        </div>
        <div id="mapContainer" class="map-container">
          <!-- El mapa se cargará aquí dinámicamente -->
        </div>
      </div>
    </div>

    <script>
      // ========================================
      // PARSER INTELIGENTE DE REVANCHAS
      // ========================================

      // Configuraciones específicas por tipo de muro
      const CONFIGURACIONES_MURO = {
        principal: {
          nombre: "Muro Principal",
          headerRow: 12,
          dataStartRow: 13,
          dataEndRow: 85,
          dateCell: "F6", // Celda combinada F-M, filas 6-7
          columns: {
            sector: "A",
            coronamiento: "C",
            revancha: "E",
            lama: "F",
            ancho: "H",
            pk: "I",
            geomembrana: "J",
            distGeoLama: "K",
            distGeoCoronamiento: "L",
          },
          sectores: [
            { num: 1, startRow: 13, endRow: 23 },
            { num: 2, startRow: 24, endRow: 33 },
            { num: 3, startRow: 34, endRow: 43 },
            { num: 4, startRow: 44, endRow: 53 },
            { num: 5, startRow: 54, endRow: 63 },
            { num: 6, startRow: 64, endRow: 73 },
            { num: 7, startRow: 74, endRow: 85 },
          ],
        },
        oeste: {
          nombre: "Muro Oeste",
          headerRow: 9,
          dataStartRow: 10,
          dataEndRow: 45,
          dateCell: "F6", // Celda combinada F-M, filas 6-7
          columns: {
            sector: "A",
            coronamiento: "B",
            revancha: "E",
            lama: "F",
            ancho: "H",
            pk: "I",
            geomembrana: "J",
            distGeoLama: "K",
            distGeoCoronamiento: "L",
          },
          sectores: [
            { num: 1, startRow: 10, endRow: 23 },
            { num: 2, startRow: 24, endRow: 35 },
            { num: 3, startRow: 36, endRow: 45 },
          ],
        },
        este: {
          nombre: "Muro Este",
          headerRow: 12,
          dataStartRow: 13,
          dataEndRow: 41,
          dateCell: "F6", // Celda combinada F-M, filas 6-7
          columns: {
            sector: "A",
            coronamiento: "C",
            revancha: "E",
            lama: "F",
            ancho: "H",
            pk: "I",
            geomembrana: "J",
            distGeoLama: "K",
            distGeoCoronamiento: "L",
          },
          sectores: [
            { num: 1, startRow: 13, endRow: 22 },
            { num: 2, startRow: 23, endRow: 32 },
            { num: 3, startRow: 33, endRow: 41 },
          ],
        },
      };

      // Variables globales para mantener datos procesados
      let datosRevanchasActuales = null;
      let fechaRevanchasActual = null;
      let archivoRevanchasActual = null;

      // Inicializar funcionalidad de revanchas
      function inicializarRevanchas() {
        const tipoMuroSelect = document.getElementById("tipo-muro-revanchas");
        const fileInput = document.getElementById("file-revanchas");
        const btnProcesar = document.getElementById("btn-procesar-revanchas");

        // Habilitar input de archivo cuando se selecciona un muro
        if (tipoMuroSelect) {
          tipoMuroSelect.addEventListener("change", (e) => {
            const tipoMuro = e.target.value;
            if (fileInput) {
              fileInput.disabled = !tipoMuro;
              fileInput.value = "";
            }
            // Limpiar preview y datos
            ocultarPreview();
            datosRevanchasActuales = null;
            fechaRevanchasActual = null;
            archivoRevanchasActual = null;
            if (btnProcesar) {
              btnProcesar.disabled = true;
              btnProcesar.style.opacity = "0.5";
            }
          });
        }

        // Procesar archivo cuando se selecciona
        if (fileInput) {
          fileInput.addEventListener("change", async (e) => {
            const file = e.target.files[0];
            const tipoMuro = tipoMuroSelect?.value;

            if (!file || !tipoMuro) return;

            try {
              mostrarMensaje("Procesando archivo...", "info");
              const resultado = await procesarArchivoRevanchas(file, tipoMuro);

              // Guardar datos en variables globales
              datosRevanchasActuales = resultado.datos;
              fechaRevanchasActual = resultado.fecha;
              archivoRevanchasActual = file;

              mostrarPreview(resultado.datos, tipoMuro, resultado.fecha);
              mostrarMensaje("Archivo procesado correctamente", "exito");

              if (btnProcesar) {
                btnProcesar.disabled = false;
                btnProcesar.style.opacity = "1";
              }
            } catch (error) {
              console.error("Error procesando archivo:", error);
              mostrarMensaje(error.message, "error");
              ocultarPreview();
              datosRevanchasActuales = null;
              fechaRevanchasActual = null;
              archivoRevanchasActual = null;
              if (btnProcesar) {
                btnProcesar.disabled = true;
                btnProcesar.style.opacity = "0.5";
              }
            }
          });
        }

        // Configurar botón "Procesar Datos"
        if (btnProcesar) {
          btnProcesar.addEventListener("click", async () => {
            const tipoMuro = tipoMuroSelect?.value;

            if (
              !tipoMuro ||
              !datosRevanchasActuales ||
              !archivoRevanchasActual
            ) {
              mostrarMensaje("No hay datos para procesar", "error");
              return;
            }

            try {
              btnProcesar.disabled = true;
              btnProcesar.textContent = "⏳ Guardando...";
              btnProcesar.style.opacity = "0.7";

              // Convertir fecha de "dd-mm-yyyy" a "yyyy-mm-dd"
              const fechaISO = convertirFechaISO(fechaRevanchasActual);

              // Obtener usuario de la sesión
              let usuarioActual = null;
              try {
                const sessionData = localStorage.getItem("userSession");
                if (sessionData) {
                  const session = JSON.parse(sessionData);
                  usuarioActual = session.usuario; // ⚠️ Es 'usuario', no 'user'
                  console.log("👤 Usuario actual:", usuarioActual);
                }
              } catch (error) {
                console.error("Error obteniendo sesión:", error);
              }

              // Enviar a API
              const response = await fetch("/api/revanchas", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  muro: tipoMuro,
                  fechaMedicion: fechaISO,
                  archivoNombre: archivoRevanchasActual.name,
                  archivoTipo: archivoRevanchasActual.name.endsWith(".csv")
                    ? "CSV"
                    : "XLSX",
                  datos: datosRevanchasActuales,
                  usuarioId: usuarioActual?.id || null,
                }),
              });

              const resultado = await response.json();

              if (response.ok) {
                mostrarMensaje(
                  `✅ ${resultado.mensaje} (${resultado.data.totalRegistros} registros guardados)`,
                  "exito",
                );

                console.log(
                  "📊 Estadísticas calculadas:",
                  resultado.data.estadisticas,
                );

                // Cerrar modal después de 2 segundos
                setTimeout(() => {
                  const modal = document.getElementById(
                    "modal-subir-revanchas",
                  );
                  if (modal) {
                    modal.classList.remove("show");
                    // Limpiar todo
                    tipoMuroSelect.value = "";
                    fileInput.value = "";
                    fileInput.disabled = true;
                    ocultarPreview();
                    datosRevanchasActuales = null;
                    fechaRevanchasActual = null;
                    archivoRevanchasActual = null;
                  }
                }, 2000);
              } else {
                // Manejar errores específicos
                if (resultado.codigo === "ARCHIVO_DUPLICADO") {
                  mostrarMensaje(`⚠️ ${resultado.error}`, "error");
                } else {
                  mostrarMensaje(`❌ ${resultado.error}`, "error");
                }
                console.error("Error del servidor:", resultado);
              }
            } catch (error) {
              console.error("Error guardando datos:", error);
              mostrarMensaje(
                "❌ Error al comunicarse con el servidor",
                "error",
              );
            } finally {
              btnProcesar.disabled = false;
              btnProcesar.textContent = "Procesar Datos";
              btnProcesar.style.opacity = "1";
            }
          });
        }
      }

      /**
       * Convertir fecha de formato "dd-mm-yyyy" a "yyyy-mm-dd" (ISO)
       */
      function convertirFechaISO(fechaStr) {
        if (!fechaStr || fechaStr === "Fecha no encontrada") {
          // Si no hay fecha, usar hoy
          const hoy = new Date();
          return hoy.toISOString().split("T")[0];
        }

        // Formato esperado: "dd-mm-yyyy"
        const partes = fechaStr.split("-");
        if (partes.length === 3) {
          const [dia, mes, anio] = partes;
          return `${anio}-${mes}-${dia}`;
        }

        // Si ya está en formato ISO, devolverlo
        if (fechaStr.includes("-") && fechaStr.split("-")[0].length === 4) {
          return fechaStr;
        }

        // Fallback: usar hoy
        const hoy = new Date();
        return hoy.toISOString().split("T")[0];
      }

      // Procesar archivo (CSV o XLSX)
      async function procesarArchivoRevanchas(file, tipoMuro) {
        const config = CONFIGURACIONES_MURO[tipoMuro];
        if (!config) {
          throw new Error("Tipo de muro no válido");
        }

        // Leer archivo
        const data = await file.arrayBuffer();
        let workbook;

        try {
          // Intentar leer como Excel/CSV
          workbook = XLSX.read(data, { type: "array" });
        } catch (error) {
          throw new Error(
            "No se pudo leer el archivo. Asegúrese de que sea un archivo CSV o XLSX válido.",
          );
        }

        // Obtener primera hoja
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];

        // Validar estructura
        const esValido = validarEstructura(worksheet, config);
        if (!esValido) {
          throw new Error(
            `El archivo no corresponde a ${config.nombre}. Verifique que los headers estén en la fila ${config.headerRow} y que las columnas coincidan.`,
          );
        }

        // Extraer fecha del archivo (celda combinada F6-M7)
        const fechaArchivo = extraerFecha(worksheet, config.dateCell);

        // Extraer datos
        const datos = extraerDatos(worksheet, config);

        return { datos, fecha: fechaArchivo };
      }

      // Validar que la estructura del archivo coincida con la configuración del muro
      function validarEstructura(worksheet, config) {
        const headerRow = config.headerRow;

        // Verificar algunos headers clave
        const headersEsperados = [
          { col: config.columns.sector, nombre: "Sector" },
          { col: config.columns.coronamiento, nombre: "Coronamiento" },
          { col: config.columns.revancha, nombre: "Revancha" },
          { col: config.columns.lama, nombre: "Lama" },
        ];

        for (const header of headersEsperados) {
          const cellAddress = header.col + headerRow;
          const cell = worksheet[cellAddress];

          if (!cell || !cell.v) {
            console.warn(`Header no encontrado en ${cellAddress}`);
            return false;
          }

          const cellValue = String(cell.v).toLowerCase();
          const expectedValue = header.nombre.toLowerCase();

          if (!cellValue.includes(expectedValue)) {
            console.warn(
              `Header incorrecto en ${cellAddress}: esperado "${header.nombre}", encontrado "${cell.v}"`,
            );
            return false;
          }
        }

        return true;
      }

      // Extraer datos del worksheet según la configuración
      function extraerDatos(worksheet, config) {
        const datos = [];

        // Iterar por cada fila de datos
        for (let row = config.dataStartRow; row <= config.dataEndRow; row++) {
          // Determinar el sector según el rango de filas
          let sectorNum = null;
          for (const sector of config.sectores) {
            if (row >= sector.startRow && row <= sector.endRow) {
              sectorNum = sector.num;
              break;
            }
          }

          // Leer valores de cada columna
          const fila = {
            sector: sectorNum,
            coronamiento: getCellValue(
              worksheet,
              config.columns.coronamiento + row,
            ),
            revancha: getCellValue(worksheet, config.columns.revancha + row),
            lama: getCellValue(worksheet, config.columns.lama + row),
            ancho: getCellValue(worksheet, config.columns.ancho + row),
            pk: getCellValue(worksheet, config.columns.pk + row),
            geomembrana: getCellValue(
              worksheet,
              config.columns.geomembrana + row,
            ),
            distGeoLama: getCellValue(
              worksheet,
              config.columns.distGeoLama + row,
            ),
            distGeoCoronamiento: getCellValue(
              worksheet,
              config.columns.distGeoCoronamiento + row,
            ),
          };

          // Solo agregar si tiene al menos un valor
          if (Object.values(fila).some((v) => v !== null && v !== "")) {
            datos.push(fila);
          }
        }

        return datos;
      }

      // Obtener valor de una celda
      function getCellValue(worksheet, cellAddress) {
        const cell = worksheet[cellAddress];
        if (!cell || cell.v === undefined || cell.v === null) {
          return "";
        }
        return cell.v;
      }

      // Extraer fecha de la celda especificada (celda combinada F6-M7)
      function extraerFecha(worksheet, cellAddress) {
        const cell = worksheet[cellAddress];
        if (!cell || !cell.v) {
          return "Fecha no encontrada";
        }

        let fechaValue = cell.v;

        // Si es un número de serie de Excel, convertirlo a fecha
        if (typeof fechaValue === "number") {
          // Convertir número de serie de Excel a fecha JavaScript
          const excelEpoch = new Date(1899, 11, 30);
          const date = new Date(excelEpoch.getTime() + fechaValue * 86400000);
          fechaValue = date;
        }

        // Si es una fecha, formatearla como dd-mm-yyyy
        if (fechaValue instanceof Date) {
          const day = String(fechaValue.getDate()).padStart(2, "0");
          const month = String(fechaValue.getMonth() + 1).padStart(2, "0");
          const year = fechaValue.getFullYear();
          return `${day}-${month}-${year}`;
        }

        // Si ya es un string, devolverlo tal cual
        return String(fechaValue);
      }

      // Mostrar preview de datos
      function mostrarPreview(datos, tipoMuro, fecha) {
        const config = CONFIGURACIONES_MURO[tipoMuro];
        const previewDiv = document.getElementById("preview-revanchas");
        const infoDiv = document.getElementById("info-archivo-revanchas");
        const tablaDiv = document.getElementById("tabla-revanchas");

        if (!previewDiv || !infoDiv || !tablaDiv) return;

        // Mostrar información del archivo incluyendo la fecha
        infoDiv.innerHTML = `
          <strong>📊 Archivo procesado:</strong> ${config.nombre}<br>
          <strong>📈 Total de registros:</strong> ${datos.length}<br>
          <strong>🎯 Sectores encontrados:</strong> ${config.sectores.length}<br>
          <strong>📅 Fecha:</strong> ${fecha || "No disponible"}
        `;

        // Función para obtener clase de color según el valor y columna
        const obtenerClaseColor = (valor, columna) => {
          const num = parseFloat(valor);
          if (isNaN(num)) return "";

          switch (columna) {
            case "revancha":
              if (num > 3.5) return "valor-verde";
              if (num >= 3.0 && num <= 3.5) return "valor-amarillo";
              if (num < 3.0) return "valor-rojo";
              break;
            case "ancho":
              if (num > 18) return "valor-verde";
              if (num >= 15 && num <= 18) return "valor-amarillo";
              if (num < 15) return "valor-rojo";
              break;
            case "distGeoCoronamiento":
              if (num > 1) return ""; // Sin color
              if (num >= 0.5 && num <= 1) return "valor-amarillo";
              if (num < 0.5) return "valor-rojo";
              break;
            default:
              return "";
          }
          return "";
        };

        // Renderizar tabla principal con scroll independiente y colores condicionales
        const tablaHTML = `
          <div class="tabla-datos-scroll">
            <table class="tabla-revanchas">
              <thead>
                <tr>
                  <th>Sector</th>
                  <th>Coronamiento</th>
                  <th>Revancha</th>
                  <th>Lama</th>
                  <th>Ancho</th>
                  <th>PK</th>
                  <th>Geomembrana</th>
                  <th>Dist Geo-Lama</th>
                  <th>Dist Geo-Coronamiento</th>
                </tr>
              </thead>
              <tbody>
                ${datos
                  .map(
                    (row) => `
                  <tr class="sector-${row.sector}">
                    <td class="sector-col">Sector ${row.sector}</td>
                    <td>${formatValue(row.coronamiento)}</td>
                    <td class="${obtenerClaseColor(row.revancha, "revancha")}">${formatValue(row.revancha, true)}</td>
                    <td>${formatValue(row.lama)}</td>
                    <td class="${obtenerClaseColor(row.ancho, "ancho")}">${formatValue(row.ancho)}</td>
                    <td>${formatValue(row.pk)}</td>
                    <td>${formatValue(row.geomembrana)}</td>
                    <td>${formatValue(row.distGeoLama, true)}</td>
                    <td class="${obtenerClaseColor(row.distGeoCoronamiento, "distGeoCoronamiento")}">${formatValue(row.distGeoCoronamiento, true)}</td>
                  </tr>
                `,
                  )
                  .join("")}
              </tbody>
            </table>
          </div>
        `;

        // Calcular estadísticas para la tabla de resumen
        const calcularEstadisticas = (campo) => {
          const valoresValidos = datos
            .map((row) => parseFloat(row[campo]))
            .filter((val) => !isNaN(val) && val !== null && val !== undefined);

          if (valoresValidos.length === 0) {
            return { min: null, pkMin: null, max: null, pkMax: null };
          }

          const min = Math.min(...valoresValidos);
          const max = Math.max(...valoresValidos);

          // Encontrar el PK correspondiente al valor mínimo
          const rowMin = datos.find((row) => parseFloat(row[campo]) === min);
          const pkMin = rowMin ? rowMin.pk : null;

          // Encontrar el PK correspondiente al valor máximo
          const rowMax = datos.find((row) => parseFloat(row[campo]) === max);
          const pkMax = rowMax ? rowMax.pk : null;

          return { min, pkMin, max, pkMax };
        };

        const statsRevancha = calcularEstadisticas("revancha");
        const statsAncho = calcularEstadisticas("ancho");
        const statsCoronamiento = calcularEstadisticas("coronamiento");

        // Generar tabla de resumen (sin clases de color)
        const tablaResumenHTML = `
          <table class="tabla-resumen">
            <thead>
              <tr>
                <th colspan="5">Resumen ${config.nombre} - ${fecha || "Sin fecha"}</th>
              </tr>
              <tr>
                <th>PARÁMETROS</th>
                <th>MIN</th>
                <th>PK MIN</th>
                <th>MAX</th>
                <th>PK MAX</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>REVANCHA (m)</td>
                <td>${statsRevancha.min !== null ? statsRevancha.min.toFixed(3) : "-"}</td>
                <td>${statsRevancha.pkMin !== null ? statsRevancha.pkMin : "-"}</td>
                <td>${statsRevancha.max !== null ? statsRevancha.max.toFixed(3) : "-"}</td>
                <td>${statsRevancha.pkMax !== null ? statsRevancha.pkMax : "-"}</td>
              </tr>
              <tr>
                <td>ANCHO (m)</td>
                <td>${statsAncho.min !== null ? statsAncho.min.toFixed(3) : "-"}</td>
                <td>${statsAncho.pkMin !== null ? statsAncho.pkMin : "-"}</td>
                <td>${statsAncho.max !== null ? statsAncho.max.toFixed(3) : "-"}</td>
                <td>${statsAncho.pkMax !== null ? statsAncho.pkMax : "-"}</td>
              </tr>
              <tr>
                <td>COTA CORONAMIENTO (m)</td>
                <td>${statsCoronamiento.min !== null ? statsCoronamiento.min.toFixed(3) : "-"}</td>
                <td>${statsCoronamiento.pkMin !== null ? statsCoronamiento.pkMin : "-"}</td>
                <td>${statsCoronamiento.max !== null ? statsCoronamiento.max.toFixed(3) : "-"}</td>
                <td>${statsCoronamiento.pkMax !== null ? statsCoronamiento.pkMax : "-"}</td>
              </tr>
            </tbody>
          </table>
        `;

        // Insertar tabla principal en su contenedor
        tablaDiv.innerHTML = tablaHTML;

        // Crear o actualizar contenedor para tabla de resumen (fuera del scroll)
        let resumenContainer = document.getElementById(
          "resumen-revanchas-container",
        );
        if (!resumenContainer) {
          resumenContainer = document.createElement("div");
          resumenContainer.id = "resumen-revanchas-container";
          resumenContainer.style.marginTop = "1.5rem";
          // Insertar después del contenedor de la tabla principal
          tablaDiv.parentNode.insertBefore(
            resumenContainer,
            tablaDiv.nextSibling,
          );
        }
        resumenContainer.innerHTML = tablaResumenHTML;

        // Calcular estadísticas por sector
        const sectoresUnicos = [
          ...new Set(datos.map((row) => row.sector)),
        ].sort();

        const calcularEstadisticasPorSector = (sector, campo) => {
          const datosSector = datos.filter((row) => row.sector === sector);
          const valoresValidos = datosSector
            .map((row) => parseFloat(row[campo]))
            .filter((val) => !isNaN(val) && val !== null && val !== undefined);

          if (valoresValidos.length === 0) {
            return { min: null, pkMin: null, max: null, pkMax: null };
          }

          const min = Math.min(...valoresValidos);
          const max = Math.max(...valoresValidos);

          const rowMin = datosSector.find(
            (row) => parseFloat(row[campo]) === min,
          );
          const pkMin = rowMin ? rowMin.pk : null;

          const rowMax = datosSector.find(
            (row) => parseFloat(row[campo]) === max,
          );
          const pkMax = rowMax ? rowMax.pk : null;

          return { min, pkMin, max, pkMax };
        };

        // Generar tabla de resumen por sectores
        let tablaSectoresHTML = `
          <table class="tabla-resumen-sectores">
            <thead>
              <tr>
                <th colspan="7">Resumen por Sector - ${config.nombre} - ${fecha || "Sin fecha"}</th>
              </tr>
              <tr style="background: #6d28d9;">
                <th>SECTOR</th>
                <th colspan="2">REVANCHA (m)</th>
                <th colspan="2">ANCHO (m)</th>
                <th colspan="2">CORONAMIENTO (m)</th>
              </tr>
              <tr style="background: #7c3aed;">
                <th></th>
                <th>MIN (PK)</th>
                <th>MAX (PK)</th>
                <th>MIN (PK)</th>
                <th>MAX (PK)</th>
                <th>MIN (PK)</th>
                <th>MAX (PK)</th>
              </tr>
            </thead>
            <tbody>`;

        sectoresUnicos.forEach((sector) => {
          const statsRevancha = calcularEstadisticasPorSector(
            sector,
            "revancha",
          );
          const statsAncho = calcularEstadisticasPorSector(sector, "ancho");
          const statsCoronamiento = calcularEstadisticasPorSector(
            sector,
            "coronamiento",
          );

          tablaSectoresHTML += `
              <tr>
                <td>Sector ${sector}</td>
                <td>${statsRevancha.min !== null ? statsRevancha.min.toFixed(3) + " (" + statsRevancha.pkMin + ")" : "-"}</td>
                <td>${statsRevancha.max !== null ? statsRevancha.max.toFixed(3) + " (" + statsRevancha.pkMax + ")" : "-"}</td>
                <td>${statsAncho.min !== null ? statsAncho.min.toFixed(3) + " (" + statsAncho.pkMin + ")" : "-"}</td>
                <td>${statsAncho.max !== null ? statsAncho.max.toFixed(3) + " (" + statsAncho.pkMax + ")" : "-"}</td>
                <td>${statsCoronamiento.min !== null ? statsCoronamiento.min.toFixed(3) + " (" + statsCoronamiento.pkMin + ")" : "-"}</td>
                <td>${statsCoronamiento.max !== null ? statsCoronamiento.max.toFixed(3) + " (" + statsCoronamiento.pkMax + ")" : "-"}</td>
              </tr>`;
        });

        tablaSectoresHTML += `
            </tbody>
          </table>
        `;

        // Crear o actualizar contenedor para tabla de resumen por sectores
        let sectoresContainer = document.getElementById(
          "resumen-sectores-container",
        );
        if (!sectoresContainer) {
          sectoresContainer = document.createElement("div");
          sectoresContainer.id = "resumen-sectores-container";
          sectoresContainer.style.marginTop = "1.5rem";
          // Insertar después del contenedor de resumen general
          resumenContainer.parentNode.insertBefore(
            sectoresContainer,
            resumenContainer.nextSibling,
          );
        }
        sectoresContainer.innerHTML = tablaSectoresHTML;

        // Crear gráfico de perfil
        let perfilContainer = document.getElementById("perfil-chart-container");
        if (!perfilContainer) {
          perfilContainer = document.createElement("div");
          perfilContainer.id = "perfil-chart-container";
          perfilContainer.className = "perfil-chart-container";
          // Insertar después del contenedor de resumen por sectores
          sectoresContainer.parentNode.insertBefore(
            perfilContainer,
            sectoresContainer.nextSibling,
          );
        }

        // Preparar datos para el gráfico
        const datosOrdenados = [...datos].sort((a, b) => {
          const pkA = parseFloat(a.pk) || 0;
          const pkB = parseFloat(b.pk) || 0;
          return pkA - pkB;
        });

        const labels = datosOrdenados.map((row) => row.pk);
        const coronamientoData = datosOrdenados.map((row) =>
          parseFloat(row.coronamiento),
        );
        const geomembranaData = datosOrdenados.map((row) =>
          parseFloat(row.geomembrana),
        );
        const lamaData = datosOrdenados.map((row) => parseFloat(row.lama));

        perfilContainer.innerHTML = `
          <div class="perfil-chart-title">Perfil de Elevaciones - ${config.nombre} - ${fecha || "Sin fecha"}</div>
          <div class="perfil-chart-canvas">
            <canvas id="perfil-canvas"></canvas>
          </div>
        `;

        // Crear el gráfico con Chart.js
        const ctx = document.getElementById("perfil-canvas").getContext("2d");

        // Destruir gráfico anterior si existe
        if (window.perfilChart) {
          window.perfilChart.destroy();
        }

        window.perfilChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Coronamiento",
                data: coronamientoData,
                borderColor: "#dc2626",
                backgroundColor: "rgba(220, 38, 38, 0.1)",
                borderWidth: 2,
                tension: 0.1,
                pointRadius: 2,
                pointHoverRadius: 5,
              },
              {
                label: "Geomembrana",
                data: geomembranaData,
                borderColor: "#2563eb",
                backgroundColor: "rgba(37, 99, 235, 0.1)",
                borderWidth: 2,
                tension: 0.1,
                pointRadius: 2,
                pointHoverRadius: 5,
              },
              {
                label: "Lama",
                data: lamaData,
                borderColor: "#16a34a",
                backgroundColor: "rgba(22, 163, 74, 0.1)",
                borderWidth: 2,
                tension: 0.1,
                pointRadius: 2,
                pointHoverRadius: 5,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: "index",
              intersect: false,
            },
            plugins: {
              legend: {
                display: true,
                position: "top",
                labels: {
                  font: {
                    size: 12,
                    weight: "bold",
                  },
                  padding: 15,
                },
              },
              tooltip: {
                backgroundColor: "rgba(0, 0, 0, 0.8)",
                padding: 12,
                titleFont: {
                  size: 14,
                },
                bodyFont: {
                  size: 13,
                },
                callbacks: {
                  label: function (context) {
                    return (
                      context.dataset.label +
                      ": " +
                      context.parsed.y.toFixed(3) +
                      " m"
                    );
                  },
                },
              },
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: "PK (Progresiva)",
                  font: {
                    size: 14,
                    weight: "bold",
                  },
                },
                ticks: {
                  maxRotation: 45,
                  minRotation: 45,
                  autoSkip: true,
                  maxTicksLimit: 20,
                },
              },
              y: {
                title: {
                  display: true,
                  text: "Cota (m)",
                  font: {
                    size: 14,
                    weight: "bold",
                  },
                },
                min: 730,
                max: 745,
                ticks: {
                  stepSize: 1,
                },
              },
            },
          },
        });

        previewDiv.style.display = "block";
      }

      // Formatear valor para mostrar
      function formatValue(value, roundToThreeDecimals = false) {
        if (value === null || value === undefined || value === "") {
          return '<span style="color: #cbd5e1;">-</span>';
        }

        // Si es un número y se requiere redondeo a 3 decimales
        if (roundToThreeDecimals && typeof value === "number") {
          return value.toFixed(3);
        }

        // Si es un string que parece número y se requiere redondeo
        if (roundToThreeDecimals && typeof value === "string") {
          const num = parseFloat(value);
          if (!isNaN(num)) {
            return num.toFixed(3);
          }
        }

        return value;
      }

      // Ocultar preview
      function ocultarPreview() {
        const previewDiv = document.getElementById("preview-revanchas");
        if (previewDiv) {
          previewDiv.style.display = "none";
        }
      }

      // Mostrar mensaje
      function mostrarMensaje(texto, tipo) {
        const mensajeDiv = document.getElementById("mensaje-revanchas");
        if (!mensajeDiv) return;

        mensajeDiv.className = `mensaje-${tipo}`;
        mensajeDiv.textContent = texto;
        mensajeDiv.style.display = "block";

        // Auto-ocultar mensajes de éxito e info
        if (tipo === "exito" || tipo === "info") {
          setTimeout(() => {
            mensajeDiv.style.display = "none";
          }, 3000);
        }
      }

      // Inicializar cuando el DOM esté listo
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", inicializarRevanchas);
      } else {
        inicializarRevanchas();
      }

      // ========================================
      // FORMULARIO DE SUBIR CANCHAS (MEJORADO CON SELECCIÓN)
      // ========================================

      // Inicializar funcionalidad de Subir Canchas
      function inicializarSubirCanchas() {
        cargarResponsables();
        configurarNavegacionModal();
        configurarSelectorMuro("cancha");
        configurarSelectorMuro("muestra");
        configurarPreviewFoto("cancha");
        configurarPreviewFoto("muestra");
        configurarFormularioCanchas();
        configurarFormularioMuestras();
      }

      // Configurar navegación entre pantallas del modal
      function configurarNavegacionModal() {
        const seleccionTipo = document.getElementById("seleccion-tipo");
        const formularioCancha = document.getElementById("formulario-cancha");
        const formularioMuestra = document.getElementById("formulario-muestra");
        const tipoCards = document.querySelectorAll(".tipo-card");
        const botonesVolver = document.querySelectorAll(".btn-volver");

        // Click en tarjetas de selección
        tipoCards.forEach((card) => {
          card.addEventListener("click", () => {
            const tipo = card.dataset.tipo;

            if (tipo === "cancha") {
              seleccionTipo.style.display = "none";
              formularioCancha.style.display = "block";
              formularioMuestra.style.display = "none";
            } else if (tipo === "muestra") {
              seleccionTipo.style.display = "none";
              formularioCancha.style.display = "none";
              formularioMuestra.style.display = "block";
            }
          });
        });

        // Click en botones "Volver"
        botonesVolver.forEach((btn) => {
          btn.addEventListener("click", () => {
            seleccionTipo.style.display = "block";
            formularioCancha.style.display = "none";
            formularioMuestra.style.display = "none";
          });
        });
      }

      // Configurar selector dinámico de Muro -> Sector (genérico)
      function configurarSelectorMuro(tipo) {
        const muroSelect = document.getElementById(`muro-${tipo}`);
        const sectorSelect = document.getElementById(`sector-${tipo}`);

        if (!muroSelect || !sectorSelect) return;

        muroSelect.addEventListener("change", (e) => {
          const muro = e.target.value;
          sectorSelect.disabled = !muro;

          if (muro === "Principal") {
            llenarSectores(sectorSelect, 7); // S1-S7
          } else if (muro === "Este" || muro === "Oeste") {
            llenarSectores(sectorSelect, 3); // S1-S3
          } else {
            sectorSelect.innerHTML =
              '<option value="">Seleccione muro primero...</option>';
          }
        });
      }

      // Llenar opciones de sector según cantidad
      function llenarSectores(select, cantidad) {
        select.innerHTML = '<option value="">Seleccione...</option>';
        for (let i = 1; i <= cantidad; i++) {
          const option = document.createElement("option");
          option.value = `S${i}`;
          option.textContent = `S${i}`;
          select.appendChild(option);
        }
      }

      // Configurar preview de foto (genérico)
      function configurarPreviewFoto(tipo) {
        const fotoInput = document.getElementById(`foto-${tipo}`);
        const previewDiv = document.getElementById(`preview-foto-${tipo}`);
        const imgPreview = document.getElementById(`img-preview-${tipo}`);

        if (!fotoInput || !previewDiv || !imgPreview) return;

        fotoInput.addEventListener("change", (e) => {
          const file = e.target.files[0];

          if (file && file.type.startsWith("image/")) {
            // Validar tamaño (5MB máximo)
            if (file.size > 5 * 1024 * 1024) {
              alert("La imagen es demasiado grande. Máximo 5MB.");
              fotoInput.value = "";
              previewDiv.style.display = "none";
              return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
              imgPreview.src = e.target.result;
              previewDiv.style.display = "block";
            };
            reader.readAsDataURL(file);
          } else {
            previewDiv.style.display = "none";
          }
        });
      }

      // Cargar responsables desde la base de datos
      async function cargarResponsables() {
        const select = document.getElementById("responsable-cancha");
        if (!select) return;

        try {
          const response = await fetch("/api/usuarios");

          if (!response.ok) {
            throw new Error("Error al cargar usuarios");
          }

          const data = await response.json();

          if (data.success && data.usuarios) {
            // Filtrar solo usuarios de Linkapsis (empresa_id = 3) activos
            const usuariosLinkapsis = data.usuarios.filter(
              (usuario) => usuario.empresa_id === 3 && usuario.activo,
            );

            select.innerHTML = '<option value="">Seleccione...</option>';

            usuariosLinkapsis.forEach((usuario) => {
              const option = document.createElement("option");
              option.value = usuario.id;
              option.textContent = usuario.nombre_completo || usuario.nombre;
              select.appendChild(option);
            });

            if (usuariosLinkapsis.length === 0) {
              select.innerHTML =
                '<option value="">No hay usuarios de Linkapsis disponibles</option>';
            }
          } else {
            select.innerHTML =
              '<option value="">Error al cargar usuarios</option>';
          }
        } catch (error) {
          console.error("Error cargando responsables:", error);
          select.innerHTML =
            '<option value="">Error al cargar usuarios</option>';
        }
      }

      // Configurar manejo del formulario CANCHA
      function configurarFormularioCanchas() {
        const form = document.getElementById("form-subir-canchas");
        if (!form) return;

        form.addEventListener("submit", (e) => {
          e.preventDefault();

          // Capturar todos los datos del formulario
          const datos = {
            tipo: "CANCHA",
            muro: document.getElementById("muro-cancha").value,
            sector: document.getElementById("sector-cancha").value,
            relleno: document.getElementById("relleno-cancha").value,
            fecha: document.getElementById("fecha-cancha").value,
            foto: document.getElementById("foto-cancha").files[0] || null,
            archivo: document.getElementById("archivo-cancha").files[0],
            responsable: document.getElementById("responsable-cancha").value,
            metodo: document.getElementById("metodo-cancha").value,
            capas: document.getElementById("capas-cancha").value,
          };

          // Log de datos capturados
          console.log("=== DATOS DE CANCHA CAPTURADOS ===");
          console.log("Tipo:", datos.tipo);
          console.log("Muro:", datos.muro);
          console.log("Sector:", datos.sector);
          console.log("Relleno:", datos.relleno);
          console.log("Fecha:", datos.fecha);
          console.log(
            "Foto:",
            datos.foto ? datos.foto.name : "No seleccionada",
          );
          console.log("Archivo:", datos.archivo.name);
          console.log("Responsable ID:", datos.responsable);
          console.log("Método:", datos.metodo);
          console.log("N° Capas:", datos.capas);
          console.log("===================================");

          // Mostrar mensaje de éxito
          alert(
            "✅ Datos de CANCHA capturados correctamente\n\nLos datos han sido registrados en la consola.\n(Sin guardar en base de datos por ahora)",
          );

          // Resetear y volver a selección
          resetearFormularioYModal("cancha");
        });
      }

      // Configurar manejo del formulario MUESTRAS
      function configurarFormularioMuestras() {
        const form = document.getElementById("form-subir-muestras");
        if (!form) return;

        form.addEventListener("submit", (e) => {
          e.preventDefault();

          // Capturar datos del formulario
          const datos = {
            tipo: "MUESTRA",
            muro: document.getElementById("muro-muestra").value,
            sector: document.getElementById("sector-muestra").value,
            relleno: document.getElementById("relleno-muestra").value,
            fecha: document.getElementById("fecha-muestra").value,
            foto: document.getElementById("foto-muestra").files[0] || null,
            archivo: document.getElementById("archivo-muestra").files[0],
          };

          // Log de datos capturados
          console.log("=== DATOS DE MUESTRA CAPTURADOS ===");
          console.log("Tipo:", datos.tipo);
          console.log("Muro:", datos.muro);
          console.log("Sector:", datos.sector);
          console.log("Relleno:", datos.relleno);
          console.log("Fecha:", datos.fecha);
          console.log(
            "Foto:",
            datos.foto ? datos.foto.name : "No seleccionada",
          );
          console.log("Archivo:", datos.archivo.name);
          console.log("===================================");

          // Mostrar mensaje de éxito
          alert(
            "✅ Datos de MUESTRA capturados correctamente\n\nLos datos han sido registrados en la consola.\n(Sin guardar en base de datos por ahora)",
          );

          // Resetear y volver a selección
          resetearFormularioYModal("muestra");
        });
      }

      // Función auxiliar para resetear formulario y volver a selección
      function resetearFormularioYModal(tipo) {
        const form = document.getElementById(
          `form-subir-${tipo === "cancha" ? "canchas" : "muestras"}`,
        );
        const seleccionTipo = document.getElementById("seleccion-tipo");
        const formularioCancha = document.getElementById("formulario-cancha");
        const formularioMuestra = document.getElementById("formulario-muestra");

        // Resetear formulario
        if (form) {
          form.reset();
        }

        // Resetear previews
        const previewDiv = document.getElementById(`preview-foto-${tipo}`);
        if (previewDiv) {
          previewDiv.style.display = "none";
        }

        // Resetear selector de sector
        const sectorSelect = document.getElementById(`sector-${tipo}`);
        if (sectorSelect) {
          sectorSelect.disabled = true;
          sectorSelect.innerHTML =
            '<option value="">Seleccione muro primero...</option>';
        }

        // Volver a pantalla de selección
        seleccionTipo.style.display = "block";
        formularioCancha.style.display = "none";
        formularioMuestra.style.display = "none";
      }

      // Inicializar Subir Canchas cuando el DOM esté listo
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", inicializarSubirCanchas);
      } else {
        inicializarSubirCanchas();
      }
    </script>
  </body>
</html>
