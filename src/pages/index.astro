---
import AuthGuard from '../components/AuthGuard.astro';
---

<AuthGuard />

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Gesti√≥n de Canchas - AngloAmerican</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background-color: #f5f7fa;
        color: #333;
        line-height: 1.6;
      }
      
      .header {
        background: linear-gradient(135deg, #2c3e50, #3498db);
        color: white;
        padding: 2rem 0;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      
      /* Estilos para logos (comentado temporalmente)
      .logos-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 2rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
      }
      
      .company-logo {
        transition: transform 0.3s ease, filter 0.3s ease;
        filter: brightness(1.1) contrast(1.1);
        background: rgba(255, 255, 255, 0.08);
        padding: 0.6rem;
        border-radius: 8px;
        backdrop-filter: blur(10px);
      }
      
      .company-logo:hover {
        transform: scale(1.03);
        filter: brightness(1.15) contrast(1.15);
        background: rgba(255, 255, 255, 0.15);
      }
      */
      
      .header h1 {
        font-size: 2.2rem;
        margin: 0;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        padding: 1rem 0;
      }
      
      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
        margin: 0;
      }
      
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
      }
      
      .controls {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
      }
      
      .control-group {
        margin-bottom: 1.5rem;
      }
      
      .control-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #2c3e50;
      }
      
      select, input, button {
        padding: 0.75rem;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
      }
      
      select:focus, input:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
      }
      
      button {
        background: #3498db;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 600;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
      }
      
      button:hover {
        background: #2980b9;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
      }
      
      button:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      
      .btn-success {
        background: #27ae60;
      }
      
      .btn-success:hover {
        background: #229954;
      }
      
      .btn-pdf {
        background: #8e44ad;
        color: white;
        font-weight: 600;
      }
      
      .btn-pdf:hover {
        background: #732d91;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(142, 68, 173, 0.3);
      }
      
      .btn-danger {
        background: #e74c3c;
      }
      
      .btn-danger:hover {
        background: #c0392b;
      }
      
      .btn-warning {
        background: #f39c12;
      }
      
      .btn-warning:hover {
        background: #e67e22;
      }
      
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr auto;
        gap: 1rem;
        align-items: end;
      }
      
      .form-row input, .form-row select {
        padding: 0.75rem;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 1rem;
        background: white;
        transition: border-color 0.3s ease;
      }
      
      .form-row input:focus, .form-row select:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
      }
      
      .form-row select:disabled {
        background: #f8f9fa;
        color: #6c757d;
        cursor: not-allowed;
      }
      
      .form-row label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.5rem;
        display: block;
      }
      
      .table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        overflow: hidden;
      }
      
      table {
        width: 100%;
        border-collapse: collapse;
      }
      
      th, td {
        padding: 1rem;
        text-align: center;
        border-bottom: 1px solid #e1e8ed;
        vertical-align: middle;
      }
      
      th {
        background: #f8f9fa;
        font-weight: 600;
        color: #2c3e50;
      }
      
      /* Asegurar que el contenido de las celdas est√© centrado */
      td {
        text-align: center !important;
      }
      
      td strong {
        display: inline-block;
      }
      
      tr:hover {
        background: #f8f9fa;
      }
      
      .estado {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        text-align: center;
        white-space: nowrap;
        display: inline-block;
      }
      
      .estado-creada { background: #e3f2fd; color: #1976d2; }
      .estado-en-proceso { background: #fff3e0; color: #f57c00; }
      .estado-finalizada { background: #e8f5e8; color: #388e3c; }
      .estado-validada { background: #e8f5e8; color: #2e7d32; }
      .estado-rechazada { background: #ffebee; color: #d32f2f; }
      .estado-cerrada { background: #f3e5f5; color: #7b1fa2; }
      
      .actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        margin: 0 auto;
      }
      
      .actions button {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        margin: 0;
      }
      
      .admin-actions {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0 auto;
      }
      
      .admin-actions button {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #e74c3c;
        color: white;
        font-weight: 600;
      }
      
      .admin-actions button:hover {
        background: #c0392b;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
      }
      
      #borrar-header {
        text-align: center;
        background: #f8f9fa;
        font-weight: 600;
        color: #e74c3c;
        border-left: 3px solid #e74c3c;
      }
      
      .loading {
        text-align: center;
        padding: 2rem;
        color: #666;
      }
      
      .error {
        background: #ffebee;
        color: #c62828;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border-left: 4px solid #c62828;
      }
      
      .success {
        background: #e8f5e8;
        color: #2e7d32;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border-left: 4px solid #2e7d32;
      }
      
      .empresa-actual {
        font-weight: 600;
        padding: 0.3rem 0.6rem;
        border-radius: 15px;
        font-size: 0.8rem;
        text-align: center;
        display: inline-block;
      }
      
      .empresa-angloamerican { background: #e3f2fd; color: #1976d2; }
      .empresa-besalco { background: #fff3e0; color: #f57c00; }
      .empresa-linkapsis { background: #e8f5e8; color: #388e3c; }
      .empresa-llayllay { background: #f3e5f5; color: #7b1fa2; }
      
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
      }
      
      .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .modal-content {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        position: relative;
      }
      
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e1e8ed;
      }
      
      .modal-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #2c3e50;
      }
      
      .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
        padding: 0.5rem;
        border-radius: 50%;
        transition: all 0.3s ease;
      }
      
      .close-btn:hover {
        background: #f1f2f6;
        color: #333;
      }
      
      .observacion-item {
        background: #f8f9fa;
        border-left: 4px solid #e74c3c;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 8px;
      }
      
      .observacion-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }
      
      .observacion-empresa {
        font-weight: 600;
        color: #e74c3c;
      }
      
      .observacion-fecha {
        font-size: 0.85rem;
        color: #666;
      }
      
      .observacion-tipo {
        font-size: 0.8rem;
        color: #7f8c8d;
        text-transform: capitalize;
      }
      
      .observacion-texto {
        color: #2c3e50;
        line-height: 1.5;
        margin-top: 0.5rem;
      }
      
      /* Estilos para Login por Empresa */
      .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 60vh;
        padding: 2rem;
      }
      
      .login-card {
        background: white;
        border-radius: 16px;
        padding: 3rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        text-align: center;
        max-width: 500px;
        width: 100%;
      }
      
      .login-card h2 {
        color: #2c3e50;
        margin-bottom: 1rem;
        font-size: 2rem;
      }
      
      .login-card p {
        color: #666;
        margin-bottom: 2rem;
        font-size: 1.1rem;
      }
      
      .login-form {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      
      #empresa-login {
        font-size: 1.2rem;
        padding: 1rem;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        background: white;
        transition: border-color 0.3s ease;
      }
      
      #empresa-login:focus {
        border-color: #3498db;
        outline: none;
      }
      
      #btn-ingresar {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      #btn-ingresar:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
      }
      
      #btn-ingresar:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
      }
      
      /* Header de empresa logueada */
      .empresa-header {
        background: white;
        padding: 1rem 2rem;
        margin-bottom: 2rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .empresa-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }
      
      .empresa-nombre {
        font-size: 1.5rem;
        font-weight: 600;
        color: #2c3e50;
      }
      
      .empresa-rol {
        font-size: 0.9rem;
        color: #666;
      }
      
      #btn-cambiar-empresa {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s ease;
      }
      
      #btn-cambiar-empresa:hover {
        background: #c0392b;
      }
      
      /* Estilos para filtros */
      .filtros-container {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
      }
      
      .filtros-container h3 {
        color: #2c3e50;
        margin-bottom: 1rem;
        font-size: 1.3rem;
      }
      
      .filtros-row {
        display: flex;
        gap: 2rem;
        align-items: end;
        flex-wrap: wrap;
        margin-bottom: 1rem;
      }
      
      .filtro-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        min-width: 150px;
      }
      
      .filtro-group.rango-fechas {
        flex-direction: row;
        align-items: center;
        gap: 1rem;
        min-width: auto;
      }
      
      .filtro-group.rango-fechas label {
        margin: 0;
        white-space: nowrap;
      }
      
      .filtro-group label {
        font-weight: 600;
        color: #555;
        font-size: 0.9rem;
      }
      
      .toggle-group {
        display: flex;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        overflow: hidden;
      }
      
      .toggle-btn {
        background: #f8f9fa;
        border: none;
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        color: #555;
      }
      
      .toggle-btn:hover:not(.active) {
        background: #e9ecef;
        color: #333;
      }
      
      .toggle-btn.active {
        background: #3498db;
        color: white;
      }
      
      .toggle-btn:first-child {
        border-right: 1px solid #e1e8ed;
      }
      
      #filtro-fecha, #fecha-desde, #fecha-hasta {
        padding: 0.75rem;
        border: 2px solid #e1e8ed;
        border-radius: 6px;
        transition: border-color 0.3s ease;
      }
      
      #filtro-fecha:focus, #fecha-desde:focus, #fecha-hasta:focus {
        border-color: #3498db;
        outline: none;
      }
      
      #btn-aplicar-rango {
        background: #27ae60;
        color: white;
        border: none;
        padding: 0.75rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s ease;
        font-weight: 500;
      }
      
      #btn-aplicar-rango:hover {
        background: #229954;
      }
      
      .resultados-info {
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #3498db;
      }
      
      #contador-resultados {
        font-weight: 600;
        color: #2c3e50;
      }
      
      /* Estilos para formularios de validaci√≥n */
      .form-group {
        margin-bottom: 1.5rem;
      }
      
      .form-group label {
        display: block;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.5rem;
      }
      
      .form-group textarea,
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e1e8ed;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }
      
      .form-group textarea {
        min-height: 100px;
        resize: vertical;
      }
      
      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        border-color: #3498db;
        outline: none;
      }
      
      .mediciones-group {
        display: flex;
        gap: 0.5rem;
      }
      
      .mediciones-group input {
        flex: 1;
      }
      
      .form-group small {
        color: #666;
        font-size: 0.85rem;
        margin-top: 0.25rem;
        display: block;
      }
      
      /* Estilos para checkboxes de tipo de trabajo */
      .checkbox-group {
        display: flex;
        gap: 1rem;
        margin-top: 0.5rem;
      }
      
      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        padding: 0.5rem;
        border: 2px solid #e1e8ed;
        border-radius: 6px;
        transition: all 0.3s ease;
      }
      
      .checkbox-item:hover {
        background-color: #f8f9fa;
        border-color: #3498db;
      }
      
      .checkbox-item input[type="checkbox"] {
        width: auto;
        margin: 0;
      }
      
      .checkbox-item span {
        font-weight: 500;
        color: #2c3e50;
      }
      
      /* Estilos para coordenadas */
      .coordenadas-grid {
        display: grid;
        gap: 1.5rem;
        margin-top: 1rem;
      }
      
      .punto-section {
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        padding: 1rem;
        background-color: #f8f9fa;
      }
      
      .punto-section h5 {
        margin: 0 0 1rem 0;
        color: #2c3e50;
        font-weight: 600;
        font-size: 1.1rem;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 0.5rem;
      }
      
      .coordenadas-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1rem;
      }
      
      .coord-field {
        display: flex;
        flex-direction: column;
      }
      
      .coord-field label {
        font-size: 0.9rem;
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.25rem;
      }
      
      .coord-field input {
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.9rem;
      }
      
      .coord-field input:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
      }
      
      /* Responsive para coordenadas */
      @media (max-width: 768px) {
        .coordenadas-row {
          grid-template-columns: 1fr;
          gap: 0.5rem;
        }
        
        .checkbox-group {
          flex-direction: column;
          gap: 0.5rem;
        }
      }
      
      .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid #e1e8ed;
      }
      
      .btn-cancel, .btn-validar, .btn-rechazar, .btn-finalizar {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .btn-cancel {
        background: #6c757d;
        color: white;
      }
      
      .btn-cancel:hover {
        background: #5a6268;
      }
      
      .btn-validar, .btn-finalizar {
        background: #27ae60;
        color: white;
      }
      
      .btn-validar:hover, .btn-finalizar:hover {
        background: #229954;
      }
      
      .btn-rechazar {
        background: #e74c3c;
        color: white;
      }
      
      .btn-rechazar:hover {
        background: #c0392b;
      }
      
      #empresa-selector {
        font-size: 1.2rem;
        font-weight: 600;
        padding: 1rem;
        background: #f8f9fa;
        border: 2px solid #3498db;
      }
      
      /* Estilos para historial de observaciones */
      .historial-observaciones {
        margin: 1rem 0;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #3498db;
      }
      
      .historial-observaciones h4 {
        margin: 0 0 1rem 0;
        font-size: 1.1rem;
        color: #2c3e50;
        text-align: center;
        border-bottom: 2px solid #3498db;
        padding-bottom: 0.5rem;
      }
      
      .historial-content {
        max-height: 300px;
        overflow-y: auto;
        padding-right: 0.5rem;
      }
      
      .historial-timeline {
        position: relative;
        padding-left: 2rem;
      }
      
      .historial-timeline::before {
        content: '';
        position: absolute;
        left: 1rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, #3498db, #2ecc71);
      }
      
      .observacion-item {
        position: relative;
        background: white;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        border: 2px solid #e0e0e0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
      }
      
      .observacion-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        border-color: #3498db;
      }
      
      .observacion-item::before {
        content: '';
        position: absolute;
        left: -2.75rem;
        top: 1rem;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: white;
        border: 3px solid #3498db;
        z-index: 1;
      }
      
      .observacion-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #eee;
      }
      
      .observacion-empresa {
        font-weight: 700;
        font-size: 1rem;
        color: #2c3e50;
        background: #3498db;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.9rem;
      }
      
      .observacion-fecha {
        font-size: 0.8rem;
        color: #7f8c8d;
        font-weight: 500;
      }
      
      .observacion-contenido {
        margin-top: 0.5rem;
      }
      
      .observacion-texto {
        color: #2c3e50;
        margin: 0.5rem 0;
        line-height: 1.5;
        font-style: italic;
        background: #f8f9fa;
        padding: 0.75rem;
        border-radius: 6px;
        border-left: 3px solid #3498db;
      }
      
      .observacion-mediciones {
        background: linear-gradient(135deg, #e8f4fd 0%, #d1ecf1 100%);
        padding: 0.75rem;
        border-radius: 6px;
        margin-top: 0.75rem;
        border: 1px solid #bee5eb;
      }
      
      .medicion-titulo {
        font-weight: 600;
        color: #155724;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
        display: flex;
        align-items: center;
      }
      
      .medicion-titulo::before {
        content: 'üìè';
        margin-right: 0.5rem;
      }
      
      .medicion-valor {
        font-size: 1rem;
        color: #0c5460;
        font-weight: 700;
        font-family: 'Courier New', monospace;
      }
      
      .empresa-besalco::before { background-color: #e74c3c; }
      .empresa-linkapsis::before { background-color: #f39c12; }
      .empresa-llayllay::before { background-color: #27ae60; }
      .empresa-angloamerican::before { background-color: #3498db; }
      
      /* Nuevos estilos para historial mejorado */
      .historial-entry {
        background: #ffffff;
        border: 1px solid #e1e8ed;
        border-radius: 8px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: box-shadow 0.3s ease;
      }
      
      .historial-entry:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
      
      .empresa-nombre {
        font-size: 1.1rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .fecha-linea, .observacion-linea, .medicion-linea {
        margin-bottom: 0.5rem;
        line-height: 1.5;
      }
      
      .fecha-label, .observacion-label, .medicion-label {
        font-weight: 600;
        color: #34495e;
      }
      
      .medicion-linea {
        color: #2c3e50;
        font-size: 0.95rem;
      }
      
      .medicion-linea strong {
        color: #27ae60;
        font-family: 'Courier New', monospace;
        font-size: 1rem;
      }
      
      .hidden {
        display: none;
      }
      
      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
        }
        
        .container {
          padding: 1rem;
        }
        
        .header h1 {
          font-size: 1.8rem;
        }
        
        /* Estilos responsivos para logos (comentado temporalmente)
        .logos-container {
          gap: 1.5rem;
          margin-bottom: 1.2rem;
        }
        
        .company-logo {
          max-width: 220px;
          height: auto;
        }
        */
        
        /* Para pantallas muy peque√±as */
        @media (max-width: 480px) {
          /* Estilos para logos comentados
          .logos-container {
            gap: 1rem;
          }
          
          .company-logo {
            max-width: 180px;
          }
          */
          
          .header h1 {
            font-size: 1.5rem;
            line-height: 1.3;
            padding: 0 1rem;
          }
        }
        
        table {
          font-size: 0.9rem;
        }
        
        th, td {
          padding: 0.5rem;
        }
        
        .actions {
          flex-direction: column;
        }
      }
      
      /* Estilos para el Modal del Mapa */
      .map-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
      }
      
      .map-modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease-out;
      }
      
      .map-modal-content {
        background: white;
        border-radius: 16px;
        width: 95%;
        height: 90%;
        max-width: 1200px;
        max-height: 800px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: slideIn 0.3s ease-out;
      }
      
      .map-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 16px 16px 0 0;
      }
      
      .map-modal-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
      }
      
      .map-close-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 2rem;
        cursor: pointer;
        padding: 0.5rem 0.8rem;
        border-radius: 50%;
        transition: all 0.3s ease;
        line-height: 1;
      }
      
      .map-close-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }
      
      .map-container {
        flex: 1;
        position: relative;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 500px;
      }
      
      .map-container iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 0 0 16px 16px;
      }
      
      .map-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #666;
        font-size: 1.1rem;
      }
      
      .map-loading::before {
        content: '';
        width: 40px;
        height: 40px;
        border: 4px solid #e1e8ed;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: scale(0.9) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Responsive para el modal del mapa */
      @media (max-width: 768px) {
        .map-modal-content {
          width: 98%;
          height: 95%;
          margin: 1%;
        }
        
        .map-modal-header {
          padding: 1rem 1.5rem;
        }
        
        .map-modal-title {
          font-size: 1.2rem;
        }
        
        /* Responsive para modal de creaci√≥n */
        #createCanchaModal .map-modal-content {
          width: 98vw !important;
          height: 98vh !important;
          margin: 1vh auto !important;
        }
        
        .create-cancha-container {
          flex-direction: column !important;
          height: calc(100% - 60px) !important;
        }
        
        .create-cancha-form {
          flex: 0 0 auto !important;
          max-height: 45vh !important;
          border-right: none !important;
          border-bottom: 2px solid #e1e8ed !important;
          padding: 1.5rem !important;
        }
        
        .create-cancha-map-panel {
          flex: 1 !important;
          min-height: 300px !important;
        }
        
        .map-panel-header {
          padding: 1rem !important;
        }
        
        .form-actions {
          flex-direction: row !important;
          gap: 0.5rem !important;
        }
        
        .form-actions button {
          font-size: 0.8rem !important;
          padding: 0.6rem 0.8rem !important;
        }
      }
      
      /* Estilos para el Modal de Creaci√≥n de Cancha */
      #createCanchaModal .map-modal-content {
        max-width: 1400px !important;
        width: 95vw !important;
        height: 90vh !important;
        max-height: none !important;
      }
      
      .create-cancha-container {
        display: flex !important;
        height: calc(100% - 80px) !important; /* Altura total menos header */
        gap: 0 !important;
        flex-direction: row !important;
      }
      
      .create-cancha-form {
        flex: 0 0 380px !important; /* Ancho fijo para el formulario */
        padding: 2rem !important;
        background: #f8f9fa !important;
        border-right: 2px solid #e1e8ed !important;
        display: flex !important;
        flex-direction: column !important;
        gap: 1.5rem !important;
        overflow-y: auto !important;
        min-height: 100% !important;
      }
      
      .form-section-title {
        color: #2c3e50 !important;
        font-size: 1.1rem !important;
        font-weight: 600 !important;
        margin: 0 0 1rem 0 !important;
        padding-bottom: 0.5rem !important;
        border-bottom: 2px solid #667eea !important;
      }
      
      .create-cancha-map-panel {
        flex: 1 !important; /* Ocupa el resto del espacio */
        display: flex !important;
        flex-direction: column !important;
        background: #ffffff !important;
        min-width: 0 !important; /* Permite que el flex item se encoja */
      }
      
      .map-panel-header {
        padding: 1.5rem 2rem 1rem 2rem !important;
        border-bottom: 1px solid #e1e8ed !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        flex-shrink: 0 !important;
      }
      
      .map-panel-title {
        margin: 0 0 0.5rem 0 !important;
        font-size: 1.1rem !important;
        font-weight: 600 !important;
      }
      
      .map-panel-subtitle {
        margin: 0 !important;
        font-size: 0.9rem !important;
        opacity: 0.9 !important;
      }
      
      .form-group {
        display: flex;
        flex-direction: column;
      }
      
      .form-group label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
      }
      
      .form-group input,
      .form-group select {
        padding: 0.8rem;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
      }
      
      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      
      .form-actions {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        margin-top: auto; /* Empuja los botones hacia abajo */
      }
      
      .form-actions button {
        padding: 0.8rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
        border: none;
        font-size: 0.9rem;
      }
      
      .drawing-map-container {
        flex: 1;
        min-height: 500px;
        background: #f0f2f5;
        position: relative;
        border-radius: 0;
        overflow: hidden;
      }
      
      .drawing-map-container iframe {
        width: 100%;
        height: 100%;
        border: none;
      }
      
      .drawing-status {
        padding: 1rem;
        border-radius: 8px;
        font-weight: 500;
        text-align: center;
        font-size: 0.9rem;
      }
      
      .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 1rem;
      }
      
      .btn-primary,
      .btn-success {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
      }
      
      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      
      .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }
      
      .btn-success {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
      }
      
      .btn-success:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
      }
      
      .btn-primary:disabled,
      .btn-success:disabled {
        background: #cccccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      
      .drawing-status {
        text-align: center;
        padding: 1rem;
        border-radius: 8px;
        font-weight: 500;
        min-height: 1.5rem;
      }
      
      .drawing-status.success {
        background: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #4caf50;
      }
      
      .drawing-status.info {
        background: #e3f2fd;
        color: #1976d2;
        border: 1px solid #2196f3;
      }
      
      
      #createCanchaModal .drawing-map-container {
        flex: 1 !important;
        height: 100% !important;
        min-height: 400px !important;
        background: #f0f2f5 !important;
        position: relative !important;
        border-radius: 0 !important;
        overflow: hidden !important;
        display: flex !important; /* Siempre visible en el nuevo dise√±o */
        align-items: center !important;
        justify-content: center !important;
      }
      
      #createCanchaModal .drawing-map-container iframe {
        width: 100% !important;
        height: 100% !important;
        border: none !important;
      }
      
      #createCanchaModal .drawing-map-container:empty::before {
        content: "üó∫Ô∏è El mapa aparecer√° aqu√≠ cuando hagas clic en 'Dibujar √Årea en Mapa'" !important;
        color: #6c757d !important;
        font-style: italic !important;
        text-align: center !important;
        padding: 2rem !important;
        line-height: 1.5 !important;
      }
      
      /* Estilos para el bot√≥n de crear cancha en el header */
      .btn-crear-cancha {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      }
      
      .btn-crear-cancha:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
      }
      
      .texto-ayuda {
        color: #666;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <!-- Logos de empresas (comentado temporalmente) -->
      <!--
      <div class="logos-container">
        <img title="Besalco" width="280" height="60" src="/Besalco.png" alt="Besalco" class="company-logo">
        <img title="Linkapsis" width="280" height="60" src="/Linkapsis.png" alt="Linkapsis" class="company-logo">
        <img title="AngloAmerican" width="280" height="60" src="/AngloAmerican.png" alt="AngloAmerican" class="company-logo">
        <img title="LlayLlay" width="80" height="80" src="/LlayLlay.png" alt="LlayLlay" class="company-logo">
      </div>
      -->
      
      <h1>Gesti√≥n de Canchas AngloAmerican - Las T√≥rtolas</h1>
    </div>

    <div class="container">
      <div id="mensaje-container"></div>

      <!-- Pantalla Principal -->
      <div id="main-screen">
        <!-- Header de usuario logueado -->
        <div class="empresa-header" id="user-header">
          <div class="empresa-info">
            <span class="empresa-nombre" id="user-name">Cargando usuario...</span>
            <span class="empresa-rol" id="user-role">Verificando permisos...</span>
          </div>
          <div style="display: flex; gap: 1rem; align-items: center;">
            <span id="user-company" class="empresa-actual">Cargando...</span>
            <a id="btn-admin-usuarios" href="/admin/usuarios" class="btn btn-warning" style="display: none;">üë• Gesti√≥n Usuarios</a>
            <button id="btn-logout" type="button">Cerrar Sesi√≥n</button>
          </div>
        </div>

        <!-- Controles y Filtros -->
        <div class="controls">
          <!-- Formulario para crear nueva cancha (solo AngloAmerican) -->
          <div id="form-crear-cancha" class="control-group hidden">
            <h3>Crear Nueva Cancha</h3>
            <div class="form-row">
              <div>
                <button id="btn-abrir-modal-crear" type="button" class="btn-crear-cancha">üèóÔ∏è Crear Nueva Cancha</button>
                <p class="texto-ayuda">Podr√°s dibujar el √°rea de trabajo en el mapa</p>
              </div>
            </div>
          </div>

          <!-- Filtros -->
          <div class="filtros-container">
            <h3>Filtros</h3>
            <div class="filtros-row">
              <div class="filtro-group">
                <label>Vista:</label>
                <div class="toggle-group">
                  <button id="btn-vista-acciones" class="toggle-btn active">Mis Acciones</button>
                  <button id="btn-vista-historico" class="toggle-btn">Ver Hist√≥rico</button>
                </div>
              </div>
              
              <div class="filtro-group">
                <label for="filtro-fecha">Filtro de Fecha:</label>
                <select id="filtro-fecha">
                  <option value="all">Todas las fechas</option>
                  <option value="today">Hoy</option>
                  <option value="week">√öltima semana</option>
                  <option value="month">√öltimo mes</option>
                  <option value="custom">Rango personalizado</option>
                </select>
              </div>
              
              <div id="rango-fechas" class="filtro-group rango-fechas hidden">
                <label>Desde:</label>
                <input type="date" id="fecha-desde">
                <label>Hasta:</label>
                <input type="date" id="fecha-hasta">
                <button id="btn-aplicar-rango" type="button">Aplicar</button>
              </div>
            </div>
            
            <!-- Contador de resultados -->
            <div class="resultados-info">
              <span id="contador-resultados">Cargando...</span>
            </div>
          </div>
        </div>

        <!-- Tabla de canchas -->
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Nombre de Cancha</th>
                <th>Estado Actual</th>
                <th>Empresa Actual</th>
                <th>Fecha Creaci√≥n</th>
                <th>Mapa</th>
                <th>Acciones</th>
                <th id="borrar-header" class="hidden">Administrar</th>
              </tr>
            </thead>
            <tbody id="canchas-tbody">
              <!-- Las canchas se cargar√°n din√°micamente -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Modal para validaci√≥n de Linkapsis (Espesores) -->
      <div id="validacion-linkapsis-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">Validaci√≥n de Espesores - Linkapsis</h3>
            <button class="close-btn">√ó</button>
          </div>
          
          <!-- Historial de observaciones anteriores -->
          <div id="historial-linkapsis" class="historial-observaciones">
            <h4>Observaciones del Proceso:</h4>
            <div class="historial-content">
              <p>Cargando historial...</p>
            </div>
          </div>
          
          <form id="form-validacion-linkapsis">
            <div class="form-group">
              <label for="linkapsis-observaciones">Observaciones:</label>
              <textarea id="linkapsis-observaciones" placeholder="Ingresa observaciones sobre la validaci√≥n..." required></textarea>
            </div>
            
            <div class="form-group">
              <label for="linkapsis-espesor">Medici√≥n de Espesor (metros):</label>
              <input type="number" id="linkapsis-espesor" placeholder="Ej: 0.03" min="0" step="0.001" required>
              <small>Ingresa la medici√≥n en metros (ej: 0.03)</small>
            </div>
            
            <!-- Tipo de Trabajo -->
            <div class="form-group">
              <label>Tipo de Trabajo:</label>
              <div class="checkbox-group">
                <label class="checkbox-item">
                  <input type="checkbox" id="trabajo-corte" name="tipo-trabajo" value="corte">
                  <span>Corte</span>
                </label>
                <label class="checkbox-item">
                  <input type="checkbox" id="trabajo-relleno" name="tipo-trabajo" value="relleno">
                  <span>Relleno</span>
                </label>
              </div>
            </div>
            
            <!-- Coordenadas de Puntos -->
            <div class="form-group">
              <label>Coordenadas de Puntos:</label>
              <div class="coordenadas-grid">
                <!-- Punto 1 -->
                <div class="punto-section">
                  <h5>Punto 1</h5>
                  <div class="coordenadas-row">
                    <div class="coord-field">
                      <label for="p1-norte">Norte:</label>
                      <input type="number" id="p1-norte" placeholder="Norte P1" step="0.001">
                    </div>
                    <div class="coord-field">
                      <label for="p1-este">Este:</label>
                      <input type="number" id="p1-este" placeholder="Este P1" step="0.001">
                    </div>
                    <div class="coord-field">
                      <label for="p1-cota">Cota:</label>
                      <input type="number" id="p1-cota" placeholder="Cota P1" step="0.001">
                    </div>
                  </div>
                </div>
                
                <!-- Punto 2 -->
                <div class="punto-section">
                  <h5>Punto 2</h5>
                  <div class="coordenadas-row">
                    <div class="coord-field">
                      <label for="p2-norte">Norte:</label>
                      <input type="number" id="p2-norte" placeholder="Norte P2" step="0.001">
                    </div>
                    <div class="coord-field">
                      <label for="p2-este">Este:</label>
                      <input type="number" id="p2-este" placeholder="Este P2" step="0.001">
                    </div>
                    <div class="coord-field">
                      <label for="p2-cota">Cota:</label>
                      <input type="number" id="p2-cota" placeholder="Cota P2" step="0.001">
                    </div>
                  </div>
                </div>
                
                <!-- Punto 3 -->
                <div class="punto-section">
                  <h5>Punto 3</h5>
                  <div class="coordenadas-row">
                    <div class="coord-field">
                      <label for="p3-norte">Norte:</label>
                      <input type="number" id="p3-norte" placeholder="Norte P3" step="0.001">
                    </div>
                    <div class="coord-field">
                      <label for="p3-este">Este:</label>
                      <input type="number" id="p3-este" placeholder="Este P3" step="0.001">
                    </div>
                    <div class="coord-field">
                      <label for="p3-cota">Cota:</label>
                      <input type="number" id="p3-cota" placeholder="Cota P3" step="0.001">
                    </div>
                  </div>
                </div>
                
                <!-- Punto 4 -->
                <div class="punto-section">
                  <h5>Punto 4</h5>
                  <div class="coordenadas-row">
                    <div class="coord-field">
                      <label for="p4-norte">Norte:</label>
                      <input type="number" id="p4-norte" placeholder="Norte P4" step="0.001">
                    </div>
                    <div class="coord-field">
                      <label for="p4-este">Este:</label>
                      <input type="number" id="p4-este" placeholder="Este P4" step="0.001">
                    </div>
                    <div class="coord-field">
                      <label for="p4-cota">Cota:</label>
                      <input type="number" id="p4-cota" placeholder="Cota P4" step="0.001">
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="form-actions">
              <button type="button" class="btn-cancel">Cancelar</button>
              <button type="submit" class="btn-validar">Validar Espesores</button>
              <button type="button" class="btn-rechazar">Rechazar</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Modal para validaci√≥n de LlayLlay (Densidad) -->
      <div id="validacion-llayllay-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">Validaci√≥n de Densidad - LlayLlay</h3>
            <button class="close-btn">√ó</button>
          </div>
          
          <!-- Historial de observaciones anteriores -->
          <div id="historial-llayllay" class="historial-observaciones">
            <h4>Observaciones del Proceso:</h4>
            <div class="historial-content">
              <p>Cargando historial...</p>
            </div>
          </div>
          
          <form id="form-validacion-llayllay">
            <div class="form-group">
              <label for="llayllay-observaciones">Observaciones:</label>
              <textarea id="llayllay-observaciones" placeholder="Ingresa observaciones sobre la validaci√≥n..." required></textarea>
            </div>
            
            <div class="form-group">
              <label for="llayllay-densidad">Densidad (g/cm¬≥):</label>
              <input type="number" id="llayllay-densidad" placeholder="ej: 2.35" min="0" step="0.01" required>
            </div>
            
            <div class="form-actions">
              <button type="button" class="btn-cancel">Cancelar</button>
              <button type="submit" class="btn-validar">Validar Densidad</button>
              <button type="button" class="btn-rechazar">Rechazar</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Modal para validaci√≥n/rechazo de Besalco -->
      <div id="validacion-besalco-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">Validaci√≥n de Trabajo - Besalco</h3>
            <button class="close-btn">√ó</button>
          </div>
          
          <!-- Historial de observaciones anteriores -->
          <div id="historial-besalco" class="historial-observaciones">
            <h4>Observaciones del Proceso:</h4>
            <div class="historial-content">
              <p>Cargando historial...</p>
            </div>
          </div>
          
          <form id="form-validacion-besalco">
            <div class="form-group">
              <label for="besalco-observaciones">Observaciones del Trabajo:</label>
              <textarea id="besalco-observaciones" placeholder="Describe el trabajo realizado o motivo del rechazo..." required></textarea>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-cancel">Cancelar</button>
              <button type="submit" class="btn-finalizar">Finalizar Trabajo</button>
              <button type="button" class="btn-rechazar">Rechazar Trabajo</button>
            </div>
          </form>
        </div>
      </div>
      
      <!-- Modal para cerrar cancha (AngloAmerican) -->
      <div id="cerrar-cancha-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">Cerrar Cancha - AngloAmerican</h3>
            <button class="close-btn">√ó</button>
          </div>
          
          <!-- Historial completo de observaciones -->
          <div id="historial-cierre" class="historial-observaciones">
            <h4>Historial Completo del Proceso:</h4>
            <div class="historial-content">
              <p>Cargando historial completo...</p>
            </div>
          </div>
          
          <div class="form-actions" style="justify-content: center; gap: 1rem; padding-top: 1rem;">
            <button type="button" class="btn-cancel">Cancelar</button>
            <button type="button" class="btn-finalizar" id="confirmar-cierre">Cerrar Cancha Definitivamente</button>
          </div>
        </div>
      </div>
      
      <!-- Modal para borrar cancha (AngloAmerican) -->
      <div id="borrar-cancha-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title" style="color: #e74c3c;">‚ö†Ô∏è Borrar Cancha Definitivamente</h3>
            <button class="close-btn">√ó</button>
          </div>
          
          <div style="padding: 1rem; background: #fef5e7; border: 2px solid #f39c12; border-radius: 8px; margin: 1rem 0;">
            <h4 style="color: #d68910; margin: 0 0 0.5rem 0;">‚ö†Ô∏è ADVERTENCIA</h4>
            <p style="margin: 0; color: #8e6e01;">
              Esta acci√≥n <strong>NO SE PUEDE DESHACER</strong>. Se eliminar√° la cancha y todas sus validaciones asociadas de forma permanente.
            </p>
          </div>
          
          <div id="historial-borrado" class="historial-observaciones">
            <h4>Historial que se Eliminar√°:</h4>
            <div class="historial-content">
              <p>Cargando historial...</p>
            </div>
          </div>
          
          <div class="form-group">
            <label for="confirmacion-borrado" style="color: #e74c3c; font-weight: 700;">
              Para confirmar, escribe exactamente: <code style="background: #f8f9fa; padding: 0.25rem;">borrar-cancha</code>
            </label>
            <input type="text" id="confirmacion-borrado" placeholder="Escribe 'borrar-cancha' para confirmar" style="border: 2px solid #e74c3c;">
          </div>
          
          <div class="form-actions" style="justify-content: center; gap: 1rem; padding-top: 1rem;">
            <button type="button" class="btn-cancel">Cancelar</button>
            <button type="button" class="btn-danger" id="confirmar-borrado" disabled>BORRAR CANCHA DEFINITIVAMENTE</button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      // Variables globales
      let usuarioLogueado = null
      let empresaLogueada = null
      let cargando = false
      let vistaActual = 'acciones' // 'acciones' o 'historico'
      let filtroFecha = 'all'
      let todasLasCanchas = []
      let canchasFiltradas = []

      // Elementos del DOM
      const mainScreen = document.getElementById('main-screen')
      const userHeader = document.getElementById('user-header')
      const userName = document.getElementById('user-name')
      const userRole = document.getElementById('user-role')
      const userCompany = document.getElementById('user-company')
      const btnAdminUsuarios = document.getElementById('btn-admin-usuarios')
      const btnLogout = document.getElementById('btn-logout')
      const formCrearCancha = document.getElementById('form-crear-cancha')
      const btnCrearCancha = document.getElementById('btn-crear-cancha')
      const btnAbrirModalCrear = document.getElementById('btn-abrir-modal-crear')
      const canchasTBody = document.getElementById('canchas-tbody')
      const mensajeContainer = document.getElementById('mensaje-container')
      const contadorResultados = document.getElementById('contador-resultados')
      
      // Elementos de filtros
      const btnVistaAcciones = document.getElementById('btn-vista-acciones')
      const btnVistaHistorico = document.getElementById('btn-vista-historico')
      const filtroFechaSelect = document.getElementById('filtro-fecha')
      const rangoFechas = document.getElementById('rango-fechas')
      const fechaDesde = document.getElementById('fecha-desde')
      const fechaHasta = document.getElementById('fecha-hasta')
      const btnAplicarRango = document.getElementById('btn-aplicar-rango')

      // Cargar datos iniciales
      async function inicializar() {
        try {
          configurarEventListeners()
          
          // Esperar a que el AuthGuard termine de verificar
          window.addEventListener('userAuthenticated', (event) => {
            cargarUsuarioAutenticado(event.detail)
          })
          
          // Verificar si ya hay usuario autenticado
          verificarUsuarioExistente()
          
        } catch (error) {
          console.error('Error al inicializar:', error)
          mostrarMensaje('Error al cargar datos iniciales', 'error')
        }
      }
      
      // Verificar si hay usuario autenticado en localStorage
      function verificarUsuarioExistente() {
        try {
          const sessionData = localStorage.getItem('userSession')
          if (sessionData) {
            const session = JSON.parse(sessionData)
            const expiresAt = new Date(session.expiresAt)
            
            if (expiresAt > new Date()) {
              cargarUsuarioAutenticado(session.usuario)
            } else {
              // Sesi√≥n expirada, redirigir al login
              window.location.href = '/login'
            }
          } else {
            // No hay sesi√≥n, redirigir al login
            window.location.href = '/login'
          }
        } catch (error) {
          console.error('Error verificando usuario:', error)
          window.location.href = '/login'
        }
      }

      // Configurar todos los event listeners
      function configurarEventListeners() {
        // Logout
        btnLogout.addEventListener('click', cerrarSesion)
        
        // Filtros
        btnVistaAcciones.addEventListener('click', () => cambiarVista('acciones'))
        btnVistaHistorico.addEventListener('click', () => cambiarVista('historico'))
        filtroFechaSelect.addEventListener('change', manejarCambioFiltroFecha)
        btnAplicarRango.addEventListener('click', aplicarRangoFechas)
        
        // Modal
        configurarModalEventListeners()
        
        // Crear cancha (si aplica)
        if (btnCrearCancha) {
          console.log('Registrando event listener para btnCrearCancha')
          btnCrearCancha.addEventListener('click', crearCancha)
        } else {
          console.log('No se encontr√≥ btnCrearCancha')
        }
        
        // Bot√≥n para abrir modal de crear cancha con pol√≠gono
        if (btnAbrirModalCrear) {
          console.log('Registrando event listener para btnAbrirModalCrear')
          btnAbrirModalCrear.addEventListener('click', abrirModalCrearCancha)
        } else {
          console.log('No se encontr√≥ btnAbrirModalCrear')
        }
        
        // Configurar selectores din√°micos de Muro y Sector
        configurarSelectoresMuroSector()
      }

      // Configurar selectores din√°micos de Muro y Sector
      function configurarSelectoresMuroSector() {
        const selectMuro = document.getElementById('muro-select')
        const selectSector = document.getElementById('sector-select')
        
        if (!selectMuro || !selectSector) return
        
        selectMuro.addEventListener('change', function() {
          const muroSeleccionado = this.value
          
          // Limpiar opciones del sector
          selectSector.innerHTML = ''
          
          if (!muroSeleccionado) {
            selectSector.disabled = true
            selectSector.innerHTML = '<option value="">Primero selecciona un muro</option>'
            return
          }
          
          selectSector.disabled = false
          selectSector.innerHTML = '<option value="">Selecciona un sector</option>'
          
          // Agregar opciones seg√∫n el muro seleccionado
          if (muroSeleccionado === 'MP') {
            // MP: S1 hasta S7
            for (let i = 1; i <= 7; i++) {
              const option = document.createElement('option')
              option.value = `S${i}`
              option.textContent = `S${i}`
              selectSector.appendChild(option)
            }
          } else if (muroSeleccionado === 'ME' || muroSeleccionado === 'MO') {
            // ME y MO: S1 hasta S3
            for (let i = 1; i <= 3; i++) {
              const option = document.createElement('option')
              option.value = `S${i}`
              option.textContent = `S${i}`
              selectSector.appendChild(option)
            }
          }
        })
      }

      // Configurar event listeners del modal
      function configurarModalEventListeners() {
        // Bot√≥n de cerrar modal
        const closeBtn = document.querySelector('.close-btn')
        if (closeBtn) {
          closeBtn.addEventListener('click', cerrarTodosLosModales)
        }
      }

      // === FUNCI√ìN TEMPORAL DE DEBUG ===
      window.debugCancha = function(canchaId) {
        const cancha = todasLasCanchas.find(c => c.id == canchaId)
        if (cancha) {
          console.log('=== DEBUG CANCHA ===')
          console.log('Cancha encontrada:', cancha)
          console.log('Estado actual:', cancha.estado_actual)
          console.log('Empresa actual:', cancha.empresa_actual)
          console.log('Validaciones:', cancha.validaciones)
          
          if (cancha.validaciones) {
            cancha.validaciones.forEach(v => {
              console.log(`- ${v.empresa}: ${v.estado}`)
            })
          }
          
          // Verificar qu√© botones deber√≠a mostrar
          const botonesGenerados = generarBotonesAccion(canchaId, cancha.estado_actual, cancha.empresa_actual)
          console.log('Botones que deber√≠a generar:', botonesGenerados)
          
          return cancha
        } else {
          console.log('Cancha no encontrada con ID:', canchaId)
          console.log('Canchas disponibles:', todasLasCanchas.map(c => ({ id: c.id, nombre: c.nombre })))
          return null
        }
      }

      window.debugTodasLasCanchas = function() {
        console.log('=== TODAS LAS CANCHAS ===')
        todasLasCanchas.forEach(cancha => {
          console.log(`ID: ${cancha.id}, Nombre: ${cancha.nombre}, Estado: ${cancha.estado_actual}, Empresa: ${cancha.empresa_actual}`)
        })
        return todasLasCanchas
      }

      // === FUNCIONES DE AUTENTICACI√ìN ===
      // Las funciones de autenticaci√≥n ahora se manejan en login.astro y AuthGuard.astro

      // Cargar informaci√≥n del usuario autenticado
      async function cargarUsuarioAutenticado(usuario) {
        try {
          console.log('Cargando usuario autenticado:', usuario)
          
          usuarioLogueado = usuario
          empresaLogueada = {
            id: usuario.empresa_id,
            nombre: usuario.empresa_nombre
          }
          
          // Actualizar UI del header
          userName.textContent = usuario.nombre_completo
          userRole.textContent = `${usuario.rol_nombre} - ${usuario.empresa_nombre}`
          userCompany.textContent = usuario.empresa_nombre
          userCompany.className = `empresa-actual empresa-${usuario.empresa_nombre.toLowerCase().replace(' ', '')}`
          
          // Mostrar/ocultar formulario de crear cancha seg√∫n la empresa
          if (usuario.empresa_nombre === 'AngloAmerican') {
            console.log('Mostrando formulario de crear cancha para AngloAmerican')
            formCrearCancha.classList.remove('hidden')
          } else {
            console.log('Ocultando formulario de crear cancha para:', usuario.empresa_nombre)
            formCrearCancha.classList.add('hidden')
          }
          
          // Mostrar enlace de administraci√≥n si es de AngloAmerican
          if (usuario.empresa_id === 1) { // AngloAmerican
            btnAdminUsuarios.style.display = 'inline-block'
          } else {
            btnAdminUsuarios.style.display = 'none'
          }
          
          // Cargar datos
          await cargarCanchas()
          
          // Actualizar columna de administraci√≥n
          actualizarColumnaAdmin()
          
          mostrarMensaje(`¬°Bienvenido, ${usuario.nombre_completo}!`, 'success')
          
        } catch (error) {
          console.error('Error cargando usuario:', error)
          mostrarMensaje('Error al cargar informaci√≥n del usuario', 'error')
          window.location.href = '/login'
        }
      }
      
      function getRolEmpresa(nombreEmpresa) {
        const roles = {
          'AngloAmerican': 'Creaci√≥n y cierre de canchas',
          'Besalco': 'Trabajo de maquinaria',
          'Linkapsis': 'Validaci√≥n de espesores',
          'LlayLlay': 'Validaci√≥n de densidad'
        }
        return roles[nombreEmpresa] || 'Usuario del sistema'
      }

      function cerrarSesion() {
        usuarioLogueado = null
        empresaLogueada = null
        
        // Limpiar localStorage
        localStorage.removeItem('userSession')
        
        // Redirigir al login
        window.location.href = '/login'
        todasLasCanchas = []
        canchasFiltradas = []
        
        // Ocultar columna de administraci√≥n
        actualizarColumnaAdmin()
        
        mostrarMensaje('Sesi√≥n cerrada correctamente', 'success')
      }

      // === FUNCIONES DE CARGA DE DATOS ===

      // === FUNCIONES DE FILTROS ===
      function cambiarVista(nuevaVista) {
        console.log('Cambiando vista a:', nuevaVista)
        vistaActual = nuevaVista
        
        // Actualizar botones
        btnVistaAcciones.classList.toggle('active', nuevaVista === 'acciones')
        btnVistaHistorico.classList.toggle('active', nuevaVista === 'historico')
        
        // Aplicar filtros
        aplicarFiltros()
      }

      function manejarCambioFiltroFecha() {
        filtroFecha = filtroFechaSelect.value
        
        if (filtroFecha === 'custom') {
          rangoFechas.classList.remove('hidden')
        } else {
          rangoFechas.classList.add('hidden')
          aplicarFiltros()
        }
      }

      function aplicarRangoFechas() {
        const desde = fechaDesde.value
        const hasta = fechaHasta.value
        
        if (!desde || !hasta) {
          mostrarMensaje('Por favor selecciona ambas fechas', 'error')
          return
        }
        
        aplicarFiltros()
      }

      function aplicarFiltros() {
        if (!empresaLogueada || !todasLasCanchas.length) return
        
        let canchasFiltradas = [...todasLasCanchas]
        console.log('Aplicando filtros, vista actual:', vistaActual)
        console.log('Total canchas antes del filtro:', canchasFiltradas.length)
        
        // Filtro por vista (acciones vs hist√≥rico)
        if (vistaActual === 'acciones') {
          canchasFiltradas = filtrarPorAccionesDisponibles(canchasFiltradas)
          console.log('Canchas despu√©s del filtro de acciones:', canchasFiltradas.length)
        }
        
        // Filtro por fecha
        canchasFiltradas = filtrarPorFecha(canchasFiltradas)
        
        // Mostrar resultados
        mostrarCanchas(canchasFiltradas)
        actualizarContadorResultados(canchasFiltradas.length, todasLasCanchas.length)
      }

      function filtrarPorAccionesDisponibles(canchas) {
        const empresaId = empresaLogueada.id
        const empresaNombre = empresaLogueada.nombre
        
        console.log('Filtrando para empresa:', empresaNombre)
        
        return canchas.filter(cancha => {
          const estado = cancha.estado_actual
          const empresaActual = cancha.empresa_actual
          
          console.log(`Cancha ${cancha.nombre}: estado="${estado}", empresa="${empresaActual}"`)
          
          let tieneAccion = false
          
          switch (empresaNombre) {
            case 'AngloAmerican':
              // AngloAmerican puede actuar cuando:
              // - Cancha creada (enviar a Besalco)
              // - Cancha en proceso en AngloAmerican (cerrar)
              tieneAccion = estado === 'Creada' || 
                           (estado === 'En Proceso' && empresaActual === 'AngloAmerican')
              break
                     
            case 'Besalco':
              // Besalco puede actuar cuando la cancha est√° en proceso en Besalco o rechazada
              tieneAccion = (estado === 'En Proceso' && empresaActual === 'Besalco') || 
                           (estado === 'Rechazada' && empresaActual === 'Besalco')
              break
                     
            case 'Linkapsis':
              // Linkapsis puede actuar cuando la cancha est√° en proceso en Linkapsis
              tieneAccion = estado === 'En Proceso' && empresaActual === 'Linkapsis'
              break
              
            case 'LlayLlay':
              // LlayLlay puede actuar cuando la cancha est√° en proceso en LlayLlay
              tieneAccion = estado === 'En Proceso' && empresaActual === 'LlayLlay'
              break
              
            default:
              tieneAccion = false
          }
          
          console.log(`-> Tiene acci√≥n: ${tieneAccion}`)
          return tieneAccion
        })
      }

      function filtrarPorFecha(canchas) {
        if (filtroFecha === 'all') return canchas
        
        const ahora = new Date()
        const hoy = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate())
        
        return canchas.filter(cancha => {
          const fechaCancha = new Date(cancha.created_at)
          
          switch (filtroFecha) {
            case 'today':
              return fechaCancha >= hoy
            case 'week':
              const semanaAtras = new Date(hoy.getTime() - 7 * 24 * 60 * 60 * 1000)
              return fechaCancha >= semanaAtras
            case 'month':
              const mesAtras = new Date(hoy.getTime() - 30 * 24 * 60 * 60 * 1000)
              return fechaCancha >= mesAtras
            case 'custom':
              if (!fechaDesde.value || !fechaHasta.value) return true
              const desde = new Date(fechaDesde.value)
              const hasta = new Date(fechaHasta.value + 'T23:59:59')
              return fechaCancha >= desde && fechaCancha <= hasta
            default:
              return true
          }
        })
      }

      function actualizarContadorResultados(mostradas, total) {
        const texto = vistaActual === 'acciones' 
          ? `${mostradas} acci√≥n(es) disponible(s) de ${total} canchas totales`
          : `${mostradas} de ${total} canchas`
        
        contadorResultados.textContent = texto
      }

      // === FUNCI√ìN DE CREACI√ìN DE CANCHAS ===
      async function crearCancha() {
        console.log('Funci√≥n crearCancha llamada')
        if (cargando) return
        
        const muro = document.getElementById('muro').value.trim()
        const sector = document.getElementById('sector').value.trim()
        const nombreDetalle = document.getElementById('nombre-detalle').value.trim()
        
        console.log('Datos del formulario:', { muro, sector, nombreDetalle })
        
        if (!muro || !sector || !nombreDetalle) {
          alert('Por favor completa todos los campos')
          return
        }
        
        try {
          cargando = true
          btnCrearCancha.textContent = 'Creando...'
          btnCrearCancha.disabled = true
          
          const response = await fetch('/api/canchas', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ muro, sector, nombreDetalle })
          })
          
          if (!response.ok) {
            const error = await response.json()
            throw new Error(error.message || 'Error al crear cancha')
          }
          
          // Limpiar formulario
          document.getElementById('muro').value = ''
          document.getElementById('sector').value = ''
          document.getElementById('nombre-detalle').value = ''
          
          // Recargar tabla
          await cargarCanchas()
          
          mostrarMensaje('Cancha creada exitosamente', 'success')
          
        } catch (error) {
          console.error('Error al crear cancha:', error)
          mostrarMensaje('Error al crear la cancha: ' + error.message, 'error')
        } finally {
          cargando = false
          btnCrearCancha.textContent = 'Crear Cancha'
          btnCrearCancha.disabled = false
        }
      }

      // === FUNCI√ìN DE CARGA DE CANCHAS ===
      async function cargarCanchas() {
        try {
          const response = await fetch('/api/canchas')
          if (!response.ok) {
            throw new Error('Error al cargar canchas')
          }
          
          todasLasCanchas = await response.json()
          console.log('üóÇÔ∏è Datos de canchas cargados:', todasLasCanchas)
          if (todasLasCanchas.length > 0) {
            console.log('üîç Primer cancha ejemplo:', todasLasCanchas[0])
            console.log('üè∑Ô∏è Campos disponibles:', Object.keys(todasLasCanchas[0]))
          }
          aplicarFiltros()
        } catch (error) {
          console.error('Error al cargar canchas:', error)
          mostrarMensaje('Error al cargar las canchas', 'error')
        }
      }

      // Mostrar canchas filtradas
      function mostrarCanchas(canchas) {
        renderizarCanchas(canchas)
      }

      // Renderizar tabla de canchas
      function renderizarCanchas(canchas) {
        canchasTBody.innerHTML = canchas.map(cancha => `
          <tr data-cancha-id="${cancha.id}">
            <td><strong>${cancha.nombre.toUpperCase()}</strong></td>
            <td>
              <span class="estado estado-${cancha.estado_actual.toLowerCase().replace(/\s+/g, '-')}">
                ${cancha.estado_actual}
              </span>
            </td>
            <td>
              <span class="empresa-actual empresa-${cancha.empresa_actual.toLowerCase().replace(/\s+/g, '-')}">
                ${cancha.empresa_actual}
              </span>
            </td>
            <td>${new Date(cancha.created_at).toLocaleDateString('es-ES')}</td>
            <td>
              <button class="btn-mapa" data-cancha-id="${cancha.id}" data-cancha-nombre="${cancha.nombre}" type="button" style="background:none; border:none; font-size:1.5rem; cursor:pointer; padding:0.5rem;" title="Ver en mapa">üó∫Ô∏è</button>
            </td>
            <td>
              <div class="actions" data-cancha-id="${cancha.id}" data-estado="${cancha.estado_actual}" data-empresa="${cancha.empresa_actual}">
              </div>
            </td>
            <td class="borrar-column hidden">
              <div class="admin-actions" data-cancha-id="${cancha.id}">
              </div>
            </td>
          </tr>
        `).join('')
        
        // Agregar event listeners para botones del mapa inmediatamente despu√©s de renderizar
        setTimeout(() => {
          console.log('üîß Agregando event listeners para botones del mapa...')
          document.querySelectorAll('.btn-mapa').forEach((btn, index) => {
            console.log(`üîß Configurando bot√≥n ${index}:`, btn.dataset)
            btn.addEventListener('click', (e) => {
              const canchaId = e.target.dataset.canchaId
              const canchaName = e.target.dataset.canchaNombre
              console.log('üó∫Ô∏è Bot√≥n de mapa clickeado:', { canchaId, canchaName })
              console.log('üîç Datasets disponibles:', e.target.dataset)
              abrirMapaModal(canchaId, canchaName)
            })
          })
        }, 100) // Peque√±o delay para asegurar que el DOM est√© actualizado
        
        actualizarAcciones()
      }

      // Actualizar botones de acci√≥n seg√∫n empresa seleccionada
      function actualizarAcciones() {
        console.log('Actualizando acciones para empresa:', empresaLogueada)
        const actionsDivs = document.querySelectorAll('.actions')
        const adminDivs = document.querySelectorAll('.admin-actions')
        
        console.log('Encontrados', actionsDivs.length, 'divs de acciones')
        console.log('Encontrados', adminDivs.length, 'divs de admin')
        
        actionsDivs.forEach((div, index) => {
          const canchaId = div.dataset.canchaId
          const estado = div.dataset.estado
          const empresaActual = div.dataset.empresa
          
          console.log(`Procesando div ${index}: canchaId=${canchaId}, estado=${estado}, empresaActual=${empresaActual}`)
          
          const botonesHTML = generarBotonesAccion(canchaId, estado, empresaActual)
          console.log(`Botones generados: ${botonesHTML}`)
          div.innerHTML = botonesHTML
        })
        
        // Actualizar botones de administraci√≥n
        adminDivs.forEach((div, index) => {
          const canchaId = div.dataset.canchaId
          console.log(`Procesando admin div ${index}: canchaId=${canchaId}`)
          const adminHTML = generarBotonesAdmin(canchaId)
          console.log(`Admin botones generados: ${adminHTML}`)
          div.innerHTML = adminHTML
        })
        
        // Agregar event listeners a los botones
        agregarEventListeners()
        console.log('Event listeners agregados')
      }

      // Generar botones seg√∫n empresa y estado
      function generarBotonesAccion(canchaId, estado, empresaActual) {
        console.log(`generarBotonesAccion: canchaId=${canchaId}, estado=${estado}, empresaActual=${empresaActual}`)
        console.log('empresaLogueada:', empresaLogueada)
        
        if (!empresaLogueada) {
          console.log('No hay empresa logueada')
          return '<span style="color:#666;">Selecciona tu empresa</span>'
        }
        
        const botones = []
        const empresaId = empresaLogueada.id
        console.log('Empresa ID:', empresaId)
        
        // AngloAmerican
        if (empresaId === 1) {
          console.log('Procesando para AngloAmerican')
          if (estado === 'Creada') {
            console.log('Estado es Creada, agregando bot√≥n enviar a Besalco')
            botones.push(`<button class="btn-accion" data-accion="enviar-besalco" data-cancha-id="${canchaId}">Enviar a Besalco</button>`)
          } else if (estado === 'En Proceso' && empresaActual === 'AngloAmerican') {
            console.log('Estado es En Proceso y empresa actual es AngloAmerican')
            // Buscar la cancha para verificar validaciones
            const cancha = todasLasCanchas.find(c => c.id == canchaId)
            if (cancha) {
              const validaciones = cancha.validaciones || []
              console.log('Validaciones encontradas:', validaciones)
              const hasLinkapsis = validaciones.some(v => v.empresa === 'Linkapsis' && v.estado === 'VALIDADO')
              const hasLlayLlay = validaciones.some(v => v.empresa === 'LlayLlay' && v.estado === 'VALIDADO')
              const hasBesalco = validaciones.some(v => v.empresa === 'Besalco' && v.estado === 'VALIDADO')
              
              console.log('Estado validaciones:', { hasLinkapsis, hasLlayLlay, hasBesalco })
              
              if (hasLinkapsis && hasLlayLlay && hasBesalco) {
                console.log('Todas las validaciones completas, agregando bot√≥n PDF')
                botones.push(`<button class="btn-accion btn-pdf" data-accion="exportar-pdf" data-cancha-id="${canchaId}">üìÑ Exportar PDF</button>`)
              }
            }
            
            console.log('Agregando bot√≥n cerrar cancha')
            botones.push(`<button class="btn-accion btn-success" data-accion="abrir-modal-cierre" data-cancha-id="${canchaId}">Cerrar Cancha</button>`)
          } else if (estado === 'Finalizada' || estado === 'Cerrada') {
            console.log('Estado es Finalizada/Cerrada, agregando bot√≥n PDF')
            // Para canchas finalizadas o cerradas, siempre mostrar el bot√≥n PDF
            botones.push(`<button class="btn-accion btn-pdf" data-accion="exportar-pdf" data-cancha-id="${canchaId}">üìÑ Exportar PDF</button>`)
          }
        }
        
        // Besalco
        else if (empresaId === 2) {
          if ((estado === 'En Proceso' || estado === 'Rechazada') && empresaActual === 'Besalco') {
            botones.push(`<button class="btn-accion btn-success" data-accion="abrir-modal-besalco" data-cancha-id="${canchaId}">Gestionar Trabajo</button>`)
          }
        }
        
        // Linkapsis
        else if (empresaId === 3) {
          if (estado === 'En Proceso' && empresaActual === 'Linkapsis') {
            botones.push(`<button class="btn-accion btn-success" data-accion="abrir-modal-linkapsis" data-cancha-id="${canchaId}">Gestionar Cancha</button>`)
          }
        }
        
        // LlayLlay
        else if (empresaId === 4) {
          if (estado === 'En Proceso' && empresaActual === 'LlayLlay') {
            botones.push(`<button class="btn-accion btn-success" data-accion="abrir-modal-llayllay" data-cancha-id="${canchaId}">Gestionar Cancha</button>`)
          }
        }
        
        return botones.length > 0 ? botones.join('') : '<span style="color:#666;">Sin acciones disponibles</span>'
      }

      // Generar botones de administraci√≥n (solo para AngloAmerican)
      function generarBotonesAdmin(canchaId) {
        if (!empresaLogueada || empresaLogueada.id !== 1) {
          return '' // Solo AngloAmerican puede administrar
        }
        
        return `<button class="btn-accion btn-danger" data-accion="abrir-modal-borrar" data-cancha-id="${canchaId}">üóëÔ∏è Borrar</button>`
      }

      // Mostrar/ocultar columna de administraci√≥n seg√∫n empresa
      function actualizarColumnaAdmin() {
        const borrarHeader = document.getElementById('borrar-header')
        const borrarColumns = document.querySelectorAll('.borrar-column')
        
        if (empresaLogueada && empresaLogueada.id === 1) {
          // Mostrar columna para AngloAmerican
          borrarHeader.classList.remove('hidden')
          borrarColumns.forEach(col => col.classList.remove('hidden'))
        } else {
          // Ocultar columna para otras empresas
          borrarHeader.classList.add('hidden')
          borrarColumns.forEach(col => col.classList.add('hidden'))
        }
      }

      // Agregar event listeners a botones de acci√≥n
      function agregarEventListeners() {
        document.querySelectorAll('.btn-accion').forEach(btn => {
          btn.addEventListener('click', manejarAccion)
        })
        
        // Los event listeners para botones del mapa se agregan en renderizarCanchas()
        console.log('ÔøΩ Event listeners de acciones agregados')
      }

      // Manejar acciones de botones
      async function manejarAccion(e) {
        if (cargando) return
        
        const accion = e.target.dataset.accion
        const canchaId = parseInt(e.target.dataset.canchaId)
        
        // Manejar apertura de modales
        if (accion === 'abrir-modal-besalco') {
          abrirModalBesalco(canchaId)
          return
        } else if (accion === 'abrir-modal-linkapsis') {
          abrirModalLinkapsis(canchaId)
          return
        } else if (accion === 'abrir-modal-llayllay') {
          abrirModalLlayLlay(canchaId)
          return
        } else if (accion === 'abrir-modal-cierre') {
          abrirModalCierre(canchaId)
          return
        } else if (accion === 'abrir-modal-borrar') {
          abrirModalBorrar(canchaId)
          return
        } else if (accion === 'exportar-pdf') {
          await exportarPDF(canchaId)
          return
        }
        
        // Confirmar acci√≥n de cierre
        if (accion === 'cerrar') {
          if (!confirm('¬øConfirmas el cierre de esta cancha?')) {
            return
          }
        }
        
        // Pedir observaciones para rechazos (acciones directas legacy)
        let observaciones = null
        if (accion.includes('rechazar')) {
          const empresaNombre = accion === 'rechazar-besalco' ? 'Besalco' : 
                               accion === 'rechazar-linkapsis' ? 'Linkapsis' : 'LlayLlay'
          observaciones = prompt(`Observaciones del rechazo por ${empresaNombre}:`)
          if (observaciones === null) return // Usuario cancel√≥
        }
        
        try {
          cargando = true
          const textoOriginal = e.target.textContent
          e.target.disabled = true
          e.target.textContent = 'Procesando...'
          
          const response = await fetch(`/api/canchas/${canchaId}/action`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ accion, observaciones })
          })
          
          if (!response.ok) {
            const error = await response.json()
            throw new Error(error.message || 'Error al ejecutar acci√≥n')
          }
          
          await cargarCanchas()
          mostrarMensaje('Acci√≥n realizada exitosamente', 'success')
          
        } catch (error) {
          console.error('Error en acci√≥n:', error)
          mostrarMensaje('Error: ' + error.message, 'error')
        } finally {
          cargando = false
        }
      }

      // Mostrar mensajes
      function mostrarMensaje(mensaje, tipo) {
        const div = document.createElement('div')
        div.className = tipo
        div.innerHTML = `<strong>${tipo === 'success' ? '√âxito:' : 'Error:'}</strong> ${mensaje}`
        
        mensajeContainer.appendChild(div)
        
        setTimeout(() => {
          div.remove()
        }, 5000)
      }

      // === FUNCIONES DE MODALES DE VALIDACI√ìN ===
      let canchaIdActual = null

      // Funci√≥n para cargar historial de observaciones de una cancha
      async function cargarHistorialObservaciones(canchaId, historialElementId) {
        try {
          const response = await fetch(`/api/canchas/${canchaId}/validaciones`)
          if (!response.ok) {
            throw new Error('Error al cargar historial')
          }
          
          const validaciones = await response.json()
          const historialElement = document.getElementById(historialElementId)
          const content = historialElement.querySelector('.historial-content')
          
          if (validaciones.length === 0) {
            content.innerHTML = '<p style="color: #666; font-style: italic; text-align: center; padding: 2rem;">No hay observaciones previas</p>'
          } else {
            content.innerHTML = `
              <div class="historial-timeline">
                ${validaciones.map(val => {
                  let medicionesHtml = ''
                  
                  if (val.mediciones) {
                    if (val.mediciones.espesores) {
                      // Mediciones de Linkapsis (formato anterior)
                      medicionesHtml = `
                        <div class="medicion-linea">
                          <span class="medicion-label">Medici√≥n de Espesor:</span> <strong>${val.mediciones.espesores.join(', ')} ${val.mediciones.unidad}</strong>
                          ${val.mediciones.promedio ? `<br><span style="font-size: 0.9rem; color: #666;">Promedio: <strong>${val.mediciones.promedio} ${val.mediciones.unidad}</strong></span>` : ''}
                        </div>`
                    } else if (val.mediciones.espesor) {
                      // Nueva medici√≥n de Linkapsis
                      medicionesHtml = `
                        <div class="medicion-linea">
                          <span class="medicion-label">Medici√≥n de Espesor:</span> <strong>${val.mediciones.espesor} ${val.mediciones.unidad}</strong>
                        </div>`
                    } else if (val.mediciones.densidad) {
                      // Mediciones de LlayLlay
                      medicionesHtml = `
                        <div class="medicion-linea">
                          <span class="medicion-label">Medici√≥n de Densidad:</span> <strong>${val.mediciones.densidad} ${val.mediciones.unidad}</strong>
                        </div>`
                    }
                  }
                  
                  const empresaNombre = val.empresa_validadora?.nombre || 'Empresa desconocida'
                  const empresaClass = empresaNombre.toLowerCase().replace(/\s+/g, '')
                  
                  return `
                    <div class="historial-entry empresa-${empresaClass}">
                      <div class="empresa-nombre">${empresaNombre}</div>
                      <div class="fecha-linea">
                        <span class="fecha-label">Fecha:</span> ${new Date(val.created_at).toLocaleDateString('es-ES', {
                          weekday: 'short',
                          year: 'numeric',
                          month: 'short',
                          day: 'numeric',
                          hour: '2-digit',
                          minute: '2-digit'
                        })}
                      </div>
                      <div class="observacion-linea">
                        <span class="observacion-label">Observaciones:</span> "${val.observaciones || 'Sin observaciones espec√≠ficas'}"
                      </div>
                      ${medicionesHtml}
                    </div>`
                }).join('')}
              </div>
            `
          }
        } catch (error) {
          console.error('Error al cargar historial:', error)
          const historialElement = document.getElementById(historialElementId)
          const content = historialElement.querySelector('.historial-content')
          content.innerHTML = '<p style="color: #e74c3c;">Error al cargar historial</p>'
        }
      }

      function abrirModalBesalco(canchaId) {
        canchaIdActual = canchaId
        const modal = document.getElementById('validacion-besalco-modal')
        const form = document.getElementById('form-validacion-besalco')
        
        // Limpiar formulario
        form.reset()
        
        // Cargar historial de observaciones
        cargarHistorialObservaciones(canchaId, 'historial-besalco')
        
        // Mostrar modal
        modal.classList.add('show')
      }

      function abrirModalLinkapsis(canchaId) {
        canchaIdActual = canchaId
        const modal = document.getElementById('validacion-linkapsis-modal')
        const form = document.getElementById('form-validacion-linkapsis')
        
        // Limpiar formulario b√°sico
        form.reset()
        
        // Limpiar checkboxes espec√≠ficamente
        document.getElementById('trabajo-corte').checked = false
        document.getElementById('trabajo-relleno').checked = false
        
        // Verificar si ya existen coordenadas previas de Linkapsis
        verificarCoordenadasExistentes(canchaId)
        
        // Cargar historial de observaciones (incluye observaciones de Besalco)
        cargarHistorialObservaciones(canchaId, 'historial-linkapsis')
        
        // Mostrar modal
        modal.classList.add('show')
      }

      async function verificarCoordenadasExistentes(canchaId) {
        try {
          const response = await fetch(`/api/canchas/${canchaId}/validaciones`)
          const validaciones = await response.json()
          
          console.log('Validaciones obtenidas:', validaciones)
          
          // Buscar validaciones de Linkapsis (empresa_validadora_id = 3) que tengan coordenadas
          if (validaciones && validaciones.length > 0) {
            const validacionLinkapsis = validaciones.find(v => 
              v.empresa_validadora_id === 3 && 
              v.mediciones && 
              v.mediciones.coordenadas
            )
            
            if (validacionLinkapsis && validacionLinkapsis.mediciones && validacionLinkapsis.mediciones.coordenadas) {
              const coordenadas = validacionLinkapsis.mediciones.coordenadas
              console.log('Coordenadas existentes encontradas:', coordenadas)
              console.log('Validaci√≥n Linkapsis completa:', validacionLinkapsis)
              
              // Pre-llenar los campos con coordenadas existentes
              const coordMap = {
                'p1-norte': coordenadas.p1?.norte || '',
                'p1-este': coordenadas.p1?.este || '',
                'p1-cota': coordenadas.p1?.cota || '',
                'p2-norte': coordenadas.p2?.norte || '',
                'p2-este': coordenadas.p2?.este || '',
                'p2-cota': coordenadas.p2?.cota || '',
                'p3-norte': coordenadas.p3?.norte || '',
                'p3-este': coordenadas.p3?.este || '',
                'p3-cota': coordenadas.p3?.cota || '',
                'p4-norte': coordenadas.p4?.norte || '',
                'p4-este': coordenadas.p4?.este || '',
                'p4-cota': coordenadas.p4?.cota || ''
              }
              
              console.log('Mapa de coordenadas para llenar:', coordMap)
              
              // Llenar los campos si tienen valores
              Object.keys(coordMap).forEach(id => {
                const input = document.getElementById(id)
                if (input && coordMap[id]) {
                  console.log(`Llenando campo ${id} con valor: ${coordMap[id]}`)
                  input.value = coordMap[id]
                } else if (input) {
                  console.log(`Campo ${id} encontrado pero sin valor para llenar`)
                } else {
                  console.log(`Campo ${id} NO encontrado en el DOM`)
                }
              })
              
              // Mantener espesor y checkboxes vac√≠os para nueva evaluaci√≥n
              const espesorInput = document.getElementById('espesor-linkapsis')
              if (espesorInput) {
                espesorInput.value = ''
              }
              
              // Mantener checkboxes de tipo de trabajo sin marcar para nueva evaluaci√≥n
              document.getElementById('trabajo-corte').checked = false
              document.getElementById('trabajo-relleno').checked = false
            } else {
              console.log('No se encontraron validaciones previas de Linkapsis con coordenadas')
              console.log('Validaciones disponibles:', validaciones)
              // No hay coordenadas previas, limpiar todos los campos
              const coordInputs = [
                'p1-norte', 'p1-este', 'p1-cota',
                'p2-norte', 'p2-este', 'p2-cota', 
                'p3-norte', 'p3-este', 'p3-cota',
                'p4-norte', 'p4-este', 'p4-cota'
              ]
              
              coordInputs.forEach(id => {
                const input = document.getElementById(id)
                if (input) input.value = ''
              })
            }
          }
        } catch (error) {
          console.error('Error al verificar coordenadas existentes:', error)
          // En caso de error, limpiar campos por seguridad
          const coordInputs = [
            'p1-norte', 'p1-este', 'p1-cota',
            'p2-norte', 'p2-este', 'p2-cota', 
            'p3-norte', 'p3-este', 'p3-cota',
            'p4-norte', 'p4-este', 'p4-cota'
          ]
          
          coordInputs.forEach(id => {
            const input = document.getElementById(id)
            if (input) input.value = ''
          })
        }
      }

      function abrirModalLlayLlay(canchaId) {
        canchaIdActual = canchaId
        const modal = document.getElementById('validacion-llayllay-modal')
        const form = document.getElementById('form-validacion-llayllay')
        
        // Limpiar formulario
        form.reset()
        
        // Cargar historial de observaciones (incluye Besalco y Linkapsis)
        cargarHistorialObservaciones(canchaId, 'historial-llayllay')
        
        // Mostrar modal
        modal.classList.add('show')
      }

      function abrirModalCierre(canchaId) {
        canchaIdActual = canchaId
        const modal = document.getElementById('cerrar-cancha-modal')
        
        // Cargar historial completo para revisi√≥n final
        cargarHistorialObservaciones(canchaId, 'historial-cierre')
        
        // Mostrar modal
        modal.classList.add('show')
      }

      function abrirModalBorrar(canchaId) {
        canchaIdActual = canchaId
        const modal = document.getElementById('borrar-cancha-modal')
        const inputConfirmacion = document.getElementById('confirmacion-borrado')
        const btnConfirmar = document.getElementById('confirmar-borrado')
        
        // Limpiar input y deshabilitar bot√≥n
        inputConfirmacion.value = ''
        btnConfirmar.disabled = true
        
        // Cargar historial que se eliminar√°
        cargarHistorialObservaciones(canchaId, 'historial-borrado')
        
        // Mostrar modal
        modal.classList.add('show')
      }

      // Funci√≥n para exportar PDF
      async function exportarPDF(canchaId) {
        try {
          cargando = true
          mostrarMensaje('Generando PDF...', 'info')
          
          // Abrir la URL de descarga directamente en una nueva ventana
          const url = `/api/canchas/${canchaId}/download-pdf`
          window.open(url, '_blank')
          
          mostrarMensaje('PDF generado correctamente', 'success')
          
        } catch (error) {
          console.error('Error al exportar PDF:', error)
          mostrarMensaje('Error al generar PDF: ' + error.message, 'error')
        } finally {
          cargando = false
        }
      }

      function cerrarTodosLosModales() {
        document.querySelectorAll('.modal').forEach(modal => {
          modal.classList.remove('show')
        })
        canchaIdActual = null
      }

      // Cerrar modal al hacer click fuera
      window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          cerrarTodosLosModales()
        }
      })

      // Event listeners para botones de cerrar y cancelar
      document.addEventListener('DOMContentLoaded', () => {
        // Botones de cerrar (X)
        document.querySelectorAll('.close-btn').forEach(btn => {
          btn.addEventListener('click', cerrarTodosLosModales)
        })
        
        // Botones de cancelar
        document.querySelectorAll('.btn-cancel').forEach(btn => {
          btn.addEventListener('click', cerrarTodosLosModales)
        })
        
        // Formularios de validaci√≥n
        configurarFormulariosValidacion()
      })

      function configurarFormulariosValidacion() {
        // Formulario Besalco
        const formBesalco = document.getElementById('form-validacion-besalco')
        if (formBesalco) {
          formBesalco.addEventListener('submit', procesarValidacionBesalco)
          
          const btnRechazar = formBesalco.querySelector('.btn-rechazar')
          if (btnRechazar) {
            btnRechazar.addEventListener('click', procesarRechazoBesalco)
          }
        }
        
        // Formulario Linkapsis
        const formLinkapsis = document.getElementById('form-validacion-linkapsis')
        if (formLinkapsis) {
          formLinkapsis.addEventListener('submit', procesarValidacionLinkapsis)
          
          const btnRechazar = formLinkapsis.querySelector('.btn-rechazar')
          if (btnRechazar) {
            btnRechazar.addEventListener('click', procesarRechazoLinkapsis)
          }
        }
        
        // Formulario LlayLlay
        const formLlayLlay = document.getElementById('form-validacion-llayllay')
        if (formLlayLlay) {
          formLlayLlay.addEventListener('submit', procesarValidacionLlayLlay)
          
          const btnRechazar = formLlayLlay.querySelector('.btn-rechazar')
          if (btnRechazar) {
            btnRechazar.addEventListener('click', procesarRechazoLlayLlay)
          }
        }
        
        // Bot√≥n de cierre definitivo
        const btnConfirmarCierre = document.getElementById('confirmar-cierre')
        if (btnConfirmarCierre) {
          btnConfirmarCierre.addEventListener('click', async () => {
            if (confirm('¬øEst√°s seguro de que deseas cerrar esta cancha definitivamente?')) {
              await ejecutarAccion('cerrar_cancha', canchaIdActual, null)
              cerrarTodosLosModales()
            }
          })
        }
        
        // Input de confirmaci√≥n de borrado
        const inputConfirmacion = document.getElementById('confirmacion-borrado')
        const btnConfirmarBorrado = document.getElementById('confirmar-borrado')
        
        if (inputConfirmacion && btnConfirmarBorrado) {
          inputConfirmacion.addEventListener('input', () => {
            btnConfirmarBorrado.disabled = inputConfirmacion.value.trim() !== 'borrar-cancha'
          })
          
          btnConfirmarBorrado.addEventListener('click', async () => {
            await ejecutarAccion('borrar_cancha', canchaIdActual, null)
            cerrarTodosLosModales()
          })
        }
      }

      // === FUNCIONES DE PROCESAMIENTO DE VALIDACIONES ===

      async function procesarValidacionBesalco(e) {
        e.preventDefault()
        
        const observaciones = document.getElementById('besalco-observaciones').value.trim()
        if (!observaciones) {
          mostrarMensaje('Por favor ingresa observaciones', 'error')
          return
        }
        
        await ejecutarAccion('finalizar_besalco', canchaIdActual, observaciones)
      }

      async function procesarRechazoBesalco(e) {
        e.preventDefault()
        
        const observaciones = document.getElementById('besalco-observaciones').value.trim()
        if (!observaciones) {
          mostrarMensaje('Por favor ingresa observaciones del rechazo', 'error')
          return
        }
        
        await ejecutarAccion('rechazar_besalco', canchaIdActual, observaciones)
      }

      async function procesarValidacionLinkapsis(e) {
        e.preventDefault()
        
        const observaciones = document.getElementById('linkapsis-observaciones').value.trim()
        const espesor = parseFloat(document.getElementById('linkapsis-espesor').value)
        
        if (!observaciones || !espesor) {
          mostrarMensaje('Por favor completa las observaciones y la medici√≥n de espesor', 'error')
          return
        }
        
        // Verificar si es revalidaci√≥n
        const isRevalidacion = await esRevalidacion(canchaIdActual, 'Linkapsis')
        
        // Recopilar tipo de trabajo
        const tipoTrabajo = []
        if (document.getElementById('trabajo-corte').checked) {
          tipoTrabajo.push('corte')
        }
        if (document.getElementById('trabajo-relleno').checked) {
          tipoTrabajo.push('relleno')
        }
        
        // Recopilar coordenadas de los 4 puntos
        const coordenadas = {
          p1: {
            norte: parseFloat(document.getElementById('p1-norte').value) || null,
            este: parseFloat(document.getElementById('p1-este').value) || null,
            cota: parseFloat(document.getElementById('p1-cota').value) || null
          },
          p2: {
            norte: parseFloat(document.getElementById('p2-norte').value) || null,
            este: parseFloat(document.getElementById('p2-este').value) || null,
            cota: parseFloat(document.getElementById('p2-cota').value) || null
          },
          p3: {
            norte: parseFloat(document.getElementById('p3-norte').value) || null,
            este: parseFloat(document.getElementById('p3-este').value) || null,
            cota: parseFloat(document.getElementById('p3-cota').value) || null
          },
          p4: {
            norte: parseFloat(document.getElementById('p4-norte').value) || null,
            este: parseFloat(document.getElementById('p4-este').value) || null,
            cota: parseFloat(document.getElementById('p4-cota').value) || null
          }
        }
        
        const mediciones = {
          espesor: espesor,
          unidad: 'metros',
          tipoTrabajo: tipoTrabajo,
          coordenadas: coordenadas,
          isRevalidacion: isRevalidacion
        }
        
        await ejecutarAccion('validar_linkapsis', canchaIdActual, observaciones, mediciones)
      }

      async function procesarRechazoLinkapsis(e) {
        e.preventDefault()
        
        const observaciones = document.getElementById('linkapsis-observaciones').value.trim()
        const espesor = parseFloat(document.getElementById('linkapsis-espesor').value)
        
        if (!observaciones) {
          mostrarMensaje('Por favor ingresa observaciones del rechazo', 'error')
          return
        }
        
        // Incluir mediciones aunque sea rechazo
        let mediciones = null
        if (espesor) {
          // Recopilar tipo de trabajo si est√°n marcados
          const tipoTrabajo = []
          if (document.getElementById('trabajo-corte').checked) {
            tipoTrabajo.push('corte')
          }
          if (document.getElementById('trabajo-relleno').checked) {
            tipoTrabajo.push('relleno')
          }
          
          // Recopilar coordenadas si est√°n disponibles
          const coordenadas = {
            p1: {
              norte: parseFloat(document.getElementById('p1-norte').value) || null,
              este: parseFloat(document.getElementById('p1-este').value) || null,
              cota: parseFloat(document.getElementById('p1-cota').value) || null
            },
            p2: {
              norte: parseFloat(document.getElementById('p2-norte').value) || null,
              este: parseFloat(document.getElementById('p2-este').value) || null,
              cota: parseFloat(document.getElementById('p2-cota').value) || null
            },
            p3: {
              norte: parseFloat(document.getElementById('p3-norte').value) || null,
              este: parseFloat(document.getElementById('p3-este').value) || null,
              cota: parseFloat(document.getElementById('p3-cota').value) || null
            },
            p4: {
              norte: parseFloat(document.getElementById('p4-norte').value) || null,
              este: parseFloat(document.getElementById('p4-este').value) || null,
              cota: parseFloat(document.getElementById('p4-cota').value) || null
            }
          }
          
          mediciones = {
            espesor: espesor,
            unidad: 'metros',
            tipoTrabajo: tipoTrabajo,
            coordenadas: coordenadas
          }
        }
        
        await ejecutarAccion('rechazar_linkapsis', canchaIdActual, observaciones, mediciones)
      }

      async function procesarValidacionLlayLlay(e) {
        e.preventDefault()
        
        const observaciones = document.getElementById('llayllay-observaciones').value.trim()
        const densidad = parseFloat(document.getElementById('llayllay-densidad').value)
        
        if (!observaciones || !densidad) {
          mostrarMensaje('Por favor completa observaciones y densidad', 'error')
          return
        }
        
        // Verificar si es revalidaci√≥n
        const isRevalidacion = await esRevalidacion(canchaIdActual, 'LlayLlay')
        
        const mediciones = {
          densidad: densidad,
          unidad: 'g/cm¬≥',
          isRevalidacion: isRevalidacion
        }
        
        await ejecutarAccion('validar_llay_llay', canchaIdActual, observaciones, mediciones)
      }

      async function procesarRechazoLlayLlay(e) {
        e.preventDefault()
        
        const observaciones = document.getElementById('llayllay-observaciones').value.trim()
        const densidad = parseFloat(document.getElementById('llayllay-densidad').value)
        
        if (!observaciones) {
          mostrarMensaje('Por favor ingresa observaciones del rechazo', 'error')
          return
        }
        
        // Incluir mediciones aunque sea rechazo
        let mediciones = null
        if (densidad) {
          mediciones = {
            densidad: densidad,
            unidad: 'g/cm¬≥'
          }
        }
        
        await ejecutarAccion('rechazar_llay_llay', canchaIdActual, observaciones, mediciones)
      }

      // Funci√≥n auxiliar para determinar si es revalidaci√≥n
      async function esRevalidacion(canchaId, empresa) {
        try {
          const response = await fetch(`/api/canchas/${canchaId}`)
          if (!response.ok) return false
          
          const data = await response.json()
          const cancha = data.cancha
          
          // Buscar validaciones previas de la misma empresa
          const validacionesPrevias = cancha.validaciones?.filter(v => 
            v.empresa === empresa && v.estado === 'VALIDADO'
          ) || []
          
          return validacionesPrevias.length > 0
        } catch (error) {
          console.error('Error al verificar revalidaci√≥n:', error)
          return false
        }
      }

      // Funci√≥n unificada para ejecutar acciones
      async function ejecutarAccion(accion, canchaId, observaciones, mediciones = null) {
        try {
          cargando = true
          
          const payload = {
            accion: accion,
            observaciones: observaciones,
            usuario: usuarioLogueado // Incluir informaci√≥n del usuario actual
          }
          
          if (mediciones) {
            payload.mediciones = mediciones
          }
          
          const response = await fetch(`/api/canchas/${canchaId}/accion`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
          })
          
          if (!response.ok) {
            throw new Error('Error en la respuesta del servidor')
          }
          
          const resultado = await response.json()
          
          cerrarTodosLosModales()
          mostrarMensaje(`Acci√≥n completada exitosamente`, 'success')
          
          // Recargar canchas para mostrar cambios
          await cargarCanchas()
          
        } catch (error) {
          console.error('Error al ejecutar acci√≥n:', error)
          mostrarMensaje('Error al procesar la acci√≥n', 'error')
        } finally {
          cargando = false
        }
      }

      // Funciones para el Modal del Mapa
      function abrirMapaModal(canchaId, canchaName) {
        console.log('üöÄ abrirMapaModal llamado con:', { canchaId, canchaName })
        
        const modal = document.getElementById('mapModal')
        const mapContainer = document.getElementById('mapContainer')
        const canchaIdSpan = document.getElementById('mapCanchaId')
        const closeBtn = document.getElementById('mapCloseBtn')
        
        // Extraer el muro del nombre de la cancha (primera parte antes del primer _)
        const muro = canchaName ? canchaName.split('_')[0] : null
        console.log(`üó∫Ô∏è Abriendo mapa para cancha ${canchaId} (${canchaName}) - Muro detectado: ${muro}`)
        
        // Mostrar ID y nombre de la cancha en el t√≠tulo
        canchaIdSpan.textContent = `${canchaId} (${canchaName || 'Sin nombre'})`
        
        // Agregar event listener al bot√≥n de cerrar
        closeBtn.addEventListener('click', cerrarMapaModal)
        
        // Mostrar el modal
        modal.classList.add('show')
        
        // Agregar evento para cerrar con Escape
        document.addEventListener('keydown', handleEscapeKey)
        
        // Mostrar indicador de carga
        mapContainer.innerHTML = '<div class="map-loading">Cargando mapa...</div>'
        
        // Cargar el mapa en un iframe con el filtro de muro y cancha ID
        setTimeout(() => {
          const iframe = document.createElement('iframe')
          // Pasar el muro y canchaId como par√°metros en la URL
          let mapUrl = '/mapbox-window'
          const params = new URLSearchParams()
          
          if (muro) {
            params.set('muro', muro)
          }
          if (canchaId) {
            params.set('canchaId', canchaId)
          }
          
          if (params.toString()) {
            mapUrl += '?' + params.toString()
          }
          
          console.log('üåê URL del mapa:', mapUrl)
          iframe.src = mapUrl
          iframe.style.width = '100%'
          iframe.style.height = '100%'
          iframe.style.border = 'none'
          iframe.style.borderRadius = '0 0 16px 16px'
          
          mapContainer.innerHTML = ''
          mapContainer.appendChild(iframe)
        }, 300)
      }
      
      function cerrarMapaModal() {
        const modal = document.getElementById('mapModal')
        const mapContainer = document.getElementById('mapContainer')
        const closeBtn = document.getElementById('mapCloseBtn')
        
        modal.classList.remove('show')
        
        // Remover event listeners
        document.removeEventListener('keydown', handleEscapeKey)
        closeBtn.removeEventListener('click', cerrarMapaModal)
        
        // Limpiar el contenido del mapa
        setTimeout(() => {
          mapContainer.innerHTML = ''
        }, 300)
      }
      
      function handleEscapeKey(e) {
        if (e.key === 'Escape') {
          cerrarMapaModal()
        }
      }
      
      // Cerrar modal al hacer clic fuera del contenido
      document.addEventListener('click', function(e) {
        const modal = document.getElementById('mapModal')
        if (e.target === modal) {
          cerrarMapaModal()
        }
        
        const createModal = document.getElementById('createCanchaModal')
        if (e.target === createModal) {
          cerrarModalCrearCancha()
        }
      })

      // =====================================================
      // FUNCIONES PARA CREAR CANCHA CON POL√çGONO
      // =====================================================
      
      // Variable global para almacenar las coordenadas del pol√≠gono dibujado
      let poligonoCoordinadas = null
      
      // Funci√≥n para abrir el modal de crear cancha
      function abrirModalCrearCancha() {
        console.log('üèóÔ∏è Abriendo modal de crear cancha...')
        const modal = document.getElementById('createCanchaModal')
        const closeBtn = document.getElementById('createCanchaCloseBtn')
        
        // Resetear formulario
        document.getElementById('muro-select').value = ''
        document.getElementById('sector-select').value = ''
        document.getElementById('nombre-detalle-input').value = ''
        document.getElementById('open-drawing-btn').disabled = true
        document.getElementById('create-cancha-btn').disabled = true
        document.getElementById('drawing-status').innerHTML = ''
        document.getElementById('drawingMapContainer').style.display = 'none'
        poligonoCoordinadas = null
        
        // Inicializar estado del selector de sector
        const sectorSelect = document.getElementById('sector-select')
        sectorSelect.disabled = true
        sectorSelect.innerHTML = '<option value="">Selecciona un muro primero</option>'
        
        // Agregar event listeners
        closeBtn.addEventListener('click', cerrarModalCrearCancha)
        document.getElementById('open-drawing-btn').addEventListener('click', abrirMapaDibujo)
        document.getElementById('create-cancha-btn').addEventListener('click', crearCanchaConPoligono)
        
        // Agregar listeners para validar formulario
        document.getElementById('muro-select').addEventListener('change', validarFormularioCreacion)
        document.getElementById('sector-select').addEventListener('change', validarFormularioCreacion)
        document.getElementById('nombre-detalle-input').addEventListener('input', validarFormularioCreacion)
        
        modal.classList.add('show')
        
        // Agregar evento para cerrar con Escape
        document.addEventListener('keydown', handleEscapeKeyCrear)
      }
      
      // Funci√≥n para cerrar el modal de crear cancha
      function cerrarModalCrearCancha() {
        console.log('‚ùå Cerrando modal de crear cancha...')
        const modal = document.getElementById('createCanchaModal')
        const closeBtn = document.getElementById('createCanchaCloseBtn')
        
        modal.classList.remove('show')
        
        // Remover event listeners
        document.removeEventListener('keydown', handleEscapeKeyCrear)
        window.removeEventListener('message', handleDrawingMessage)
        closeBtn.removeEventListener('click', cerrarModalCrearCancha)
        document.getElementById('open-drawing-btn').removeEventListener('click', abrirMapaDibujo)
        document.getElementById('create-cancha-btn').removeEventListener('click', crearCanchaConPoligono)
        document.getElementById('muro-select').removeEventListener('change', validarFormularioCreacion)
        document.getElementById('sector-select').removeEventListener('change', validarFormularioCreacion)
        document.getElementById('nombre-detalle-input').removeEventListener('input', validarFormularioCreacion)
        
        // Limpiar el contenido del mapa de dibujo
        setTimeout(() => {
          document.getElementById('drawingMapContainer').innerHTML = ''
        }, 300)
      }
      
      // Funci√≥n para validar el formulario y habilitar botones
      function validarFormularioCreacion() {
        const muro = document.getElementById('muro-select').value
        const sector = document.getElementById('sector-select').value
        const nombreDetalle = document.getElementById('nombre-detalle-input').value.trim()
        
        // Solo actualizar opciones de sector si el muro cambi√≥
        const sectorSelect = document.getElementById('sector-select')
        if (sectorSelect.dataset.ultimoMuro !== muro) {
          actualizarOpcionesSector(muro)
          sectorSelect.dataset.ultimoMuro = muro
        }
        
        const formularioCompleto = muro && sector && nombreDetalle
        document.getElementById('open-drawing-btn').disabled = !formularioCompleto
        
        // Solo habilitar crear cancha si tambi√©n hay pol√≠gono dibujado
        const puedeCrear = formularioCompleto && poligonoCoordinadas
        document.getElementById('create-cancha-btn').disabled = !puedeCrear
        
        console.log('üîç Validaci√≥n formulario:', { muro, sector, nombreDetalle, formularioCompleto, puedeCrear })
      }
      
      // Funci√≥n para actualizar las opciones del selector de sector
      function actualizarOpcionesSector(muro) {
        const sectorSelect = document.getElementById('sector-select')
        
        if (!muro) {
          sectorSelect.disabled = true
          sectorSelect.innerHTML = '<option value="">Selecciona un muro primero</option>'
          return
        }
        
        // Guardar la selecci√≥n actual antes de regenerar
        const seleccionActual = sectorSelect.value
        
        sectorSelect.disabled = false
        
        // Determinar el rango de sectores seg√∫n el muro
        let maxSector = 3 // Por defecto para MO y ME
        if (muro === 'MP') {
          maxSector = 7
        }
        
        // Generar opciones din√°micamente
        let opciones = '<option value="">Selecciona un sector</option>'
        for (let i = 1; i <= maxSector; i++) {
          opciones += `<option value="S${i}">S${i}</option>`
        }
        
        sectorSelect.innerHTML = opciones
        
        // Restaurar la selecci√≥n anterior si es v√°lida
        if (seleccionActual && seleccionActual.match(/^S[1-9]$/)) {
          const numeroSector = parseInt(seleccionActual.substring(1))
          if (numeroSector <= maxSector) {
            sectorSelect.value = seleccionActual
          }
        }
        
        console.log(`üìç Muro ${muro} seleccionado - Sectores disponibles: S1 a S${maxSector}`)
      }
      
      // Funci√≥n para abrir el mapa de dibujo
      function abrirMapaDibujo() {
        console.log('üó∫Ô∏è Abriendo mapa de dibujo...')
        const muro = document.getElementById('muro-select').value
        const drawingContainer = document.getElementById('drawingMapContainer')
        const statusDiv = document.getElementById('drawing-status')
        
        // Mostrar status de carga
        statusDiv.innerHTML = 'üîÑ Cargando mapa de dibujo...'
        statusDiv.className = 'drawing-status info'
        
        // Mostrar el contenedor del mapa
        drawingContainer.style.display = 'block'
        
        // Crear iframe con el mapa de dibujo
        setTimeout(() => {
          const iframe = document.createElement('iframe')
          iframe.src = `/mapbox-window?muro=${encodeURIComponent(muro)}&drawing=true`
          iframe.style.width = '100%'
          iframe.style.height = '100%'
          iframe.style.border = 'none'
          
          // Limpiar listener anterior si existe
          window.removeEventListener('message', handleDrawingMessage)
          
          // Agregar listener para mensajes del iframe
          window.addEventListener('message', handleDrawingMessage)
          
          drawingContainer.innerHTML = ''
          drawingContainer.appendChild(iframe)
          
          statusDiv.innerHTML = 'üé® Herramientas de dibujo activas'
          statusDiv.className = 'drawing-status info'
        }, 300)
      }
      
      // Funci√≥n para manejar mensajes del iframe de dibujo
      function handleDrawingMessage(event) {
        if (event.data.type === 'polygon-drawn') {
          poligonoCoordinadas = event.data.coordinates
          console.log('‚úÖ Pol√≠gono recibido del iframe:', poligonoCoordinadas)
          
          const statusDiv = document.getElementById('drawing-status')
          statusDiv.innerHTML = `‚úÖ ¬°√Årea dibujada correctamente! (${poligonoCoordinadas.length} puntos) Ahora puedes crear la cancha.`
          statusDiv.className = 'drawing-status success'
          
          // Validar formulario nuevamente para habilitar el bot√≥n de crear
          validarFormularioCreacion()
        } else if (event.data.type === 'polygon-deleted') {
          poligonoCoordinadas = null
          console.log('üóëÔ∏è Pol√≠gono eliminado del iframe')
          
          const statusDiv = document.getElementById('drawing-status')
          statusDiv.innerHTML = 'üé® Dibuja un nuevo √°rea de trabajo en el mapa'
          statusDiv.className = 'drawing-status info'
          
          // Validar formulario nuevamente para deshabilitar el bot√≥n de crear
          validarFormularioCreacion()
        }
      }
      
      // Funci√≥n para crear la cancha con pol√≠gono
      async function crearCanchaConPoligono() {
        console.log('üöÄ Creando cancha con pol√≠gono...')
        
        const muro = document.getElementById('muro-select').value
        const sector = document.getElementById('sector-select').value
        const nombreDetalle = document.getElementById('nombre-detalle-input').value.trim()
        
        if (!muro || !sector || !nombreDetalle || !poligonoCoordinadas) {
          alert('Por favor completa todos los campos y dibuja el √°rea en el mapa')
          return
        }
        
        try {
          // Deshabilitar bot√≥n mientras se crea
          document.getElementById('create-cancha-btn').disabled = true
          document.getElementById('create-cancha-btn').textContent = 'Creando...'
          
          const response = await fetch('/api/canchas', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              muro,
              sector,
              nombreDetalle,
              poligonoCoordinadas
            })
          })
          
          if (!response.ok) {
            throw new Error('Error al crear la cancha')
          }
          
          const nuevaCancha = await response.json()
          console.log('‚úÖ Cancha creada exitosamente:', nuevaCancha)
          
          // Cerrar modal
          cerrarModalCrearCancha()
          
          // Recargar la lista de canchas
          await cargarCanchas()
          
          // Mostrar mensaje de √©xito
          mostrarMensaje(`Cancha ${nuevaCancha.nombre} creada exitosamente con √°rea dibujada`, 'success')
          
        } catch (error) {
          console.error('‚ùå Error al crear cancha:', error)
          alert('Error al crear la cancha: ' + error.message)
        } finally {
          // Restaurar bot√≥n
          document.getElementById('create-cancha-btn').disabled = false
          document.getElementById('create-cancha-btn').textContent = 'Crear Cancha'
        }
      }
      
      // Manejar tecla Escape para cerrar modal de crear cancha
      function handleEscapeKeyCrear(e) {
        if (e.key === 'Escape') {
          cerrarModalCrearCancha()
        }
      }

      // Inicializar la aplicaci√≥n
      inicializar()
    </script>

    <!-- Modal para Crear Cancha (solo AngloAmerican) -->
    <div id="createCanchaModal" class="map-modal">
      <div class="map-modal-content create-cancha-modal-content">
        <div class="map-modal-header">
          <h3 class="map-modal-title">Crear Nueva Cancha</h3>
          <button id="createCanchaCloseBtn" class="map-close-btn">&times;</button>
        </div>
        <div class="create-cancha-container">
          <!-- Panel izquierdo: Formulario -->
          <div class="create-cancha-form">
            <h4 class="form-section-title">üìã Datos de la Cancha</h4>
            <div class="form-group">
              <label for="muro-select">Muro:</label>
              <select id="muro-select" required>
                <option value="">Seleccionar Muro</option>
                <option value="MP">MP</option>
                <option value="ME">ME</option>
                <option value="MO">MO</option>
              </select>
            </div>
            <div class="form-group">
              <label for="sector-select">Sector:</label>
              <select id="sector-select" disabled required>
                <option value="">Selecciona un muro primero</option>
              </select>
            </div>
            <div class="form-group">
              <label for="nombre-detalle-input">Nombre Detalle:</label>
              <input type="text" id="nombre-detalle-input" placeholder="ej: TEST1" required>
            </div>
            <div class="form-actions">
              <button id="open-drawing-btn" class="btn-primary" disabled>üó∫Ô∏è Dibujar √Årea en Mapa</button>
              <button id="create-cancha-btn" class="btn-success" disabled>‚úÖ Crear Cancha</button>
            </div>
            <div id="drawing-status" class="drawing-status"></div>
          </div>
          
          <!-- Panel derecho: Mapa -->
          <div class="create-cancha-map-panel">
            <div class="map-panel-header">
              <h4 class="map-panel-title">üó∫Ô∏è √Årea de Trabajo</h4>
              <p class="map-panel-subtitle">Dibuja el pol√≠gono que define el √°rea de la cancha</p>
            </div>
            <div id="drawingMapContainer" class="drawing-map-container">
              <!-- El mapa de dibujo se cargar√° aqu√≠ -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para el Mapa -->
    <div id="mapModal" class="map-modal">
      <div class="map-modal-content">
        <div class="map-modal-header">
          <h3 class="map-modal-title">Visor de Mapa - Cancha <span id="mapCanchaId"></span></h3>
          <button id="mapCloseBtn" class="map-close-btn">&times;</button>
        </div>
        <div id="mapContainer" class="map-container">
          <!-- El mapa se cargar√° aqu√≠ din√°micamente -->
        </div>
      </div>
    </div>
  </body>
</html>
