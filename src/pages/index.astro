---
import AuthGuard from "../components/AuthGuard.astro";
---

<AuthGuard />

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Gestión de Canchas - AngloAmerican</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background-color: #f5f7fa;
        color: #333;
        line-height: 1.6;
      }

      .header {
        background: linear-gradient(135deg, #2c3e50, #3498db);
        color: white;
        padding: 2rem 0;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
      }

      /* Canvas de partículas de fondo */
      #particles-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
      }

      .header h1 {
        position: relative;
        z-index: 1;
      }

      /* Estilos para logos (comentado temporalmente)
      .logos-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 2rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
      }
      
      .company-logo {
        transition: transform 0.3s ease, filter 0.3s ease;
        filter: brightness(1.1) contrast(1.1);
        background: rgba(255, 255, 255, 0.08);
        padding: 0.6rem;
        border-radius: 8px;
        backdrop-filter: blur(10px);
      }
      
      .company-logo:hover {
        transform: scale(1.03);
        filter: brightness(1.15) contrast(1.15);
        background: rgba(255, 255, 255, 0.15);
      }
      */

      .header h1 {
        font-size: 2.2rem;
        margin: 0;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        padding: 1rem 0;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
        margin: 0;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
      }

      .controls {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }

      .control-group {
        margin-bottom: 1.5rem;
      }

      .control-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #2c3e50;
      }

      select,
      input,
      button {
        padding: 0.75rem;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      select:focus,
      input:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
      }

      button {
        background: #3498db;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 600;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
      }

      button:hover {
        background: #2980b9;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
      }

      button:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-success {
        background: #27ae60;
      }

      .btn-success:hover {
        background: #229954;
      }

      .btn-pdf {
        background: #8e44ad;
        color: white;
        font-weight: 600;
      }

      .btn-pdf:hover {
        background: #732d91;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(142, 68, 173, 0.3);
      }

      .btn-danger {
        background: #e74c3c;
      }

      .btn-danger:hover {
        background: #c0392b;
      }

      .btn-warning {
        background: #f39c12;
      }

      .btn-warning:hover {
        background: #e67e22;
      }

      /* Estilos para botones del header */
      .header-buttons {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .header-btn {
        padding: 0.6rem 1.2rem;
        border: none;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
      }

      .header-btn-admin {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        color: white;
      }

      .header-btn-admin:hover {
        background: linear-gradient(135deg, #229954, #27ae60);
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(46, 204, 113, 0.3);
      }

      .header-btn-logout {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
      }

      .header-btn-logout:hover {
        background: linear-gradient(135deg, #c0392b, #a93226);
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(231, 76, 60, 0.3);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr auto;
        gap: 1rem;
        align-items: end;
      }

      .form-row input,
      .form-row select {
        padding: 0.75rem;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 1rem;
        background: white;
        transition: border-color 0.3s ease;
      }

      .form-row input:focus,
      .form-row select:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
      }

      .form-row select:disabled {
        background: #f8f9fa;
        color: #6c757d;
        cursor: not-allowed;
      }

      .form-row label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.5rem;
        display: block;
      }

      .table-container {
        background: white;
        border-radius: 16px;
        box-shadow:
          0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.04);
        margin-bottom: 2rem;
        transition: transform 0.3s ease;
      }

      .table-container:hover {
        transform: translateY(-2px);
      }

      /* Estilos de paginación */
      .pagination-container {
        background: white;
        padding: 1rem 1.5rem;
        border-top: 1px solid #e5e7eb;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .pagination-info {
        color: #64748b;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .pagination-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .pagination-current {
        color: #334155;
        font-weight: 600;
        padding: 0 1rem;
      }

      .pagination-btn {
        background: white;
        border: 1px solid #e5e7eb;
        color: #64748b;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.2s;
        min-width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .pagination-btn:hover:not(:disabled) {
        background: #f1f5f9;
        border-color: #cbd5e1;
        color: #334155;
      }

      .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #f9fafb;
      }

      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }

      th,
      td {
        padding: 1.2rem 1rem;
        text-align: center;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
      }

      th {
        background: linear-gradient(to bottom, #f0f9ff, #e0f2fe);
        font-weight: 700;
        color: #1e3a8a;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.05em;
        border-bottom: 2px solid #bfdbfe;
        position: relative;
      }

      /* Asegurar que el contenido de las celdas esté centrado */
      td {
        text-align: center !important;
        color: #475569;
        font-size: 0.95rem;
      }

      td strong {
        display: inline-block;
        color: #1e293b;
        font-weight: 600;
      }

      tr:last-child td {
        border-bottom: none;
      }

      tr:hover {
        background: #f8fafc;
      }

      /* Estilo para filas clickeables con doble-click */
      .cancha-row {
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .cancha-row:hover {
        background: #f8fafc !important;
        transform: scale(1.001);
        border-left: 3px solid #3b82f6;
      }

      .cancha-row:active {
        background: #bbdefb !important;
      }

      .estado {
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 700;
        text-align: center;
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .estado-creada {
        background: #eff6ff;
        color: #2563eb;
        border: 1px solid #dbeafe;
      }
      .estado-en-proceso {
        background: #fff7ed;
        color: #ea580c;
        border: 1px solid #ffedd5;
      }
      .estado-finalizada {
        background: #f0fdf4;
        color: #16a34a;
        border: 1px solid #dcfce7;
      }
      .estado-validada {
        background: #f0fdf4;
        color: #15803d;
        border: 1px solid #dcfce7;
      }
      .estado-rechazada {
        background: #fef2f2;
        color: #dc2626;
        border: 1px solid #fee2e2;
      }
      .estado-cerrada {
        background: #faf5ff;
        color: #9333ea;
        border: 1px solid #f3e8ff;
      }

      .actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        margin: 0 auto;
      }

      .actions button {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
        margin: 0;
        border-radius: 50px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        transition: all 0.2s ease;
      }

      .btn-accion {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        border: none;
        box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5);
      }

      .btn-accion:hover {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.4);
      }

      .admin-actions {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0 auto;
      }

      .admin-actions button {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
        border-radius: 50px;
        border: 1px solid #ef4444;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        color: #ef4444;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
      }

      .admin-actions button:hover {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        border-color: transparent;
      }

      #borrar-header {
        text-align: center;
        background: #f8f9fa;
        font-weight: 600;
        color: #e74c3c;
        border-left: 3px solid #e74c3c;
      }

      .loading {
        text-align: center;
        padding: 2rem;
        color: #666;
      }

      .error {
        background: #ffebee;
        color: #c62828;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border-left: 4px solid #c62828;
      }

      .success {
        background: #e8f5e8;
        color: #2e7d32;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border-left: 4px solid #2e7d32;
      }

      .empresa-actual {
        font-weight: 600;
        padding: 0.4rem 0.8rem;
        border-radius: 50px;
        font-size: 0.8rem;
        text-align: center;
        display: inline-block;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }

      .empresa-angloamerican {
        background: #eff6ff;
        color: #1d4ed8;
        border: 1px solid #dbeafe;
      }
      .empresa-besalco {
        background: #fff7ed;
        color: #c2410c;
        border: 1px solid #ffedd5;
      }
      .empresa-linkapsis {
        background: #f0fdf4;
        color: #15803d;
        border: 1px solid #dcfce7;
      }
      .empresa-llayllay {
        background: #faf5ff;
        color: #7e22ce;
        border: 1px solid #f3e8ff;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        position: relative;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e1e8ed;
      }

      .modal-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #2c3e50;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
        padding: 0.5rem;
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .close-btn:hover {
        background: #f1f2f6;
        color: #333;
      }

      .observacion-item {
        background: #f8f9fa;
        border-left: 4px solid #e74c3c;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 8px;
      }

      .observacion-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }

      .observacion-empresa {
        font-weight: 600;
        color: #e74c3c;
      }

      .observacion-fecha {
        font-size: 0.85rem;
        color: #666;
      }

      .observacion-tipo {
        font-size: 0.8rem;
        color: #7f8c8d;
        text-transform: capitalize;
      }

      .observacion-texto {
        color: #2c3e50;
        line-height: 1.5;
        margin-top: 0.5rem;
      }

      /* Estilos para Login por Empresa */
      .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 60vh;
        padding: 2rem;
      }

      .login-card {
        background: white;
        border-radius: 16px;
        padding: 3rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 500px;
        width: 100%;
      }

      .login-card h2 {
        color: #2c3e50;
        margin-bottom: 1rem;
        font-size: 2rem;
      }

      .login-card p {
        color: #666;
        margin-bottom: 2rem;
        font-size: 1.1rem;
      }

      .login-form {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      #empresa-login {
        font-size: 1.2rem;
        padding: 1rem;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        background: white;
        transition: border-color 0.3s ease;
      }

      #empresa-login:focus {
        border-color: #3498db;
        outline: none;
      }

      #btn-ingresar {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      #btn-ingresar:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
      }

      #btn-ingresar:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
      }

      /* Header de empresa logueada */
      .empresa-header {
        background: white;
        padding: 1rem 2rem;
        margin-bottom: 2rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .empresa-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .empresa-nombre {
        font-size: 1.5rem;
        font-weight: 600;
        color: #2c3e50;
      }

      .empresa-rol {
        font-size: 0.9rem;
        color: #666;
      }

      #btn-cambiar-empresa {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      #btn-cambiar-empresa:hover {
        background: #c0392b;
      }

      /* Estilos para filtros */
      .filtros-container {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }

      .filtros-container h3 {
        color: #2c3e50;
        margin-bottom: 1rem;
        font-size: 1.3rem;
      }

      .filtros-row {
        display: flex;
        gap: 2rem;
        align-items: end;
        flex-wrap: wrap;
        margin-bottom: 1rem;
      }

      .filtro-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        min-width: 150px;
      }

      .filtro-group.rango-fechas {
        flex-direction: row;
        align-items: center;
        gap: 1rem;
        min-width: auto;
      }

      .filtro-group.rango-fechas label {
        margin: 0;
        white-space: nowrap;
      }

      .filtro-group label {
        font-weight: 600;
        color: #555;
        font-size: 0.9rem;
      }

      .toggle-group {
        display: flex;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        overflow: hidden;
      }

      .toggle-btn {
        background: #f8f9fa;
        border: none;
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        color: #555;
      }

      .toggle-btn:hover:not(.active) {
        background: #e9ecef;
        color: #333;
      }

      .toggle-btn.active {
        background: #3498db;
        color: white;
      }

      .toggle-btn:first-child {
        border-right: 1px solid #e1e8ed;
      }

      #filtro-fecha,
      #fecha-desde,
      #fecha-hasta {
        padding: 0.75rem;
        border: 2px solid #e1e8ed;
        border-radius: 6px;
        transition: border-color 0.3s ease;
      }

      #filtro-fecha:focus,
      #fecha-desde:focus,
      #fecha-hasta:focus {
        border-color: #3498db;
        outline: none;
      }

      #btn-aplicar-rango {
        background: #27ae60;
        color: white;
        border: none;
        padding: 0.75rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s ease;
        font-weight: 500;
      }

      #btn-aplicar-rango:hover {
        background: #229954;
      }

      /* Layout principal de filtros */
      .filtros-main-layout {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 2rem;
        align-items: start;
      }

      .filtros-controls {
        flex: 1;
      }

      /* === STATS SIDEBAR (WIDGETS ORIGINALES) === */
      .stats-sidebar {
        display: flex;
        flex-direction: row;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 1rem 1.5rem;
        color: white;
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 1rem;
        flex: 1;
        box-shadow:
          0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }

      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow:
          0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }

      .stat-card.stat-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      }

      .stat-card.stat-info {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      }

      .stat-icon {
        font-size: 2rem;
        opacity: 0.9;
        line-height: 1;
        flex-shrink: 0;
      }

      .stat-content {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex: 1;
      }

      .stat-content-top {
        display: flex;
        align-items: center;
        gap: 0;
      }

      .stat-number {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1;
        flex-shrink: 0;
      }

      .stat-label {
        font-size: 0.875rem;
        opacity: 0.9;
        font-weight: 500;
        white-space: nowrap;
      }

      /* === DASHBOARD DE ESTADOS (NUEVA SECCIÓN) === */
      .dashboard-estados-section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 2rem;
        margin-bottom: 2rem;
        box-shadow:
          0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
      }

      .dashboard-estados-header {
        margin-bottom: 1.5rem;
      }

      .dashboard-estados-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
      }

      /* Dashboard de Estados - Widgets circulares */
      .dashboard-estados {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        gap: 1.5rem;
        padding: 1rem 0;
        min-width: 700px;
      }

      .estado-widget {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
        flex: 1;
        min-width: 0;
        transition: transform 0.3s ease;
        cursor: pointer;
        user-select: none;
      }

      .estado-widget:hover {
        transform: translateY(-4px);
      }

      /* No hover para widgets dimmed */
      .estado-widget.dimmed:hover {
        transform: none;
      }

      .estado-widget.selected .widget-circle {
        transform: scale(1.2);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.45);
        border-width: 6px;
      }

      .estado-widget.selected .widget-label {
        font-weight: 700;
        color: #1f2937;
      }

      /* Widgets no seleccionados cuando hay uno activo */
      .estado-widget.dimmed .widget-circle {
        opacity: 0.3 !important;
        filter: grayscale(100%) !important;
        transform: scale(1) !important;
      }

      .estado-widget.dimmed:hover .widget-circle {
        opacity: 0.3 !important;
        filter: grayscale(100%) !important;
        transform: scale(1) !important;
      }

      .estado-widget.dimmed .widget-label {
        opacity: 0.4;
        color: #9ca3af;
      }

      .widget-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
        border: 4px solid;
        position: relative;
      }

      .estado-widget:not(.dimmed):hover .widget-circle {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
      }

      .widget-number {
        font-size: 2rem;
        font-weight: 800;
        color: white;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        font-family: "Segoe UI", system-ui, sans-serif;
      }

      .widget-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #475569;
        text-align: center;
        line-height: 1.2;
        text-transform: capitalize;
      }

      /* Colores específicos por estado - Basados en el mapa */
      .widget-creada {
        background: #3b82f6; /* Azul */
        border-color: #2563eb; /* Azul oscuro */
      }

      .widget-en-espera {
        background: #fbbf24; /* Amarillo */
        border-color: #f59e0b; /* Amarillo oscuro */
      }

      .widget-en-proceso {
        background: #fbbf24; /* Amarillo */
        border-color: #10b981; /* Verde - diferenciador */
      }

      .widget-validada {
        background: #10b981; /* Verde */
        border-color: #fbbf24; /* Amarillo - diferenciador */
      }

      .widget-rechazada-en-espera {
        background: #ef4444; /* Rojo */
        border-color: #fbbf24; /* Amarillo */
      }

      .widget-cerrada {
        background: #10b981; /* Verde */
        border-color: #059669; /* Verde oscuro */
      }

      @media (max-width: 1200px) {
        .filtros-main-layout {
          grid-template-columns: 1fr;
          gap: 1.5rem;
        }

        .dashboard-estados {
          min-width: unset;
          gap: 1.2rem;
        }

        .widget-circle {
          width: 70px;
          height: 70px;
        }

        .widget-number {
          font-size: 1.75rem;
        }

        .widget-label {
          font-size: 0.8rem;
        }
      }

      @media (max-width: 768px) {
        .dashboard-estados {
          flex-wrap: wrap;
          justify-content: center;
          gap: 1.5rem;
        }

        .estado-widget {
          flex: 0 0 auto;
          min-width: 90px;
        }

        .widget-circle {
          width: 75px;
          height: 75px;
        }
      }

      @media (max-width: 480px) {
        .dashboard-estados {
          gap: 1rem;
        }

        .widget-circle {
          width: 65px;
          height: 65px;
        }

        .widget-number {
          font-size: 1.5rem;
        }

        .widget-label {
          font-size: 0.75rem;
        }
      }

      /* Estilos para formularios de validación */
      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.5rem;
      }

      .form-group textarea,
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e1e8ed;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }

      .form-group textarea {
        min-height: 100px;
        resize: vertical;
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        border-color: #3498db;
        outline: none;
      }

      .mediciones-group {
        display: flex;
        gap: 0.5rem;
      }

      .mediciones-group input {
        flex: 1;
      }

      .form-group small {
        color: #666;
        font-size: 0.85rem;
        margin-top: 0.25rem;
        display: block;
      }

      /* Estilos para checkboxes de tipo de trabajo */
      .checkbox-group {
        display: flex;
        gap: 1rem;
        margin-top: 0.5rem;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        padding: 0.5rem;
        border: 2px solid #e1e8ed;
        border-radius: 6px;
        transition: all 0.3s ease;
      }

      .checkbox-item:hover {
        background-color: #f8f9fa;
        border-color: #3498db;
      }

      .checkbox-item input[type="checkbox"] {
        width: auto;
        margin: 0;
      }

      .checkbox-item span {
        font-weight: 500;
        color: #2c3e50;
      }

      /* Estilos para coordenadas */
      .coordenadas-grid {
        display: grid;
        gap: 1.5rem;
        margin-top: 1rem;
      }

      .punto-section {
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        padding: 1rem;
        background-color: #f8f9fa;
      }

      .punto-section h5 {
        margin: 0 0 1rem 0;
        color: #2c3e50;
        font-weight: 600;
        font-size: 1.1rem;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 0.5rem;
      }

      .coordenadas-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1rem;
      }

      .coord-field {
        display: flex;
        flex-direction: column;
      }

      .coord-field label {
        font-size: 0.9rem;
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.25rem;
      }

      .coord-field input {
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.9rem;
      }

      .coord-field input:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
      }

      /* Responsive para coordenadas */
      @media (max-width: 768px) {
        .coordenadas-row {
          grid-template-columns: 1fr;
          gap: 0.5rem;
        }

        .checkbox-group {
          flex-direction: column;
          gap: 0.5rem;
        }
      }

      .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid #e1e8ed;
      }

      .btn-cancel,
      .btn-validar,
      .btn-rechazar,
      .btn-finalizar {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-cancel {
        background: #6c757d;
        color: white;
      }

      .btn-cancel:hover {
        background: #5a6268;
      }

      .btn-validar,
      .btn-finalizar {
        background: #27ae60;
        color: white;
      }

      .btn-validar:hover,
      .btn-finalizar:hover {
        background: #229954;
      }

      .btn-rechazar {
        background: #e74c3c;
        color: white;
      }

      .btn-rechazar:hover {
        background: #c0392b;
      }

      .btn-comenzar {
        background: #3498db;
        color: white;
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-comenzar:hover {
        background: #2980b9;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
      }

      #empresa-selector {
        font-size: 1.2rem;
        font-weight: 600;
        padding: 1rem;
        background: #f8f9fa;
        border: 2px solid #3498db;
      }

      /* Estilos para historial de observaciones */
      .historial-observaciones {
        margin: 1rem 0;
        padding: 1.5rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        border-left: 4px solid #3498db;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .historial-observaciones h4 {
        margin: 0 0 1.5rem 0;
        font-size: 1.3rem;
        color: #2c3e50;
        text-align: center;
        border-bottom: 3px solid #3498db;
        padding-bottom: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .historial-content {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 0.5rem;
      }

      .historial-timeline {
        position: relative;
        padding-left: 2rem;
      }

      .historial-timeline::before {
        content: "";
        position: absolute;
        left: 1rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, #3498db, #2ecc71);
      }

      .observacion-item {
        position: relative;
        background: white;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        border: 2px solid #e0e0e0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .observacion-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        border-color: #3498db;
      }

      .observacion-item::before {
        content: "";
        position: absolute;
        left: -2.75rem;
        top: 1rem;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: white;
        border: 3px solid #3498db;
        z-index: 1;
      }

      .observacion-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #eee;
      }

      .observacion-empresa {
        font-weight: 700;
        font-size: 1rem;
        color: #2c3e50;
        background: #3498db;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.9rem;
      }

      .observacion-fecha {
        font-size: 0.8rem;
        color: #7f8c8d;
        font-weight: 500;
      }

      .observacion-contenido {
        margin-top: 0.5rem;
      }

      .observacion-texto {
        color: #2c3e50;
        margin: 0.5rem 0;
        line-height: 1.5;
        font-style: italic;
        background: #f8f9fa;
        padding: 0.75rem;
        border-radius: 6px;
        border-left: 3px solid #3498db;
      }

      .observacion-mediciones {
        background: linear-gradient(135deg, #e8f4fd 0%, #d1ecf1 100%);
        padding: 0.75rem;
        border-radius: 6px;
        margin-top: 0.75rem;
        border: 1px solid #bee5eb;
      }

      .medicion-titulo {
        font-weight: 600;
        color: #155724;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
        display: flex;
        align-items: center;
      }

      .medicion-titulo::before {
        content: "📏";
        margin-right: 0.5rem;
      }

      .medicion-valor {
        font-size: 1rem;
        color: #0c5460;
        font-weight: 700;
        font-family: "Courier New", monospace;
      }

      .empresa-besalco::before {
        background-color: #e74c3c;
      }
      .empresa-linkapsis::before {
        background-color: #f39c12;
      }
      .empresa-llayllay::before {
        background-color: #27ae60;
      }
      .empresa-angloamerican::before {
        background-color: #3498db;
      }

      /* Nuevos estilos para historial mejorado */
      .historial-entry {
        background: #ffffff;
        border: 2px solid #e1e8ed;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        position: relative;
      }

      .historial-entry:hover {
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
      }

      .empresa-nombre {
        font-size: 1.4rem;
        font-weight: 800;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 1.2px;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      /* Colores específicos por empresa */
      .historial-entry.empresa-besalco {
        border-left: 6px solid #e74c3c;
        background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
      }

      .historial-entry.empresa-besalco .empresa-nombre {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
      }

      .historial-entry.empresa-linkapsis {
        border-left: 6px solid #f39c12;
        background: linear-gradient(135deg, #fffaf5 0%, #ffffff 100%);
      }

      .historial-entry.empresa-linkapsis .empresa-nombre {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        color: white;
      }

      .historial-entry.empresa-llayllay {
        border-left: 6px solid #27ae60;
        background: linear-gradient(135deg, #f8fff8 0%, #ffffff 100%);
      }

      .historial-entry.empresa-llayllay .empresa-nombre {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        color: white;
      }

      .historial-entry.empresa-angloamerican {
        border-left: 6px solid #3498db;
        background: linear-gradient(135deg, #f5f9ff 0%, #ffffff 100%);
      }

      .historial-entry.empresa-angloamerican .empresa-nombre {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
      }

      .fecha-linea,
      .observacion-linea,
      .medicion-linea {
        margin-bottom: 1rem;
        line-height: 1.6;
        padding: 0.5rem 0;
      }

      .fecha-label,
      .observacion-label,
      .medicion-label {
        font-weight: 700;
        color: #2c3e50;
        font-size: 1rem;
        display: inline-block;
        min-width: 120px;
      }

      .observacion-linea {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #3498db;
        font-style: italic;
        font-size: 1.05rem;
      }

      .medicion-linea {
        background: linear-gradient(135deg, #e8f4fd 0%, #d1ecf1 100%);
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #bee5eb;
        font-size: 1rem;
      }

      .medicion-linea strong {
        color: #155724;
        font-family: "Courier New", monospace;
        font-size: 1.1rem;
        font-weight: 800;
      }

      /* Separador entre empresas */
      .separador-empresas {
        text-align: center;
        margin: 2rem 0;
        font-size: 1.2rem;
        color: #bdc3c7;
        letter-spacing: 3px;
        font-family: monospace;
        line-height: 1;
      }

      .hidden {
        display: none;
      }

      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
        }

        .container {
          padding: 1rem;
        }

        .header h1 {
          font-size: 1.8rem;
        }

        /* Estilos responsivos para logos (comentado temporalmente)
        .logos-container {
          gap: 1.5rem;
          margin-bottom: 1.2rem;
        }
        
        .company-logo {
          max-width: 220px;
          height: auto;
        }
        */

        /* Para pantallas muy pequeñas */
        @media (max-width: 480px) {
          /* Estilos para logos comentados
          .logos-container {
            gap: 1rem;
          }
          
          .company-logo {
            max-width: 180px;
          }
          */

          .header h1 {
            font-size: 1.5rem;
            line-height: 1.3;
            padding: 0 1rem;
          }
        }

        table {
          font-size: 0.9rem;
        }

        th,
        td {
          padding: 0.5rem;
        }

        .actions {
          flex-direction: column;
        }
      }

      /* Estilos para el Modal del Mapa */
      .map-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
      }

      .map-modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease-out;
      }

      .map-modal-content {
        background: white;
        border-radius: 16px;
        width: 95%;
        height: 90%;
        max-width: 1200px;
        max-height: 800px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: slideIn 0.3s ease-out;
      }

      .map-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 16px 16px 0 0;
      }

      .map-modal-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
      }

      .map-close-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 2rem;
        cursor: pointer;
        padding: 0.5rem 0.8rem;
        border-radius: 50%;
        transition: all 0.3s ease;
        line-height: 1;
      }

      .map-close-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      .map-container {
        flex: 1;
        position: relative;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 500px;
      }

      .map-container iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 0 0 16px 16px;
      }

      .map-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #666;
        font-size: 1.1rem;
      }

      .map-loading::before {
        content: "";
        width: 40px;
        height: 40px;
        border: 4px solid #e1e8ed;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: scale(0.9) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Responsive para el modal del mapa */
      @media (max-width: 768px) {
        .map-modal-content {
          width: 98%;
          height: 95%;
          margin: 1%;
        }

        .map-modal-header {
          padding: 1rem 1.5rem;
        }

        .map-modal-title {
          font-size: 1.2rem;
        }

        /* Responsive para modal de creación */
        #createCanchaModal .map-modal-content {
          width: 98vw !important;
          height: 98vh !important;
          margin: 1vh auto !important;
        }

        .create-cancha-container {
          flex-direction: column !important;
          height: calc(100% - 60px) !important;
        }

        .create-cancha-form {
          flex: 0 0 auto !important;
          max-height: 45vh !important;
          border-right: none !important;
          border-bottom: 2px solid #e1e8ed !important;
          padding: 1.5rem !important;
        }

        .create-cancha-map-panel {
          flex: 1 !important;
          min-height: 300px !important;
        }

        .map-panel-header {
          padding: 1rem !important;
        }

        .form-actions {
          flex-direction: row !important;
          gap: 0.5rem !important;
        }

        .form-actions button {
          font-size: 0.8rem !important;
          padding: 0.6rem 0.8rem !important;
        }
      }

      /* Estilos para el Modal de Creación de Cancha */
      #createCanchaModal .map-modal-content {
        max-width: 1400px !important;
        width: 95vw !important;
        height: 90vh !important;
        max-height: none !important;
      }

      .create-cancha-container {
        display: flex !important;
        height: calc(100% - 80px) !important; /* Altura total menos header */
        gap: 0 !important;
        flex-direction: row !important;
      }

      .create-cancha-form {
        flex: 0 0 380px !important; /* Ancho fijo para el formulario */
        padding: 2rem !important;
        background: #f8f9fa !important;
        border-right: 2px solid #e1e8ed !important;
        display: flex !important;
        flex-direction: column !important;
        gap: 1.5rem !important;
        overflow-y: auto !important;
        min-height: 100% !important;
      }

      .form-section-title {
        color: #2c3e50 !important;
        font-size: 1.1rem !important;
        font-weight: 600 !important;
        margin: 0 0 1rem 0 !important;
        padding-bottom: 0.5rem !important;
        border-bottom: 2px solid #667eea !important;
      }

      .create-cancha-map-panel {
        flex: 1 !important; /* Ocupa el resto del espacio */
        display: flex !important;
        flex-direction: column !important;
        background: #ffffff !important;
        min-width: 0 !important; /* Permite que el flex item se encoja */
      }

      .map-panel-header {
        padding: 1.5rem 2rem 1rem 2rem !important;
        border-bottom: 1px solid #e1e8ed !important;
        background: linear-gradient(
          135deg,
          #667eea 0%,
          #764ba2 100%
        ) !important;
        color: white !important;
        flex-shrink: 0 !important;
      }

      .map-panel-title {
        margin: 0 0 0.5rem 0 !important;
        font-size: 1.1rem !important;
        font-weight: 600 !important;
      }

      .map-panel-subtitle {
        margin: 0 !important;
        font-size: 0.9rem !important;
        opacity: 0.9 !important;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
      }

      .form-group input,
      .form-group select {
        padding: 0.8rem;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-actions {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        margin-top: auto; /* Empuja los botones hacia abajo */
      }

      .form-actions button {
        padding: 0.8rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
        border: none;
        font-size: 0.9rem;
      }

      .drawing-map-container {
        flex: 1;
        min-height: 500px;
        background: #f0f2f5;
        position: relative;
        border-radius: 0;
        overflow: hidden;
      }

      .drawing-map-container iframe {
        width: 100%;
        height: 100%;
        border: none;
      }

      .drawing-status {
        padding: 1rem;
        border-radius: 8px;
        font-weight: 500;
        text-align: center;
        font-size: 0.9rem;
      }

      .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 1rem;
      }

      .btn-primary,
      .btn-success {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-success {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
      }

      .btn-success:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
      }

      .btn-primary:disabled,
      .btn-success:disabled {
        background: #cccccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .drawing-status {
        text-align: center;
        padding: 1rem;
        border-radius: 8px;
        font-weight: 500;
        min-height: 1.5rem;
      }

      .drawing-status.success {
        background: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #4caf50;
      }

      .drawing-status.info {
        background: #e3f2fd;
        color: #1976d2;
        border: 1px solid #2196f3;
      }

      #createCanchaModal .drawing-map-container {
        flex: 1 !important;
        height: 100% !important;
        min-height: 400px !important;
        background: #f0f2f5 !important;
        position: relative !important;
        border-radius: 0 !important;
        overflow: hidden !important;
        display: flex !important; /* Siempre visible en el nuevo diseño */
        align-items: center !important;
        justify-content: center !important;
      }

      #createCanchaModal .drawing-map-container iframe {
        width: 100% !important;
        height: 100% !important;
        border: none !important;
      }

      #createCanchaModal .drawing-map-container:empty::before {
        content: "🗺️ El mapa aparecerá aquí cuando hagas clic en 'Dibujar Área en Mapa'" !important;
        color: #6c757d !important;
        font-style: italic !important;
        text-align: center !important;
        padding: 2rem !important;
        line-height: 1.5 !important;
      }

      /* Estilos para el botón de crear cancha en el header */
      .btn-crear-cancha {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      }

      .btn-crear-cancha:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
      }

      .texto-ayuda {
        color: #666;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        font-style: italic;
      }

      /* === ESTILOS DEL MAPA DASHBOARD === */
      .dashboard-map-section {
        margin: 2rem 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }

      .dashboard-map-header {
        padding: 1.5rem;
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        border-bottom: 3px solid #3b82f6;
      }

      .dashboard-map-title {
        margin: 0;
        color: white;
        font-size: 1.5rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .dashboard-map-subtitle {
        margin: 0.5rem 0 0 0;
        color: #cbd5e1;
        font-size: 0.9rem;
        font-weight: 400;
      }

      .dashboard-map-container {
        position: relative;
        width: 100%;
        height: 600px;
        background: #f8fafc;
      }

      .dashboard-map-container iframe {
        width: 100%;
        height: 100%;
        border: none;
      }

      .dashboard-map-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #64748b;
        font-size: 1rem;
        font-weight: 500;
      }

      .dashboard-map-loading::before {
        content: "🗺️";
        display: block;
        font-size: 3rem;
        margin-bottom: 1rem;
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.7;
          transform: scale(1.1);
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .dashboard-map-container {
          height: 400px;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <!-- Logos de empresas (comentado temporalmente) -->
      <!--
      <div class="logos-container">
        <img title="Besalco" width="280" height="60" src="/Besalco.png" alt="Besalco" class="company-logo">
        <img title="Linkapsis" width="280" height="60" src="/Linkapsis.png" alt="Linkapsis" class="company-logo">
        <img title="AngloAmerican" width="280" height="60" src="/AngloAmerican.png" alt="AngloAmerican" class="company-logo">
        <img title="LlayLlay" width="80" height="80" src="/LlayLlay.png" alt="LlayLlay" class="company-logo">
      </div>
      -->

      <canvas id="particles-canvas"></canvas>
      <h1>Gestión de Canchas AngloAmerican - Las Tórtolas</h1>
    </div>

    <div class="container">
      <div id="mensaje-container"></div>

      <!-- Pantalla Principal -->
      <div id="main-screen">
        <!-- Header de usuario logueado -->
        <div class="empresa-header" id="user-header">
          <div class="empresa-info">
            <span class="empresa-nombre" id="user-name"
              >Cargando usuario...</span
            >
            <span class="empresa-rol" id="user-role"
              >Verificando permisos...</span
            >
          </div>
          <div class="header-buttons">
            <span id="user-company" class="empresa-actual">Cargando...</span>
            <button
              id="btn-abrir-modal-crear"
              type="button"
              class="header-btn header-btn-create"
              style="display: none;">🏗️ Crear Cancha</button
            >
            <a
              id="btn-admin-usuarios"
              href="/admin/usuarios"
              class="header-btn header-btn-admin"
              style="display: none;">👥 Gestión Usuarios</a
            >
            <button
              id="btn-logout"
              type="button"
              class="header-btn header-btn-logout">Cerrar Sesión</button
            >
          </div>
        </div>

        <!-- Controles y Filtros -->
        <div class="controls">
          <!-- Filtros -->

          <!-- Filtros -->
          <div class="filtros-container">
            <h3>Filtros</h3>
            <!-- Layout principal con controles a la izquierda y stats a la derecha -->
            <div class="filtros-main-layout">
              <!-- Controles de filtros -->
              <div class="filtros-controls">
                <div class="filtros-row">
                  <div class="filtro-group">
                    <label>Vista:</label>
                    <div class="toggle-group">
                      <button id="btn-vista-acciones" class="toggle-btn active"
                        >Mis Acciones</button
                      >
                      <button id="btn-vista-historico" class="toggle-btn"
                        >Ver Histórico</button
                      >
                    </div>
                  </div>

                  <div class="filtro-group">
                    <label for="filtro-fecha">Filtro de Fecha:</label>
                    <select id="filtro-fecha">
                      <option value="all">Todas las fechas</option>
                      <option value="today">Hoy</option>
                      <option value="week">Última semana</option>
                      <option value="month">Último mes</option>
                      <option value="custom">Rango personalizado</option>
                    </select>
                  </div>

                  <div
                    id="rango-fechas"
                    class="filtro-group rango-fechas hidden"
                  >
                    <label>Desde:</label>
                    <input type="date" id="fecha-desde" />
                    <label>Hasta:</label>
                    <input type="date" id="fecha-hasta" />
                    <button id="btn-aplicar-rango" type="button">Aplicar</button
                    >
                  </div>
                </div>
              </div>

              <!-- Dashboard de Estadísticas en sidebar -->
              <div class="stats-sidebar">
                <div class="stat-card stat-primary">
                  <div class="stat-icon">⚙️</div>
                  <div class="stat-number" id="stat-acciones">-</div>
                  <div class="stat-label">Acciones Disponibles</div>
                </div>

                <div class="stat-card stat-info">
                  <div class="stat-icon">📋</div>
                  <div class="stat-number" id="stat-total">-</div>
                  <div class="stat-label">Total de Canchas</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tabla de canchas -->
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Nombre de Cancha</th>
                <th>Estado Actual</th>
                <th>Empresa Actual</th>
                <th>Fecha Creación</th>
                <th>Mapa</th>
                <th>Acciones</th>
                <th id="borrar-header" class="hidden">Administrar</th>
              </tr>
            </thead>
            <tbody id="canchas-tbody">
              <!-- Las canchas se cargarán dinámicamente -->
            </tbody>
          </table>

          <!-- Controles de paginación -->
          <div class="pagination-container">
            <div class="pagination-info">
              Mostrando <span id="pagination-start">0</span> - <span
                id="pagination-end">0</span
              > de <span id="pagination-total">0</span> canchas
            </div>
            <div class="pagination-controls">
              <button
                id="btn-primera-pagina"
                class="pagination-btn"
                title="Primera página">&laquo;</button
              >
              <button
                id="btn-pagina-anterior"
                class="pagination-btn"
                title="Página anterior">&lsaquo;</button
              >
              <span class="pagination-current">
                Página <span id="pagina-actual">1</span> de <span
                  id="total-paginas">1</span
                >
              </span>
              <button
                id="btn-pagina-siguiente"
                class="pagination-btn"
                title="Página siguiente">&rsaquo;</button
              >
              <button
                id="btn-ultima-pagina"
                class="pagination-btn"
                title="Última página">&raquo;</button
              >
            </div>
          </div>
        </div>
      </div>

      <!-- === DASHBOARD DE ESTADOS === -->
      <div class="dashboard-estados-section">
        <div class="dashboard-estados-header">
          <h3 class="dashboard-estados-title">📊 Estados de Canchas</h3>
        </div>
        <div class="dashboard-estados">
          <div class="estado-widget" data-estado="creada">
            <div class="widget-circle widget-creada">
              <span class="widget-number" id="count-creada">0</span>
            </div>
            <div class="widget-label">Creada</div>
          </div>

          <div class="estado-widget" data-estado="en-espera">
            <div class="widget-circle widget-en-espera">
              <span class="widget-number" id="count-en-espera">0</span>
            </div>
            <div class="widget-label">En Espera</div>
          </div>

          <div class="estado-widget" data-estado="en-proceso">
            <div class="widget-circle widget-en-proceso">
              <span class="widget-number" id="count-en-proceso">0</span>
            </div>
            <div class="widget-label">En Proceso</div>
          </div>

          <div class="estado-widget" data-estado="validada">
            <div class="widget-circle widget-validada">
              <span class="widget-number" id="count-validada">0</span>
            </div>
            <div class="widget-label">Validada</div>
          </div>

          <div class="estado-widget" data-estado="rechazada-en-espera">
            <div class="widget-circle widget-rechazada-en-espera">
              <span class="widget-number" id="count-rechazada-en-espera">0</span
              >
            </div>
            <div class="widget-label">Rechazada, en Espera</div>
          </div>

          <div class="estado-widget" data-estado="cerrada">
            <div class="widget-circle widget-cerrada">
              <span class="widget-number" id="count-cerrada">0</span>
            </div>
            <div class="widget-label">Cerrada</div>
          </div>
        </div>
      </div>

      <!-- === MAPA DASHBOARD === -->
      <div class="dashboard-map-section">
        <div class="dashboard-map-header">
          <h3 class="dashboard-map-title">🗺️ Vista de Mapa</h3>
          <p class="dashboard-map-subtitle" id="map-subtitle">
            Mostrando todas las canchas
          </p>
        </div>
        <div class="dashboard-map-container" id="dashboard-map-container">
          <div class="dashboard-map-loading">Cargando mapa...</div>
        </div>
      </div>

      <!-- Modal para validación de Linkapsis (Espesores) -->
      <div id="validacion-linkapsis-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">Validación de Espesores - Linkapsis</h3>
            <button class="close-btn">×</button>
          </div>

          <!-- Historial de observaciones anteriores -->
          <div id="historial-linkapsis" class="historial-observaciones">
            <h4>Observaciones del Proceso:</h4>
            <div class="historial-content">
              <p>Cargando historial...</p>
            </div>
          </div>

          <form id="form-validacion-linkapsis">
            <div class="form-group">
              <label for="linkapsis-observaciones">Observaciones:</label>
              <textarea
                id="linkapsis-observaciones"
                placeholder="Ingresa observaciones sobre la validación..."
                required></textarea>
            </div>

            <div class="form-group">
              <label for="linkapsis-espesor"
                >Medición de Espesor (metros):</label
              >
              <input
                type="number"
                id="linkapsis-espesor"
                placeholder="Ej: 0.03"
                min="0"
                step="0.001"
                required
              />
              <small>Ingresa la medición en metros (ej: 0.03)</small>
            </div>

            <!-- Tipo de Trabajo -->
            <div class="form-group">
              <label>Tipo de Trabajo:</label>
              <div class="checkbox-group">
                <label class="checkbox-item">
                  <input
                    type="checkbox"
                    id="trabajo-corte"
                    name="tipo-trabajo"
                    value="corte"
                  />
                  <span>Corte</span>
                </label>
                <label class="checkbox-item">
                  <input
                    type="checkbox"
                    id="trabajo-relleno"
                    name="tipo-trabajo"
                    value="relleno"
                  />
                  <span>Relleno</span>
                </label>
              </div>
            </div>

            <!-- Coordenadas de Puntos -->
            <div class="form-group">
              <label>Coordenadas de Puntos:</label>
              <div class="coordenadas-grid">
                <!-- Punto 1 -->
                <div class="punto-section">
                  <h5>Punto 1</h5>
                  <div class="coordenadas-row">
                    <div class="coord-field">
                      <label for="p1-norte">Norte:</label>
                      <input
                        type="number"
                        id="p1-norte"
                        placeholder="Norte P1"
                        step="0.001"
                      />
                    </div>
                    <div class="coord-field">
                      <label for="p1-este">Este:</label>
                      <input
                        type="number"
                        id="p1-este"
                        placeholder="Este P1"
                        step="0.001"
                      />
                    </div>
                    <div class="coord-field">
                      <label for="p1-cota">Cota:</label>
                      <input
                        type="number"
                        id="p1-cota"
                        placeholder="Cota P1"
                        step="0.001"
                      />
                    </div>
                  </div>
                </div>

                <!-- Punto 2 -->
                <div class="punto-section">
                  <h5>Punto 2</h5>
                  <div class="coordenadas-row">
                    <div class="coord-field">
                      <label for="p2-norte">Norte:</label>
                      <input
                        type="number"
                        id="p2-norte"
                        placeholder="Norte P2"
                        step="0.001"
                      />
                    </div>
                    <div class="coord-field">
                      <label for="p2-este">Este:</label>
                      <input
                        type="number"
                        id="p2-este"
                        placeholder="Este P2"
                        step="0.001"
                      />
                    </div>
                    <div class="coord-field">
                      <label for="p2-cota">Cota:</label>
                      <input
                        type="number"
                        id="p2-cota"
                        placeholder="Cota P2"
                        step="0.001"
                      />
                    </div>
                  </div>
                </div>

                <!-- Punto 3 -->
                <div class="punto-section">
                  <h5>Punto 3</h5>
                  <div class="coordenadas-row">
                    <div class="coord-field">
                      <label for="p3-norte">Norte:</label>
                      <input
                        type="number"
                        id="p3-norte"
                        placeholder="Norte P3"
                        step="0.001"
                      />
                    </div>
                    <div class="coord-field">
                      <label for="p3-este">Este:</label>
                      <input
                        type="number"
                        id="p3-este"
                        placeholder="Este P3"
                        step="0.001"
                      />
                    </div>
                    <div class="coord-field">
                      <label for="p3-cota">Cota:</label>
                      <input
                        type="number"
                        id="p3-cota"
                        placeholder="Cota P3"
                        step="0.001"
                      />
                    </div>
                  </div>
                </div>

                <!-- Punto 4 -->
                <div class="punto-section">
                  <h5>Punto 4</h5>
                  <div class="coordenadas-row">
                    <div class="coord-field">
                      <label for="p4-norte">Norte:</label>
                      <input
                        type="number"
                        id="p4-norte"
                        placeholder="Norte P4"
                        step="0.001"
                      />
                    </div>
                    <div class="coord-field">
                      <label for="p4-este">Este:</label>
                      <input
                        type="number"
                        id="p4-este"
                        placeholder="Este P4"
                        step="0.001"
                      />
                    </div>
                    <div class="coord-field">
                      <label for="p4-cota">Cota:</label>
                      <input
                        type="number"
                        id="p4-cota"
                        placeholder="Cota P4"
                        step="0.001"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn-cancel">Cancelar</button>
              <button type="submit" class="btn-validar"
                >Validar Espesores</button
              >
              <button type="button" class="btn-rechazar">Rechazar</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Modal para validación de LlayLlay (Densidad) -->
      <!-- Modal de RECEPCIÓN de trabajo para Besalco -->
      <div id="recepcion-besalco-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">📋 Recepción de Trabajo - Besalco</h3>
            <button class="close-btn">×</button>
          </div>

          <!-- Historial de observaciones (solo lectura) -->
          <div id="historial-recepcion-besalco" class="historial-observaciones">
            <h4>Observaciones del Proceso:</h4>
            <div class="historial-content">
              <p>Cargando historial...</p>
            </div>
          </div>

          <div
            style="padding: 1rem; background: #e8f4f8; border-left: 4px solid #3498db; border-radius: 4px; margin: 1rem 0;"
          >
            <p style="margin: 0; color: #2c3e50;">
              <strong>Modo Recepción:</strong> Revise el trabajo anterior y presione
              "Comenzar Trabajo" para iniciar la validación.
            </p>
          </div>

          <div class="form-actions" style="justify-content: center;">
            <button type="button" class="btn-cancel">Cancelar</button>
            <button type="button" class="btn-comenzar" id="btn-comenzar-besalco"
              >🚀 Comenzar Trabajo</button
            >
          </div>
        </div>
      </div>

      <!-- Modal de RECEPCIÓN de trabajo para Linkapsis -->
      <div id="recepcion-linkapsis-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">📋 Recepción de Trabajo - Linkapsis</h3>
            <button class="close-btn">×</button>
          </div>

          <!-- Historial de observaciones (solo lectura) -->
          <div
            id="historial-recepcion-linkapsis"
            class="historial-observaciones"
          >
            <h4>Observaciones del Proceso:</h4>
            <div class="historial-content">
              <p>Cargando historial...</p>
            </div>
          </div>

          <div
            style="padding: 1rem; background: #e8f4f8; border-left: 4px solid #3498db; border-radius: 4px; margin: 1rem 0;"
          >
            <p style="margin: 0; color: #2c3e50;">
              <strong>Modo Recepción:</strong> Revise el trabajo anterior y presione
              "Comenzar Trabajo" para iniciar la validación de espesores.
            </p>
          </div>

          <div class="form-actions" style="justify-content: center;">
            <button type="button" class="btn-cancel">Cancelar</button>
            <button
              type="button"
              class="btn-comenzar"
              id="btn-comenzar-linkapsis">🚀 Comenzar Trabajo</button
            >
          </div>
        </div>
      </div>

      <!-- Modal de RECEPCIÓN de trabajo para LlayLlay -->
      <div id="recepcion-llayllay-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">📋 Recepción de Trabajo - LlayLlay</h3>
            <button class="close-btn">×</button>
          </div>

          <!-- Historial de observaciones (solo lectura) -->
          <div
            id="historial-recepcion-llayllay"
            class="historial-observaciones"
          >
            <h4>Observaciones del Proceso:</h4>
            <div class="historial-content">
              <p>Cargando historial...</p>
            </div>
          </div>

          <div
            style="padding: 1rem; background: #e8f4f8; border-left: 4px solid #3498db; border-radius: 4px; margin: 1rem 0;"
          >
            <p style="margin: 0; color: #2c3e50;">
              <strong>Modo Recepción:</strong> Revise el trabajo anterior y presione
              "Comenzar Trabajo" para iniciar la validación de densidad.
            </p>
          </div>

          <div class="form-actions" style="justify-content: center;">
            <button type="button" class="btn-cancel">Cancelar</button>
            <button
              type="button"
              class="btn-comenzar"
              id="btn-comenzar-llayllay">🚀 Comenzar Trabajo</button
            >
          </div>
        </div>
      </div>

      <!-- Modal de VALIDACIÓN de trabajo para LlayLlay -->
      <div id="validacion-llayllay-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">Validación de Densidad - LlayLlay</h3>
            <button class="close-btn">×</button>
          </div>

          <!-- Historial de observaciones anteriores -->
          <div id="historial-llayllay" class="historial-observaciones">
            <h4>Observaciones del Proceso:</h4>
            <div class="historial-content">
              <p>Cargando historial...</p>
            </div>
          </div>

          <form id="form-validacion-llayllay">
            <div class="form-group">
              <label for="llayllay-observaciones">Observaciones:</label>
              <textarea
                id="llayllay-observaciones"
                placeholder="Ingresa observaciones sobre la validación..."
                required></textarea>
            </div>

            <div class="form-group">
              <label for="llayllay-densidad">Densidad (g/cm³):</label>
              <input
                type="number"
                id="llayllay-densidad"
                placeholder="ej: 2.35"
                min="0"
                step="0.01"
                required
              />
            </div>

            <div class="form-actions">
              <button type="button" class="btn-cancel">Cancelar</button>
              <button type="submit" class="btn-validar">Validar Densidad</button
              >
              <button type="button" class="btn-rechazar">Rechazar</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Modal para validación/rechazo de Besalco -->
      <div id="validacion-besalco-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">Validación de Trabajo - Besalco</h3>
            <button class="close-btn">×</button>
          </div>

          <!-- Historial de observaciones anteriores -->
          <div id="historial-besalco" class="historial-observaciones">
            <h4>Observaciones del Proceso:</h4>
            <div class="historial-content">
              <p>Cargando historial...</p>
            </div>
          </div>

          <form id="form-validacion-besalco">
            <div class="form-group">
              <label for="besalco-observaciones"
                >Observaciones del Trabajo:</label
              >
              <textarea
                id="besalco-observaciones"
                placeholder="Describe el trabajo realizado o motivo del rechazo..."
                required></textarea>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-cancel">Cancelar</button>
              <button type="submit" class="btn-finalizar"
                >Finalizar Trabajo</button
              >
              <button type="button" class="btn-rechazar"
                >Rechazar Trabajo</button
              >
            </div>
          </form>
        </div>
      </div>

      <!-- Modal para cerrar cancha (AngloAmerican) -->
      <div id="cerrar-cancha-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">Cerrar Cancha - AngloAmerican</h3>
            <button class="close-btn">×</button>
          </div>

          <!-- Historial completo de observaciones -->
          <div id="historial-cierre" class="historial-observaciones">
            <h4>Historial Completo del Proceso:</h4>
            <div class="historial-content">
              <p>Cargando historial completo...</p>
            </div>
          </div>

          <div
            class="form-actions"
            style="justify-content: center; gap: 1rem; padding-top: 1rem;"
          >
            <button type="button" class="btn-cancel">Cancelar</button>
            <button type="button" class="btn-finalizar" id="confirmar-cierre"
              >Cerrar Cancha Definitivamente</button
            >
          </div>
        </div>
      </div>

      <!-- Modal para borrar cancha (AngloAmerican) -->
      <div id="borrar-cancha-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title" style="color: #e74c3c;">
              ⚠️ Borrar Cancha Definitivamente
            </h3>
            <button class="close-btn">×</button>
          </div>

          <div
            style="padding: 1rem; background: #fef5e7; border: 2px solid #f39c12; border-radius: 8px; margin: 1rem 0;"
          >
            <h4 style="color: #d68910; margin: 0 0 0.5rem 0;">
              ⚠️ ADVERTENCIA
            </h4>
            <p style="margin: 0; color: #8e6e01;">
              Esta acción <strong>NO SE PUEDE DESHACER</strong>. Se eliminará la
              cancha y todas sus validaciones asociadas de forma permanente.
            </p>
          </div>

          <div id="historial-borrado" class="historial-observaciones">
            <h4>Historial que se Eliminará:</h4>
            <div class="historial-content">
              <p>Cargando historial...</p>
            </div>
          </div>

          <div class="form-group">
            <label
              for="confirmacion-borrado"
              style="color: #e74c3c; font-weight: 700;"
            >
              Para confirmar, escribe exactamente: <code
                style="background: #f8f9fa; padding: 0.25rem;"
                >borrar-cancha</code
              >
            </label>
            <input
              type="text"
              id="confirmacion-borrado"
              placeholder="Escribe 'borrar-cancha' para confirmar"
              style="border: 2px solid #e74c3c;"
            />
          </div>

          <div
            class="form-actions"
            style="justify-content: center; gap: 1rem; padding-top: 1rem;"
          >
            <button type="button" class="btn-cancel">Cancelar</button>
            <button
              type="button"
              class="btn-danger"
              id="confirmar-borrado"
              disabled>BORRAR CANCHA DEFINITIVAMENTE</button
            >
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      // ========== ANIMACIÓN DE PARTÍCULAS EN HEADER ==========
      function initParticles() {
        const canvas = document.getElementById("particles-canvas");
        if (!canvas) return;

        const ctx = canvas.getContext("2d");
        const header = canvas.parentElement;

        let width, height;

        // Ajustar tamaño del canvas
        function resizeCanvas() {
          width = header.offsetWidth;
          height = header.offsetHeight;
          canvas.width = width;
          canvas.height = height;
        }

        resizeCanvas();

        // Configuración de partículas
        let particles = [];
        const particleDensity = 9000; // Menor número = más partículas

        // Mouse interaction
        let mouse = { x: null, y: null, radius: 150 };

        header.addEventListener("mousemove", (event) => {
          const rect = header.getBoundingClientRect();
          mouse.x = event.clientX - rect.left;
          mouse.y = event.clientY - rect.top;
        });

        header.addEventListener("mouseleave", () => {
          mouse.x = null;
          mouse.y = null;
        });

        class Particle {
          constructor() {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.size = Math.random() * 2 + 1.5; // Tamaño variado
            this.speedX = (Math.random() * 1.5 - 0.75) * 0.5; // Velocidad lenta y elegante
            this.speedY = (Math.random() * 1.5 - 0.75) * 0.5;
            this.density = Math.random() * 30 + 1;
          }

          update() {
            // Movimiento normal
            this.x += this.speedX;
            this.y += this.speedY;

            // Rebote en bordes
            if (this.x > width || this.x < 0) this.speedX = -this.speedX;
            if (this.y > height || this.y < 0) this.speedY = -this.speedY;

            // Interacción con mouse
            if (mouse.x != null) {
              let dx = mouse.x - this.x;
              let dy = mouse.y - this.y;
              let distance = Math.sqrt(dx * dx + dy * dy);

              if (distance < mouse.radius) {
                const forceDirectionX = dx / distance;
                const forceDirectionY = dy / distance;
                const maxDistance = mouse.radius;
                const force = (maxDistance - distance) / maxDistance;
                const directionX = forceDirectionX * force * this.density;
                const directionY = forceDirectionY * force * this.density;

                // Efecto de repulsión suave
                this.x -= directionX * 0.05;
                this.y -= directionY * 0.05;
              }
            }
          }

          draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fillStyle = "rgba(255, 255, 255, 0.7)"; // Partículas claras
            ctx.fill();
          }
        }

        function init() {
          particles = [];
          let numberOfParticles = (width * height) / particleDensity;
          // Asegurar un mínimo de partículas
          if (numberOfParticles < 50) numberOfParticles = 50;
          if (numberOfParticles > 150) numberOfParticles = 150; // Límite superior

          for (let i = 0; i < numberOfParticles; i++) {
            particles.push(new Particle());
          }
        }

        init();

        window.addEventListener("resize", () => {
          resizeCanvas();
          init();
        });

        // Animar
        function animate() {
          ctx.clearRect(0, 0, width, height);

          particles.forEach((particle) => {
            particle.update();
            particle.draw();
          });

          connect();

          requestAnimationFrame(animate);
        }

        function connect() {
          const maxDistance = 130; // Distancia de conexión
          for (let a = 0; a < particles.length; a++) {
            for (let b = a; b < particles.length; b++) {
              let dx = particles[a].x - particles[b].x;
              let dy = particles[a].y - particles[b].y;
              let distance = Math.sqrt(dx * dx + dy * dy);

              if (distance < maxDistance) {
                let opacityValue = 1 - distance / maxDistance;
                ctx.strokeStyle =
                  "rgba(255, 255, 255," + opacityValue * 0.35 + ")";
                ctx.lineWidth = 0.8;
                ctx.beginPath();
                ctx.moveTo(particles[a].x, particles[a].y);
                ctx.lineTo(particles[b].x, particles[b].y);
                ctx.stroke();
              }
            }
          }
        }

        animate();
      }

      // Inicializar partículas cuando cargue el DOM
      initParticles();
      // ========== FIN ANIMACIÓN DE PARTÍCULAS ==========

      // Variables globales
      let usuarioLogueado = null;
      let empresaLogueada = null;
      let cargando = false;
      let vistaActual = "acciones"; // 'acciones' o 'historico'
      let filtroFecha = "all";
      let todasLasCanchas = [];
      let canchasFiltradas = [];

      // Variables de paginación
      let paginaActual = 1;
      const filasPorPagina = 15;
      let filtroEstadoActivo = null; // Estado seleccionado desde los círculos

      // Elementos del DOM
      const mainScreen = document.getElementById("main-screen");
      const userHeader = document.getElementById("user-header");
      const userName = document.getElementById("user-name");
      const userRole = document.getElementById("user-role");
      const userCompany = document.getElementById("user-company");
      const btnAdminUsuarios = document.getElementById("btn-admin-usuarios");
      const btnLogout = document.getElementById("btn-logout");
      const formCrearCancha = document.getElementById("form-crear-cancha");
      const btnCrearCancha = document.getElementById("btn-crear-cancha");
      const btnAbrirModalCrear = document.getElementById(
        "btn-abrir-modal-crear",
      );
      const canchasTBody = document.getElementById("canchas-tbody");
      const mensajeContainer = document.getElementById("mensaje-container");
      // Elementos del dashboard de estadísticas (reemplaza contador-resultados)

      // Elementos de filtros
      const btnVistaAcciones = document.getElementById("btn-vista-acciones");
      const btnVistaHistorico = document.getElementById("btn-vista-historico");
      const filtroFechaSelect = document.getElementById("filtro-fecha");
      const rangoFechas = document.getElementById("rango-fechas");
      const fechaDesde = document.getElementById("fecha-desde");
      const fechaHasta = document.getElementById("fecha-hasta");
      const btnAplicarRango = document.getElementById("btn-aplicar-rango");

      // Cargar datos iniciales
      async function inicializar() {
        try {
          configurarEventListeners();

          // Esperar a que el AuthGuard termine de verificar
          window.addEventListener("userAuthenticated", (event) => {
            cargarUsuarioAutenticado(event.detail);
          });

          // Verificar si ya hay usuario autenticado
          verificarUsuarioExistente();
        } catch (error) {
          console.error("Error al inicializar:", error);
          mostrarMensaje("Error al cargar datos iniciales", "error");
        }
      }

      // Verificar si hay usuario autenticado en localStorage
      function verificarUsuarioExistente() {
        try {
          const sessionData = localStorage.getItem("userSession");
          if (sessionData) {
            const session = JSON.parse(sessionData);
            const expiresAt = new Date(session.expiresAt);

            if (expiresAt > new Date()) {
              cargarUsuarioAutenticado(session.usuario);
            } else {
              // Sesión expirada, redirigir al login
              window.location.href = "/login";
            }
          } else {
            // No hay sesión, redirigir al login
            window.location.href = "/login";
          }
        } catch (error) {
          console.error("Error verificando usuario:", error);
          window.location.href = "/login";
        }
      }

      // Configurar todos los event listeners
      function configurarEventListeners() {
        // Logout
        btnLogout.addEventListener("click", cerrarSesion);

        // Filtros
        btnVistaAcciones.addEventListener("click", () =>
          cambiarVista("acciones"),
        );
        btnVistaHistorico.addEventListener("click", () =>
          cambiarVista("historico"),
        );
        filtroFechaSelect.addEventListener("change", manejarCambioFiltroFecha);
        btnAplicarRango.addEventListener("click", aplicarRangoFechas);

        // Modal
        configurarModalEventListeners();

        // Crear cancha (si aplica)
        if (btnCrearCancha) {
          console.log("Registrando event listener para btnCrearCancha");
          btnCrearCancha.addEventListener("click", crearCancha);
        } else {
          console.log("No se encontró btnCrearCancha");
        }

        // Botón para abrir modal de crear cancha con polígono
        if (btnAbrirModalCrear) {
          console.log("Registrando event listener para btnAbrirModalCrear");
          btnAbrirModalCrear.addEventListener("click", abrirModalCrearCancha);
        } else {
          console.log("No se encontró btnAbrirModalCrear");
        }

        // Configurar selectores dinámicos de Muro y Sector
        configurarSelectoresMuroSector();

        // Configurar botones de paginación
        configurarPaginacion();
      }

      // Configurar event listeners de paginación
      function configurarPaginacion() {
        document
          .getElementById("btn-primera-pagina")
          .addEventListener("click", () => {
            paginaActual = 1;
            renderizarPaginaCanchas();
          });

        document
          .getElementById("btn-pagina-anterior")
          .addEventListener("click", () => {
            if (paginaActual > 1) {
              paginaActual--;
              renderizarPaginaCanchas();
            }
          });

        document
          .getElementById("btn-pagina-siguiente")
          .addEventListener("click", () => {
            const totalPaginas = Math.ceil(
              canchasFiltradas.length / filasPorPagina,
            );
            if (paginaActual < totalPaginas) {
              paginaActual++;
              renderizarPaginaCanchas();
            }
          });

        document
          .getElementById("btn-ultima-pagina")
          .addEventListener("click", () => {
            const totalPaginas = Math.ceil(
              canchasFiltradas.length / filasPorPagina,
            );
            paginaActual = totalPaginas || 1;
            renderizarPaginaCanchas();
          });

        // Configurar event listeners para widgets de estado (doble click)
        const estadoWidgets = document.querySelectorAll(".estado-widget");
        estadoWidgets.forEach((widget) => {
          widget.addEventListener("dblclick", () => {
            const estadoData = widget.getAttribute("data-estado");
            const estadoMap = {
              creada: "Creada",
              "en-espera": "En Espera",
              "en-proceso": "En Proceso",
              validada: "Validada",
              "rechazada-en-espera": "Rechazada, en Espera",
              cerrada: "Cerrada",
            };
            const estadoNombre = estadoMap[estadoData];
            if (estadoNombre) {
              filtrarPorEstadoWidget(estadoNombre);
            }
          });
        });
      }

      // Configurar selectores dinámicos de Muro y Sector
      function configurarSelectoresMuroSector() {
        const selectMuro = document.getElementById("muro-select");
        const selectSector = document.getElementById("sector-select");

        if (!selectMuro || !selectSector) return;

        selectMuro.addEventListener("change", function () {
          const muroSeleccionado = this.value;

          // Limpiar opciones del sector
          selectSector.innerHTML = "";

          if (!muroSeleccionado) {
            selectSector.disabled = true;
            selectSector.innerHTML =
              '<option value="">Primero selecciona un muro</option>';
            return;
          }

          selectSector.disabled = false;
          selectSector.innerHTML =
            '<option value="">Selecciona un sector</option>';

          // Agregar opciones según el muro seleccionado
          if (muroSeleccionado === "MP") {
            // MP: S1 hasta S7
            for (let i = 1; i <= 7; i++) {
              const option = document.createElement("option");
              option.value = `S${i}`;
              option.textContent = `S${i}`;
              selectSector.appendChild(option);
            }
          } else if (muroSeleccionado === "ME" || muroSeleccionado === "MO") {
            // ME y MO: S1 hasta S3
            for (let i = 1; i <= 3; i++) {
              const option = document.createElement("option");
              option.value = `S${i}`;
              option.textContent = `S${i}`;
              selectSector.appendChild(option);
            }
          }
        });
      }

      // Configurar event listeners del modal
      function configurarModalEventListeners() {
        // Botón de cerrar modal
        const closeBtn = document.querySelector(".close-btn");
        if (closeBtn) {
          closeBtn.addEventListener("click", cerrarTodosLosModales);
        }
      }

      // === FUNCIÓN TEMPORAL DE DEBUG ===
      window.debugCancha = function (canchaId) {
        const cancha = todasLasCanchas.find((c) => c.id == canchaId);
        if (cancha) {
          console.log("=== DEBUG CANCHA ===");
          console.log("Cancha encontrada:", cancha);
          console.log("Estado actual:", cancha.estado_actual);
          console.log("Empresa actual:", cancha.empresa_actual);
          console.log("Validaciones:", cancha.validaciones);

          if (cancha.validaciones) {
            cancha.validaciones.forEach((v) => {
              console.log(`- ${v.empresa}: ${v.estado}`);
            });
          }

          // Verificar qué botones debería mostrar
          const botonesGenerados = generarBotonesAccion(
            canchaId,
            cancha.estado_actual,
            cancha.empresa_actual,
          );
          console.log("Botones que debería generar:", botonesGenerados);

          return cancha;
        } else {
          console.log("Cancha no encontrada con ID:", canchaId);
          console.log(
            "Canchas disponibles:",
            todasLasCanchas.map((c) => ({ id: c.id, nombre: c.nombre })),
          );
          return null;
        }
      };

      window.debugTodasLasCanchas = function () {
        console.log("=== TODAS LAS CANCHAS ===");
        todasLasCanchas.forEach((cancha) => {
          console.log(
            `ID: ${cancha.id}, Nombre: ${cancha.nombre}, Estado: ${cancha.estado_actual}, Empresa: ${cancha.empresa_actual}`,
          );
        });
        return todasLasCanchas;
      };

      // === FUNCIONES DE AUTENTICACIÓN ===
      // Las funciones de autenticación ahora se manejan en login.astro y AuthGuard.astro

      // Cargar información del usuario autenticado
      async function cargarUsuarioAutenticado(usuario) {
        try {
          console.log("Cargando usuario autenticado:", usuario);

          usuarioLogueado = usuario;
          empresaLogueada = {
            id: usuario.empresa_id,
            nombre: usuario.empresa_nombre,
          };

          // Actualizar UI del header
          userName.textContent = usuario.nombre_completo;
          userRole.textContent = `${usuario.rol_nombre} - ${usuario.empresa_nombre}`;
          userCompany.textContent = usuario.empresa_nombre;
          userCompany.className = `empresa-actual empresa-${usuario.empresa_nombre.toLowerCase().replace(" ", "")}`;

          // Mostrar/ocultar botón de crear cancha según la empresa
          if (usuario.empresa_nombre === "AngloAmerican") {
            console.log("Mostrando botón de crear cancha para AngloAmerican");
            if (btnAbrirModalCrear)
              btnAbrirModalCrear.style.display = "inline-flex";
          } else {
            console.log(
              "Ocultando botón de crear cancha para:",
              usuario.empresa_nombre,
            );
            if (btnAbrirModalCrear) btnAbrirModalCrear.style.display = "none";
          }

          // Mostrar enlace de administración si es de AngloAmerican
          if (usuario.empresa_id === 1) {
            // AngloAmerican
            btnAdminUsuarios.style.display = "inline-block";
          } else {
            btnAdminUsuarios.style.display = "none";
          }

          // Cargar datos
          await cargarCanchas();

          // Actualizar columna de administración
          actualizarColumnaAdmin();

          // Mensaje de bienvenida eliminado para evitar duplicados
        } catch (error) {
          console.error("Error cargando usuario:", error);
          mostrarMensaje("Error al cargar información del usuario", "error");
          window.location.href = "/login";
        }
      }

      function getRolEmpresa(nombreEmpresa) {
        const roles = {
          AngloAmerican: "Creación y cierre de canchas",
          Besalco: "Trabajo de maquinaria",
          Linkapsis: "Validación de espesores",
          LlayLlay: "Validación de densidad",
        };
        return roles[nombreEmpresa] || "Usuario del sistema";
      }

      function cerrarSesion() {
        usuarioLogueado = null;
        empresaLogueada = null;

        // Limpiar localStorage
        localStorage.removeItem("userSession");

        // Redirigir al login
        window.location.href = "/login";
        todasLasCanchas = [];
        canchasFiltradas = [];

        // Ocultar columna de administración
        actualizarColumnaAdmin();

        mostrarMensaje("Sesión cerrada correctamente", "success");
      }

      // === FUNCIONES DE CARGA DE DATOS ===

      // === FUNCIONES DE FILTROS ===
      function cambiarVista(nuevaVista) {
        console.log("Cambiando vista a:", nuevaVista);
        vistaActual = nuevaVista;

        // Actualizar botones
        btnVistaAcciones.classList.toggle("active", nuevaVista === "acciones");
        btnVistaHistorico.classList.toggle(
          "active",
          nuevaVista === "historico",
        );

        // Aplicar filtros
        aplicarFiltros();
      }

      function manejarCambioFiltroFecha() {
        filtroFecha = filtroFechaSelect.value;

        if (filtroFecha === "custom") {
          rangoFechas.classList.remove("hidden");
        } else {
          rangoFechas.classList.add("hidden");
          aplicarFiltros();
        }
      }

      function aplicarRangoFechas() {
        const desde = fechaDesde.value;
        const hasta = fechaHasta.value;

        if (!desde || !hasta) {
          mostrarMensaje("Por favor selecciona ambas fechas", "error");
          return;
        }

        aplicarFiltros();
      }

      function aplicarFiltros() {
        if (!empresaLogueada || !todasLasCanchas.length) return;

        canchasFiltradas = [...todasLasCanchas];
        console.log("Aplicando filtros, vista actual:", vistaActual);
        console.log("Total canchas antes del filtro:", canchasFiltradas.length);

        // Filtro por vista (acciones vs histórico)
        if (vistaActual === "acciones") {
          canchasFiltradas = filtrarPorAccionesDisponibles(canchasFiltradas);
          console.log(
            "Canchas después del filtro de acciones:",
            canchasFiltradas.length,
          );
        }

        // Filtro por fecha
        canchasFiltradas = filtrarPorFecha(canchasFiltradas);

        // Filtro por estado desde widgets circulares
        if (filtroEstadoActivo) {
          canchasFiltradas = canchasFiltradas.filter(
            (cancha) => cancha.estado_actual === filtroEstadoActivo,
          );
          console.log(
            "Canchas después del filtro de estado:",
            canchasFiltradas.length,
          );
        }

        // Reiniciar a la primera página al aplicar filtros
        paginaActual = 1;

        // Mostrar resultados
        mostrarCanchas(canchasFiltradas);
        actualizarContadorResultados(
          canchasFiltradas.length,
          todasLasCanchas.length,
        );
      }

      function filtrarPorAccionesDisponibles(canchas) {
        const empresaId = empresaLogueada.id;
        const empresaNombre = empresaLogueada.nombre;

        console.log("Filtrando para empresa:", empresaNombre);

        return canchas.filter((cancha) => {
          const estado = cancha.estado_actual;
          const empresaActual = cancha.empresa_actual;

          console.log(
            `Cancha ${cancha.nombre}: estado="${estado}", empresa="${empresaActual}"`,
          );

          let tieneAccion = false;

          switch (empresaNombre) {
            case "AngloAmerican":
              // AngloAmerican puede actuar cuando:
              // - Cancha creada (enviar a Besalco)
              // - Cancha en proceso en AngloAmerican (cerrar)
              tieneAccion =
                estado === "Creada" ||
                (estado === "En Proceso" && empresaActual === "AngloAmerican");
              break;

            case "Besalco":
              // Besalco puede actuar cuando:
              // - Está en espera (recién asignada o rechazada)
              // - Está en proceso (trabajando activamente)
              tieneAccion =
                (estado === "En Espera" && empresaActual === "Besalco") ||
                (estado === "En Proceso" && empresaActual === "Besalco") ||
                (estado === "Rechazada, en Espera" &&
                  empresaActual === "Besalco");
              break;

            case "Linkapsis":
              // Linkapsis puede actuar cuando está en espera o en proceso
              tieneAccion =
                (estado === "En Espera" && empresaActual === "Linkapsis") ||
                (estado === "En Proceso" && empresaActual === "Linkapsis");
              break;

            case "LlayLlay":
              // LlayLlay puede actuar cuando está en espera o en proceso
              tieneAccion =
                (estado === "En Espera" && empresaActual === "LlayLlay") ||
                (estado === "En Proceso" && empresaActual === "LlayLlay");
              break;

            default:
              tieneAccion = false;
          }

          console.log(`-> Tiene acción: ${tieneAccion}`);
          return tieneAccion;
        });
      }

      function filtrarPorFecha(canchas) {
        if (filtroFecha === "all") return canchas;

        const ahora = new Date();
        const hoy = new Date(
          ahora.getFullYear(),
          ahora.getMonth(),
          ahora.getDate(),
        );

        return canchas.filter((cancha) => {
          const fechaCancha = new Date(cancha.created_at);

          switch (filtroFecha) {
            case "today":
              return fechaCancha >= hoy;
            case "week":
              const semanaAtras = new Date(
                hoy.getTime() - 7 * 24 * 60 * 60 * 1000,
              );
              return fechaCancha >= semanaAtras;
            case "month":
              const mesAtras = new Date(
                hoy.getTime() - 30 * 24 * 60 * 60 * 1000,
              );
              return fechaCancha >= mesAtras;
            case "custom":
              if (!fechaDesde.value || !fechaHasta.value) return true;
              const desde = new Date(fechaDesde.value);
              const hasta = new Date(fechaHasta.value + "T23:59:59");
              return fechaCancha >= desde && fechaCancha <= hasta;
            default:
              return true;
          }
        });
      }

      // Actualizar dashboard de estados con contadores
      function actualizarContadorResultados(mostradas, total) {
        // === ACTUALIZAR WIDGETS ORIGINALES (SIDEBAR) ===
        // Contar acciones disponibles
        const accionesDisponibles = canchasFiltradas.filter((cancha) => {
          const estado = cancha.estado_actual;
          const empresaActual = cancha.empresa_actual;

          let tieneAccion = false;
          switch (empresaActual) {
            case "AngloAmerican":
              tieneAccion =
                estado === "Creada" ||
                estado === "Validada" ||
                estado === "Rechazada, en Espera";
              break;
            case "Besalco":
              tieneAccion =
                (estado === "En Espera" && empresaActual === "Besalco") ||
                (estado === "Rechazada, en Espera" &&
                  empresaActual === "Besalco");
              break;
            case "Linkapsis":
              tieneAccion =
                (estado === "En Espera" && empresaActual === "Linkapsis") ||
                (estado === "En Proceso" && empresaActual === "Linkapsis");
              break;
            case "LlayLlay":
              tieneAccion =
                (estado === "En Espera" && empresaActual === "LlayLlay") ||
                (estado === "En Proceso" && empresaActual === "LlayLlay");
              break;
            default:
              tieneAccion = false;
          }
          return tieneAccion;
        }).length;

        // Actualizar contadores del sidebar
        const statAcciones = document.getElementById("stat-acciones");
        const statTotal = document.getElementById("stat-total");

        if (statAcciones) {
          animateNumber(
            statAcciones,
            parseInt(statAcciones.textContent) || 0,
            accionesDisponibles,
          );
        }

        if (statTotal) {
          animateNumber(statTotal, parseInt(statTotal.textContent) || 0, total);
        }

        // === ACTUALIZAR WIDGETS CIRCULARES (DASHBOARD DE ESTADOS) ===
        // Contar canchas por estado
        const contadores = {
          Creada: 0,
          "En Espera": 0,
          "En Proceso": 0,
          Validada: 0,
          "Rechazada, en Espera": 0,
          Cerrada: 0,
        };

        // Contar las canchas filtradas por estado
        canchasFiltradas.forEach((cancha) => {
          const estado = cancha.estado_actual;
          if (contadores.hasOwnProperty(estado)) {
            contadores[estado]++;
          }
        });

        // Actualizar los widgets circulares con animación
        animateNumber(
          document.getElementById("count-creada"),
          parseInt(document.getElementById("count-creada").textContent) || 0,
          contadores["Creada"],
        );

        animateNumber(
          document.getElementById("count-en-espera"),
          parseInt(document.getElementById("count-en-espera").textContent) || 0,
          contadores["En Espera"],
        );

        animateNumber(
          document.getElementById("count-en-proceso"),
          parseInt(document.getElementById("count-en-proceso").textContent) ||
            0,
          contadores["En Proceso"],
        );

        animateNumber(
          document.getElementById("count-validada"),
          parseInt(document.getElementById("count-validada").textContent) || 0,
          contadores["Validada"],
        );

        animateNumber(
          document.getElementById("count-rechazada-en-espera"),
          parseInt(
            document.getElementById("count-rechazada-en-espera").textContent,
          ) || 0,
          contadores["Rechazada, en Espera"],
        );

        animateNumber(
          document.getElementById("count-cerrada"),
          parseInt(document.getElementById("count-cerrada").textContent) || 0,
          contadores["Cerrada"],
        );

        // Actualizar subtítulo del mapa
        actualizarSubtituloMapa(mostradas);
      }

      // Manejar doble click en widgets de estado para filtrar
      function filtrarPorEstadoWidget(estadoNombre) {
        const widgets = document.querySelectorAll(".estado-widget");

        // Si se clickea el mismo estado, desactivar filtro
        if (filtroEstadoActivo === estadoNombre) {
          filtroEstadoActivo = null;
          widgets.forEach((w) => {
            w.classList.remove("selected");
            w.classList.remove("dimmed");
          });
        } else {
          // Activar nuevo filtro
          filtroEstadoActivo = estadoNombre;

          // Actualizar clases de selección y dimmed
          widgets.forEach((widget) => {
            const estadoWidget = widget.getAttribute("data-estado");
            const estadoMap = {
              creada: "Creada",
              "en-espera": "En Espera",
              "en-proceso": "En Proceso",
              validada: "Validada",
              "rechazada-en-espera": "Rechazada, en Espera",
              cerrada: "Cerrada",
            };

            if (estadoMap[estadoWidget] === estadoNombre) {
              widget.classList.add("selected");
              widget.classList.remove("dimmed");
            } else {
              widget.classList.remove("selected");
              widget.classList.add("dimmed");
            }
          });
        }

        // Re-aplicar filtros
        aplicarFiltros();
      }

      // Actualizar subtítulo del mapa según filtros activos
      function actualizarSubtituloMapa(cantidadCanchas) {
        const subtitle = document.getElementById("map-subtitle");
        if (!subtitle) return;

        let texto = "";

        if (vistaActual === "acciones") {
          texto = `Mostrando ${cantidadCanchas} cancha${cantidadCanchas !== 1 ? "s" : ""} con acciones disponibles`;
        } else {
          texto = `Mostrando ${cantidadCanchas} cancha${cantidadCanchas !== 1 ? "s" : ""} del histórico`;
        }

        // Agregar información del filtro de fecha
        if (filtroFecha === "today") {
          texto += " (Hoy)";
        } else if (filtroFecha === "week") {
          texto += " (Última semana)";
        } else if (filtroFecha === "month") {
          texto += " (Último mes)";
        } else if (filtroFecha === "custom") {
          texto += " (Rango personalizado)";
        }

        subtitle.textContent = texto;
      }

      // Actualizar mapa dashboard con las canchas filtradas
      function actualizarMapaDashboard(canchas) {
        const mapContainer = document.getElementById("dashboard-map-container");
        if (!mapContainer) return;

        console.log(
          "🗺️ Actualizando mapa dashboard con",
          canchas.length,
          "canchas",
        );

        // Extraer IDs de canchas para el mapa
        const canchaIds = canchas.map((c) => c.id).join(",");

        // Construir URL del iframe con parámetros de filtrado
        const params = new URLSearchParams();
        params.set("dashboardMode", "true");
        params.set("canchaIds", canchaIds);

        const mapUrl = `/mapbox-window?${params.toString()}`;

        // Crear o actualizar iframe
        let iframe = mapContainer.querySelector("iframe");
        if (!iframe) {
          iframe = document.createElement("iframe");
          iframe.style.width = "100%";
          iframe.style.height = "100%";
          iframe.style.border = "none";

          // Limpiar loading y agregar iframe
          mapContainer.innerHTML = "";
          mapContainer.appendChild(iframe);
        }

        // Actualizar src del iframe
        iframe.src = mapUrl;

        console.log("✅ Mapa dashboard actualizado con URL:", mapUrl);
      }

      // Función para animar números
      function animateNumber(element, start, end, suffix = "") {
        const duration = 800;
        const startTime = Date.now();

        function update() {
          const elapsed = Date.now() - startTime;
          const progress = Math.min(elapsed / duration, 1);

          // Easing function (ease-out)
          const easedProgress = 1 - Math.pow(1 - progress, 3);
          const current = Math.round(start + (end - start) * easedProgress);

          element.textContent = current + suffix;

          if (progress < 1) {
            requestAnimationFrame(update);
          }
        }

        update();
      }

      // === FUNCIÓN DE CREACIÓN DE CANCHAS ===
      async function crearCancha() {
        console.log("Función crearCancha llamada");
        if (cargando) return;

        const muro = document.getElementById("muro").value.trim();
        const sector = document.getElementById("sector").value.trim();
        const nombreDetalle = document
          .getElementById("nombre-detalle")
          .value.trim();

        console.log("Datos del formulario:", { muro, sector, nombreDetalle });

        if (!muro || !sector || !nombreDetalle) {
          alert("Por favor completa todos los campos");
          return;
        }

        try {
          cargando = true;
          btnCrearCancha.textContent = "Creando...";
          btnCrearCancha.disabled = true;

          const response = await fetch("/api/canchas", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ muro, sector, nombreDetalle }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || "Error al crear cancha");
          }

          // Limpiar formulario
          document.getElementById("muro").value = "";
          document.getElementById("sector").value = "";
          document.getElementById("nombre-detalle").value = "";

          // Recargar tabla
          await cargarCanchas();

          mostrarMensaje("Cancha creada exitosamente", "success");
        } catch (error) {
          console.error("Error al crear cancha:", error);
          mostrarMensaje("Error al crear la cancha: " + error.message, "error");
        } finally {
          cargando = false;
          btnCrearCancha.textContent = "Crear Cancha";
          btnCrearCancha.disabled = false;
        }
      }

      // === FUNCIÓN DE CARGA DE CANCHAS ===
      async function cargarCanchas() {
        try {
          const response = await fetch("/api/canchas");
          if (!response.ok) {
            throw new Error("Error al cargar canchas");
          }

          todasLasCanchas = await response.json();
          console.log("🗂️ Datos de canchas cargados:", todasLasCanchas);
          if (todasLasCanchas.length > 0) {
            console.log("🔍 Primer cancha ejemplo:", todasLasCanchas[0]);
            console.log(
              "🏷️ Campos disponibles:",
              Object.keys(todasLasCanchas[0]),
            );
          }
          aplicarFiltros();
        } catch (error) {
          console.error("Error al cargar canchas:", error);
          mostrarMensaje("Error al cargar las canchas", "error");
        }
      }

      // Mostrar canchas filtradas
      function mostrarCanchas(canchas) {
        renderizarCanchas(canchas);
        actualizarMapaDashboard(canchas);
      }

      // Renderizar tabla de canchas con paginación
      function renderizarCanchas(canchas) {
        canchasFiltradas = canchas;
        paginaActual = 1; // Resetear a la primera página cuando cambian los datos
        renderizarPaginaCanchas();
      }

      // Renderizar página específica de canchas
      function renderizarPaginaCanchas() {
        const inicio = (paginaActual - 1) * filasPorPagina;
        const fin = inicio + filasPorPagina;
        const canchasPagina = canchasFiltradas.slice(inicio, fin);

        canchasTBody.innerHTML = canchasPagina
          .map(
            (cancha) => `
          <tr data-cancha-id="${cancha.id}" class="cancha-row">
            <td><strong>${cancha.nombre.toUpperCase()}</strong></td>
            <td>
              <span class="estado estado-${cancha.estado_actual.toLowerCase().replace(/\s+/g, "-")}">
                ${cancha.estado_actual}
              </span>
            </td>
            <td>
              <span class="empresa-actual empresa-${cancha.empresa_actual.toLowerCase().replace(/\s+/g, "-")}">
                ${cancha.empresa_actual}
              </span>
            </td>
            <td>${new Date(cancha.created_at).toLocaleDateString("es-ES")}</td>
            <td>
              <button class="btn-mapa" data-cancha-id="${cancha.id}" data-cancha-nombre="${cancha.nombre}" type="button" style="background:none; border:none; font-size:1.5rem; cursor:pointer; padding:0.5rem; transition: transform 0.2s;" title="Ver en mapa">🗺️</button>
            </td>
            <td>
              <div class="actions" data-cancha-id="${cancha.id}" data-estado="${cancha.estado_actual}" data-empresa="${cancha.empresa_actual}">
              </div>
            </td>
            <td class="borrar-column hidden">
              <div class="admin-actions" data-cancha-id="${cancha.id}">
              </div>
            </td>
          </tr>
        `,
          )
          .join("");

        // Agregar event listeners para botones del mapa inmediatamente después de renderizar
        setTimeout(() => {
          console.log("🔧 Agregando event listeners para botones del mapa...");
          document.querySelectorAll(".btn-mapa").forEach((btn, index) => {
            console.log(`🔧 Configurando botón ${index}:`, btn.dataset);
            btn.addEventListener("click", (e) => {
              const canchaId = e.target.dataset.canchaId;
              const canchaName = e.target.dataset.canchaNombre;
              console.log("🗺️ Botón de mapa clickeado:", {
                canchaId,
                canchaName,
              });
              console.log("🔍 Datasets disponibles:", e.target.dataset);
              abrirMapaModal(canchaId, canchaName);
            });
          });
        }, 100); // Pequeño delay para asegurar que el DOM esté actualizado

        actualizarAcciones();
        actualizarControlesPaginacion();
      }

      // Actualizar controles de paginación
      function actualizarControlesPaginacion() {
        const totalCanchas = canchasFiltradas.length;
        const totalPaginas = Math.ceil(totalCanchas / filasPorPagina);
        const inicio = (paginaActual - 1) * filasPorPagina + 1;
        const fin = Math.min(inicio + filasPorPagina - 1, totalCanchas);

        document.getElementById("pagination-start").textContent =
          totalCanchas > 0 ? inicio : 0;
        document.getElementById("pagination-end").textContent = fin;
        document.getElementById("pagination-total").textContent = totalCanchas;
        document.getElementById("pagina-actual").textContent = paginaActual;
        document.getElementById("total-paginas").textContent =
          totalPaginas || 1;

        // Habilitar/deshabilitar botones
        document.getElementById("btn-primera-pagina").disabled =
          paginaActual === 1;
        document.getElementById("btn-pagina-anterior").disabled =
          paginaActual === 1;
        document.getElementById("btn-pagina-siguiente").disabled =
          paginaActual >= totalPaginas;
        document.getElementById("btn-ultima-pagina").disabled =
          paginaActual >= totalPaginas;
      }

      // Actualizar botones de acción según empresa seleccionada
      function actualizarAcciones() {
        console.log("Actualizando acciones para empresa:", empresaLogueada);
        const actionsDivs = document.querySelectorAll(".actions");
        const adminDivs = document.querySelectorAll(".admin-actions");

        console.log("Encontrados", actionsDivs.length, "divs de acciones");
        console.log("Encontrados", adminDivs.length, "divs de admin");

        actionsDivs.forEach((div, index) => {
          const canchaId = div.dataset.canchaId;
          const estado = div.dataset.estado;
          const empresaActual = div.dataset.empresa;

          console.log(
            `Procesando div ${index}: canchaId=${canchaId}, estado=${estado}, empresaActual=${empresaActual}`,
          );

          const botonesHTML = generarBotonesAccion(
            canchaId,
            estado,
            empresaActual,
          );
          console.log(`Botones generados: ${botonesHTML}`);
          div.innerHTML = botonesHTML;
        });

        // Actualizar botones de administración
        adminDivs.forEach((div, index) => {
          const canchaId = div.dataset.canchaId;
          console.log(`Procesando admin div ${index}: canchaId=${canchaId}`);
          const adminHTML = generarBotonesAdmin(canchaId);
          console.log(`Admin botones generados: ${adminHTML}`);
          div.innerHTML = adminHTML;
        });

        // Agregar event listeners a los botones
        agregarEventListeners();
        console.log("Event listeners agregados");

        // Agregar event listeners de doble-click
        agregarEventListenersDobleClick();
      }

      // Generar botones según empresa y estado
      function generarBotonesAccion(canchaId, estado, empresaActual) {
        console.log(
          `generarBotonesAccion: canchaId=${canchaId}, estado=${estado}, empresaActual=${empresaActual}`,
        );
        console.log("empresaLogueada:", empresaLogueada);

        if (!empresaLogueada) {
          console.log("No hay empresa logueada");
          return '<span style="color:#666;">Selecciona tu empresa</span>';
        }

        const botones = [];
        const empresaId = empresaLogueada.id;
        console.log("Empresa ID:", empresaId);

        // AngloAmerican
        if (empresaId === 1) {
          console.log("Procesando para AngloAmerican");
          if (estado === "Creada") {
            console.log("Estado es Creada, agregando botón enviar a Besalco");
            botones.push(
              `<button class="btn-accion" data-accion="enviar-besalco" data-cancha-id="${canchaId}">📤 Enviar a Besalco</button>`,
            );
          } else if (
            estado === "En Proceso" &&
            empresaActual === "AngloAmerican"
          ) {
            console.log(
              "Estado es En Proceso y empresa actual es AngloAmerican",
            );
            // Buscar la cancha para verificar validaciones
            const cancha = todasLasCanchas.find((c) => c.id == canchaId);
            if (cancha) {
              const validaciones = cancha.validaciones || [];
              console.log("Validaciones encontradas:", validaciones);
              const hasLinkapsis = validaciones.some(
                (v) => v.empresa === "Linkapsis" && v.estado === "VALIDADO",
              );
              const hasLlayLlay = validaciones.some(
                (v) => v.empresa === "LlayLlay" && v.estado === "VALIDADO",
              );
              const hasBesalco = validaciones.some(
                (v) => v.empresa === "Besalco" && v.estado === "VALIDADO",
              );

              console.log("Estado validaciones:", {
                hasLinkapsis,
                hasLlayLlay,
                hasBesalco,
              });

              if (hasLinkapsis && hasLlayLlay && hasBesalco) {
                console.log(
                  "Todas las validaciones completas, agregando botón PDF",
                );
                botones.push(
                  `<button class="btn-accion btn-pdf" data-accion="exportar-pdf" data-cancha-id="${canchaId}">📄 PDF</button>`,
                );
              }
            }

            console.log("Agregando botón cerrar cancha");
            botones.push(
              `<button class="btn-accion btn-success" data-accion="abrir-modal-cierre" data-cancha-id="${canchaId}">🔒 Cerrar Cancha</button>`,
            );
          } else if (estado === "Finalizada" || estado === "Cerrada") {
            console.log("Estado es Finalizada/Cerrada, agregando botón PDF");
            // Para canchas finalizadas o cerradas, siempre mostrar el botón PDF
            botones.push(
              `<button class="btn-accion btn-pdf" data-accion="exportar-pdf" data-cancha-id="${canchaId}">📄 PDF</button>`,
            );
          }
        }

        // Besalco
        else if (empresaId === 2) {
          if (
            (estado === "En Espera" || estado === "Rechazada, en Espera") &&
            empresaActual === "Besalco"
          ) {
            // Cancha en espera - Recepcionar para revisar
            botones.push(
              `<button class="btn-accion btn-info" data-accion="recepcionar-besalco" data-cancha-id="${canchaId}">📋 Recepcionar Trabajo</button>`,
            );
          } else if (estado === "En Proceso" && empresaActual === "Besalco") {
            // Cancha en proceso - Validar trabajo activo
            botones.push(
              `<button class="btn-accion btn-success" data-accion="validar-besalco" data-cancha-id="${canchaId}">🛠️ Gestionar</button>`,
            );
          }
        }

        // Linkapsis
        else if (empresaId === 3) {
          if (estado === "En Espera" && empresaActual === "Linkapsis") {
            // Cancha en espera - Recepcionar para revisar
            botones.push(
              `<button class="btn-accion btn-info" data-accion="recepcionar-linkapsis" data-cancha-id="${canchaId}">📋 Recepcionar Trabajo</button>`,
            );
          } else if (estado === "En Proceso" && empresaActual === "Linkapsis") {
            // Cancha en proceso - Validar espesores
            botones.push(
              `<button class="btn-accion btn-success" data-accion="validar-linkapsis" data-cancha-id="${canchaId}">📏 Gestionar</button>`,
            );
          }
        }

        // LlayLlay
        else if (empresaId === 4) {
          if (estado === "En Espera" && empresaActual === "LlayLlay") {
            // Cancha en espera - Recepcionar para revisar
            botones.push(
              `<button class="btn-accion btn-info" data-accion="recepcionar-llayllay" data-cancha-id="${canchaId}">📋 Recepcionar Trabajo</button>`,
            );
          } else if (estado === "En Proceso" && empresaActual === "LlayLlay") {
            // Cancha en proceso - Validar densidad
            botones.push(
              `<button class="btn-accion btn-success" data-accion="validar-llayllay" data-cancha-id="${canchaId}">🧪 Gestionar</button>`,
            );
          }
        }

        return botones.length > 0
          ? botones.join("")
          : '<span style="color:#666;">Sin acciones disponibles</span>';
      }

      // Generar botones de administración (solo para AngloAmerican)
      function generarBotonesAdmin(canchaId) {
        if (!empresaLogueada || empresaLogueada.id !== 1) {
          return ""; // Solo AngloAmerican puede administrar
        }

        return `<button class="btn-accion btn-danger" data-accion="abrir-modal-borrar" data-cancha-id="${canchaId}">🗑️ Borrar</button>`;
      }

      // Mostrar/ocultar columna de administración según empresa
      function actualizarColumnaAdmin() {
        const borrarHeader = document.getElementById("borrar-header");
        const borrarColumns = document.querySelectorAll(".borrar-column");

        if (empresaLogueada && empresaLogueada.id === 1) {
          // Mostrar columna para AngloAmerican
          borrarHeader.classList.remove("hidden");
          borrarColumns.forEach((col) => col.classList.remove("hidden"));
        } else {
          // Ocultar columna para otras empresas
          borrarHeader.classList.add("hidden");
          borrarColumns.forEach((col) => col.classList.add("hidden"));
        }
      }

      // Agregar event listeners a botones de acción
      function agregarEventListeners() {
        document.querySelectorAll(".btn-accion").forEach((btn) => {
          btn.addEventListener("click", manejarAccion);
        });

        // Los event listeners para botones del mapa se agregan en renderizarCanchas()
        console.log("🖱️ Event listeners de acciones agregados");
      }

      // Agregar event listeners de doble-click a las filas de la tabla
      function agregarEventListenersDobleClick() {
        document.querySelectorAll(".cancha-row").forEach((row) => {
          row.addEventListener("dblclick", (e) => {
            const canchaId = e.currentTarget.dataset.canchaId;
            console.log("🖱️ Doble-click en cancha:", canchaId);
            hacerZoomEnMapaDashboard(canchaId);
          });
        });
        console.log("✅ Event listeners de doble-click agregados");
      }

      // Enviar mensaje al iframe del mapa para hacer zoom a una cancha
      function hacerZoomEnMapaDashboard(canchaId) {
        const mapContainer = document.getElementById("dashboard-map-container");
        const iframe = mapContainer?.querySelector("iframe");

        if (!iframe || !iframe.contentWindow) {
          console.log("⚠️ Iframe del mapa no disponible");
          return;
        }

        // Enviar mensaje al iframe
        iframe.contentWindow.postMessage(
          {
            type: "zoom-to-cancha",
            canchaId: canchaId,
          },
          "*",
        );

        console.log("📤 Mensaje de zoom enviado al mapa:", canchaId);
      }

      // Manejar acciones de botones
      async function manejarAccion(e) {
        if (cargando) return;

        const accion = e.target.dataset.accion;
        const canchaId = parseInt(e.target.dataset.canchaId);

        // Manejar apertura de modales de RECEPCIÓN (solo lectura + botón Comenzar)
        if (accion === "recepcionar-besalco") {
          abrirModalRecepcionBesalco(canchaId);
          return;
        } else if (accion === "recepcionar-linkapsis") {
          abrirModalRecepcionLinkapsis(canchaId);
          return;
        } else if (accion === "recepcionar-llayllay") {
          abrirModalRecepcionLlayLlay(canchaId);
          return;
        }

        // Manejar apertura de modales de VALIDACIÓN (formulario completo)
        else if (accion === "validar-besalco") {
          abrirModalBesalco(canchaId);
          return;
        } else if (accion === "validar-linkapsis") {
          abrirModalLinkapsis(canchaId);
          return;
        } else if (accion === "validar-llayllay") {
          abrirModalLlayLlay(canchaId);
          return;
        }

        // Otros modales
        else if (accion === "abrir-modal-cierre") {
          abrirModalCierre(canchaId);
          return;
        } else if (accion === "abrir-modal-borrar") {
          abrirModalBorrar(canchaId);
          return;
        } else if (accion === "exportar-pdf") {
          await exportarPDF(canchaId);
          return;
        }

        // Confirmar acción de cierre
        if (accion === "cerrar") {
          if (!confirm("¿Confirmas el cierre de esta cancha?")) {
            return;
          }
        }

        // Pedir observaciones para rechazos (acciones directas legacy)
        let observaciones = null;
        if (accion.includes("rechazar")) {
          const empresaNombre =
            accion === "rechazar-besalco"
              ? "Besalco"
              : accion === "rechazar-linkapsis"
                ? "Linkapsis"
                : "LlayLlay";
          observaciones = prompt(
            `Observaciones del rechazo por ${empresaNombre}:`,
          );
          if (observaciones === null) return; // Usuario canceló
        }

        try {
          cargando = true;
          const textoOriginal = e.target.textContent;
          e.target.disabled = true;
          e.target.textContent = "Procesando...";

          const response = await fetch(`/api/canchas/${canchaId}/action`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ accion, observaciones }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || "Error al ejecutar acción");
          }

          await cargarCanchas();
          mostrarMensaje("Acción realizada exitosamente", "success");
        } catch (error) {
          console.error("Error en acción:", error);
          mostrarMensaje("Error: " + error.message, "error");
        } finally {
          cargando = false;
        }
      }

      // Mostrar mensajes
      function mostrarMensaje(mensaje, tipo) {
        const div = document.createElement("div");
        div.className = tipo;
        div.innerHTML = `<strong>${tipo === "success" ? "Éxito:" : "Error:"}</strong> ${mensaje}`;

        mensajeContainer.appendChild(div);

        setTimeout(() => {
          div.remove();
        }, 5000);
      }

      // === FUNCIONES DE MODALES DE VALIDACIÓN ===
      let canchaIdActual = null;

      // Función para cargar historial de observaciones de una cancha
      async function cargarHistorialObservaciones(
        canchaId,
        historialElementId,
      ) {
        try {
          const response = await fetch(`/api/canchas/${canchaId}/validaciones`);
          if (!response.ok) {
            throw new Error("Error al cargar historial");
          }

          const validaciones = await response.json();
          const historialElement = document.getElementById(historialElementId);
          const content = historialElement.querySelector(".historial-content");

          if (validaciones.length === 0) {
            content.innerHTML =
              '<p style="color: #666; font-style: italic; text-align: center; padding: 2rem;">No hay observaciones previas</p>';
          } else {
            content.innerHTML = `
              <div class="historial-timeline">
                ${validaciones
                  .map((val, index) => {
                    let medicionesHtml = "";

                    if (val.mediciones) {
                      if (val.mediciones.espesores) {
                        // Mediciones de Linkapsis (formato anterior)
                        medicionesHtml = `
                        <div class="medicion-linea">
                          <span class="medicion-label">📏 Medición de Espesor:</span> <strong>${val.mediciones.espesores.join(", ")} ${val.mediciones.unidad || "metros"}</strong>
                          ${val.mediciones.promedio ? `<br><span style="font-size: 0.95rem; color: #666; margin-left: 1.5rem;">📊 Promedio: <strong>${val.mediciones.promedio} ${val.mediciones.unidad || "metros"}</strong></span>` : ""}
                        </div>`;
                      } else if (val.mediciones.espesor) {
                        // Nueva medición de Linkapsis
                        medicionesHtml = `
                        <div class="medicion-linea">
                          <span class="medicion-label">📏 Medición de Espesor:</span> <strong>${val.mediciones.espesor} ${val.mediciones.unidad || "metros"}</strong>
                        </div>`;
                      } else if (val.mediciones.densidad) {
                        // Mediciones de LlayLlay
                        medicionesHtml = `
                        <div class="medicion-linea">
                          <span class="medicion-label">⚖️ Medición de Densidad:</span> <strong>${val.mediciones.densidad} ${val.mediciones.unidad || "g/cm³"}</strong>
                        </div>`;
                      }
                    }

                    const empresaNombre =
                      val.empresa_validadora?.nombre || "Empresa desconocida";
                    const empresaClass = empresaNombre
                      .toLowerCase()
                      .replace(/\s+/g, "");

                    // Generar separador solo si no es la última entrada
                    const separador =
                      index < validaciones.length - 1
                        ? `
                    <div class="separador-empresas">
                      ──────────────────────────────────────
                    </div>`
                        : "";

                    return `
                    <div class="historial-entry empresa-${empresaClass}">
                      <div class="empresa-nombre">🏢 ${empresaNombre}</div>
                      <div class="fecha-linea">
                        <span class="fecha-label">📅 Fecha:</span> ${new Date(
                          val.created_at,
                        ).toLocaleDateString("es-ES", {
                          weekday: "short",
                          year: "numeric",
                          month: "short",
                          day: "numeric",
                          hour: "2-digit",
                          minute: "2-digit",
                        })}
                      </div>
                      <div class="observacion-linea">
                        <span class="observacion-label">💬 Observaciones:</span> "${val.observaciones || "Sin observaciones específicas"}"
                      </div>
                      ${medicionesHtml}
                    </div>${separador}`;
                  })
                  .join("")}
              </div>
            `;
          }
        } catch (error) {
          console.error("Error al cargar historial:", error);
          const historialElement = document.getElementById(historialElementId);
          const content = historialElement.querySelector(".historial-content");
          content.innerHTML =
            '<p style="color: #e74c3c;">Error al cargar historial</p>';
        }
      }

      function abrirModalBesalco(canchaId) {
        canchaIdActual = canchaId;
        const modal = document.getElementById("validacion-besalco-modal");
        const form = document.getElementById("form-validacion-besalco");

        // Limpiar formulario
        form.reset();

        // Cargar historial de observaciones
        cargarHistorialObservaciones(canchaId, "historial-besalco");

        // Mostrar modal
        modal.classList.add("show");
      }

      function abrirModalLinkapsis(canchaId) {
        canchaIdActual = canchaId;
        const modal = document.getElementById("validacion-linkapsis-modal");
        const form = document.getElementById("form-validacion-linkapsis");

        // Limpiar formulario básico
        form.reset();

        // Limpiar checkboxes específicamente
        document.getElementById("trabajo-corte").checked = false;
        document.getElementById("trabajo-relleno").checked = false;

        // Verificar si ya existen coordenadas previas de Linkapsis
        verificarCoordenadasExistentes(canchaId);

        // Cargar historial de observaciones (incluye observaciones de Besalco)
        cargarHistorialObservaciones(canchaId, "historial-linkapsis");

        // Mostrar modal
        modal.classList.add("show");
      }

      async function verificarCoordenadasExistentes(canchaId) {
        try {
          const response = await fetch(`/api/canchas/${canchaId}/validaciones`);
          const validaciones = await response.json();

          console.log("Validaciones obtenidas:", validaciones);

          // Buscar validaciones de Linkapsis (empresa_validadora_id = 3) que tengan coordenadas
          if (validaciones && validaciones.length > 0) {
            const validacionLinkapsis = validaciones.find(
              (v) =>
                v.empresa_validadora_id === 3 &&
                v.mediciones &&
                v.mediciones.coordenadas,
            );

            if (
              validacionLinkapsis &&
              validacionLinkapsis.mediciones &&
              validacionLinkapsis.mediciones.coordenadas
            ) {
              const coordenadas = validacionLinkapsis.mediciones.coordenadas;
              console.log("Coordenadas existentes encontradas:", coordenadas);
              console.log(
                "Validación Linkapsis completa:",
                validacionLinkapsis,
              );

              // Pre-llenar los campos con coordenadas existentes
              const coordMap = {
                "p1-norte": coordenadas.p1?.norte || "",
                "p1-este": coordenadas.p1?.este || "",
                "p1-cota": coordenadas.p1?.cota || "",
                "p2-norte": coordenadas.p2?.norte || "",
                "p2-este": coordenadas.p2?.este || "",
                "p2-cota": coordenadas.p2?.cota || "",
                "p3-norte": coordenadas.p3?.norte || "",
                "p3-este": coordenadas.p3?.este || "",
                "p3-cota": coordenadas.p3?.cota || "",
                "p4-norte": coordenadas.p4?.norte || "",
                "p4-este": coordenadas.p4?.este || "",
                "p4-cota": coordenadas.p4?.cota || "",
              };

              console.log("Mapa de coordenadas para llenar:", coordMap);

              // Llenar los campos si tienen valores
              Object.keys(coordMap).forEach((id) => {
                const input = document.getElementById(id);
                if (input && coordMap[id]) {
                  console.log(
                    `Llenando campo ${id} con valor: ${coordMap[id]}`,
                  );
                  input.value = coordMap[id];
                } else if (input) {
                  console.log(
                    `Campo ${id} encontrado pero sin valor para llenar`,
                  );
                } else {
                  console.log(`Campo ${id} NO encontrado en el DOM`);
                }
              });

              // Mantener espesor y checkboxes vacíos para nueva evaluación
              const espesorInput = document.getElementById("espesor-linkapsis");
              if (espesorInput) {
                espesorInput.value = "";
              }

              // Mantener checkboxes de tipo de trabajo sin marcar para nueva evaluación
              document.getElementById("trabajo-corte").checked = false;
              document.getElementById("trabajo-relleno").checked = false;
            } else {
              console.log(
                "No se encontraron validaciones previas de Linkapsis con coordenadas",
              );
              console.log("Validaciones disponibles:", validaciones);
              // No hay coordenadas previas, limpiar todos los campos
              const coordInputs = [
                "p1-norte",
                "p1-este",
                "p1-cota",
                "p2-norte",
                "p2-este",
                "p2-cota",
                "p3-norte",
                "p3-este",
                "p3-cota",
                "p4-norte",
                "p4-este",
                "p4-cota",
              ];

              coordInputs.forEach((id) => {
                const input = document.getElementById(id);
                if (input) input.value = "";
              });
            }
          }
        } catch (error) {
          console.error("Error al verificar coordenadas existentes:", error);
          // En caso de error, limpiar campos por seguridad
          const coordInputs = [
            "p1-norte",
            "p1-este",
            "p1-cota",
            "p2-norte",
            "p2-este",
            "p2-cota",
            "p3-norte",
            "p3-este",
            "p3-cota",
            "p4-norte",
            "p4-este",
            "p4-cota",
          ];

          coordInputs.forEach((id) => {
            const input = document.getElementById(id);
            if (input) input.value = "";
          });
        }
      }

      function abrirModalLlayLlay(canchaId) {
        canchaIdActual = canchaId;
        const modal = document.getElementById("validacion-llayllay-modal");
        const form = document.getElementById("form-validacion-llayllay");

        // Limpiar formulario
        form.reset();

        // Cargar historial de observaciones (incluye Besalco y Linkapsis)
        cargarHistorialObservaciones(canchaId, "historial-llayllay");

        // Mostrar modal
        modal.classList.add("show");
      }

      // ============ MODALES DE RECEPCIÓN (solo lectura + botón Comenzar) ============

      function abrirModalRecepcionBesalco(canchaId) {
        canchaIdActual = canchaId;
        const modal = document.getElementById("recepcion-besalco-modal");

        // Cargar historial de observaciones
        cargarHistorialObservaciones(canchaId, "historial-recepcion-besalco");

        // Mostrar modal
        modal.classList.add("show");
      }

      function abrirModalRecepcionLinkapsis(canchaId) {
        canchaIdActual = canchaId;
        const modal = document.getElementById("recepcion-linkapsis-modal");

        // Cargar historial de observaciones
        cargarHistorialObservaciones(canchaId, "historial-recepcion-linkapsis");

        // Mostrar modal
        modal.classList.add("show");
      }

      function abrirModalRecepcionLlayLlay(canchaId) {
        canchaIdActual = canchaId;
        const modal = document.getElementById("recepcion-llayllay-modal");

        // Cargar historial de observaciones
        cargarHistorialObservaciones(canchaId, "historial-recepcion-llayllay");

        // Mostrar modal
        modal.classList.add("show");
      }

      // ============ MODALES DE CIERRE Y BORRADO ============

      function abrirModalCierre(canchaId) {
        canchaIdActual = canchaId;
        const modal = document.getElementById("cerrar-cancha-modal");

        // Cargar historial completo para revisión final
        cargarHistorialObservaciones(canchaId, "historial-cierre");

        // Mostrar modal
        modal.classList.add("show");
      }

      function abrirModalBorrar(canchaId) {
        canchaIdActual = canchaId;
        const modal = document.getElementById("borrar-cancha-modal");
        const inputConfirmacion = document.getElementById(
          "confirmacion-borrado",
        );
        const btnConfirmar = document.getElementById("confirmar-borrado");

        // Limpiar input y deshabilitar botón
        inputConfirmacion.value = "";
        btnConfirmar.disabled = true;

        // Cargar historial que se eliminará
        cargarHistorialObservaciones(canchaId, "historial-borrado");

        // Mostrar modal
        modal.classList.add("show");
      }

      // Función para exportar PDF
      async function exportarPDF(canchaId) {
        try {
          cargando = true;
          mostrarMensaje("Generando PDF...", "info");

          // Abrir la URL de descarga directamente en una nueva ventana
          const url = `/api/canchas/${canchaId}/download-pdf`;
          window.open(url, "_blank");

          mostrarMensaje("PDF generado correctamente", "success");
        } catch (error) {
          console.error("Error al exportar PDF:", error);
          mostrarMensaje("Error al generar PDF: " + error.message, "error");
        } finally {
          cargando = false;
        }
      }

      function cerrarTodosLosModales() {
        document.querySelectorAll(".modal").forEach((modal) => {
          modal.classList.remove("show");
        });
        canchaIdActual = null;
      }

      // Cerrar modal al hacer click fuera
      window.addEventListener("click", (e) => {
        if (e.target.classList.contains("modal")) {
          cerrarTodosLosModales();
        }
      });

      // Event listeners para botones de cerrar y cancelar
      document.addEventListener("DOMContentLoaded", () => {
        // Botones de cerrar (X)
        document.querySelectorAll(".close-btn").forEach((btn) => {
          btn.addEventListener("click", cerrarTodosLosModales);
        });

        // Botones de cancelar
        document.querySelectorAll(".btn-cancel").forEach((btn) => {
          btn.addEventListener("click", cerrarTodosLosModales);
        });

        // Formularios de validación
        configurarFormulariosValidacion();
      });

      function configurarFormulariosValidacion() {
        // Formulario Besalco
        const formBesalco = document.getElementById("form-validacion-besalco");
        if (formBesalco) {
          formBesalco.addEventListener("submit", procesarValidacionBesalco);

          const btnRechazar = formBesalco.querySelector(".btn-rechazar");
          if (btnRechazar) {
            btnRechazar.addEventListener("click", procesarRechazoBesalco);
          }
        }

        // Botones de "Comenzar Trabajo" en modales de recepción
        const btnComenzarBesalco = document.getElementById(
          "btn-comenzar-besalco",
        );
        if (btnComenzarBesalco) {
          btnComenzarBesalco.addEventListener("click", () =>
            comenzarTrabajo("Besalco"),
          );
        }

        const btnComenzarLinkapsis = document.getElementById(
          "btn-comenzar-linkapsis",
        );
        if (btnComenzarLinkapsis) {
          btnComenzarLinkapsis.addEventListener("click", () =>
            comenzarTrabajo("Linkapsis"),
          );
        }

        const btnComenzarLlayLlay = document.getElementById(
          "btn-comenzar-llayllay",
        );
        if (btnComenzarLlayLlay) {
          btnComenzarLlayLlay.addEventListener("click", () =>
            comenzarTrabajo("LlayLlay"),
          );
        }

        // Formulario Linkapsis
        const formLinkapsis = document.getElementById(
          "form-validacion-linkapsis",
        );
        if (formLinkapsis) {
          formLinkapsis.addEventListener("submit", procesarValidacionLinkapsis);

          const btnRechazar = formLinkapsis.querySelector(".btn-rechazar");
          if (btnRechazar) {
            btnRechazar.addEventListener("click", procesarRechazoLinkapsis);
          }
        }

        // Formulario LlayLlay
        const formLlayLlay = document.getElementById(
          "form-validacion-llayllay",
        );
        if (formLlayLlay) {
          formLlayLlay.addEventListener("submit", procesarValidacionLlayLlay);

          const btnRechazar = formLlayLlay.querySelector(".btn-rechazar");
          if (btnRechazar) {
            btnRechazar.addEventListener("click", procesarRechazoLlayLlay);
          }
        }

        // Botón de cierre definitivo
        const btnConfirmarCierre = document.getElementById("confirmar-cierre");
        if (btnConfirmarCierre) {
          btnConfirmarCierre.addEventListener("click", async () => {
            if (
              confirm(
                "¿Estás seguro de que deseas cerrar esta cancha definitivamente?",
              )
            ) {
              await ejecutarAccion("cerrar_cancha", canchaIdActual, null);
              cerrarTodosLosModales();
            }
          });
        }

        // Input de confirmación de borrado
        const inputConfirmacion = document.getElementById(
          "confirmacion-borrado",
        );
        const btnConfirmarBorrado =
          document.getElementById("confirmar-borrado");

        if (inputConfirmacion && btnConfirmarBorrado) {
          inputConfirmacion.addEventListener("input", () => {
            btnConfirmarBorrado.disabled =
              inputConfirmacion.value.trim() !== "borrar-cancha";
          });

          btnConfirmarBorrado.addEventListener("click", async () => {
            await ejecutarAccion("borrar_cancha", canchaIdActual, null);
            cerrarTodosLosModales();
          });
        }
      }

      // === FUNCIONES DE PROCESAMIENTO DE VALIDACIONES ===

      // Función para cambiar estado de "En Espera" a "En Proceso"
      async function comenzarTrabajo(empresa) {
        try {
          if (!canchaIdActual) {
            mostrarMensaje("No hay cancha seleccionada", "error");
            return;
          }

          console.log(
            `Comenzando trabajo para ${empresa} en cancha ${canchaIdActual}`,
          );

          // Cambiar estado de En Espera (7) o Rechazada, en Espera (8) → En Proceso (3)
          const response = await fetch(
            `/api/canchas/${canchaIdActual}/accion`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                accion: "tomar_trabajo",
                empresa: empresa,
              }),
            },
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Error al comenzar trabajo");
          }

          const result = await response.json();
          console.log("Trabajo iniciado:", result);

          mostrarMensaje(`✅ Trabajo iniciado para ${empresa}`, "success");
          cerrarTodosLosModales();

          // Recargar canchas para actualizar la tabla
          await cargarCanchas();
        } catch (error) {
          console.error("Error al comenzar trabajo:", error);
          mostrarMensaje(`Error: ${error.message}`, "error");
        }
      }

      async function procesarValidacionBesalco(e) {
        e.preventDefault();

        const observaciones = document
          .getElementById("besalco-observaciones")
          .value.trim();
        if (!observaciones) {
          mostrarMensaje("Por favor ingresa observaciones", "error");
          return;
        }

        await ejecutarAccion(
          "finalizar_besalco",
          canchaIdActual,
          observaciones,
        );
      }

      async function procesarRechazoBesalco(e) {
        e.preventDefault();

        const observaciones = document
          .getElementById("besalco-observaciones")
          .value.trim();
        if (!observaciones) {
          mostrarMensaje(
            "Por favor ingresa observaciones del rechazo",
            "error",
          );
          return;
        }

        await ejecutarAccion("rechazar_besalco", canchaIdActual, observaciones);
      }

      async function procesarValidacionLinkapsis(e) {
        e.preventDefault();

        const observaciones = document
          .getElementById("linkapsis-observaciones")
          .value.trim();
        const espesor = parseFloat(
          document.getElementById("linkapsis-espesor").value,
        );

        if (!observaciones || !espesor) {
          mostrarMensaje(
            "Por favor completa las observaciones y la medición de espesor",
            "error",
          );
          return;
        }

        // Verificar si es revalidación
        const isRevalidacion = await esRevalidacion(
          canchaIdActual,
          "Linkapsis",
        );

        // Recopilar tipo de trabajo
        const tipoTrabajo = [];
        if (document.getElementById("trabajo-corte").checked) {
          tipoTrabajo.push("corte");
        }
        if (document.getElementById("trabajo-relleno").checked) {
          tipoTrabajo.push("relleno");
        }

        // Recopilar coordenadas de los 4 puntos
        const coordenadas = {
          p1: {
            norte:
              parseFloat(document.getElementById("p1-norte").value) || null,
            este: parseFloat(document.getElementById("p1-este").value) || null,
            cota: parseFloat(document.getElementById("p1-cota").value) || null,
          },
          p2: {
            norte:
              parseFloat(document.getElementById("p2-norte").value) || null,
            este: parseFloat(document.getElementById("p2-este").value) || null,
            cota: parseFloat(document.getElementById("p2-cota").value) || null,
          },
          p3: {
            norte:
              parseFloat(document.getElementById("p3-norte").value) || null,
            este: parseFloat(document.getElementById("p3-este").value) || null,
            cota: parseFloat(document.getElementById("p3-cota").value) || null,
          },
          p4: {
            norte:
              parseFloat(document.getElementById("p4-norte").value) || null,
            este: parseFloat(document.getElementById("p4-este").value) || null,
            cota: parseFloat(document.getElementById("p4-cota").value) || null,
          },
        };

        const mediciones = {
          espesor: espesor,
          unidad: "metros",
          tipoTrabajo: tipoTrabajo,
          coordenadas: coordenadas,
          isRevalidacion: isRevalidacion,
        };

        await ejecutarAccion(
          "validar_linkapsis",
          canchaIdActual,
          observaciones,
          mediciones,
        );
      }

      async function procesarRechazoLinkapsis(e) {
        e.preventDefault();

        const observaciones = document
          .getElementById("linkapsis-observaciones")
          .value.trim();
        const espesor = parseFloat(
          document.getElementById("linkapsis-espesor").value,
        );

        if (!observaciones) {
          mostrarMensaje(
            "Por favor ingresa observaciones del rechazo",
            "error",
          );
          return;
        }

        // Incluir mediciones aunque sea rechazo
        let mediciones = null;
        if (espesor) {
          // Recopilar tipo de trabajo si están marcados
          const tipoTrabajo = [];
          if (document.getElementById("trabajo-corte").checked) {
            tipoTrabajo.push("corte");
          }
          if (document.getElementById("trabajo-relleno").checked) {
            tipoTrabajo.push("relleno");
          }

          // Recopilar coordenadas si están disponibles
          const coordenadas = {
            p1: {
              norte:
                parseFloat(document.getElementById("p1-norte").value) || null,
              este:
                parseFloat(document.getElementById("p1-este").value) || null,
              cota:
                parseFloat(document.getElementById("p1-cota").value) || null,
            },
            p2: {
              norte:
                parseFloat(document.getElementById("p2-norte").value) || null,
              este:
                parseFloat(document.getElementById("p2-este").value) || null,
              cota:
                parseFloat(document.getElementById("p2-cota").value) || null,
            },
            p3: {
              norte:
                parseFloat(document.getElementById("p3-norte").value) || null,
              este:
                parseFloat(document.getElementById("p3-este").value) || null,
              cota:
                parseFloat(document.getElementById("p3-cota").value) || null,
            },
            p4: {
              norte:
                parseFloat(document.getElementById("p4-norte").value) || null,
              este:
                parseFloat(document.getElementById("p4-este").value) || null,
              cota:
                parseFloat(document.getElementById("p4-cota").value) || null,
            },
          };

          mediciones = {
            espesor: espesor,
            unidad: "metros",
            tipoTrabajo: tipoTrabajo,
            coordenadas: coordenadas,
          };
        }

        await ejecutarAccion(
          "rechazar_linkapsis",
          canchaIdActual,
          observaciones,
          mediciones,
        );
      }

      async function procesarValidacionLlayLlay(e) {
        e.preventDefault();

        const observaciones = document
          .getElementById("llayllay-observaciones")
          .value.trim();
        const densidad = parseFloat(
          document.getElementById("llayllay-densidad").value,
        );

        if (!observaciones || !densidad) {
          mostrarMensaje(
            "Por favor completa observaciones y densidad",
            "error",
          );
          return;
        }

        // Verificar si es revalidación
        const isRevalidacion = await esRevalidacion(canchaIdActual, "LlayLlay");

        const mediciones = {
          densidad: densidad,
          unidad: "g/cm³",
          isRevalidacion: isRevalidacion,
        };

        await ejecutarAccion(
          "validar_llay_llay",
          canchaIdActual,
          observaciones,
          mediciones,
        );
      }

      async function procesarRechazoLlayLlay(e) {
        e.preventDefault();

        const observaciones = document
          .getElementById("llayllay-observaciones")
          .value.trim();
        const densidad = parseFloat(
          document.getElementById("llayllay-densidad").value,
        );

        if (!observaciones) {
          mostrarMensaje(
            "Por favor ingresa observaciones del rechazo",
            "error",
          );
          return;
        }

        // Incluir mediciones aunque sea rechazo
        let mediciones = null;
        if (densidad) {
          mediciones = {
            densidad: densidad,
            unidad: "g/cm³",
          };
        }

        await ejecutarAccion(
          "rechazar_llay_llay",
          canchaIdActual,
          observaciones,
          mediciones,
        );
      }

      // Función auxiliar para determinar si es revalidación
      async function esRevalidacion(canchaId, empresa) {
        try {
          const response = await fetch(`/api/canchas/${canchaId}`);
          if (!response.ok) return false;

          const data = await response.json();
          const cancha = data.cancha;

          // Buscar validaciones previas de la misma empresa
          const validacionesPrevias =
            cancha.validaciones?.filter(
              (v) => v.empresa === empresa && v.estado === "VALIDADO",
            ) || [];

          return validacionesPrevias.length > 0;
        } catch (error) {
          console.error("Error al verificar revalidación:", error);
          return false;
        }
      }

      // Función unificada para ejecutar acciones
      async function ejecutarAccion(
        accion,
        canchaId,
        observaciones,
        mediciones = null,
      ) {
        try {
          cargando = true;

          const payload = {
            accion: accion,
            observaciones: observaciones,
            usuario: usuarioLogueado, // Incluir información del usuario actual
          };

          if (mediciones) {
            payload.mediciones = mediciones;
          }

          const response = await fetch(`/api/canchas/${canchaId}/accion`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            throw new Error("Error en la respuesta del servidor");
          }

          const resultado = await response.json();

          cerrarTodosLosModales();
          mostrarMensaje(`Acción completada exitosamente`, "success");

          // Recargar canchas para mostrar cambios
          await cargarCanchas();
        } catch (error) {
          console.error("Error al ejecutar acción:", error);
          mostrarMensaje("Error al procesar la acción", "error");
        } finally {
          cargando = false;
        }
      }

      // Funciones para el Modal del Mapa
      function abrirMapaModal(canchaId, canchaName) {
        console.log("🚀 abrirMapaModal llamado con:", { canchaId, canchaName });

        const modal = document.getElementById("mapModal");
        const mapContainer = document.getElementById("mapContainer");
        const canchaIdSpan = document.getElementById("mapCanchaId");
        const closeBtn = document.getElementById("mapCloseBtn");

        // Extraer el muro del nombre de la cancha (primera parte antes del primer _)
        const muro = canchaName ? canchaName.split("_")[0] : null;
        console.log(
          `🗺️ Abriendo mapa para cancha ${canchaId} (${canchaName}) - Muro detectado: ${muro}`,
        );

        // Mostrar ID y nombre de la cancha en el título
        canchaIdSpan.textContent = `${canchaId} (${canchaName || "Sin nombre"})`;

        // Agregar event listener al botón de cerrar
        closeBtn.addEventListener("click", cerrarMapaModal);

        // Mostrar el modal
        modal.classList.add("show");

        // Agregar evento para cerrar con Escape
        document.addEventListener("keydown", handleEscapeKey);

        // Mostrar indicador de carga
        mapContainer.innerHTML =
          '<div class="map-loading">Cargando mapa...</div>';

        // Cargar el mapa en un iframe con el filtro de muro y cancha ID
        setTimeout(() => {
          const iframe = document.createElement("iframe");
          // Pasar el muro y canchaId como parámetros en la URL
          let mapUrl = "/mapbox-window";
          const params = new URLSearchParams();

          if (muro) {
            params.set("muro", muro);
          }
          if (canchaId) {
            params.set("canchaId", canchaId);
          }

          if (params.toString()) {
            mapUrl += "?" + params.toString();
          }

          console.log("🌐 URL del mapa:", mapUrl);
          iframe.src = mapUrl;
          iframe.style.width = "100%";
          iframe.style.height = "100%";
          iframe.style.border = "none";
          iframe.style.borderRadius = "0 0 16px 16px";

          mapContainer.innerHTML = "";
          mapContainer.appendChild(iframe);
        }, 300);
      }

      function cerrarMapaModal() {
        const modal = document.getElementById("mapModal");
        const mapContainer = document.getElementById("mapContainer");
        const closeBtn = document.getElementById("mapCloseBtn");

        modal.classList.remove("show");

        // Remover event listeners
        document.removeEventListener("keydown", handleEscapeKey);
        closeBtn.removeEventListener("click", cerrarMapaModal);

        // Limpiar el contenido del mapa
        setTimeout(() => {
          mapContainer.innerHTML = "";
        }, 300);
      }

      function handleEscapeKey(e) {
        if (e.key === "Escape") {
          cerrarMapaModal();
        }
      }

      // Cerrar modal al hacer clic fuera del contenido
      document.addEventListener("click", function (e) {
        const modal = document.getElementById("mapModal");
        if (e.target === modal) {
          cerrarMapaModal();
        }

        const createModal = document.getElementById("createCanchaModal");
        if (e.target === createModal) {
          cerrarModalCrearCancha();
        }
      });

      // =====================================================
      // FUNCIONES PARA CREAR CANCHA CON POLÍGONO
      // =====================================================

      // Variable global para almacenar las coordenadas del polígono dibujado
      let poligonoCoordinadas = null;

      // Función para abrir el modal de crear cancha
      function abrirModalCrearCancha() {
        console.log("🏗️ Abriendo modal de crear cancha...");
        const modal = document.getElementById("createCanchaModal");
        const closeBtn = document.getElementById("createCanchaCloseBtn");

        // Resetear formulario
        document.getElementById("muro-select").value = "";
        document.getElementById("sector-select").value = "";
        document.getElementById("nombre-detalle-input").value = "";
        document.getElementById("open-drawing-btn").disabled = true;
        document.getElementById("create-cancha-btn").disabled = true;
        document.getElementById("drawing-status").innerHTML = "";
        document.getElementById("drawingMapContainer").style.display = "none";
        poligonoCoordinadas = null;

        // Inicializar estado del selector de sector
        const sectorSelect = document.getElementById("sector-select");
        sectorSelect.disabled = true;
        sectorSelect.innerHTML =
          '<option value="">Selecciona un muro primero</option>';

        // Agregar event listeners
        closeBtn.addEventListener("click", cerrarModalCrearCancha);
        document
          .getElementById("open-drawing-btn")
          .addEventListener("click", abrirMapaDibujo);
        document
          .getElementById("create-cancha-btn")
          .addEventListener("click", crearCanchaConPoligono);

        // Agregar listeners para validar formulario
        document
          .getElementById("muro-select")
          .addEventListener("change", validarFormularioCreacion);
        document
          .getElementById("sector-select")
          .addEventListener("change", validarFormularioCreacion);
        document
          .getElementById("nombre-detalle-input")
          .addEventListener("input", validarFormularioCreacion);

        modal.classList.add("show");

        // Agregar evento para cerrar con Escape
        document.addEventListener("keydown", handleEscapeKeyCrear);
      }

      // Función para cerrar el modal de crear cancha
      function cerrarModalCrearCancha() {
        console.log("❌ Cerrando modal de crear cancha...");
        const modal = document.getElementById("createCanchaModal");
        const closeBtn = document.getElementById("createCanchaCloseBtn");

        modal.classList.remove("show");

        // Remover event listeners
        document.removeEventListener("keydown", handleEscapeKeyCrear);
        window.removeEventListener("message", handleDrawingMessage);
        closeBtn.removeEventListener("click", cerrarModalCrearCancha);
        document
          .getElementById("open-drawing-btn")
          .removeEventListener("click", abrirMapaDibujo);
        document
          .getElementById("create-cancha-btn")
          .removeEventListener("click", crearCanchaConPoligono);
        document
          .getElementById("muro-select")
          .removeEventListener("change", validarFormularioCreacion);
        document
          .getElementById("sector-select")
          .removeEventListener("change", validarFormularioCreacion);
        document
          .getElementById("nombre-detalle-input")
          .removeEventListener("input", validarFormularioCreacion);

        // Limpiar el contenido del mapa de dibujo
        setTimeout(() => {
          document.getElementById("drawingMapContainer").innerHTML = "";
        }, 300);
      }

      // Función para validar el formulario y habilitar botones
      function validarFormularioCreacion() {
        const muro = document.getElementById("muro-select").value;
        const sector = document.getElementById("sector-select").value;
        const nombreDetalle = document
          .getElementById("nombre-detalle-input")
          .value.trim();

        // Solo actualizar opciones de sector si el muro cambió
        const sectorSelect = document.getElementById("sector-select");
        if (sectorSelect.dataset.ultimoMuro !== muro) {
          actualizarOpcionesSector(muro);
          sectorSelect.dataset.ultimoMuro = muro;
        }

        const formularioCompleto = muro && sector && nombreDetalle;
        document.getElementById("open-drawing-btn").disabled =
          !formularioCompleto;

        // Solo habilitar crear cancha si también hay polígono dibujado
        const puedeCrear = formularioCompleto && poligonoCoordinadas;
        document.getElementById("create-cancha-btn").disabled = !puedeCrear;

        console.log("🔍 Validación formulario:", {
          muro,
          sector,
          nombreDetalle,
          formularioCompleto,
          puedeCrear,
        });
      }

      // Función para actualizar las opciones del selector de sector
      function actualizarOpcionesSector(muro) {
        const sectorSelect = document.getElementById("sector-select");

        if (!muro) {
          sectorSelect.disabled = true;
          sectorSelect.innerHTML =
            '<option value="">Selecciona un muro primero</option>';
          return;
        }

        // Guardar la selección actual antes de regenerar
        const seleccionActual = sectorSelect.value;

        sectorSelect.disabled = false;

        // Determinar el rango de sectores según el muro
        let maxSector = 3; // Por defecto para MO y ME
        if (muro === "MP") {
          maxSector = 7;
        }

        // Generar opciones dinámicamente
        let opciones = '<option value="">Selecciona un sector</option>';
        for (let i = 1; i <= maxSector; i++) {
          opciones += `<option value="S${i}">S${i}</option>`;
        }

        sectorSelect.innerHTML = opciones;

        // Restaurar la selección anterior si es válida
        if (seleccionActual && seleccionActual.match(/^S[1-9]$/)) {
          const numeroSector = parseInt(seleccionActual.substring(1));
          if (numeroSector <= maxSector) {
            sectorSelect.value = seleccionActual;
          }
        }

        console.log(
          `📍 Muro ${muro} seleccionado - Sectores disponibles: S1 a S${maxSector}`,
        );
      }

      // Función para abrir el mapa de dibujo
      function abrirMapaDibujo() {
        console.log("🗺️ Abriendo mapa de dibujo...");
        const muro = document.getElementById("muro-select").value;
        const drawingContainer = document.getElementById("drawingMapContainer");
        const statusDiv = document.getElementById("drawing-status");

        // Mostrar status de carga
        statusDiv.innerHTML = "🔄 Cargando mapa de dibujo...";
        statusDiv.className = "drawing-status info";

        // Mostrar el contenedor del mapa
        drawingContainer.style.display = "block";

        // Crear iframe con el mapa de dibujo
        setTimeout(() => {
          const iframe = document.createElement("iframe");
          iframe.src = `/mapbox-window?muro=${encodeURIComponent(muro)}&drawing=true`;
          iframe.style.width = "100%";
          iframe.style.height = "100%";
          iframe.style.border = "none";

          // Limpiar listener anterior si existe
          window.removeEventListener("message", handleDrawingMessage);

          // Agregar listener para mensajes del iframe
          window.addEventListener("message", handleDrawingMessage);

          drawingContainer.innerHTML = "";
          drawingContainer.appendChild(iframe);

          statusDiv.innerHTML = "🎨 Herramientas de dibujo activas";
          statusDiv.className = "drawing-status info";
        }, 300);
      }

      // Función para manejar mensajes del iframe de dibujo
      function handleDrawingMessage(event) {
        if (event.data.type === "polygon-drawn") {
          poligonoCoordinadas = event.data.coordinates;
          console.log("✅ Polígono recibido del iframe:", poligonoCoordinadas);

          const statusDiv = document.getElementById("drawing-status");
          statusDiv.innerHTML = `✅ ¡Área dibujada correctamente! (${poligonoCoordinadas.length} puntos) Ahora puedes crear la cancha.`;
          statusDiv.className = "drawing-status success";

          // Validar formulario nuevamente para habilitar el botón de crear
          validarFormularioCreacion();
        } else if (event.data.type === "polygon-deleted") {
          poligonoCoordinadas = null;
          console.log("🗑️ Polígono eliminado del iframe");

          const statusDiv = document.getElementById("drawing-status");
          statusDiv.innerHTML = "🎨 Dibuja un nuevo área de trabajo en el mapa";
          statusDiv.className = "drawing-status info";

          // Validar formulario nuevamente para deshabilitar el botón de crear
          validarFormularioCreacion();
        }
      }

      // Función para crear la cancha con polígono
      async function crearCanchaConPoligono() {
        console.log("🚀 Creando cancha con polígono...");

        const muro = document.getElementById("muro-select").value;
        const sector = document.getElementById("sector-select").value;
        const nombreDetalle = document
          .getElementById("nombre-detalle-input")
          .value.trim();

        if (!muro || !sector || !nombreDetalle || !poligonoCoordinadas) {
          alert(
            "Por favor completa todos los campos y dibuja el área en el mapa",
          );
          return;
        }

        try {
          // Deshabilitar botón mientras se crea
          document.getElementById("create-cancha-btn").disabled = true;
          document.getElementById("create-cancha-btn").textContent =
            "Creando...";

          const response = await fetch("/api/canchas", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              muro,
              sector,
              nombreDetalle,
              poligonoCoordinadas,
            }),
          });

          if (!response.ok) {
            throw new Error("Error al crear la cancha");
          }

          const nuevaCancha = await response.json();
          console.log("✅ Cancha creada exitosamente:", nuevaCancha);

          // Cerrar modal
          cerrarModalCrearCancha();

          // Recargar la lista de canchas
          await cargarCanchas();

          // Mostrar mensaje de éxito
          mostrarMensaje(
            `Cancha ${nuevaCancha.nombre} creada exitosamente con área dibujada`,
            "success",
          );
        } catch (error) {
          console.error("❌ Error al crear cancha:", error);
          alert("Error al crear la cancha: " + error.message);
        } finally {
          // Restaurar botón
          document.getElementById("create-cancha-btn").disabled = false;
          document.getElementById("create-cancha-btn").textContent =
            "Crear Cancha";
        }
      }

      // Manejar tecla Escape para cerrar modal de crear cancha
      function handleEscapeKeyCrear(e) {
        if (e.key === "Escape") {
          cerrarModalCrearCancha();
        }
      }

      // Inicializar la aplicación
      inicializar();
    </script>

    <!-- Modal para Crear Cancha (solo AngloAmerican) -->
    <div id="createCanchaModal" class="map-modal">
      <div class="map-modal-content create-cancha-modal-content">
        <div class="map-modal-header">
          <h3 class="map-modal-title">Crear Nueva Cancha</h3>
          <button id="createCanchaCloseBtn" class="map-close-btn"
            >&times;</button
          >
        </div>
        <div class="create-cancha-container">
          <!-- Panel izquierdo: Formulario -->
          <div class="create-cancha-form">
            <h4 class="form-section-title">📋 Datos de la Cancha</h4>
            <div class="form-group">
              <label for="muro-select">Muro:</label>
              <select id="muro-select" required>
                <option value="">Seleccionar Muro</option>
                <option value="MP">MP</option>
                <option value="ME">ME</option>
                <option value="MO">MO</option>
              </select>
            </div>
            <div class="form-group">
              <label for="sector-select">Sector:</label>
              <select id="sector-select" disabled required>
                <option value="">Selecciona un muro primero</option>
              </select>
            </div>
            <div class="form-group">
              <label for="nombre-detalle-input">Nombre Detalle:</label>
              <input
                type="text"
                id="nombre-detalle-input"
                placeholder="ej: TEST1"
                required
              />
            </div>
            <div class="form-actions">
              <button id="open-drawing-btn" class="btn-primary" disabled
                >🗺️ Dibujar Área en Mapa</button
              >
              <button id="create-cancha-btn" class="btn-success" disabled
                >✅ Crear Cancha</button
              >
            </div>
            <div id="drawing-status" class="drawing-status"></div>
          </div>

          <!-- Panel derecho: Mapa -->
          <div class="create-cancha-map-panel">
            <div class="map-panel-header">
              <h4 class="map-panel-title">🗺️ Área de Trabajo</h4>
              <p class="map-panel-subtitle">
                Dibuja el polígono que define el área de la cancha
              </p>
            </div>
            <div id="drawingMapContainer" class="drawing-map-container">
              <!-- El mapa de dibujo se cargará aquí -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para el Mapa -->
    <div id="mapModal" class="map-modal">
      <div class="map-modal-content">
        <div class="map-modal-header">
          <h3 class="map-modal-title">
            Visor de Mapa - Cancha <span id="mapCanchaId"></span>
          </h3>
          <button id="mapCloseBtn" class="map-close-btn">&times;</button>
        </div>
        <div id="mapContainer" class="map-container">
          <!-- El mapa se cargará aquí dinámicamente -->
        </div>
      </div>
    </div>
  </body>
</html>
