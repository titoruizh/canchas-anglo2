---
// Componente principal del mapa de miner√≠a - Refactorizado y Modular
import MapControls from "./map/MapControls.astro";
import MapLoader from "./map/MapLoader.astro";

interface Props {
  muroFilter?: string;
  drawingMode?: boolean;
  canchaId?: string;
  dashboardMode?: boolean;
  canchaIds?: string;
}

const {
  muroFilter,
  drawingMode = false,
  canchaId,
  dashboardMode = false,
  canchaIds,
} = Astro.props;

console.log("üèóÔ∏è MiningMap (New) iniciado con:", {
  muroFilter,
  drawingMode,
  canchaId,
});
---

<style>
  .map-container {
    position: relative;
    width: 100%;
    height: 100vh;
    max-width: 100%;
    margin: 0 auto;
    border-radius: 0;
    overflow: hidden;
  }
  #map {
    width: 100%;
    height: 100%;
  }
</style>

<div
  class="map-container"
  data-muro-filter={muroFilter || ""}
  data-drawing-mode={drawingMode.toString()}
  data-cancha-id={canchaId || ""}
  data-dashboard-mode={dashboardMode.toString()}
  data-cancha-ids={canchaIds || ""}
>
  <div id="map"></div>

  <!-- UI Components -->
  {!drawingMode && <MapControls muroFilter={muroFilter} />}
  <MapLoader />
</div>

<script>
  import { MapManager } from "./map/MapManager";

  async function initMap() {
    try {
      const mapContainer = document.querySelector(".map-container");
      if (!mapContainer) return;

      const options = {
        drawingMode: mapContainer.getAttribute("data-drawing-mode") === "true",
        canchaId: mapContainer.getAttribute("data-cancha-id") || undefined,
        dashboardMode:
          mapContainer.getAttribute("data-dashboard-mode") === "true",
        canchaIds: mapContainer.getAttribute("data-cancha-ids") || undefined,
        autoMuroFilter:
          mapContainer.getAttribute("data-muro-filter") || undefined,
      };

      console.log("üöÄ Instanciando MapManager...");
      const mapManager = new MapManager("map");
      await mapManager.initialize(options);

      // Window Message Event Listeners (API for Index.astro)
      window.addEventListener("message", (event) => {
        if (!event.data || !event.data.type) return;
        console.log("üì® Mensaje recibido en MiningMap:", event.data.type);

        if (event.data.type === "zoom-to-cancha") {
          mapManager.zoomToCancha(event.data.canchaId);
        } else if (event.data.type === "mostrar-revanchas") {
          mapManager.showRevanchas(event.data.data);
        } else if (event.data.type === "ocultar-revanchas") {
          mapManager.hideRevanchas();
        }
      });
    } catch (e) {
      console.error("Critical error in MiningMap script:", e);
    }
  }

  // Initialize on load
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initMap);
  } else {
    initMap();
  }
</script>
